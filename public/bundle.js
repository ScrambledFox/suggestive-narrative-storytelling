var app=function(){"use strict";function e(){}const t=e=>e;function n(e,t){for(const n in t)e[n]=t[n];return e}function r(e){return e()}function i(){return Object.create(null)}function a(e){e.forEach(r)}function o(e){return"function"==typeof e}function s(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function l(e,t,n,r){if(e){const i=u(e,t,n,r);return e[0](i)}}function u(e,t,r,i){return e[1]&&i?n(r.ctx.slice(),e[1](i(t))):r.ctx}function c(e,t,n,r){if(e[2]&&r){const i=e[2](r(n));if(void 0===t.dirty)return i;if("object"==typeof i){const e=[],n=Math.max(t.dirty.length,i.length);for(let r=0;r<n;r+=1)e[r]=t.dirty[r]|i[r];return e}return t.dirty|i}return t.dirty}function h(e,t,n,r,i,a){if(i){const o=u(t,n,r,a);e.p(o,i)}}function f(e){if(e.ctx.length>32){const t=[],n=e.ctx.length/32;for(let e=0;e<n;e++)t[e]=-1;return t}return-1}function d(e){const t={};for(const n in e)"$"!==n[0]&&(t[n]=e[n]);return t}const p="undefined"!=typeof window;let v=p?()=>window.performance.now():()=>Date.now(),m=p?e=>requestAnimationFrame(e):e;const y=new Set;function g(e){y.forEach((t=>{t.c(e)||(y.delete(t),t.f())})),0!==y.size&&m(g)}function C(e){let t;return 0===y.size&&m(g),{promise:new Promise((n=>{y.add(t={c:e,f:n})})),abort(){y.delete(t)}}}function b(e,t){e.appendChild(t)}function w(e){if(!e)return document;const t=e.getRootNode?e.getRootNode():e.ownerDocument;return t&&t.host?t:e.ownerDocument}function S(e){const t=_("style");return function(e,t){b(e.head||e,t),t.sheet}(w(e),t),t.sheet}function k(e,t,n){e.insertBefore(t,n||null)}function x(e){e.parentNode.removeChild(e)}function E(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function _(e){return document.createElement(e)}function T(e){return document.createTextNode(e)}function A(){return T(" ")}function N(){return T("")}function O(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}function P(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function I(e,t){const n=Object.getOwnPropertyDescriptors(e.__proto__);for(const r in t)null==t[r]?e.removeAttribute(r):"style"===r?e.style.cssText=t[r]:"__value"===r?e.value=e[r]=t[r]:n[r]&&n[r].set?e[r]=t[r]:P(e,r,t[r])}function F(e,t){t=""+t,e.wholeText!==t&&(e.data=t)}function W(e,t){e.value=null==t?"":t}function R(e,t,n){e.classList[n?"add":"remove"](t)}function D(e,t,{bubbles:n=!1,cancelable:r=!1}={}){const i=document.createEvent("CustomEvent");return i.initCustomEvent(e,n,r,t),i}const L=new Map;let j,$=0;function M(e,t,n,r,i,a,o,s=0){const l=16.666/r;let u="{\n";for(let e=0;e<=1;e+=l){const r=t+(n-t)*a(e);u+=100*e+`%{${o(r,1-r)}}\n`}const c=u+`100% {${o(n,1-n)}}\n}`,h=`__svelte_${function(e){let t=5381,n=e.length;for(;n--;)t=(t<<5)-t^e.charCodeAt(n);return t>>>0}(c)}_${s}`,f=w(e),{stylesheet:d,rules:p}=L.get(f)||function(e,t){const n={stylesheet:S(t),rules:{}};return L.set(e,n),n}(f,e);p[h]||(p[h]=!0,d.insertRule(`@keyframes ${h} ${c}`,d.cssRules.length));const v=e.style.animation||"";return e.style.animation=`${v?`${v}, `:""}${h} ${r}ms linear ${i}ms 1 both`,$+=1,h}function V(e,t){const n=(e.style.animation||"").split(", "),r=n.filter(t?e=>e.indexOf(t)<0:e=>-1===e.indexOf("__svelte")),i=n.length-r.length;i&&(e.style.animation=r.join(", "),$-=i,$||m((()=>{$||(L.forEach((e=>{const{ownerNode:t}=e.stylesheet;t&&x(t)})),L.clear())})))}function B(e){j=e}function G(){if(!j)throw new Error("Function called outside component initialization");return j}function q(){const e=G();return(t,n,{cancelable:r=!1}={})=>{const i=e.$$.callbacks[t];if(i){const a=D(t,n,{cancelable:r});return i.slice().forEach((t=>{t.call(e,a)})),!a.defaultPrevented}return!0}}function H(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach((e=>e.call(this,t)))}const U=[],K=[],z=[],J=[],Y=Promise.resolve();let X=!1;function Z(e){z.push(e)}const Q=new Set;let ee,te=0;function ne(){const e=j;do{for(;te<U.length;){const e=U[te];te++,B(e),re(e.$$)}for(B(null),U.length=0,te=0;K.length;)K.pop()();for(let e=0;e<z.length;e+=1){const t=z[e];Q.has(t)||(Q.add(t),t())}z.length=0}while(U.length);for(;J.length;)J.pop()();X=!1,Q.clear(),B(e)}function re(e){if(null!==e.fragment){e.update(),a(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(Z)}}function ie(){return ee||(ee=Promise.resolve(),ee.then((()=>{ee=null}))),ee}function ae(e,t,n){e.dispatchEvent(D(`${t?"intro":"outro"}${n}`))}const oe=new Set;let se;function le(){se={r:0,c:[],p:se}}function ue(){se.r||a(se.c),se=se.p}function ce(e,t){e&&e.i&&(oe.delete(e),e.i(t))}function he(e,t,n,r){if(e&&e.o){if(oe.has(e))return;oe.add(e),se.c.push((()=>{oe.delete(e),r&&(n&&e.d(1),r())})),e.o(t)}else r&&r()}const fe={duration:0};function de(n,r,i){let a,s,l=r(n,i),u=!1,c=0;function h(){a&&V(n,a)}function f(){const{delay:r=0,duration:i=300,easing:o=t,tick:f=e,css:d}=l||fe;d&&(a=M(n,0,1,i,r,o,d,c++)),f(0,1);const p=v()+r,m=p+i;s&&s.abort(),u=!0,Z((()=>ae(n,!0,"start"))),s=C((e=>{if(u){if(e>=m)return f(1,0),ae(n,!0,"end"),h(),u=!1;if(e>=p){const t=o((e-p)/i);f(t,1-t)}}return u}))}let d=!1;return{start(){d||(d=!0,V(n),o(l)?(l=l(),ie().then(f)):f())},invalidate(){d=!1},end(){u&&(h(),u=!1)}}}function pe(n,r,i,s){let l=r(n,i),u=s?0:1,c=null,h=null,f=null;function d(){f&&V(n,f)}function p(e,t){const n=e.b-u;return t*=Math.abs(n),{a:u,b:e.b,d:n,duration:t,start:e.start,end:e.start+t,group:e.group}}function m(r){const{delay:i=0,duration:o=300,easing:s=t,tick:m=e,css:y}=l||fe,g={start:v()+i,b:r};r||(g.group=se,se.r+=1),c||h?h=g:(y&&(d(),f=M(n,u,r,o,i,s,y)),r&&m(0,1),c=p(g,o),Z((()=>ae(n,r,"start"))),C((e=>{if(h&&e>h.start&&(c=p(h,o),h=null,ae(n,c.b,"start"),y&&(d(),f=M(n,u,c.b,c.duration,0,s,l.css))),c)if(e>=c.end)m(u=c.b,1-u),ae(n,c.b,"end"),h||(c.b?d():--c.group.r||a(c.group.c)),c=null;else if(e>=c.start){const t=e-c.start;u=c.a+c.d*s(t/c.duration),m(u,1-u)}return!(!c&&!h)})))}return{run(e){o(l)?ie().then((()=>{l=l(),m(e)})):m(e)},end(){d(),c=h=null}}}function ve(e,t){const n=t.token={};function r(e,r,i,a){if(t.token!==n)return;t.resolved=a;let o=t.ctx;void 0!==i&&(o=o.slice(),o[i]=a);const s=e&&(t.current=e)(o);let l=!1;t.block&&(t.blocks?t.blocks.forEach(((e,n)=>{n!==r&&e&&(le(),he(e,1,1,(()=>{t.blocks[n]===e&&(t.blocks[n]=null)})),ue())})):t.block.d(1),s.c(),ce(s,1),s.m(t.mount(),t.anchor),l=!0),t.block=s,t.blocks&&(t.blocks[r]=s),l&&ne()}if((i=e)&&"object"==typeof i&&"function"==typeof i.then){const n=G();if(e.then((e=>{B(n),r(t.then,1,t.value,e),B(null)}),(e=>{if(B(n),r(t.catch,2,t.error,e),B(null),!t.hasCatch)throw e})),t.current!==t.pending)return r(t.pending,0),!0}else{if(t.current!==t.then)return r(t.then,1,t.value,e),!0;t.resolved=e}var i}function me(e,t,n){const r=t.slice(),{resolved:i}=e;e.current===e.then&&(r[e.value]=i),e.current===e.catch&&(r[e.error]=i),e.block.p(r,n)}function ye(e){e&&e.c()}function ge(e,t,n,i){const{fragment:s,on_mount:l,on_destroy:u,after_update:c}=e.$$;s&&s.m(t,n),i||Z((()=>{const t=l.map(r).filter(o);u?u.push(...t):a(t),e.$$.on_mount=[]})),c.forEach(Z)}function Ce(e,t){const n=e.$$;null!==n.fragment&&(a(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function be(e,t){-1===e.$$.dirty[0]&&(U.push(e),X||(X=!0,Y.then(ne)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function we(t,n,r,o,s,l,u,c=[-1]){const h=j;B(t);const f=t.$$={fragment:null,ctx:null,props:l,update:e,not_equal:s,bound:i(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(n.context||(h?h.$$.context:[])),callbacks:i(),dirty:c,skip_bound:!1,root:n.target||h.$$.root};u&&u(f.root);let d=!1;if(f.ctx=r?r(t,n.props||{},((e,n,...r)=>{const i=r.length?r[0]:n;return f.ctx&&s(f.ctx[e],f.ctx[e]=i)&&(!f.skip_bound&&f.bound[e]&&f.bound[e](i),d&&be(t,e)),n})):[],f.update(),d=!0,a(f.before_update),f.fragment=!!o&&o(f.ctx),n.target){if(n.hydrate){const e=function(e){return Array.from(e.childNodes)}(n.target);f.fragment&&f.fragment.l(e),e.forEach(x)}else f.fragment&&f.fragment.c();n.intro&&ce(t.$$.fragment),ge(t,n.target,n.anchor,n.customElement),ne()}B(h)}class Se{$destroy(){Ce(this,1),this.$destroy=e}$on(e,t){const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}function ke(e){let t,n,r,i={ctx:e,current:null,token:null,hasCatch:!1,pending:Pe,then:_e,catch:Ee,blocks:[,,,]};return ve(n=e[6](),i),{c(){t=N(),i.block.c()},m(e,n){k(e,t,n),i.block.m(e,i.anchor=n),i.mount=()=>t.parentNode,i.anchor=t,r=!0},p(t,r){e=t,i.ctx=e,64&r&&n!==(n=e[6]())&&ve(n,i)||me(i,e,r)},i(e){r||(ce(i.block),r=!0)},o(e){for(let e=0;e<3;e+=1){he(i.blocks[e])}r=!1},d(e){e&&x(t),i.block.d(e),i.token=null,i=null}}}function xe(e){let t,n;const r=e[23].default,i=l(r,e,e[22],null);return{c(){t=_("div"),i&&i.c(),P(t,"class","typewriter-container svelte-12nvf3j")},m(e,r){k(e,t,r),i&&i.m(t,null),n=!0},p(e,t){i&&i.p&&(!n||4194304&t)&&h(i,r,e,e[22],n?c(r,e[22],t,null):f(e[22]),null)},i(e){n||(ce(i,e),n=!0)},o(e){he(i,e),n=!1},d(e){e&&x(t),i&&i.d(e)}}}function Ee(t){return{c:e,m:e,p:e,i:e,o:e,d:e}}function _e(e){let t,n,r,i={ctx:e,current:null,token:null,hasCatch:!1,pending:Oe,then:Ae,catch:Te,value:24,blocks:[,,,]};return ve(n=e[7][e[0]](),i),{c(){t=N(),i.block.c()},m(e,n){k(e,t,n),i.block.m(e,i.anchor=n),i.mount=()=>t.parentNode,i.anchor=t,r=!0},p(t,r){e=t,i.ctx=e,1&r&&n!==(n=e[7][e[0]]())&&ve(n,i)||me(i,e,r)},i(e){r||(ce(i.block),r=!0)},o(e){for(let e=0;e<3;e+=1){he(i.blocks[e])}r=!1},d(e){e&&x(t),i.block.d(e),i.token=null,i=null}}}function Te(t){return{c:e,m:e,p:e,i:e,o:e,d:e}}function Ae(e){let t,n,r=e[4],i=e[4]&&Ne(e);return{c(){i&&i.c(),t=N()},m(e,r){i&&i.m(e,r),k(e,t,r),n=!0},p(e,n){e[4]?r?s(r,e[4])?(i.d(1),i=Ne(e),i.c(),i.m(t.parentNode,t)):i.p(e,n):(i=Ne(e),i.c(),i.m(t.parentNode,t)):r&&(i.d(1),i=null),r=e[4]},i(e){n||(ce(i),n=!0)},o(e){he(i),n=!1},d(e){e&&x(t),i&&i.d(e)}}}function Ne(t){let r,i,a,s,u;const d=t[23].default,p=l(d,t,t[22],null);let v=[{class:"typewriter-container svelte-12nvf3j"}],m={};for(let e=0;e<v.length;e+=1)m=n(m,v[e]);return{c(){r=_(t[4]),p&&p.c(),I(r,m),R(r,"cursor",t[1])},m(n,l){var c;k(n,r,l),p&&p.m(r,null),a=!0,s||(c=i=t[24].default(r,t[5]),u=c&&o(c.destroy)?c.destroy:e,s=!0)},p(e,t){p&&p.p&&(!a||4194304&t)&&h(p,d,e,e[22],a?c(d,e[22],t,null):f(e[22]),null),I(r,m=function(e,t){const n={},r={},i={$$scope:1};let a=e.length;for(;a--;){const o=e[a],s=t[a];if(s){for(const e in o)e in s||(r[e]=1);for(const e in s)i[e]||(n[e]=s[e],i[e]=1);e[a]=s}else for(const e in o)i[e]=1}for(const e in r)e in n||(n[e]=void 0);return n}(v,[{class:"typewriter-container svelte-12nvf3j"}])),i&&o(i.update)&&32&t&&i.update.call(null,e[5]),R(r,"cursor",e[1])},i(e){a||(ce(p,e),a=!0)},o(e){he(p,e),a=!1},d(e){e&&x(r),p&&p.d(e),s=!1,u()}}}function Oe(t){return{c:e,m:e,p:e,i:e,o:e,d:e}}function Pe(t){let n,r=t[2]&&Ie();return{c(){r&&r.c(),n=N()},m(e,t){r&&r.m(e,t),k(e,n,t)},p(e,t){e[2]?r||(r=Ie(),r.c(),r.m(n.parentNode,n)):r&&(r.d(1),r=null)},i:e,o:e,d(e){r&&r.d(e),e&&x(n)}}}function Ie(e){let t;return{c(){t=_("div"),t.innerHTML='<p class="typing"></p>',P(t,"class","typewriter-container cursor svelte-12nvf3j")},m(e,n){k(e,t,n)},d(e){e&&x(t)}}}function Fe(e){let t,n,r,i;const a=[xe,ke],o=[];function s(e,t){return e[3]?0:1}return t=s(e),n=o[t]=a[t](e),{c(){n.c(),r=N()},m(e,n){o[t].m(e,n),k(e,r,n),i=!0},p(e,i){let l=t;t=s(e),t===l?o[t].p(e,i):(le(),he(o[l],1,1,(()=>{o[l]=null})),ue(),n=o[t],n?n.p(e,i):(n=o[t]=a[t](e),n.c()),ce(n,1),n.m(r.parentNode,r))},i(e){i||(ce(n),i=!0)},o(e){he(n),i=!1},d(e){o[t].d(e),e&&x(r)}}}function We(t){let n,r,i,a=t[8],o=Fe(t);return{c(){n=A(),o.c(),r=N()},m(e,t){k(e,n,t),o.m(e,t),k(e,r,t),i=!0},p(t,[n]){256&n&&s(a,a=t[8])?(le(),he(o,1,1,e),ue(),o=Fe(t),o.c(),ce(o,1),o.m(r.parentNode,r)):o.p(t,n)},i(e){i||(ce(o),i=!0)},o(e){he(o),i=!1},d(e){e&&x(n),e&&x(r),o.d(e)}}}function Re(e,t,r){let i,a,o,s,l,u,c,h,{$$slots:f={},$$scope:p}=t,{mode:v="concurrent"}=t,{interval:m=30}=t,{cursor:y=!0}=t,{keepCursorOnFinish:g=!1}=t,{delay:C=0}=t,{showCursorOnDelay:b=!1}=t,{disabled:w=!1}=t,{element:S="div"}=t,{scrambleDuration:k=3e3}=t,{scrambleSlowdown:x=!0}=t,{unwriteInterval:E=30}=t,{wordInterval:_=1500}=t;const T={concurrent:()=>Promise.resolve().then((function(){return fn})),cascade:()=>Promise.resolve().then((function(){return dn})),loop:()=>Promise.resolve().then((function(){return mn})),loopOnce:()=>Promise.resolve().then((function(){return yn})),loopRandom:()=>Promise.resolve().then((function(){return bn})),scramble:()=>Promise.resolve().then((function(){return Sn}))};return e.$$set=e=>{r(8,t=n(n({},t),d(e))),"mode"in e&&r(0,v=e.mode),"interval"in e&&r(9,m=e.interval),"cursor"in e&&r(1,y=e.cursor),"keepCursorOnFinish"in e&&r(10,g=e.keepCursorOnFinish),"delay"in e&&r(11,C=e.delay),"showCursorOnDelay"in e&&r(2,b=e.showCursorOnDelay),"disabled"in e&&r(3,w=e.disabled),"element"in e&&r(4,S=e.element),"scrambleDuration"in e&&r(12,k=e.scrambleDuration),"scrambleSlowdown"in e&&r(13,x=e.scrambleSlowdown),"unwriteInterval"in e&&r(14,E=e.unwriteInterval),"wordInterval"in e&&r(15,_=e.wordInterval),"$$scope"in e&&r(22,p=e.$$scope)},e.$$.update=()=>{1&e.$$.dirty&&r(20,i=/^loop(Once|Random)?$/.test(v)),1&e.$$.dirty&&r(21,a=["concurrent","cascade","loopOnce"].includes(v)),2098176&e.$$.dirty&&r(19,o=!a&&g),2052&e.$$.dirty&&r(18,s=C<1&&b),r(17,l=!i&&(t.unwriteInterval||t.wordInterval)),r(16,u="scramble"!==v&&(t.scrambleDuration||t.scrambleSlowdown)),524288&e.$$.dirty&&o&&console.warn("[svelte-typewriter] The prop 'keepCursorOnFinish' only has effect on the following modes: 'concurrent', 'cascade' and 'loopOnce'"),262144&e.$$.dirty&&s&&console.warn("[svelte-typewriter] The prop 'showCursorOnDelay' has no effect if the delay is 0"),131072&e.$$.dirty&&l&&console.warn("[svelte-typewriter] The props 'unwriteInterval' and 'wordInterval' can only be used on loop mode"),65536&e.$$.dirty&&u&&console.warn("[svelte-typewriter] The props 'scrambleDuration' and 'scrambleSlowdown' can only be used on scramble mode"),2048&e.$$.dirty&&r(6,c=()=>new Promise((e=>setTimeout((()=>e(C)),C)))),65054&e.$$.dirty&&r(5,h={interval:m,cursor:y,keepCursorOnFinish:g,delay:C,showCursorOnDelay:b,disabled:w,element:S,scrambleDuration:k,scrambleSlowdown:x,unwriteInterval:E,wordInterval:_})},t=d(t),[v,y,b,w,S,h,c,T,t,m,g,C,k,x,E,_,u,l,s,o,i,a,p,f]}class De extends Se{constructor(e){super(),we(this,e,Re,We,s,{mode:0,interval:9,cursor:1,keepCursorOnFinish:10,delay:11,showCursorOnDelay:2,disabled:3,element:4,scrambleDuration:12,scrambleSlowdown:13,unwriteInterval:14,wordInterval:15})}}function Le(e,{delay:n=0,duration:r=400,easing:i=t}={}){const a=+getComputedStyle(e).opacity;return{delay:n,duration:r,easing:i,css:e=>"opacity: "+e*a}}function je(e){let t,n;return t=new De({props:{mode:"cascade",keepCursorOnFinish:!0,$$slots:{default:[$e]},$$scope:{ctx:e}}}),t.$on("done",Be),{c(){ye(t.$$.fragment)},m(e,r){ge(t,e,r),n=!0},p(e,n){const r={};17&n&&(r.$$scope={dirty:n,ctx:e}),t.$set(r)},i(e){n||(ce(t.$$.fragment,e),n=!0)},o(e){he(t.$$.fragment,e),n=!1},d(e){Ce(t,e)}}}function $e(e){let t,n;return{c(){t=_("p"),n=T(e[0])},m(e,r){k(e,t,r),b(t,n)},p(e,t){1&t&&F(n,e[0])},d(e){e&&x(t)}}}function Me(t){let n,r,i,a;return{c(){n=_("button"),n.textContent="Continue ▶",P(n,"class","svelte-1k8sxjl")},m(e,r){k(e,n,r),i||(a=O(n,"click",t[2]),i=!0)},p:e,i(e){r||Z((()=>{r=de(n,Le,{delay:0,duration:1e3}),r.start()}))},o:e,d(e){e&&x(n),i=!1,a()}}}function Ve(e){let t,n,r,i=null!==e[0]&&je(e),a=e[1]&&Me(e);return{c(){i&&i.c(),t=A(),a&&a.c(),n=N()},m(e,o){i&&i.m(e,o),k(e,t,o),a&&a.m(e,o),k(e,n,o),r=!0},p(e,[r]){null!==e[0]?i?(i.p(e,r),1&r&&ce(i,1)):(i=je(e),i.c(),ce(i,1),i.m(t.parentNode,t)):i&&(le(),he(i,1,1,(()=>{i=null})),ue()),e[1]?a?(a.p(e,r),2&r&&ce(a,1)):(a=Me(e),a.c(),ce(a,1),a.m(n.parentNode,n)):a&&(a.d(1),a=null)},i(e){r||(ce(i),ce(a),r=!0)},o(e){he(i),r=!1},d(e){i&&i.d(e),e&&x(t),a&&a.d(e),e&&x(n)}}}const Be=()=>{};function Ge(e,t,n){const r=q();let{text:i=""}=t,{canContinue:a=!1}=t;return e.$$set=e=>{"text"in e&&n(0,i=e.text),"canContinue"in e&&n(1,a=e.canContinue)},[i,a,()=>{r("story:continue")}]}class qe extends Se{constructor(e){super(),we(this,e,Ge,Ve,s,{text:0,canContinue:1})}}function He(t){let n,r,i,a,o;return{c(){n=_("wrapper"),r=_("p"),i=T(t[0]),P(r,"class","svelte-14js4l9"),P(n,"class","svelte-14js4l9"),R(n,"isSelected",t[1])},m(e,s){k(e,n,s),b(n,r),b(r,i),a||(o=O(n,"mousedown",t[2]),a=!0)},p(e,[t]){1&t&&F(i,e[0]),2&t&&R(n,"isSelected",e[1])},i:e,o:e,d(e){e&&x(n),a=!1,o()}}}function Ue(e,t,n){let{text:r}=t,{index:i}=t,{isSelected:a}=t;const o=q();return e.$$set=e=>{"text"in e&&n(0,r=e.text),"index"in e&&n(3,i=e.index),"isSelected"in e&&n(1,a=e.isSelected)},[r,a,()=>{o("choice:selected",{index:i,text:r})},i]}class Ke extends Se{constructor(e){super(),we(this,e,Ue,He,s,{text:0,index:3,isSelected:1})}}function ze(e,t,n){const r=e.slice();return r[6]=t[n],r[8]=n,r}function Je(e){let t,n,r,i,a,o,s=e[8]>0&&function(e){let t;return{c(){t=_("p"),t.textContent="-"},m(e,n){k(e,t,n)},d(e){e&&x(t)}}}();return r=new Ke({props:{text:e[6].text+` (${e[2](e[8])}%)`,index:e[8],isSelected:e[0]===e[8]}}),r.$on("choice:selected",e[5]),{c(){t=_("div"),s&&s.c(),n=A(),ye(r.$$.fragment),i=A()},m(e,a){k(e,t,a),s&&s.m(t,null),b(t,n),ge(r,t,null),b(t,i),o=!0},p(e,t){const n={};2&t&&(n.text=e[6].text+` (${e[2](e[8])}%)`),1&t&&(n.isSelected=e[0]===e[8]),r.$set(n)},i(n){o||(ce(r.$$.fragment,n),a||Z((()=>{a=de(t,Le,{delay:1250*e[8],duration:1e3}),a.start()})),o=!0)},o(e){he(r.$$.fragment,e),o=!1},d(e){e&&x(t),s&&s.d(),Ce(r)}}}function Ye(e){let t,n,r=e[1],i=[];for(let t=0;t<r.length;t+=1)i[t]=Je(ze(e,r,t));const a=e=>he(i[e],1,1,(()=>{i[e]=null}));return{c(){t=_("wrapper");for(let e=0;e<i.length;e+=1)i[e].c()},m(e,r){k(e,t,r);for(let e=0;e<i.length;e+=1)i[e].m(t,null);n=!0},p(e,[n]){if(7&n){let o;for(r=e[1],o=0;o<r.length;o+=1){const a=ze(e,r,o);i[o]?(i[o].p(a,n),ce(i[o],1)):(i[o]=Je(a),i[o].c(),ce(i[o],1),i[o].m(t,null))}for(le(),o=r.length;o<i.length;o+=1)a(o);ue()}},i(e){if(!n){for(let e=0;e<r.length;e+=1)ce(i[e]);n=!0}},o(e){i=i.filter(Boolean);for(let e=0;e<i.length;e+=1)he(i[e]);n=!1},d(e){e&&x(t),E(i,e)}}}function Xe(e,t,n){let{selected:r=-1}=t,{choices:i}=t,{choiceData:a}=t,{totalChosen:o}=t;console.log(a,o);return e.$$set=e=>{"selected"in e&&n(0,r=e.selected),"choices"in e&&n(1,i=e.choices),"choiceData"in e&&n(3,a=e.choiceData),"totalChosen"in e&&n(4,o=e.totalChosen)},[r,i,e=>{let t=a.find((t=>t.index===e));return void 0===t||0===o?0:(100*t.chosen/o).toFixed(0)},a,o,e=>{n(0,r=e.detail.index)}]}class Ze extends Se{constructor(e){super(),we(this,e,Xe,Ye,s,{selected:0,choices:1,choiceData:3,totalChosen:4})}}function Qe(e){let t,n;return{c(){t=T(e[1]),n=T(" People Agree")},m(e,r){k(e,t,r),k(e,n,r)},p(e,n){2&n&&F(t,e[1])},d(e){e&&x(t),e&&x(n)}}}function et(e){let t,n;return{c(){t=T(e[1]),n=T(" Person Agrees")},m(e,r){k(e,t,r),k(e,n,r)},p(e,n){2&n&&F(t,e[1])},d(e){e&&x(t),e&&x(n)}}}function tt(t){let n;return{c(){n=T("No One Agrees")},m(e,t){k(e,n,t)},p:e,d(e){e&&x(n)}}}function nt(e){let t,n,r;return{c(){t=_("button"),t.textContent="Agree",P(t,"class","svelte-ygfl7b")},m(i,a){k(i,t,a),n||(r=O(t,"click",e[3]),n=!0)},d(e){e&&x(t),n=!1,r()}}}function rt(t){let n,r,i,a,o,s,l,u,c;function h(e,t){return 0===e[1]?tt:1===e[1]?et:Qe}let f=h(t),d=f(t),p=t[2]&&nt(t);return{c(){n=_("container"),r=_("card"),i=_("h5"),d.c(),a=A(),o=_("hr"),s=A(),l=_("p"),u=T(t[0]),c=A(),p&&p.c(),P(i,"class","svelte-ygfl7b"),P(o,"class","svelte-ygfl7b"),P(l,"class","svelte-ygfl7b"),P(r,"class","svelte-ygfl7b"),P(n,"class","svelte-ygfl7b")},m(e,t){k(e,n,t),b(n,r),b(r,i),d.m(i,null),b(r,a),b(r,o),b(r,s),b(r,l),b(l,u),b(r,c),p&&p.m(r,null)},p(e,[t]){f===(f=h(e))&&d?d.p(e,t):(d.d(1),d=f(e),d&&(d.c(),d.m(i,null))),1&t&&F(u,e[0]),e[2]?p||(p=nt(e),p.c(),p.m(r,null)):p&&(p.d(1),p=null)},i:e,o:e,d(e){e&&x(n),d.d(),p&&p.d()}}}function it(e,t,n){let{text:r=""}=t,{agreed:i=0}=t,{showAgreeButton:a=!1}=t;return e.$$set=e=>{"text"in e&&n(0,r=e.text),"agreed"in e&&n(1,i=e.agreed),"showAgreeButton"in e&&n(2,a=e.showAgreeButton)},[r,i,a,function(t){H.call(this,e,t)}]}class at extends Se{constructor(e){super(),we(this,e,it,rt,s,{text:0,agreed:1,showAgreeButton:2})}}function ot(e){let t,n;return t=new at({props:{text:e[0].opinion,agreed:e[1],showAgreeButton:e[2]}}),t.$on("click",e[4]),{c(){ye(t.$$.fragment)},m(e,r){ge(t,e,r),n=!0},p(e,[n]){const r={};1&n&&(r.text=e[0].opinion),2&n&&(r.agreed=e[1]),4&n&&(r.showAgreeButton=e[2]),t.$set(r)},i(e){n||(ce(t.$$.fragment,e),n=!0)},o(e){he(t.$$.fragment,e),n=!1},d(e){Ce(t,e)}}}function st(e,t,n){const r=q();let{opinion:i}=t,{agreed:a}=t,{showAgreeButton:o}=t;const s=()=>{console.log("OPI",i),r("opinion:agreed",{opinion:i})};return e.$$set=e=>{"opinion"in e&&n(0,i=e.opinion),"agreed"in e&&n(1,a=e.agreed),"showAgreeButton"in e&&n(2,o=e.showAgreeButton)},[i,a,o,s,()=>s()]}class lt extends Se{constructor(e){super(),we(this,e,st,ot,s,{opinion:0,agreed:1,showAgreeButton:2})}}function ut(e,t,n){const r=e.slice();return r[4]=t[n],r[6]=n,r}function ct(e){let t,n,r=e[0],i=[];for(let t=0;t<r.length;t+=1)i[t]=dt(ut(e,r,t));const a=e=>he(i[e],1,1,(()=>{i[e]=null}));return{c(){t=_("scroller");for(let e=0;e<i.length;e+=1)i[e].c();P(t,"class","svelte-pz0la2")},m(e,r){k(e,t,r);for(let e=0;e<i.length;e+=1)i[e].m(t,null);n=!0},p(e,n){if(7&n){let o;for(r=e[0],o=0;o<r.length;o+=1){const a=ut(e,r,o);i[o]?(i[o].p(a,n),ce(i[o],1)):(i[o]=dt(a),i[o].c(),ce(i[o],1),i[o].m(t,null))}for(le(),o=r.length;o<i.length;o+=1)a(o);ue()}},i(e){if(!n){for(let e=0;e<r.length;e+=1)ce(i[e]);n=!0}},o(e){i=i.filter(Boolean);for(let e=0;e<i.length;e+=1)he(i[e]);n=!1},d(e){e&&x(t),E(i,e)}}}function ht(t){let n,r;return{c(){n=_("p"),n.innerHTML="<i>No opinions exist yet for this choice.</i>",P(n,"class","svelte-pz0la2")},m(e,t){k(e,n,t)},p:e,i(e){r||Z((()=>{r=de(n,Le,{duration:1e3}),r.start()}))},o:e,d(e){e&&x(n)}}}function ft(t){let n,r;return{c(){n=_("p"),n.innerHTML="<i>Select an choice to see opinions for that choice.</i>",P(n,"class","svelte-pz0la2")},m(e,t){k(e,n,t)},p:e,i(e){r||Z((()=>{r=de(n,Le,{duration:1e3}),r.start()}))},o:e,d(e){e&&x(n)}}}function dt(e){let t,n;return t=new lt({props:{opinion:e[4],agreed:e[4].agreedTimes,showAgreeButton:e[1]}}),t.$on("opinion:agreed",e[3]),{c(){ye(t.$$.fragment)},m(e,r){ge(t,e,r),n=!0},p(e,n){const r={};1&n&&(r.opinion=e[4]),1&n&&(r.agreed=e[4].agreedTimes),2&n&&(r.showAgreeButton=e[1]),t.$set(r)},i(e){n||(ce(t.$$.fragment,e),n=!0)},o(e){he(t.$$.fragment,e),n=!1},d(e){Ce(t,e)}}}function pt(e){let t,n,r,i;const a=[ft,ht,ct],o=[];function s(e,t){return null===e[0]?0:0===e[0].length?1:2}return n=s(e),r=o[n]=a[n](e),{c(){t=_("wrapper"),r.c(),P(t,"class","svelte-pz0la2")},m(e,r){k(e,t,r),o[n].m(t,null),i=!0},p(e,[i]){let l=n;n=s(e),n===l?o[n].p(e,i):(le(),he(o[l],1,1,(()=>{o[l]=null})),ue(),r=o[n],r?r.p(e,i):(r=o[n]=a[n](e),r.c()),ce(r,1),r.m(t,null))},i(e){i||(ce(r),i=!0)},o(e){he(r),i=!1},d(e){e&&x(t),o[n].d()}}}function vt(e,t,n){const r=q();let{opinions:i=[]}=t,{showAgreeButton:a=!1}=t;return e.$$set=e=>{"opinions"in e&&n(0,i=e.opinions),"showAgreeButton"in e&&n(1,a=e.showAgreeButton)},[i,a,r,e=>{r("opinion:agreed",{opinion:e.detail.opinion})}]}class mt extends Se{constructor(e){super(),we(this,e,vt,pt,s,{opinions:0,showAgreeButton:1})}}function yt(e){let t,n;return{c(){t=_("h3"),n=T(e[0])},m(e,r){k(e,t,r),b(t,n)},p(e,t){1&t&&F(n,e[0])},d(e){e&&x(t)}}}function gt(e){let t,n,r,i,a,o;function s(t){e[10](t)}let l={choices:e[1],choiceData:e[2],totalChosen:e[3]};void 0!==e[7]&&(l.selected=e[7]),t=new Ze({props:l}),K.push((()=>function(e,t,n){const r=e.$$.props[t];void 0!==r&&(e.$$.bound[r]=n,n(e.$$.ctx[r]))}(t,"selected",s)));let u=e[5]&&Ct(e),c=-1!==e[7]&&bt(e);return{c(){ye(t.$$.fragment),r=A(),u&&u.c(),i=A(),c&&c.c(),a=N()},m(e,n){ge(t,e,n),k(e,r,n),u&&u.m(e,n),k(e,i,n),c&&c.m(e,n),k(e,a,n),o=!0},p(e,r){const o={};var s;2&r&&(o.choices=e[1]),4&r&&(o.choiceData=e[2]),8&r&&(o.totalChosen=e[3]),!n&&128&r&&(n=!0,o.selected=e[7],s=()=>n=!1,J.push(s)),t.$set(o),e[5]?u?(u.p(e,r),32&r&&ce(u,1)):(u=Ct(e),u.c(),ce(u,1),u.m(i.parentNode,i)):u&&(le(),he(u,1,1,(()=>{u=null})),ue()),-1!==e[7]?c?(c.p(e,r),128&r&&ce(c,1)):(c=bt(e),c.c(),ce(c,1),c.m(a.parentNode,a)):c&&(c.d(1),c=null)},i(e){o||(ce(t.$$.fragment,e),ce(u),ce(c),o=!0)},o(e){he(t.$$.fragment,e),he(u),o=!1},d(e){Ce(t,e),e&&x(r),u&&u.d(e),e&&x(i),c&&c.d(e),e&&x(a)}}}function Ct(e){let t,n;return t=new mt({props:{opinions:e[7]>=0?e[4].filter(e[11]):[]}}),{c(){ye(t.$$.fragment)},m(e,r){ge(t,e,r),n=!0},p(e,n){const r={};144&n&&(r.opinions=e[7]>=0?e[4].filter(e[11]):[]),t.$set(r)},i(e){n||(ce(t.$$.fragment,e),n=!0)},o(e){he(t.$$.fragment,e),n=!1},d(e){Ce(t,e)}}}function bt(t){let n,r,i,a;return{c(){n=_("button"),n.textContent="Choose ▶",P(n,"class","svelte-1ooqfdk")},m(e,r){k(e,n,r),i||(a=O(n,"click",(function(){o(t[8]("choice:confirmed",{index:t[7],choice:t[1][t[7]]}))&&t[8]("choice:confirmed",{index:t[7],choice:t[1][t[7]]}).apply(this,arguments)})),i=!0)},p(e,n){t=e},i(e){r||Z((()=>{r=de(n,Le,{delay:0,duration:1e3}),r.start()}))},o:e,d(e){e&&x(n),i=!1,a()}}}function wt(e){let t,n,r,i;n=new De({props:{mode:"concurrent",$$slots:{default:[yt]},$$scope:{ctx:e}}}),n.$on("done",e[9]);let a=e[6]&&gt(e);return{c(){t=_("wrapper"),ye(n.$$.fragment),r=A(),a&&a.c(),P(t,"class","svelte-1ooqfdk")},m(e,o){k(e,t,o),ge(n,t,null),b(t,r),a&&a.m(t,null),i=!0},p(e,[r]){const i={};4097&r&&(i.$$scope={dirty:r,ctx:e}),n.$set(i),e[6]?a?(a.p(e,r),64&r&&ce(a,1)):(a=gt(e),a.c(),ce(a,1),a.m(t,null)):a&&(le(),he(a,1,1,(()=>{a=null})),ue())},i(e){i||(ce(n.$$.fragment,e),ce(a),i=!0)},o(e){he(n.$$.fragment,e),he(a),i=!1},d(e){e&&x(t),Ce(n),a&&a.d()}}}function St(e,t,n){const r=q();let{text:i}=t,{choices:a}=t,{choiceData:o}=t,{totalChosen:s}=t,{opinions:l=[]}=t,{canHaveOpinion:u}=t,c=!1,h=-1;return e.$$set=e=>{"text"in e&&n(0,i=e.text),"choices"in e&&n(1,a=e.choices),"choiceData"in e&&n(2,o=e.choiceData),"totalChosen"in e&&n(3,s=e.totalChosen),"opinions"in e&&n(4,l=e.opinions),"canHaveOpinion"in e&&n(5,u=e.canHaveOpinion)},[i,a,o,s,l,u,c,h,r,()=>{n(6,c=!0)},function(e){h=e,n(7,h)},e=>e.choiceId===h]}class kt extends Se{constructor(e){super(),we(this,e,St,wt,s,{text:0,choices:1,choiceData:2,totalChosen:3,opinions:4,canHaveOpinion:5})}}function xt(e){let t,n,r,i;const a=[_t,Et],o=[];function s(e,t){return void 0!==e[0].choices&&e[0].choices.length>0?0:1}return t=s(e),n=o[t]=a[t](e),{c(){n.c(),r=N()},m(e,n){o[t].m(e,n),k(e,r,n),i=!0},p(e,i){let l=t;t=s(e),t===l?o[t].p(e,i):(le(),he(o[l],1,1,(()=>{o[l]=null})),ue(),n=o[t],n?n.p(e,i):(n=o[t]=a[t](e),n.c()),ce(n,1),n.m(r.parentNode,r))},i(e){i||(ce(n),i=!0)},o(e){he(n),i=!1},d(e){o[t].d(e),e&&x(r)}}}function Et(e){let t,n;return t=new qe({props:{text:e[0].prompt,canContinue:void 0!==e[0].choices&&0===e[0].choices.length}}),t.$on("story:continue",e[4]),{c(){ye(t.$$.fragment)},m(e,r){ge(t,e,r),n=!0},p(e,n){const r={};1&n&&(r.text=e[0].prompt),1&n&&(r.canContinue=void 0!==e[0].choices&&0===e[0].choices.length),t.$set(r)},i(e){n||(ce(t.$$.fragment,e),n=!0)},o(e){he(t.$$.fragment,e),n=!1},d(e){Ce(t,e)}}}function _t(e){let t,n;return t=new kt({props:{text:e[0].prompt,choices:e[0].choices,choiceData:e[0].choiceData,totalChosen:e[0].totalChosen,canHaveOpinion:e[0].opinionId>0,opinions:e[0].opinions}}),t.$on("choice:confirmed",e[3]),{c(){ye(t.$$.fragment)},m(e,r){ge(t,e,r),n=!0},p(e,n){const r={};1&n&&(r.text=e[0].prompt),1&n&&(r.choices=e[0].choices),1&n&&(r.choiceData=e[0].choiceData),1&n&&(r.totalChosen=e[0].totalChosen),1&n&&(r.canHaveOpinion=e[0].opinionId>0),1&n&&(r.opinions=e[0].opinions),t.$set(r)},i(e){n||(ce(t.$$.fragment,e),n=!0)},o(e){he(t.$$.fragment,e),n=!1},d(e){Ce(t,e)}}}function Tt(e){let t,n,r=null!==e[0]&&xt(e);return{c(){t=_("wrapper"),r&&r.c()},m(e,i){k(e,t,i),r&&r.m(t,null),n=!0},p(e,[n]){null!==e[0]?r?(r.p(e,n),1&n&&ce(r,1)):(r=xt(e),r.c(),ce(r,1),r.m(t,null)):r&&(le(),he(r,1,1,(()=>{r=null})),ue())},i(e){n||(ce(r),n=!0)},o(e){he(r),n=!1},d(e){e&&x(t),r&&r.d()}}}function At(e,t,n){const r=q();let{state:i=null}=t;const a=e=>{r("choice:confirmed",{index:e.detail.index,choice:e.detail.choice})};return e.$$set=e=>{"state"in e&&n(0,i=e.state)},[i,r,a,e=>a(e),()=>r("story:continue")]}class Nt extends Se{constructor(e){super(),we(this,e,At,Tt,s,{state:0})}}function Ot(t){let n,r,i;return{c(){n=_("h3"),n.textContent="Why did you choose this?",r=A(),i=_("p"),i.textContent="Others will see this, so try to be convincing!"},m(e,t){k(e,n,t),k(e,r,t),k(e,i,t)},p:e,d(e){e&&x(n),e&&x(r),e&&x(i)}}}function Pt(e){let t,n,r,i,s,l,u,c,h,f,d,p,v,m,y,g,C,w;return l=new De({props:{$$slots:{default:[Ot]},$$scope:{ctx:e}}}),y=new mt({props:{opinions:e[0],showAgreeButton:!0}}),y.$on("opinion:agreed",e[6]),{c(){t=_("wrap"),n=_("p"),r=T("You chose: "),i=T(e[1]),s=A(),ye(l.$$.fragment),u=A(),c=_("textarea"),h=A(),f=_("button"),f.textContent="Submit",p=A(),v=_("p"),v.textContent="Or agree with another opinion!",m=A(),ye(y.$$.fragment),P(c,"type","text"),P(c,"maxlength",500),P(c,"class","svelte-1gm4r5v"),P(f,"class","svelte-1gm4r5v")},m(a,d){k(a,t,d),b(t,n),b(n,r),b(n,i),b(t,s),ge(l,t,null),b(t,u),b(t,c),W(c,e[3]),b(t,h),b(t,f),b(t,p),b(t,v),b(t,m),ge(y,t,null),g=!0,C||(w=[O(c,"input",e[5]),O(f,"click",(function(){o(e[4]("opinion:submitted",{choice:e[1],opinion:e[3]}))&&e[4]("opinion:submitted",{choice:e[1],opinion:e[3]}).apply(this,arguments)}))],C=!0)},p(t,[n]){e=t,(!g||2&n)&&F(i,e[1]);const r={};128&n&&(r.$$scope={dirty:n,ctx:e}),l.$set(r),8&n&&W(c,e[3]);const a={};1&n&&(a.opinions=e[0]),y.$set(a)},i(e){g||(ce(l.$$.fragment,e),Z((()=>{d||(d=pe(f,Le,{delay:0,duration:1e3},!0)),d.run(1)})),ce(y.$$.fragment,e),g=!0)},o(e){he(l.$$.fragment,e),d||(d=pe(f,Le,{delay:0,duration:1e3},!1)),d.run(0),he(y.$$.fragment,e),g=!1},d(e){e&&x(t),Ce(l),e&&d&&d.end(),Ce(y),C=!1,a(w)}}}function It(e,t,n){const r=q();let i="",{opinions:a=[]}=t,{choiceText:o=""}=t,{choiceIndex:s}=t;return e.$$set=e=>{"opinions"in e&&n(0,a=e.opinions),"choiceText"in e&&n(1,o=e.choiceText),"choiceIndex"in e&&n(2,s=e.choiceIndex)},[a,o,s,i,r,function(){i=this.value,n(3,i)},e=>{console.log(e),r("opinion:agreed",{opinion:e.detail.opinion,choiceText:o,choiceIndex:s})}]}class Ft extends Se{constructor(e){super(),we(this,e,It,Pt,s,{opinions:0,choiceText:1,choiceIndex:2})}}var Wt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Rt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Dt(e){var t={exports:{}};return e(t,t.exports),t.exports}var Lt=Dt((function(e,t){!function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&s(e,t)}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function u(e,t,n){return(u=l()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&s(i,n.prototype),i}).apply(null,arguments)}function c(e){var t="function"==typeof Map?new Map:void 0;return(c=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return u(e,arguments,o(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),s(r,e)})(e)}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function f(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return h(e)}function d(e){var t=l();return function(){var n,r=o(e);if(t){var i=o(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function p(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=o(e)););return e}function v(){return(v="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=p(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}}).apply(this,arguments)}function m(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a=[],o=!0,s=!1;try{for(n=n.call(e);!(o=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);o=!0);}catch(e){s=!0,i=e}finally{try{o||null==n.return||n.return()}finally{if(s)throw i}}return a}}(e,t)||g(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function y(e){return function(e){if(Array.isArray(e))return C(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||g(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function g(e,t){if(e){if("string"==typeof e)return C(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?C(e,t):void 0}}function C(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function b(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=g(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}var w,S=i((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;n(this,e),this.sourceFilename=t,this.pluginNames=r,this.countAllVisits=i,this.errorHandler=a,this.fileHandler=o})),k=i((function e(t,r,i){n(this,e),this.length=t,this.debugMetadata=r,this.text=i}));!function(e){e[e.Author=0]="Author",e[e.Warning=1]="Warning",e[e.Error=2]="Error"}(w||(w={}));var x=i((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;n(this,e),this.identifier=t,this.isByReference=r,this.isDivertTarget=i}));function E(e,t){return e instanceof t?O(e):null}function _(e,t){if(e instanceof t)return O(e);throw new Error("".concat(e," is not of type ").concat(t))}function T(e){return e.hasValidName&&e.name?e:null}function A(e){return void 0===e?null:e}function N(e){return"object"===t(e)&&"function"==typeof e.Equals}function O(e,t){return e}function P(e){return null!=e}var I,F=function(){function e(){var t=this;n(this,e),this._alreadyHadError=!1,this._alreadyHadWarning=!1,this._debugMetadata=null,this._runtimeObject=null,this.content=[],this.parent=null,this.GetType=function(){return t.typeName},this.AddContent=function(e){null===t.content&&(t.content=[]);var n,r=b(Array.isArray(e)?e:[e]);try{for(r.s();!(n=r.n()).done;){var i=n.value;i.hasOwnProperty("parent")&&(i.parent=t),t.content.push(i)}}catch(e){r.e(e)}finally{r.f()}return Array.isArray(e)?void 0:e},this.InsertContent=function(e,n){return null===t.content&&(t.content=[]),n.parent=t,t.content.splice(e,0,n),n},this.Find=function(e){return function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=E(t,e);if(null!==r&&(null===n||!0===n(r)))return r;if(null===t.content)return null;var i,a=b(t.content);try{for(a.s();!(i=a.n()).done;){var o=i.value,s=o.Find&&o.Find(e)(n);if(s)return s}}catch(e){a.e(e)}finally{a.f()}return null}},this.FindAll=function(e){return function(n,r){var i=Array.isArray(r)?r:[],a=E(t,e);if(null===a||n&&!0!==n(a)||i.push(a),null===t.content)return[];var o,s=b(t.content);try{for(s.s();!(o=s.n()).done;){var l=o.value;l.FindAll&&l.FindAll(e)(n,i)}}catch(e){s.e(e)}finally{s.f()}return i}},this.Warning=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t.Error(e,n,!0)}}return i(e,[{key:"debugMetadata",get:function(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata},set:function(e){this._debugMetadata=e}},{key:"hasOwnDebugMetadata",get:function(){return Boolean(this.debugMetadata)}},{key:"typeName",get:function(){return"ParsedObject"}},{key:"story",get:function(){for(var e=this;e.parent;)e=e.parent;return e}},{key:"runtimeObject",get:function(){return this._runtimeObject||(this._runtimeObject=this.GenerateRuntimeObject(),this._runtimeObject&&(this._runtimeObject.debugMetadata=this.debugMetadata)),this._runtimeObject},set:function(e){this._runtimeObject=e}},{key:"runtimePath",get:function(){if(!this.runtimeObject.path)throw new Error;return this.runtimeObject.path}},{key:"containerForCounting",get:function(){return this.runtimeObject}},{key:"ancestry",get:function(){for(var e=[],t=this.parent;t;)e.push(t),t=t.parent;return e.reverse()}},{key:"ResolveReferences",value:function(e){if(null!==this.content){var t,n=b(this.content);try{for(n.s();!(t=n.n()).done;)t.value.ResolveReferences(e)}catch(e){n.e(e)}finally{n.f()}}}},{key:"Error",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null===t&&(t=this),!(t._alreadyHadError&&!n||t._alreadyHadWarning&&n)){if(!this.parent)throw new Error("No parent object to send error to: ".concat(e));this.parent.Error(e,t,n),n?t._alreadyHadWarning=!0:t._alreadyHadError=!0}}))}]),e}(),W=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this)).warningMessage=e,i.GenerateRuntimeObject=function(){return i.Warning(i.warningMessage),null},i}return i(r,[{key:"typeName",get:function(){return"AuthorWarning"}}]),r}(F),R=function(){function e(){if(n(this,e),this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]){var t=arguments[0];this.componentsString=t}else if(arguments[0]instanceof e.Component&&arguments[1]instanceof e){var r=arguments[0],i=arguments[1];this._components.push(r),this._components=this._components.concat(i._components)}else if(arguments[0]instanceof Array){var a=arguments[0],o=!!arguments[1];this._components=this._components.concat(a),this._isRelative=o}}return i(e,[{key:"isRelative",get:function(){return this._isRelative}},{key:"componentCount",get:function(){return this._components.length}},{key:"head",get:function(){return this._components.length>0?this._components[0]:null}},{key:"tail",get:function(){return this._components.length>=2?new e(this._components.slice(1,this._components.length)):e.self}},{key:"length",get:function(){return this._components.length}},{key:"lastComponent",get:function(){var e=this._components.length-1;return e>=0?this._components[e]:null}},{key:"containsNamedComponent",get:function(){for(var e=0,t=this._components.length;e<t;e++)if(!this._components[e].isIndex)return!0;return!1}},{key:"GetComponent",value:function(e){return this._components[e]}},{key:"PathByAppendingPath",value:function(t){for(var n=new e,r=0,i=0;i<t._components.length&&t._components[i].isParent;++i)r++;for(var a=0;a<this._components.length-r;++a)n._components.push(this._components[a]);for(var o=r;o<t._components.length;++o)n._components.push(t._components[o]);return n}},{key:"componentsString",get:function(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString},set:function(t){if(this._components.length=0,this._componentsString=t,null!=this._componentsString&&""!=this._componentsString){"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));var n,r=b(this._componentsString.split("."));try{for(r.s();!(n=r.n()).done;){var i=n.value;/^(\-|\+)?([0-9]+|Infinity)$/.test(i)?this._components.push(new e.Component(parseInt(i))):this._components.push(new e.Component(i))}}catch(e){r.e(e)}finally{r.f()}}}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(e){if(null==e)return!1;if(e._components.length!=this._components.length)return!1;if(e.isRelative!=this.isRelative)return!1;for(var t=0,n=e._components.length;t<n;t++)if(!e._components[t].Equals(this._components[t]))return!1;return!0}},{key:"PathByAppendingComponent",value:function(t){var n,r=new e;return(n=r._components).push.apply(n,y(this._components)),r._components.push(t),r}}],[{key:"self",get:function(){var t=new e;return t._isRelative=!0,t}}]),e}();R.parentId="^",function(e){var t=function(){function t(e){n(this,t),this.index=-1,this.name=null,"string"==typeof e?this.name=e:this.index=e}return i(t,[{key:"isIndex",get:function(){return this.index>=0}},{key:"isParent",get:function(){return this.name==e.parentId}},{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(e){return null!=e&&e.isIndex==this.isIndex&&(this.isIndex?this.index==e.index:this.name==e.name)}}],[{key:"ToParent",value:function(){return new t(e.parentId)}}]),t}();e.Component=t}(R||(R={})),function(e){function t(e,t){if(!e)throw void 0!==t&&console.warn(t),console.trace&&console.trace(),new Error("")}e.AssertType=function(e,n,r){t(e instanceof n,r)},e.Assert=t}(I||(I={}));var D=function(e){a(r,e);var t=d(r);function r(){return n(this,r),t.apply(this,arguments)}return i(r)}(c(Error));function L(e){throw new D("".concat(e," is null or undefined"))}var j=function(){function e(){n(this,e),this.parent=null,this._debugMetadata=null,this._path=null}return i(e,[{key:"debugMetadata",get:function(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata},set:function(e){this._debugMetadata=e}},{key:"ownDebugMetadata",get:function(){return this._debugMetadata}},{key:"DebugLineNumberOfPath",value:function(e){if(null===e)return null;var t=this.rootContentContainer;if(t){var n=t.ContentAtPath(e).obj;if(n){var r=n.debugMetadata;if(null!==r)return r.startLineNumber}}return null}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new R;else{for(var e=[],t=this,n=E(t.parent,ee);null!==n;){var r=T(t);if(null!=r&&r.hasValidName){if(null===r.name)return L("namedChild.name");e.unshift(new R.Component(r.name))}else e.unshift(new R.Component(n.content.indexOf(t)));t=n,n=E(n.parent,ee)}this._path=new R(e)}return this._path}},{key:"ResolvePath",value:function(e){if(null===e)return L("path");if(e.isRelative){var t=E(this,ee);return null===t&&(I.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),t=E(this.parent,ee),I.Assert(null!==t,"Expected parent to be a container"),I.Assert(e.GetComponent(0).isParent),e=e.tail),null===t?L("nearestContainer"):t.ContentAtPath(e)}var n=this.rootContentContainer;return null===n?L("contentContainer"):n.ContentAtPath(e)}},{key:"ConvertPathToRelative",value:function(e){for(var t=this.path,n=Math.min(e.length,t.length),r=-1,i=0;i<n;++i){var a=t.GetComponent(i),o=e.GetComponent(i);if(!a.Equals(o))break;r=i}if(-1==r)return e;for(var s=t.componentCount-1-r,l=[],u=0;u<s;++u)l.push(R.Component.ToParent());for(var c=r+1;c<e.componentCount;++c)l.push(e.GetComponent(c));return new R(l,!0)}},{key:"CompactPathString",value:function(e){var t=null,n=null;return e.isRelative?(n=e.componentsString,t=this.path.PathByAppendingPath(e).componentsString):(n=this.ConvertPathToRelative(e).componentsString,t=e.componentsString),n.length<t.length?n:t}},{key:"rootContentContainer",get:function(){for(var e=this;e.parent;)e=e.parent;return E(e,ee)}},{key:"Copy",value:function(){throw Error("Not Implemented: Doesn't support copying")}},{key:"SetChild",value:function(e,t,n){e[t]&&(e[t]=null),e[t]=n,e[t]&&(e[t].parent=this)}},{key:"Equals",value:function(e){return e===this}}]),e}(),$=function(){function e(t){n(this,e),t=void 0!==t?t.toString():"",this.string=t}return i(e,[{key:"Length",get:function(){return this.string.length}},{key:"Append",value:function(e){null!==e&&(this.string+=e)}},{key:"AppendLine",value:function(e){void 0!==e&&this.Append(e),this.string+="\n"}},{key:"AppendFormat",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.string+=e.replace(/{(\d+)}/g,(function(e,t){return void 0!==n[t]?n[t]:e}))}},{key:"toString",value:function(){return this.string}}]),e}(),M=function(){function e(){if(n(this,e),this.originName=null,this.itemName=null,void 0!==arguments[1]){var t=arguments[0],r=arguments[1];this.originName=t,this.itemName=r}else if(arguments[0]){var i=arguments[0].toString().split(".");this.originName=i[0],this.itemName=i[1]}}return i(e,[{key:"isNull",get:function(){return null==this.originName&&null==this.itemName}},{key:"fullName",get:function(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}},{key:"toString",value:function(){return this.fullName}},{key:"Equals",value:function(t){if(t instanceof e){var n=t;return n.itemName==this.itemName&&n.originName==this.originName}return!1}},{key:"copy",value:function(){return new e(this.originName,this.itemName)}},{key:"serialized",value:function(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}}],[{key:"Null",get:function(){return new e(null,null)}},{key:"fromSerializedKey",value:function(t){var n=JSON.parse(t);if(!e.isLikeInkListItem(n))return e.Null;var r=n;return new e(r.originName,r.itemName)}},{key:"isLikeInkListItem",value:function(e){return!("object"!==t(e)||!e.hasOwnProperty("originName")||!e.hasOwnProperty("itemName")||"string"!=typeof e.originName&&null!==typeof e.originName||"string"!=typeof e.itemName&&null!==typeof e.itemName)}}]),e}(),V=function(e){a(o,e);var r=d(o);function o(){var e,i=arguments;if(n(this,o),(e=r.call(this,i[0]instanceof o?i[0]:[])).origins=null,e._originNames=[],arguments[0]instanceof o){var a=arguments[0];e._originNames=a.originNames,null!==a.origins&&(e.origins=a.origins.slice())}else if("string"==typeof arguments[0]){var s=arguments[0],l=arguments[1];if(e.SetInitialOriginName(s),null===l.listDefinitions)return f(e,L("originStory.listDefinitions"));var u=l.listDefinitions.TryListGetDefinition(s,null);if(!u.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+s);if(null===u.result)return f(e,L("def.result"));e.origins=[u.result]}else if("object"===t(arguments[0])&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){var c=arguments[0];e.Add(c.Key,c.Value)}return e}return i(o,[{key:"AddItem",value:function(e){if(e instanceof M){var t=e;if(null==t.originName)return void this.AddItem(t.itemName);if(null===this.origins)return L("this.origins");var n,r=b(this.origins);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(i.name==t.originName){var a=i.TryGetValueForItem(t,0);if(a.exists)return void this.Add(t,a.result);throw new Error("Could not add the item "+t+" to this list because it doesn't exist in the original list definition in ink.")}}}catch(e){r.e(e)}finally{r.f()}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}var o=e,s=null;if(null===this.origins)return L("this.origins");var l,u=b(this.origins);try{for(u.s();!(l=u.n()).done;){var c=l.value;if(null===o)return L("itemName");if(c.ContainsItemWithName(o)){if(null!=s)throw new Error("Could not add the item "+o+" to this list because it could come from either "+c.name+" or "+s.name);s=c}}}catch(e){u.e(e)}finally{u.f()}if(null==s)throw new Error("Could not add the item "+o+" to this list because it isn't known to any list definitions previously associated with this list.");var h=new M(s.name,o),f=s.ValueForItem(h);this.Add(h,f)}},{key:"ContainsItemNamed",value:function(e){var t,n=b(this);try{for(n.s();!(t=n.n()).done;){var r=m(t.value,1)[0];if(M.fromSerializedKey(r).itemName==e)return!0}}catch(e){n.e(e)}finally{n.f()}return!1}},{key:"ContainsKey",value:function(e){return this.has(e.serialized())}},{key:"Add",value:function(e,t){var n=e.serialized();if(this.has(n))throw new Error("The Map already contains an entry for ".concat(e));this.set(n,t)}},{key:"Remove",value:function(e){return this.delete(e.serialized())}},{key:"Count",get:function(){return this.size}},{key:"originOfMaxItem",get:function(){if(null==this.origins)return null;var e=this.maxItem.Key.originName,t=null;return this.origins.every((function(n){return n.name!=e||(t=n,!1)})),t}},{key:"originNames",get:function(){if(this.Count>0){null==this._originNames&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);var e,t=b(this);try{for(t.s();!(e=t.n()).done;){var n=m(e.value,1)[0],r=M.fromSerializedKey(n);if(null===r.originName)return L("item.originName");this._originNames.push(r.originName)}}catch(e){t.e(e)}finally{t.f()}}return this._originNames}},{key:"SetInitialOriginName",value:function(e){this._originNames=[e]}},{key:"SetInitialOriginNames",value:function(e){this._originNames=null==e?null:e.slice()}},{key:"maxItem",get:function(){var e,t={Key:M.Null,Value:0},n=b(this);try{for(n.s();!(e=n.n()).done;){var r=m(e.value,2),i=r[0],a=r[1],o=M.fromSerializedKey(i);(t.Key.isNull||a>t.Value)&&(t={Key:o,Value:a})}}catch(e){n.e(e)}finally{n.f()}return t}},{key:"minItem",get:function(){var e,t={Key:M.Null,Value:0},n=b(this);try{for(n.s();!(e=n.n()).done;){var r=m(e.value,2),i=r[0],a=r[1],o=M.fromSerializedKey(i);(t.Key.isNull||a<t.Value)&&(t={Key:o,Value:a})}}catch(e){n.e(e)}finally{n.f()}return t}},{key:"inverse",get:function(){var e=new o;if(null!=this.origins){var t,n=b(this.origins);try{for(n.s();!(t=n.n()).done;){var r,i=b(t.value.items);try{for(i.s();!(r=i.n()).done;){var a=m(r.value,2),s=a[0],l=a[1],u=M.fromSerializedKey(s);this.ContainsKey(u)||e.Add(u,l)}}catch(e){i.e(e)}finally{i.f()}}}catch(e){n.e(e)}finally{n.f()}}return e}},{key:"all",get:function(){var e=new o;if(null!=this.origins){var t,n=b(this.origins);try{for(n.s();!(t=n.n()).done;){var r,i=b(t.value.items);try{for(i.s();!(r=i.n()).done;){var a=m(r.value,2),s=a[0],l=a[1],u=M.fromSerializedKey(s);e.set(u.serialized(),l)}}catch(e){i.e(e)}finally{i.f()}}}catch(e){n.e(e)}finally{n.f()}}return e}},{key:"Union",value:function(e){var t,n=new o(this),r=b(e);try{for(r.s();!(t=r.n()).done;){var i=m(t.value,2),a=i[0],s=i[1];n.set(a,s)}}catch(e){r.e(e)}finally{r.f()}return n}},{key:"Intersect",value:function(e){var t,n=new o,r=b(this);try{for(r.s();!(t=r.n()).done;){var i=m(t.value,2),a=i[0],s=i[1];e.has(a)&&n.set(a,s)}}catch(e){r.e(e)}finally{r.f()}return n}},{key:"Without",value:function(e){var t,n=new o(this),r=b(e);try{for(r.s();!(t=r.n()).done;){var i=m(t.value,1)[0];n.delete(i)}}catch(e){r.e(e)}finally{r.f()}return n}},{key:"Contains",value:function(e){var t,n=b(e);try{for(n.s();!(t=n.n()).done;){var r=m(t.value,1)[0];if(!this.has(r))return!1}}catch(e){n.e(e)}finally{n.f()}return!0}},{key:"GreaterThan",value:function(e){return 0!=this.Count&&(0==e.Count||this.minItem.Value>e.maxItem.Value)}},{key:"GreaterThanOrEquals",value:function(e){return 0!=this.Count&&(0==e.Count||this.minItem.Value>=e.minItem.Value&&this.maxItem.Value>=e.maxItem.Value)}},{key:"LessThan",value:function(e){return 0!=e.Count&&(0==this.Count||this.maxItem.Value<e.minItem.Value)}},{key:"LessThanOrEquals",value:function(e){return 0!=e.Count&&(0==this.Count||this.maxItem.Value<=e.maxItem.Value&&this.minItem.Value<=e.minItem.Value)}},{key:"MaxAsList",value:function(){return this.Count>0?new o(this.maxItem):new o}},{key:"MinAsList",value:function(){return this.Count>0?new o(this.minItem):new o}},{key:"ListWithSubRange",value:function(e,t){if(0==this.Count)return new o;var n=this.orderedItems,r=0,i=Number.MAX_SAFE_INTEGER;Number.isInteger(e)?r=e:e instanceof o&&e.Count>0&&(r=e.minItem.Value),Number.isInteger(t)?i=t:e instanceof o&&e.Count>0&&(i=t.maxItem.Value);var a=new o;a.SetInitialOriginNames(this.originNames);var s,l=b(n);try{for(l.s();!(s=l.n()).done;){var u=s.value;u.Value>=r&&u.Value<=i&&a.Add(u.Key,u.Value)}}catch(e){l.e(e)}finally{l.f()}return a}},{key:"Equals",value:function(e){if(e instanceof o==0)return!1;if(e.Count!=this.Count)return!1;var t,n=b(this);try{for(n.s();!(t=n.n()).done;){var r=m(t.value,1)[0];if(!e.has(r))return!1}}catch(e){n.e(e)}finally{n.f()}return!0}},{key:"orderedItems",get:function(){var e,t=new Array,n=b(this);try{for(n.s();!(e=n.n()).done;){var r=m(e.value,2),i=r[0],a=r[1],o=M.fromSerializedKey(i);t.push({Key:o,Value:a})}}catch(e){n.e(e)}finally{n.f()}return t.sort((function(e,t){return null===e.Key.originName?L("x.Key.originName"):null===t.Key.originName?L("y.Key.originName"):e.Value==t.Value?e.Key.originName.localeCompare(t.Key.originName):e.Value<t.Value?-1:e.Value>t.Value?1:0})),t}},{key:"toString",value:function(){for(var e=this.orderedItems,t=new $,n=0;n<e.length;n++){n>0&&t.Append(", ");var r=e[n].Key;if(null===r.itemName)return L("item.itemName");t.Append(r.itemName)}return t.toString()}},{key:"valueOf",value:function(){return NaN}}],[{key:"FromString",value:function(e,t){var n,r=null===(n=t.listDefinitions)||void 0===n?void 0:n.FindSingleItemListWithName(e);if(r)return null===r.value?L("listValue.value"):new o(r.value);throw new Error("Could not find the InkListItem from the string '"+e+"' to create an InkList because it doesn't exist in the original list definition in ink.")}}]),o}(c(Map)),B=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this,e)).useEndLineNumber=!1,i.message=e,i.name="StoryException",i}return i(r)}(c(Error));function G(e,t,n){if(null===e)return{result:n,exists:!1};var r=e.get(t);return void 0===r?{result:n,exists:!1}:{result:r,exists:!0}}var q,H=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this)).value=e,i}return i(r,[{key:"valueObject",get:function(){return this.value}},{key:"toString",value:function(){return null===this.value?L("Value.value"):this.value.toString()}}]),r}(function(e){a(r,e);var t=d(r);function r(){return n(this,r),t.apply(this,arguments)}return i(r,[{key:"Copy",value:function(){return _(r.Create(this.valueObject),j)}},{key:"BadCastException",value:function(e){return new B("Can't cast "+this.valueObject+" from "+this.valueType+" to "+e)}}],[{key:"Create",value:function(e,t){if(t){if(t===q.Int&&Number.isInteger(Number(e)))return new K(Number(e));if(t===q.Float&&!isNaN(e))return new z(Number(e))}return"boolean"==typeof e?new U(Boolean(e)):"string"==typeof e?new J(String(e)):Number.isInteger(Number(e))?new K(Number(e)):isNaN(e)?e instanceof R?new Y(_(e,R)):e instanceof V?new Z(_(e,V)):null:new z(Number(e))}}]),r}(j)),U=function(e){a(r,e);var t=d(r);function r(e){return n(this,r),t.call(this,e||!1)}return i(r,[{key:"isTruthy",get:function(){return Boolean(this.value)}},{key:"valueType",get:function(){return q.Bool}},{key:"Cast",value:function(e){if(null===this.value)return L("Value.value");if(e==this.valueType)return this;if(e==q.Int)return new K(this.value?1:0);if(e==q.Float)return new z(this.value?1:0);if(e==q.String)return new J(this.value?"true":"false");throw this.BadCastException(e)}},{key:"toString",value:function(){return this.value?"true":"false"}}]),r}(H),K=function(e){a(r,e);var t=d(r);function r(e){return n(this,r),t.call(this,e||0)}return i(r,[{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return q.Int}},{key:"Cast",value:function(e){if(null===this.value)return L("Value.value");if(e==this.valueType)return this;if(e==q.Bool)return new U(0!==this.value);if(e==q.Float)return new z(this.value);if(e==q.String)return new J(""+this.value);throw this.BadCastException(e)}}]),r}(H),z=function(e){a(r,e);var t=d(r);function r(e){return n(this,r),t.call(this,e||0)}return i(r,[{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return q.Float}},{key:"Cast",value:function(e){if(null===this.value)return L("Value.value");if(e==this.valueType)return this;if(e==q.Bool)return new U(0!==this.value);if(e==q.Int)return new K(this.value);if(e==q.String)return new J(""+this.value);throw this.BadCastException(e)}}]),r}(H),J=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this,e||""))._isNewline="\n"==i.value,i._isInlineWhitespace=!0,null===i.value?f(i,L("Value.value")):(i.value.length>0&&i.value.split("").every((function(e){return" "==e||"\t"==e||(i._isInlineWhitespace=!1,!1)})),i)}return i(r,[{key:"valueType",get:function(){return q.String}},{key:"isTruthy",get:function(){return null===this.value?L("Value.value"):this.value.length>0}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}},{key:"Cast",value:function(e){if(e==this.valueType)return this;if(e==q.Int){var t=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=parseInt(e);return Number.isNaN(n)?{result:t,exists:!1}:{result:n,exists:!0}}(this.value);if(t.exists)return new K(t.result);throw this.BadCastException(e)}if(e==q.Float){var n=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=parseFloat(e);return Number.isNaN(n)?{result:t,exists:!1}:{result:n,exists:!0}}(this.value);if(n.exists)return new z(n.result);throw this.BadCastException(e)}throw this.BadCastException(e)}}]),r}(H),Y=function(e){a(r,e);var t=d(r);function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return n(this,r),t.call(this,e)}return i(r,[{key:"valueType",get:function(){return q.DivertTarget}},{key:"targetPath",get:function(){return null===this.value?L("Value.value"):this.value},set:function(e){this.value=e}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a divert target")}},{key:"Cast",value:function(e){if(e==this.valueType)return this;throw this.BadCastException(e)}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}}]),r}(H),X=function(e){a(r,e);var t=d(r);function r(e){var i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;return n(this,r),(i=t.call(this,e))._contextIndex=a,i}return i(r,[{key:"contextIndex",get:function(){return this._contextIndex},set:function(e){this._contextIndex=e}},{key:"variableName",get:function(){return null===this.value?L("Value.value"):this.value},set:function(e){this.value=e}},{key:"valueType",get:function(){return q.VariablePointer}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}},{key:"Cast",value:function(e){if(e==this.valueType)return this;throw this.BadCastException(e)}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new r(this.variableName,this.contextIndex)}}]),r}(H),Z=function(e){a(r,e);var t=d(r);function r(e,i){var a;return n(this,r),a=t.call(this,null),e||i?e instanceof V?a.value=new V(e):e instanceof M&&"number"==typeof i&&(a.value=new V({Key:e,Value:i})):a.value=new V,a}return i(r,[{key:"isTruthy",get:function(){return null===this.value?L("this.value"):this.value.Count>0}},{key:"valueType",get:function(){return q.List}},{key:"Cast",value:function(e){if(null===this.value)return L("Value.value");if(e==q.Int){var t=this.value.maxItem;return t.Key.isNull?new K(0):new K(t.Value)}if(e==q.Float){var n=this.value.maxItem;return n.Key.isNull?new z(0):new z(n.Value)}if(e==q.String){var r=this.value.maxItem;return r.Key.isNull?new J(""):new J(r.Key.toString())}if(e==this.valueType)return this;throw this.BadCastException(e)}}],[{key:"RetainListOriginsForAssignment",value:function(e,t){var n=E(e,r),i=E(t,r);return i&&null===i.value?L("newList.value"):n&&null===n.value?L("oldList.value"):void(n&&i&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames))}}]),r}(H);!function(e){e[e.Bool=-1]="Bool",e[e.Int=0]="Int",e[e.Float=1]="Float",e[e.List=2]="List",e[e.String=3]="String",e[e.DivertTarget=4]="DivertTarget",e[e.VariablePointer=5]="VariablePointer"}(q||(q={}));var Q=function(){function e(){n(this,e),this.obj=null,this.approximate=!1}return i(e,[{key:"correctObj",get:function(){return this.approximate?null:this.obj}},{key:"container",get:function(){return this.obj instanceof ee?this.obj:null}},{key:"copy",value:function(){var t=new e;return t.obj=this.obj,t.approximate=this.approximate,t}}]),e}(),ee=function(e){a(r,e);var t=d(r);function r(){var e;return n(this,r),(e=t.apply(this,arguments)).name=null,e._content=[],e.namedContent=new Map,e.visitsShouldBeCounted=!1,e.turnIndexShouldBeCounted=!1,e.countingAtStartOnly=!1,e._pathToFirstLeafContent=null,e}return i(r,[{key:"hasValidName",get:function(){return null!=this.name&&this.name.length>0}},{key:"content",get:function(){return this._content},set:function(e){this.AddContent(e)}},{key:"namedOnlyContent",get:function(){var e,t=new Map,n=b(this.namedContent);try{for(n.s();!(e=n.n()).done;){var r=m(e.value,2),i=r[0],a=_(r[1],j);t.set(i,a)}}catch(e){n.e(e)}finally{n.f()}var o,s=b(this.content);try{for(s.s();!(o=s.n()).done;){var l=T(o.value);null!=l&&l.hasValidName&&t.delete(l.name)}}catch(e){s.e(e)}finally{s.f()}return 0==t.size&&(t=null),t},set:function(e){var t=this.namedOnlyContent;if(null!=t){var n,r=b(t);try{for(r.s();!(n=r.n()).done;){var i=m(n.value,1)[0];this.namedContent.delete(i)}}catch(e){r.e(e)}finally{r.f()}}if(null!=e){var a,o=b(e);try{for(o.s();!(a=o.n()).done;){var s=T(m(a.value,2)[1]);null!=s&&this.AddToNamedContentOnly(s)}}catch(e){o.e(e)}finally{o.f()}}}},{key:"countFlags",get:function(){var e=0;return this.visitsShouldBeCounted&&(e|=r.CountFlags.Visits),this.turnIndexShouldBeCounted&&(e|=r.CountFlags.Turns),this.countingAtStartOnly&&(e|=r.CountFlags.CountStartOnly),e==r.CountFlags.CountStartOnly&&(e=0),e},set:function(e){var t=e;(t&r.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(t&r.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(t&r.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var e=[],t=this;t instanceof r;)t.content.length>0&&(e.push(new R.Component(0)),t=t.content[0]);return new R(e)}},{key:"AddContent",value:function(e){if(e instanceof Array){var t,n=b(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;this.AddContent(r)}}catch(e){n.e(e)}finally{n.f()}}else{var i=e;if(this._content.push(i),i.parent)throw new Error("content is already in "+i.parent);i.parent=this,this.TryAddNamedContent(i)}}},{key:"TryAddNamedContent",value:function(e){var t=T(e);null!=t&&t.hasValidName&&this.AddToNamedContentOnly(t)}},{key:"AddToNamedContentOnly",value:function(e){if(I.AssertType(e,j,"Can only add Runtime.Objects to a Runtime.Container"),_(e,j).parent=this,null===e.name)return L("namedContentObj.name");this.namedContent.set(e.name,e)}},{key:"ContentAtPath",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;-1==n&&(n=e.length);var i=new Q;i.approximate=!1;for(var a=this,o=this,s=t;s<n;++s){var l=e.GetComponent(s);if(null==a){i.approximate=!0;break}var u=a.ContentWithPathComponent(l);if(null==u){i.approximate=!0;break}o=u,a=E(u,r)}return i.obj=o,i}},{key:"InsertContent",value:function(e,t){if(this.content.splice(t,0,e),e.parent)throw new Error("content is already in "+e.parent);e.parent=this,this.TryAddNamedContent(e)}},{key:"AddContentsOfContainer",value:function(e){var t;(t=this.content).push.apply(t,y(e.content));var n,r=b(e.content);try{for(r.s();!(n=r.n()).done;){var i=n.value;i.parent=this,this.TryAddNamedContent(i)}}catch(e){r.e(e)}finally{r.f()}}},{key:"ContentWithPathComponent",value:function(e){if(e.isIndex)return e.index>=0&&e.index<this.content.length?this.content[e.index]:null;if(e.isParent)return this.parent;if(null===e.name)return L("component.name");var t=G(this.namedContent,e.name,null);return t.exists?_(t.result,j):null}},{key:"BuildStringOfHierarchy",value:function(){var e;if(0==arguments.length)return e=new $,this.BuildStringOfHierarchy(e,0,null),e.toString();e=arguments[0];var t=arguments[1],n=arguments[2];function i(){for(var n=0;n<4*t;++n)e.Append(" ")}i(),e.Append("["),this.hasValidName&&e.AppendFormat(" ({0})",this.name),this==n&&e.Append("  <---"),e.AppendLine(),t++;for(var a=0;a<this.content.length;++a){var o=this.content[a];o instanceof r?o.BuildStringOfHierarchy(e,t,n):(i(),o instanceof J?(e.Append('"'),e.Append(o.toString().replace("\n","\\n")),e.Append('"')):e.Append(o.toString())),a!=this.content.length-1&&e.Append(","),o instanceof r||o!=n||e.Append("  <---"),e.AppendLine()}var s,l=new Map,u=b(this.namedContent);try{for(u.s();!(s=u.n()).done;){var c=m(s.value,2),h=c[0],f=c[1];this.content.indexOf(_(f,j))>=0||l.set(h,f)}}catch(e){u.e(e)}finally{u.f()}if(l.size>0){i(),e.AppendLine("-- named: --");var d,p=b(l);try{for(p.s();!(d=p.n()).done;){var v=m(d.value,2)[1];I.AssertType(v,r,"Can only print out named Containers"),v.BuildStringOfHierarchy(e,t,n),e.AppendLine()}}catch(e){p.e(e)}finally{p.f()}}t--,i(),e.Append("]")}}]),r}(j);!function(e){var t;(t=e.CountFlags||(e.CountFlags={}))[t.Visits=1]="Visits",t[t.Turns=2]="Turns",t[t.CountStartOnly=4]="CountStartOnly"}(ee||(ee={}));var te=function(e){a(r,e);var t=d(r);function r(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:r.CommandType.NotSet;return n(this,r),(e=t.call(this))._commandType=i,e}return i(r,[{key:"commandType",get:function(){return this._commandType}},{key:"Copy",value:function(){return new r(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}}],[{key:"EvalStart",value:function(){return new r(r.CommandType.EvalStart)}},{key:"EvalOutput",value:function(){return new r(r.CommandType.EvalOutput)}},{key:"EvalEnd",value:function(){return new r(r.CommandType.EvalEnd)}},{key:"Duplicate",value:function(){return new r(r.CommandType.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new r(r.CommandType.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new r(r.CommandType.PopFunction)}},{key:"PopTunnel",value:function(){return new r(r.CommandType.PopTunnel)}},{key:"BeginString",value:function(){return new r(r.CommandType.BeginString)}},{key:"EndString",value:function(){return new r(r.CommandType.EndString)}},{key:"NoOp",value:function(){return new r(r.CommandType.NoOp)}},{key:"ChoiceCount",value:function(){return new r(r.CommandType.ChoiceCount)}},{key:"Turns",value:function(){return new r(r.CommandType.Turns)}},{key:"TurnsSince",value:function(){return new r(r.CommandType.TurnsSince)}},{key:"ReadCount",value:function(){return new r(r.CommandType.ReadCount)}},{key:"Random",value:function(){return new r(r.CommandType.Random)}},{key:"SeedRandom",value:function(){return new r(r.CommandType.SeedRandom)}},{key:"VisitIndex",value:function(){return new r(r.CommandType.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new r(r.CommandType.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new r(r.CommandType.StartThread)}},{key:"Done",value:function(){return new r(r.CommandType.Done)}},{key:"End",value:function(){return new r(r.CommandType.End)}},{key:"ListFromInt",value:function(){return new r(r.CommandType.ListFromInt)}},{key:"ListRange",value:function(){return new r(r.CommandType.ListRange)}},{key:"ListRandom",value:function(){return new r(r.CommandType.ListRandom)}}]),r}(j);!function(e){var t;(t=e.CommandType||(e.CommandType={}))[t.NotSet=-1]="NotSet",t[t.EvalStart=0]="EvalStart",t[t.EvalOutput=1]="EvalOutput",t[t.EvalEnd=2]="EvalEnd",t[t.Duplicate=3]="Duplicate",t[t.PopEvaluatedValue=4]="PopEvaluatedValue",t[t.PopFunction=5]="PopFunction",t[t.PopTunnel=6]="PopTunnel",t[t.BeginString=7]="BeginString",t[t.EndString=8]="EndString",t[t.NoOp=9]="NoOp",t[t.ChoiceCount=10]="ChoiceCount",t[t.Turns=11]="Turns",t[t.TurnsSince=12]="TurnsSince",t[t.Random=13]="Random",t[t.SeedRandom=14]="SeedRandom",t[t.VisitIndex=15]="VisitIndex",t[t.SequenceShuffleIndex=16]="SequenceShuffleIndex",t[t.StartThread=17]="StartThread",t[t.Done=18]="Done",t[t.End=19]="End",t[t.ListFromInt=20]="ListFromInt",t[t.ListRange=21]="ListRange",t[t.ListRandom=22]="ListRandom",t[t.ReadCount=23]="ReadCount",t[t.TOTAL_VALUES=24]="TOTAL_VALUES"}(te||(te={}));var ne=function(e){a(r,e);var t=d(r);function r(){var e;return n(this,r),(e=t.apply(this,arguments))._prototypeRuntimeConstantExpression=null,e.outputWhenComplete=!1,e.GenerateRuntimeObject=function(){var t=new ee;return t.AddContent(te.EvalStart()),e.GenerateIntoContainer(t),e.outputWhenComplete&&t.AddContent(te.EvalOutput()),t.AddContent(te.EvalEnd()),t},e.GenerateConstantIntoContainer=function(t){null===e._prototypeRuntimeConstantExpression&&(e._prototypeRuntimeConstantExpression=new ee,e.GenerateIntoContainer(e._prototypeRuntimeConstantExpression));var n,r=b(e._prototypeRuntimeConstantExpression.content);try{for(r.s();!(n=r.n()).done;){var i=n.value.Copy();i&&t.AddContent(i)}}catch(e){r.e(e)}finally{r.f()}},e.toString=function(){return"No string value in JavaScript."},e}return i(r,[{key:"typeName",get:function(){return"Expression"}},{key:"Equals",value:function(e){return!1}}]),r}(F),re=function(e){a(r,e);var t=d(r);function r(){return n(this,r),t.apply(this,arguments)}return i(r)}(j),ie=function(e){a(r,e);var t=d(r);function r(){var e;if(n(this,r),(e=t.call(this))._name=null,e._numberOfParameters=0,e._prototype=null,e._isPrototype=!1,e._operationFuncs=null,0===arguments.length)r.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){var i=arguments[0];r.GenerateNativeFunctionsIfNecessary(),e.name=i}else if(2===arguments.length){var a=arguments[0],o=arguments[1];e._isPrototype=!0,e.name=a,e.numberOfParameters=o}return e}return i(r,[{key:"name",get:function(){return null===this._name?L("NativeFunctionCall._name"):this._name},set:function(e){this._name=e,this._isPrototype||(null===r._nativeFunctions?L("NativeFunctionCall._nativeFunctions"):this._prototype=r._nativeFunctions.get(this._name)||null)}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(e){this._numberOfParameters=e}},{key:"Call",value:function(e){if(this._prototype)return this._prototype.Call(e);if(this.numberOfParameters!=e.length)throw new Error("Unexpected number of parameters");var t,n=!1,r=b(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(i instanceof re)throw new B('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');i instanceof Z&&(n=!0)}}catch(e){r.e(e)}finally{r.f()}if(2==e.length&&n)return this.CallBinaryListOperation(e);var a=this.CoerceValuesToSingleType(e),o=a[0].valueType;return o==q.Int||o==q.Float||o==q.String||o==q.DivertTarget||o==q.List?this.CallType(a):null}},{key:"CallType",value:function(e){var t=_(e[0],H),n=t.valueType,i=t,a=e.length;if(2==a||1==a){if(null===this._operationFuncs)return L("NativeFunctionCall._operationFuncs");var o=this._operationFuncs.get(n);if(!o){var s=q[n];throw new B("Cannot perform operation "+this.name+" on "+s)}if(2==a){var l=_(e[1],H),u=o;if(null===i.value||null===l.value)return L("NativeFunctionCall.Call BinaryOp values");var c=u(i.value,l.value);return H.Create(c)}var h=o;if(null===i.value)return L("NativeFunctionCall.Call UnaryOp value");var f=h(i.value);return this.name===r.Int?H.Create(f,q.Int):this.name===r.Float?H.Create(f,q.Float):H.Create(f,t.valueType)}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+e.length)}},{key:"CallBinaryListOperation",value:function(e){if(("+"==this.name||"-"==this.name)&&e[0]instanceof Z&&e[1]instanceof K)return this.CallListIncrementOperation(e);var t=_(e[0],H),n=_(e[1],H);if(!("&&"!=this.name&&"||"!=this.name||t.valueType==q.List&&n.valueType==q.List)){if(null===this._operationFuncs)return L("NativeFunctionCall._operationFuncs");var r=this._operationFuncs.get(q.Int);if(null===r)return L("NativeFunctionCall.CallBinaryListOperation op");var i=function(e){if("boolean"==typeof e)return e;throw new Error("".concat(e," is not a boolean"))}(r(t.isTruthy?1:0,n.isTruthy?1:0));return new U(i)}if(t.valueType==q.List&&n.valueType==q.List)return this.CallType([t,n]);throw new B("Can not call use "+this.name+" operation on "+q[t.valueType]+" and "+q[n.valueType])}},{key:"CallListIncrementOperation",value:function(e){var t=_(e[0],Z),n=_(e[1],K),r=new V;if(null===t.value)return L("NativeFunctionCall.CallListIncrementOperation listVal.value");var i,a=b(t.value);try{for(a.s();!(i=a.n()).done;){var o=m(i.value,2),s=o[0],l=o[1],u=M.fromSerializedKey(s);if(null===this._operationFuncs)return L("NativeFunctionCall._operationFuncs");var c=this._operationFuncs.get(q.Int);if(null===n.value)return L("NativeFunctionCall.CallListIncrementOperation intVal.value");var h=c(l,n.value),f=null;if(null===t.value.origins)return L("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");var d,p=b(t.value.origins);try{for(p.s();!(d=p.n()).done;){var v=d.value;if(v.name==u.originName){f=v;break}}}catch(e){p.e(e)}finally{p.f()}if(null!=f){var y=f.TryGetItemWithValue(h,M.Null);y.exists&&r.Add(y.result,h)}}}catch(e){a.e(e)}finally{a.f()}return new Z(r)}},{key:"CoerceValuesToSingleType",value:function(e){var t,n=q.Int,r=null,i=b(e);try{for(i.s();!(t=i.n()).done;){var a=_(t.value,H);a.valueType>n&&(n=a.valueType),a.valueType==q.List&&(r=E(a,Z))}}catch(e){i.e(e)}finally{i.f()}var o=[];if(q[n]==q[q.List]){var s,l=b(e);try{for(l.s();!(s=l.n()).done;){var u=_(s.value,H);if(u.valueType==q.List)o.push(u);else{if(u.valueType!=q.Int){var c=q[u.valueType];throw new B("Cannot mix Lists and "+c+" values in this operation")}var h=parseInt(u.valueObject);if(null===(r=_(r,Z)).value)return L("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");var f=r.value.originOfMaxItem;if(null===f)return L("NativeFunctionCall.CoerceValuesToSingleType list");var d=f.TryGetItemWithValue(h,M.Null);if(!d.exists)throw new B("Could not find List item with the value "+h+" in "+f.name);var p=new Z(d.result,h);o.push(p)}}}catch(e){l.e(e)}finally{l.f()}}else{var v,m=b(e);try{for(m.s();!(v=m.n()).done;){var y=_(v.value,H).Cast(n);o.push(y)}}catch(e){m.e(e)}finally{m.f()}}return o}},{key:"AddOpFuncForType",value:function(e,t){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(e,t)}},{key:"toString",value:function(){return'Native "'+this.name+'"'}}],[{key:"CallWithName",value:function(e){return new r(e)}},{key:"CallExistsWithName",value:function(e){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(e)}},{key:"Identity",value:function(e){return e}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){null==this._nativeFunctions&&(this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,(function(e,t){return e+t})),this.AddIntBinaryOp(this.Subtract,(function(e,t){return e-t})),this.AddIntBinaryOp(this.Multiply,(function(e,t){return e*t})),this.AddIntBinaryOp(this.Divide,(function(e,t){return Math.floor(e/t)})),this.AddIntBinaryOp(this.Mod,(function(e,t){return e%t})),this.AddIntUnaryOp(this.Negate,(function(e){return-e})),this.AddIntBinaryOp(this.Equal,(function(e,t){return e==t})),this.AddIntBinaryOp(this.Greater,(function(e,t){return e>t})),this.AddIntBinaryOp(this.Less,(function(e,t){return e<t})),this.AddIntBinaryOp(this.GreaterThanOrEquals,(function(e,t){return e>=t})),this.AddIntBinaryOp(this.LessThanOrEquals,(function(e,t){return e<=t})),this.AddIntBinaryOp(this.NotEquals,(function(e,t){return e!=t})),this.AddIntUnaryOp(this.Not,(function(e){return 0==e})),this.AddIntBinaryOp(this.And,(function(e,t){return 0!=e&&0!=t})),this.AddIntBinaryOp(this.Or,(function(e,t){return 0!=e||0!=t})),this.AddIntBinaryOp(this.Max,(function(e,t){return Math.max(e,t)})),this.AddIntBinaryOp(this.Min,(function(e,t){return Math.min(e,t)})),this.AddIntBinaryOp(this.Pow,(function(e,t){return Math.pow(e,t)})),this.AddIntUnaryOp(this.Floor,r.Identity),this.AddIntUnaryOp(this.Ceiling,r.Identity),this.AddIntUnaryOp(this.Int,r.Identity),this.AddIntUnaryOp(this.Float,(function(e){return e})),this.AddFloatBinaryOp(this.Add,(function(e,t){return e+t})),this.AddFloatBinaryOp(this.Subtract,(function(e,t){return e-t})),this.AddFloatBinaryOp(this.Multiply,(function(e,t){return e*t})),this.AddFloatBinaryOp(this.Divide,(function(e,t){return e/t})),this.AddFloatBinaryOp(this.Mod,(function(e,t){return e%t})),this.AddFloatUnaryOp(this.Negate,(function(e){return-e})),this.AddFloatBinaryOp(this.Equal,(function(e,t){return e==t})),this.AddFloatBinaryOp(this.Greater,(function(e,t){return e>t})),this.AddFloatBinaryOp(this.Less,(function(e,t){return e<t})),this.AddFloatBinaryOp(this.GreaterThanOrEquals,(function(e,t){return e>=t})),this.AddFloatBinaryOp(this.LessThanOrEquals,(function(e,t){return e<=t})),this.AddFloatBinaryOp(this.NotEquals,(function(e,t){return e!=t})),this.AddFloatUnaryOp(this.Not,(function(e){return 0==e})),this.AddFloatBinaryOp(this.And,(function(e,t){return 0!=e&&0!=t})),this.AddFloatBinaryOp(this.Or,(function(e,t){return 0!=e||0!=t})),this.AddFloatBinaryOp(this.Max,(function(e,t){return Math.max(e,t)})),this.AddFloatBinaryOp(this.Min,(function(e,t){return Math.min(e,t)})),this.AddFloatBinaryOp(this.Pow,(function(e,t){return Math.pow(e,t)})),this.AddFloatUnaryOp(this.Floor,(function(e){return Math.floor(e)})),this.AddFloatUnaryOp(this.Ceiling,(function(e){return Math.ceil(e)})),this.AddFloatUnaryOp(this.Int,(function(e){return Math.floor(e)})),this.AddFloatUnaryOp(this.Float,r.Identity),this.AddStringBinaryOp(this.Add,(function(e,t){return e+t})),this.AddStringBinaryOp(this.Equal,(function(e,t){return e===t})),this.AddStringBinaryOp(this.NotEquals,(function(e,t){return!(e===t)})),this.AddStringBinaryOp(this.Has,(function(e,t){return e.includes(t)})),this.AddStringBinaryOp(this.Hasnt,(function(e,t){return!e.includes(t)})),this.AddListBinaryOp(this.Add,(function(e,t){return e.Union(t)})),this.AddListBinaryOp(this.Subtract,(function(e,t){return e.Without(t)})),this.AddListBinaryOp(this.Has,(function(e,t){return e.Contains(t)})),this.AddListBinaryOp(this.Hasnt,(function(e,t){return!e.Contains(t)})),this.AddListBinaryOp(this.Intersect,(function(e,t){return e.Intersect(t)})),this.AddListBinaryOp(this.Equal,(function(e,t){return e.Equals(t)})),this.AddListBinaryOp(this.Greater,(function(e,t){return e.GreaterThan(t)})),this.AddListBinaryOp(this.Less,(function(e,t){return e.LessThan(t)})),this.AddListBinaryOp(this.GreaterThanOrEquals,(function(e,t){return e.GreaterThanOrEquals(t)})),this.AddListBinaryOp(this.LessThanOrEquals,(function(e,t){return e.LessThanOrEquals(t)})),this.AddListBinaryOp(this.NotEquals,(function(e,t){return!e.Equals(t)})),this.AddListBinaryOp(this.And,(function(e,t){return e.Count>0&&t.Count>0})),this.AddListBinaryOp(this.Or,(function(e,t){return e.Count>0||t.Count>0})),this.AddListUnaryOp(this.Not,(function(e){return 0==e.Count?1:0})),this.AddListUnaryOp(this.Invert,(function(e){return e.inverse})),this.AddListUnaryOp(this.All,(function(e){return e.all})),this.AddListUnaryOp(this.ListMin,(function(e){return e.MinAsList()})),this.AddListUnaryOp(this.ListMax,(function(e){return e.MaxAsList()})),this.AddListUnaryOp(this.Count,(function(e){return e.Count})),this.AddListUnaryOp(this.ValueOfList,(function(e){return e.maxItem.Value})),this.AddOpToNativeFunc(this.Equal,2,q.DivertTarget,(function(e,t){return e.Equals(t)})),this.AddOpToNativeFunc(this.NotEquals,2,q.DivertTarget,(function(e,t){return!e.Equals(t)})))}},{key:"AddOpToNativeFunc",value:function(e,t,n,i){if(null===this._nativeFunctions)return L("NativeFunctionCall._nativeFunctions");var a=this._nativeFunctions.get(e);a||(a=new r(e,t),this._nativeFunctions.set(e,a)),a.AddOpFuncForType(n,i)}},{key:"AddIntBinaryOp",value:function(e,t){this.AddOpToNativeFunc(e,2,q.Int,t)}},{key:"AddIntUnaryOp",value:function(e,t){this.AddOpToNativeFunc(e,1,q.Int,t)}},{key:"AddFloatBinaryOp",value:function(e,t){this.AddOpToNativeFunc(e,2,q.Float,t)}},{key:"AddFloatUnaryOp",value:function(e,t){this.AddOpToNativeFunc(e,1,q.Float,t)}},{key:"AddStringBinaryOp",value:function(e,t){this.AddOpToNativeFunc(e,2,q.String,t)}},{key:"AddListBinaryOp",value:function(e,t){this.AddOpToNativeFunc(e,2,q.List,t)}},{key:"AddListUnaryOp",value:function(e,t){this.AddOpToNativeFunc(e,1,q.List,t)}}]),r}(j);ie.Add="+",ie.Subtract="-",ie.Divide="/",ie.Multiply="*",ie.Mod="%",ie.Negate="_",ie.Equal="==",ie.Greater=">",ie.Less="<",ie.GreaterThanOrEquals=">=",ie.LessThanOrEquals="<=",ie.NotEquals="!=",ie.Not="!",ie.And="&&",ie.Or="||",ie.Min="MIN",ie.Max="MAX",ie.Pow="POW",ie.Floor="FLOOR",ie.Ceiling="CEILING",ie.Int="INT",ie.Float="FLOAT",ie.Has="?",ie.Hasnt="!?",ie.Intersect="^",ie.ListMin="LIST_MIN",ie.ListMax="LIST_MAX",ie.All="LIST_ALL",ie.Count="LIST_COUNT",ie.ValueOfList="LIST_VALUE",ie.Invert="LIST_INVERT",ie._nativeFunctions=null;var ae=function(e){a(r,e);var t=d(r);function r(e,i){var a;if(n(this,r),(a=t.call(this)).isInt=function(){return"int"==a.subtype},a.isFloat=function(){return"float"==a.subtype},a.isBool=function(){return"bool"==a.subtype},a.GenerateIntoContainer=function(e){a.isInt()?e.AddContent(new K(a.value)):a.isFloat()?e.AddContent(new z(a.value)):a.isBool()&&e.AddContent(new U(a.value))},a.toString=function(){return String(a.value)},("number"!=typeof e||Number.isNaN(e))&&"boolean"!=typeof e)throw new Error("Unexpected object type in NumberExpression.");return a.value=e,a.subtype=i,a}return i(r,[{key:"typeName",get:function(){return"Number"}},{key:"Equals",value:function(e){var t=E(e,r);return!!t&&t.subtype==this.subtype&&t.value==this.value}}]),r}(ne),oe=function(e){a(r,e);var t=d(r);function r(e,i){var a;return n(this,r),(a=t.call(this)).op=i,a.GenerateIntoContainer=function(e){a.innerExpression.GenerateIntoContainer(e),e.AddContent(ie.CallWithName(a.nativeNameForOp))},a.toString=function(){return a.nativeNameForOp+a.innerExpression},a.innerExpression=a.AddContent(e),a}return i(r,[{key:"nativeNameForOp",get:function(){return"-"===this.op?"_":"not"===this.op?"!":this.op}},{key:"typeName",get:function(){return"UnaryExpression"}}]),r}(ne);oe.WithInner=function(e,t){var n=E(e,ae);if(n){if("-"===t){if(n.isInt())return new ae(-n.value,"int");if(n.isFloat())return new ae(-n.value,"float")}else if("!"==t||"not"==t){if(n.isInt())return new ae(0==n.value,"bool");if(n.isFloat())return new ae(0==n.value,"bool");if(n.isBool())return new ae(!n.value,"bool")}throw new Error("Unexpected operation or number type")}return new oe(e,t)};var se=function(e){a(r,e);var t=d(r);function r(e,i,a){var o;return n(this,r),(o=t.call(this)).opName=a,o.GenerateIntoContainer=function(e){o.leftExpression.GenerateIntoContainer(e),o.rightExpression.GenerateIntoContainer(e),o.opName=o.NativeNameForOp(o.opName),e.AddContent(ie.CallWithName(o.opName))},o.NativeNameForOp=function(e){return"and"===e?"&&":"or"===e?"||":"mod"===e?"%":"has"===e?"?":"hasnt"===e?"!?":e},o.toString=function(){return"(".concat(o.leftExpression," ").concat(o.opName," ").concat(o.rightExpression,")")},o.leftExpression=o.AddContent(e),o.rightExpression=o.AddContent(i),o.opName=a,o}return i(r,[{key:"typeName",get:function(){return"BinaryExpression"}},{key:"ResolveReferences",value:function(e){if(v(o(r.prototype),"ResolveReferences",this).call(this,e),"?"===this.NativeNameForOp(this.opName)){var t=E(this.leftExpression,oe);null===t||"not"!==t.op&&"!"!==t.op||this.Error("Using 'not' or '!' here negates '".concat(t.innerExpression,"' rather than the result of the '?' or 'has' operator. You need to add parentheses around the (A ? B) expression."))}}}]),r}(ne),le=i((function e(t){var r=this;n(this,e),this.set=new Set,this.Add=function(e){return r.set.add(e)},this.AddRange=function(e,t){for(var n=e.charCodeAt(0);n<=t.charCodeAt(0);++n)r.Add(String.fromCharCode(n));return r},this.AddCharacters=function(e){if("string"==typeof e||Array.isArray(e)){var t,n=b(e);try{for(n.s();!(t=n.n()).done;){var i=t.value;r.Add(i)}}catch(e){n.e(e)}finally{n.f()}}else{var a,o=b(e.set);try{for(o.s();!(a=o.n()).done;){var s=a.value;r.Add(s)}}catch(e){o.e(e)}finally{o.f()}}return r},t&&this.AddCharacters(t)}));le.FromRange=function(e,t){return(new le).AddRange(e,t)};var ue=function(){function e(t,r){var i=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(n(this,e),this._start=t,this._end=r,this._correspondingCharSet=new le,this._excludes=new Set,this.ToCharacterSet=function(){if(0===i._correspondingCharSet.set.size)for(var e=i.start.charCodeAt(0),t=String.fromCharCode(e);e<=i.end.charCodeAt(0);e+=1)i._excludes.has(t)||i._correspondingCharSet.AddCharacters(t);return i._correspondingCharSet},a instanceof le)this._excludes=a.set;else{var o,s=b(a);try{for(s.s();!(o=s.n()).done;){var l=o.value;this._excludes.add(l)}}catch(e){s.e(e)}finally{s.f()}}}return i(e,[{key:"start",get:function(){return this._start}},{key:"end",get:function(){return this._end}}]),e}();ue.Define=function(e,t){return new ue(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:[])};var ce,he=function(e){a(r,e);var t=d(r);function r(){var e,i=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return n(this,r),(e=t.call(this))._pathOnChoice=null,e.hasCondition=!1,e.hasStartContent=!1,e.hasChoiceOnlyContent=!1,e.isInvisibleDefault=!1,e.onceOnly=!0,e.onceOnly=i,e}return i(r,[{key:"pathOnChoice",get:function(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){var e=this.choiceTarget;e&&(this._pathOnChoice=e.path)}return this._pathOnChoice},set:function(e){this._pathOnChoice=e}},{key:"choiceTarget",get:function(){return null===this._pathOnChoice?L("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}},{key:"pathStringOnChoice",get:function(){return null===this.pathOnChoice?L("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)},set:function(e){this.pathOnChoice=new R(e)}},{key:"flags",get:function(){var e=0;return this.hasCondition&&(e|=1),this.hasStartContent&&(e|=2),this.hasChoiceOnlyContent&&(e|=4),this.isInvisibleDefault&&(e|=8),this.onceOnly&&(e|=16),e},set:function(e){this.hasCondition=(1&e)>0,this.hasStartContent=(2&e)>0,this.hasChoiceOnlyContent=(4&e)>0,this.isInvisibleDefault=(8&e)>0,this.onceOnly=(16&e)>0}},{key:"toString",value:function(){return null===this.pathOnChoice?L("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}}]),r}(j);!function(e){e[e.Tunnel=0]="Tunnel",e[e.Function=1]="Function",e[e.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"}(ce||(ce={}));var fe,de=function(){function e(){n(this,e),this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}return i(e,[{key:"Resolve",value:function(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}},{key:"isNull",get:function(){return null==this.container}},{key:"path",get:function(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new R.Component(this.index)):this.container.path}},{key:"toString",value:function(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}},{key:"copy",value:function(){return new e(this.container,this.index)}}],[{key:"StartOf",value:function(t){return new e(t,0)}},{key:"Null",get:function(){return new e(null,-1)}}]),e}(),pe=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this))._targetPath=null,i._targetPointer=de.Null,i.variableDivertName=null,i.pushesToStack=!1,i.stackPushType=0,i.isExternal=!1,i.externalArgs=0,i.isConditional=!1,i.pushesToStack=!1,void 0!==e&&(i.pushesToStack=!0,i.stackPushType=e),i}return i(r,[{key:"targetPath",get:function(){if(null!=this._targetPath&&this._targetPath.isRelative){var e=this.targetPointer.Resolve();e&&(this._targetPath=e.path)}return this._targetPath},set:function(e){this._targetPath=e,this._targetPointer=de.Null}},{key:"targetPointer",get:function(){if(this._targetPointer.isNull){var e=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return L("this._targetPath");if(null===this._targetPath.lastComponent)return L("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===e)return L("targetObj");this._targetPointer.container=e.parent instanceof ee?e.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=de.StartOf(e instanceof ee?e:null)}return this._targetPointer.copy()}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(e){this.targetPath=null==e?null:new R(e)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}},{key:"Equals",value:function(e){var t=e;return t instanceof r&&this.hasVariableTarget==t.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==t.variableDivertName:null===this.targetPath?L("this.targetPath"):this.targetPath.Equals(t.targetPath))}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var e=new $,t=this.targetPath.toString();return e.Append("Divert"),this.isConditional&&e.Append("?"),this.pushesToStack&&(this.stackPushType==ce.Function?e.Append(" function"):e.Append(" tunnel")),e.Append(" -> "),e.Append(this.targetPathString),e.Append(" ("),e.Append(t),e.Append(")"),e.toString()}}]),r}(j);!function(e){e[e.Knot=0]="Knot",e[e.List=1]="List",e[e.ListItem=2]="ListItem",e[e.Var=3]="Var",e[e.SubFlowAndWeave=4]="SubFlowAndWeave",e[e.Arg=5]="Arg",e[e.Temp=6]="Temp"}(fe||(fe={}));var ve=function(e){a(r,e);var t=d(r);function r(e,i){var a;return n(this,r),(a=t.call(this)).variableName=e||null,a.isNewDeclaration=!!i,a.isGlobal=!1,a}return i(r,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}}]),r}(j),me=function(e){a(r,e);var t=d(r);function r(e,i,a){var o;return n(this,r),(o=t.call(this))._condition=null,o._innerContentContainer=null,o._outerContainer=null,o._runtimeChoice=null,o._returnToR1=null,o._returnToR2=null,o._r1Label=null,o._r2Label=null,o._divertToStartContentOuter=null,o._divertToStartContentInner=null,o._startContentRuntimeContainer=null,o.isInvisibleDefault=!1,o.hasWeaveStyleInlineBrackets=!1,o.GenerateRuntimeObject=function(){if(o._outerContainer=new ee,o._runtimeChoice=new he(o.onceOnly),o._runtimeChoice.isInvisibleDefault=o.isInvisibleDefault,(o.startContent||o.choiceOnlyContent||o.condition)&&o._outerContainer.AddContent(te.EvalStart()),o.startContent){o._returnToR1=new Y,o._outerContainer.AddContent(o._returnToR1);var e=new ve("$r",!0);o._outerContainer.AddContent(e),o._outerContainer.AddContent(te.BeginString()),o._divertToStartContentOuter=new pe,o._outerContainer.AddContent(o._divertToStartContentOuter),o._startContentRuntimeContainer=o.startContent.GenerateRuntimeObject(),o._startContentRuntimeContainer.name="s";var t=new pe;t.variableDivertName="$r",o._startContentRuntimeContainer.AddContent(t),o._outerContainer.AddToNamedContentOnly(o._startContentRuntimeContainer),o._r1Label=new ee,o._r1Label.name="$r1",o._outerContainer.AddContent(o._r1Label),o._outerContainer.AddContent(te.EndString()),o._runtimeChoice.hasStartContent=!0}if(o.choiceOnlyContent){o._outerContainer.AddContent(te.BeginString());var n=o.choiceOnlyContent.GenerateRuntimeObject();o._outerContainer.AddContentsOfContainer(n),o._outerContainer.AddContent(te.EndString()),o._runtimeChoice.hasChoiceOnlyContent=!0}if(o.condition&&(o.condition.GenerateIntoContainer(o._outerContainer),o._runtimeChoice.hasCondition=!0),(o.startContent||o.choiceOnlyContent||o.condition)&&o._outerContainer.AddContent(te.EvalEnd()),o._outerContainer.AddContent(o._runtimeChoice),o._innerContentContainer=new ee,o.startContent){o._returnToR2=new Y,o._innerContentContainer.AddContent(te.EvalStart()),o._innerContentContainer.AddContent(o._returnToR2),o._innerContentContainer.AddContent(te.EvalEnd());var r=new ve("$r",!0);o._innerContentContainer.AddContent(r),o._divertToStartContentInner=new pe,o._innerContentContainer.AddContent(o._divertToStartContentInner),o._r2Label=new ee,o._r2Label.name="$r2",o._innerContentContainer.AddContent(o._r2Label)}if(o.innerContent){var i=o.innerContent.GenerateRuntimeObject();o._innerContentContainer.AddContentsOfContainer(i)}return o.story.countAllVisits&&(o._innerContentContainer.visitsShouldBeCounted=!0),o._innerContentContainer.countingAtStartOnly=!0,o._outerContainer},o.toString=function(){return null!==o.choiceOnlyContent?"* ".concat(o.startContent,"[").concat(o.choiceOnlyContent,"]..."):"* ".concat(o.startContent,"...")},o.startContent=e,o.choiceOnlyContent=i,o.innerContent=a,o.indentationDepth=1,e&&o.AddContent(o.startContent),i&&o.AddContent(o.choiceOnlyContent),a&&o.AddContent(o.innerContent),o.onceOnly=!0,o}return i(r,[{key:"runtimeChoice",get:function(){if(!this._runtimeChoice)throw new Error;return this._runtimeChoice}},{key:"name",get:function(){var e;return(null===(e=this.identifier)||void 0===e?void 0:e.name)||null}},{key:"condition",get:function(){return this._condition},set:function(e){this._condition=e,e&&this.AddContent(e)}},{key:"runtimeContainer",get:function(){return this._innerContentContainer}},{key:"innerContentContainer",get:function(){return this._innerContentContainer}},{key:"containerForCounting",get:function(){return this._innerContentContainer}},{key:"runtimePath",get:function(){if(!this.innerContentContainer||!this.innerContentContainer.path)throw new Error;return this.innerContentContainer.path}},{key:"typeName",get:function(){return"Choice"}},{key:"ResolveReferences",value:function(e){var t;if(this._innerContentContainer&&(this.runtimeChoice.pathOnChoice=this._innerContentContainer.path,this.onceOnly&&(this._innerContentContainer.visitsShouldBeCounted=!0)),this._returnToR1){if(!this._r1Label)throw new Error;this._returnToR1.targetPath=this._r1Label.path}if(this._returnToR2){if(!this._r2Label)throw new Error;this._returnToR2.targetPath=this._r2Label.path}if(this._divertToStartContentOuter){if(!this._startContentRuntimeContainer)throw new Error;this._divertToStartContentOuter.targetPath=this._startContentRuntimeContainer.path}if(this._divertToStartContentInner){if(!this._startContentRuntimeContainer)throw new Error;this._divertToStartContentInner.targetPath=this._startContentRuntimeContainer.path}v(o(r.prototype),"ResolveReferences",this).call(this,e),this.identifier&&((null===(t=this.identifier)||void 0===t?void 0:t.name)||"").length>0&&e.CheckForNamingCollisions(this,this.identifier,fe.SubFlowAndWeave)}}]),r}(F),ye=i((function e(){var t=this;n(this,e),this.characterIndex=0,this.characterInLineIndex=0,this.lineIndex=0,this.reportedErrorInScope=!1,this.uniqueId=0,this.customFlags=0,this.CopyFrom=function(n){e._uniqueIdCounter++,t.uniqueId=e._uniqueIdCounter,t.characterIndex=n.characterIndex,t.characterInLineIndex=n.characterInLineIndex,t.lineIndex=n.lineIndex,t.customFlags=n.customFlags,t.reportedErrorInScope=!1},this.SquashFrom=function(e){t.characterIndex=e.characterIndex,t.characterInLineIndex=e.characterInLineIndex,t.lineIndex=e.lineIndex,t.reportedErrorInScope=e.reportedErrorInScope}}));ye._uniqueIdCounter=1e3;var ge=function(){function e(){var t=this;n(this,e),this._stack=[],this._numElements=0,this.StringParserState=function(){t._stack=new Array(200);for(var e=0;e<200;++e)t._stack[e]=new ye;t._numElements=1},this.Push=function(){if(t._numElements>=t._stack.length&&t._numElements>0)throw new Error("Stack overflow in parser state.");var e=t._stack[t._numElements-1],n=t._stack[t._numElements];return t._numElements++,n.CopyFrom(e),n.uniqueId},this.Pop=function(e){if(1==t._numElements)throw new Error("Attempting to remove final stack element is illegal! Mismatched Begin/Succceed/Fail?");if(t.currentElement.uniqueId!=e)throw new Error("Mismatched rule IDs while Poping - do you have mismatched Begin/Succeed/Fail?");t._numElements-=1},this.Peek=function(e){if(t.currentElement.uniqueId!=e)throw new Error("Mismatched rule IDs while Peeking - do you have mismatched Begin/Succeed/Fail?");return t._stack[t._numElements-1]},this.PeekPenultimate=function(){return t._numElements>=2?t._stack[t._numElements-2]:null},this.Squash=function(){if(t._numElements<2)throw new Error("Attempting to remove final stack element is illegal! Mismatched Begin/Succceed/Fail?");var e=t._stack[t._numElements-2],n=t._stack[t._numElements-1];e.SquashFrom(n),t._numElements-=1},this.NoteErrorReported=function(){var e,n=b(t._stack);try{for(n.s();!(e=n.n()).done;)e.value.reportedErrorInScope=!0}catch(e){n.e(e)}finally{n.f()}};for(var r=0;r<200;r++)this._stack[r]=new ye;this._numElements=1}return i(e,[{key:"currentElement",get:function(){return this._stack[this._numElements-1]}},{key:"lineIndex",get:function(){return this.currentElement.lineIndex},set:function(e){this.currentElement.lineIndex=e}},{key:"characterIndex",get:function(){return this.currentElement.characterIndex},set:function(e){this.currentElement.characterIndex=e}},{key:"characterInLineIndex",get:function(){return this.currentElement.characterInLineIndex},set:function(e){this.currentElement.characterInLineIndex=e}},{key:"customFlags",get:function(){return this.currentElement.customFlags},set:function(e){this.currentElement.customFlags=e}},{key:"errorReportedAlreadyInScope",get:function(){return this.currentElement.reportedErrorInScope}},{key:"stackHeight",get:function(){return this._numElements}}]),e}(),Ce=Symbol("ParseSuccessStruct"),be=function(){function e(t){var r=this;n(this,e),this.ParseRule=null,this.errorHandler=null,this.hadError=!1,this.BeginRule=function(){return r.state.Push()},this.FailRule=function(e){return r.state.Pop(e),null},this.CancelRule=function(e){r.state.Pop(e)},this.SucceedRule=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=r.state.Peek(t),a=r.state.PeekPenultimate();r.RuleDidSucceed&&r.RuleDidSucceed(n,a,i),r.state.Squash();var o=n;return null===o&&(o=e.ParseSuccess),o},this.Expect=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=r.ParseObject(e);if(null===i){var a;null===t&&(t=e.name);var o=r.LineRemainder();a=null===o||0===o.length?"end of line":"'".concat(o,"'"),r.Error("Expected ".concat(t," but saw ").concat(a)),null!==n&&(i=n())}return i},this.Error=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];r.ErrorOnLine(e,r.lineIndex+1,t)},this.ErrorWithParsedObject=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];r.ErrorOnLine(e,t.debugMetadata?t.debugMetadata.startLineNumber:-1,n)},this.ErrorOnLine=function(e,t,n){if(!r.state.errorReportedAlreadyInScope){var i=n?"Warning":"Error";if(!r.errorHandler)throw new Error("".concat(i," on line ").concat(t,": ").concat(e));r.errorHandler(e,r.index,t-1,n),r.state.NoteErrorReported()}n||(r.hadError=!0)},this.Warning=function(e){return r.Error(e,!0)},this.LineRemainder=function(){return r.Peek((function(){return r.ParseUntilCharactersFromString("\n\r")}))},this.SetFlag=function(e,t){t?r.state.customFlags|=e:r.state.customFlags&=~e},this.GetFlag=function(e){return Boolean(r.state.customFlags&e)},this.ParseObject=function(e){var t=r.BeginRule(),n=r.state.stackHeight,i=e();if(n!==r.state.stackHeight)throw new Error("Mismatched Begin/Fail/Succeed rules");return null===i?r.FailRule(t):(r.SucceedRule(t,i),i)},this.Parse=function(e){var t=r.BeginRule(),n=e();return null===n?(r.FailRule(t),null):(r.SucceedRule(t,n),n)},this.OneOf=function(e){var t,n=b(e);try{for(n.s();!(t=n.n()).done;){var i=t.value,a=r.ParseObject(i);if(null!==a)return a}}catch(e){n.e(e)}finally{n.f()}return null},this.OneOrMore=function(e){var t=[],n=null;do{null!==(n=r.ParseObject(e))&&t.push(n)}while(null!==n);return t.length>0?t:null},this.Optional=function(t){return function(){var n=r.ParseObject(t);return null===n?e.ParseSuccess:n}},this.Exclude=function(t){return function(){return r.ParseObject(t)&&e.ParseSuccess}},this.OptionalExclude=function(t){return function(){return r.ParseObject(t),e.ParseSuccess}},this.String=function(e){return function(){return r.ParseString(e)}},this.TryAddResultToList=function(t,n){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(t!==e.ParseSuccess){if(r&&Array.isArray(t)&&null!==t){var i,a=b(t);try{for(a.s();!(i=a.n()).done;){var o=i.value;n.push(o)}}catch(e){a.e(e)}finally{a.f()}return}n.push(t)}},this.Interleave=function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=r.BeginRule(),s=[],l=r.ParseObject(t);if(null===l)return r.FailRule(o);r.TryAddResultToList(l,s,a);var u=null,c=null;do{if(null!==i&&null!==r.Peek(i))break;if(null===(u=r.ParseObject(n)))break;if(r.TryAddResultToList(u,s,a),c=null,null!==u){if(null===(c=r.ParseObject(t)))break;r.TryAddResultToList(c,s,a)}}while((null!==u||null!==c)&&(u!==e.ParseSuccess||c!=e.ParseSuccess)&&r.remainingLength>0);return 0===s.length?r.FailRule(o):r.SucceedRule(o,s)},this.ParseString=function(e){if(e.length>r.remainingLength)return null;for(var t=r.BeginRule(),n=r.index,i=r.characterInLineIndex,a=r.lineIndex,o=!0,s=0;s<e.length;s+=1){var l=e[s];if(r._chars[n]!==l){o=!1;break}"\n"===l&&(a++,i=-1),n++,i++}return r.index=n,r.characterInLineIndex=i,r.lineIndex=a,o?r.SucceedRule(t,e):r.FailRule(t)},this.ParseSingleCharacter=function(){if(r.remainingLength>0){var e=r._chars[r.index];return"\n"===e&&(r.lineIndex+=1,r.characterInLineIndex=-1),r.index+=1,r.characterInLineIndex+=1,e}return"0"},this.ParseUntilCharactersFromString=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;return r.ParseCharactersFromString(e,!1,t)},this.ParseUntilCharactersFromCharSet=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;return r.ParseCharactersFromCharSet(e,!1,t)},this.ParseCharactersFromString=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,i=new le(e);return"number"==typeof t?r.ParseCharactersFromCharSet(i,!0,t):r.ParseCharactersFromCharSet(i,t,n)},this.ParseCharactersFromCharSet=function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;-1===n&&(n=Number.MAX_SAFE_INTEGER);for(var i=r.index,a=r.index,o=r.characterInLineIndex,s=r.lineIndex,l=0;a<r._chars.length&&e.set.has(r._chars[a])===t&&l<n;)"\n"===r._chars[a]&&(s+=1,o=-1),a+=1,o+=1,l+=1;return r.index=a,r.characterInLineIndex=o,r.lineIndex=s,r.index>i?r._chars.slice(i,r.index).join(""):null},this.Peek=function(e){var t=r.BeginRule(),n=e();return r.CancelRule(t),n},this.ParseInt=function(){var t=r.index,n=r.characterInLineIndex,i=null!==r.ParseString("-");r.ParseCharactersFromString(" \t");var a,o=r.ParseCharactersFromCharSet(e.numbersCharacterSet);return null===o?(r.index=t,r.characterInLineIndex=n,null):Number.isNaN(Number(o))?(r.Error("Failed to read integer value: "+o+". Perhaps it's out of the range of acceptable numbers ink supports? ("+Number.MIN_SAFE_INTEGER+" to "+Number.MAX_SAFE_INTEGER+")"),null):(a=Number(o),i?-a:a)},this.ParseFloat=function(){var t=r.index,n=r.characterInLineIndex,i=r.ParseInt();if(null!==i&&null!==r.ParseString(".")){var a=r.ParseCharactersFromCharSet(e.numbersCharacterSet);return Number("".concat(i,".").concat(a))}return r.index=t,r.characterInLineIndex=n,null},this.ParseNewline=function(){var e=r.BeginRule();return r.ParseString("\r"),null===r.ParseString("\n")?r.FailRule(e):r.SucceedRule(e,"\n")};var i=this.PreProcessInputString(t);this.state=new ge,this._chars=t?i.split(""):[],this.inputString=i}return i(e,[{key:"currentCharacter",get:function(){return this.index>=0&&this.remainingLength>0?this._chars[this.index]:"0"}},{key:"PreProcessInputString",value:function(e){return e}},{key:"endOfInput",get:function(){return this.index>=this._chars.length}},{key:"remainingString",get:function(){return this._chars.slice(this.index,this.index+this.remainingLength).join("")}},{key:"remainingLength",get:function(){return this._chars.length-this.index}},{key:"lineIndex",get:function(){return this.state.lineIndex},set:function(e){this.state.lineIndex=e}},{key:"characterInLineIndex",get:function(){return this.state.characterInLineIndex},set:function(e){this.state.characterInLineIndex=e}},{key:"index",get:function(){return this.state.characterIndex},set:function(e){this.state.characterIndex=e}},{key:"ParseUntil",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=this.BeginRule(),i=new le;null!==t&&(i.set=new Set([].concat(y(i.set.values()),y(t.set.values())))),null!==n&&(i.set=new Set([].concat(y(i.set.values()),y(n.set.values()))));for(var a="";;){var o=this.ParseUntilCharactersFromCharSet(i);if(o&&(a+=o),null!==this.Peek(e))break;if(this.endOfInput)break;var s=this.currentCharacter;if(null===t||!t.set.has(s))break;a+=s,"\n"===s&&(this.lineIndex+=1,this.characterInLineIndex=-1),this.index+=1,this.characterInLineIndex+=1}return a.length>0?this.SucceedRule(r,String(a)):this.FailRule(r)}}]),e}();be.ParseSuccess=Ce,be.numbersCharacterSet=new le("0123456789");var we,Se=function(e){a(r,e);var t=d(r);function r(){var e;return n(this,r),(e=t.apply(this,arguments))._commentOrNewlineStartCharacter=new le("/\r\n"),e._commentBlockEndCharacter=new le("*"),e._newlineCharacters=new le("\n\r"),e.Process=function(){var t=e.Interleave(e.Optional(e.CommentsAndNewlines),e.Optional(e.MainInk));return null!==t?t.join(""):""},e.MainInk=function(){return e.ParseUntil(e.CommentsAndNewlines,e._commentOrNewlineStartCharacter,null)},e.CommentsAndNewlines=function(){var t=e.Interleave(e.Optional(e.ParseNewline),e.Optional(e.ParseSingleComment));return null!==t?t.join(""):null},e.ParseSingleComment=function(){return e.OneOf([e.EndOfLineComment,e.BlockComment])},e.EndOfLineComment=function(){return null===e.ParseString("//")?null:(e.ParseUntilCharactersFromCharSet(e._newlineCharacters),"")},e.BlockComment=function(){if(null===e.ParseString("/*"))return null;var t=e.lineIndex,n=e.ParseUntil(e.String("*/"),e._commentBlockEndCharacter,null);return e.endOfInput||e.ParseString("*/"),null!=n?"\n".repeat(e.lineIndex-t):null},e}return i(r,[{key:"PreProcessInputString",value:function(e){return e}}]),r}(be),ke=function(e){a(r,e);var t=d(r);function r(e,i){var a;return n(this,r),(a=t.call(this)).initialCondition=e,a.branches=i,a._reJoinTarget=null,a.GenerateRuntimeObject=function(){var e=new ee;a.initialCondition&&e.AddContent(a.initialCondition.runtimeObject);var t,n=b(a.branches);try{for(n.s();!(t=n.n()).done;){var r=t.value.runtimeObject;e.AddContent(r)}}catch(e){n.e(e)}finally{n.f()}return null===a.initialCondition||null===a.branches[0].ownExpression||a.branches[a.branches.length-1].isElse||e.AddContent(te.PopEvaluatedValue()),a._reJoinTarget=te.NoOp(),e.AddContent(a._reJoinTarget),e},a.initialCondition&&a.AddContent(a.initialCondition),null!==a.branches&&a.AddContent(a.branches),a}return i(r,[{key:"typeName",get:function(){return"Conditional"}},{key:"ResolveReferences",value:function(e){var t,n=this._reJoinTarget.path,i=b(this.branches);try{for(i.s();!(t=i.n()).done;){var a=t.value;if(!a.returnDivert)throw new Error;a.returnDivert.targetPath=n}}catch(e){i.e(e)}finally{i.f()}v(o(r.prototype),"ResolveReferences",this).call(this,e)}}]),r}(F),xe=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this)).text=e,i.GenerateRuntimeObject=function(){return new J(i.text)},i.toString=function(){return i.text},i}return i(r,[{key:"typeName",get:function(){return"Text"}}]),r}(F),Ee=function(e){a(r,e);var t=d(r);function r(e,i){var a;return n(this,r),(a=t.call(this))._expression=null,a.GenerateRuntimeObject=function(){return null},a.constantIdentifier=e,i&&(a._expression=a.AddContent(i)),a}return i(r,[{key:"constantName",get:function(){var e;return null===(e=this.constantIdentifier)||void 0===e?void 0:e.name}},{key:"expression",get:function(){if(!this._expression)throw new Error;return this._expression}},{key:"typeName",get:function(){return"CONST"}},{key:"ResolveReferences",value:function(e){v(o(r.prototype),"ResolveReferences",this).call(this,e),e.CheckForNamingCollisions(this,this.constantIdentifier,fe.Var)}}]),r}(F);!function(e){e[e.Story=0]="Story",e[e.Knot=1]="Knot",e[e.Stitch=2]="Stitch",e[e.WeavePoint=3]="WeavePoint"}(we||(we={}));var _e=function(e){a(r,e);var t=d(r);function r(e,i){var a;return n(this,r),(a=t.call(this)).indentationDepth=i,a.GenerateRuntimeObject=function(){var e=new ee;if(e.name=a.name,a.story.countAllVisits&&(e.visitsShouldBeCounted=!0),e.countingAtStartOnly=!0,a.content){var t,n=b(a.content);try{for(n.s();!(t=n.n()).done;){var r=t.value;e.AddContent(r.runtimeObject)}}catch(e){n.e(e)}finally{n.f()}}return e},a.toString=function(){var e,t;return"- ".concat((null===(e=a.identifier)||void 0===e?void 0:e.name)?"("+(null===(t=a.identifier)||void 0===t?void 0:t.name)+")":"gather")},e&&(a.identifier=e),a}return i(r,[{key:"name",get:function(){var e;return(null===(e=this.identifier)||void 0===e?void 0:e.name)||null}},{key:"runtimeContainer",get:function(){return this.runtimeObject}},{key:"typeName",get:function(){return"Gather"}},{key:"ResolveReferences",value:function(e){v(o(r.prototype),"ResolveReferences",this).call(this,e),this.identifier&&(this.identifier.name||"").length>0&&e.CheckForNamingCollisions(this,this.identifier,fe.SubFlowAndWeave)}}]),r}(F),Te=function(){function e(t,r){var i=this;n(this,e),this._dotSeparatedComponents=null,this.toString=function(){return null===i.components||0===i.components.length?i.baseTargetLevel===we.WeavePoint?"-> <next gather point>":"<invalid Path>":"-> ".concat(i.dotSeparatedComponents)},this.ResolveFromContext=function(e){if(null==i.components||0==i.components.length)return null;var t=i.ResolveBaseTarget(e);return null===t?null:i.components.length>1?i.ResolveTailComponents(t):t},this.ResolveBaseTarget=function(e){for(var t=i.firstComponent,n=e;n;){var r=n===e,a=i.GetChildFromContext(n,t,null,r);if(a)return a;n=n.parent}return null},this.ResolveTailComponents=function(e){var t=e;if(!i.components)return null;for(var n=1;n<i.components.length;++n){var r=i.components[n].name,a=void 0,o=E(t,Pe);if(a=null!==o?o.flowLevel+1:we.WeavePoint,null===(t=i.GetChildFromContext(t,r,a)))break}return t},this.GetChildFromContext=function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=null===n,a=E(e,ze);if(t&&null!==a&&(i||n===we.WeavePoint))return a.WeavePointNamed(t);var o=E(e,Pe);if(t&&null!==o){var s=r||o.flowLevel===we.Knot;return o.ContentWithNameAtLevel(t,n,s)}return null},Object.values(we).includes(t)?(this._baseTargetLevel=t,this.components=r||[]):Array.isArray(t)?(this._baseTargetLevel=null,this.components=t||[]):(this._baseTargetLevel=null,this.components=[t])}return i(e,[{key:"baseTargetLevel",get:function(){return this.baseLevelIsAmbiguous?we.Story:this._baseTargetLevel}},{key:"baseLevelIsAmbiguous",get:function(){return!this._baseTargetLevel}},{key:"firstComponent",get:function(){return null!=this.components&&this.components.length?this.components[0].name:null}},{key:"numberOfComponents",get:function(){return this.components?this.components.length:0}},{key:"dotSeparatedComponents",get:function(){return null==this._dotSeparatedComponents&&(this._dotSeparatedComponents=(this.components?this.components:[]).map((function(e){return e.name})).filter(P).join(".")),this._dotSeparatedComponents}},{key:"typeName",get:function(){return"Path"}}]),e}(),Ae=function(e){a(r,e);var t=d(r);function r(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return n(this,r),(e=t.call(this)).returnedExpression=null,e.GenerateRuntimeObject=function(){var t=new ee;return e.returnedExpression?t.AddContent(e.returnedExpression.runtimeObject):(t.AddContent(te.EvalStart()),t.AddContent(new re),t.AddContent(te.EvalEnd())),t.AddContent(te.PopFunction()),t},i&&(e.returnedExpression=e.AddContent(i)),e}return i(r,[{key:"typeName",get:function(){return"ReturnType"}}]),r}(F);function Ne(e){for(var t=e.parent;t;){if(t.hasOwnProperty("iamFlowbase")&&t.iamFlowbase())return t;t=t.parent}return null}var Oe=function(){function e(t){var r=this;n(this,e),this.debugMetadata=null,this.toString=function(){return r.name||"undefined identifer"},this.name=t}return i(e,[{key:"typeName",get:function(){return"Identifier"}}],[{key:"Done",value:function(){return new e("DONE")}}]),e}(),Pe=function(e){a(r,e);var t=d(r);function r(e){var i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],l=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return n(this,r),(i=t.call(this)).isFunction=s,i._rootWeave=null,i._subFlowsByName=new Map,i._startingSubFlowDivert=null,i._startingSubFlowRuntime=null,i._firstChildFlow=null,i.variableDeclarations=new Map,i.identifier=null,i.args=null,i.iamFlowbase=function(){return!0},i.SplitWeaveAndSubFlowContent=function(e,t){var n,a,o=[],s=[];i._subFlowsByName=new Map;var l,u=b(e);try{for(u.s();!(l=u.n()).done;){var c=l.value,h=E(c,r);h?(null===i._firstChildFlow&&(i._firstChildFlow=h),s.push(c),(null===(n=h.identifier)||void 0===n?void 0:n.name)&&i._subFlowsByName.set(null===(a=h.identifier)||void 0===a?void 0:a.name,h)):o.push(c)}}catch(e){u.e(e)}finally{u.f()}t&&o.push(new _e(null,1),new $e(new Te(Oe.Done())));var f=[];return o.length>0&&(i._rootWeave=new ze(o,0),f.push(i._rootWeave)),s.length>0&&f.push.apply(f,s),f},i.ResolveVariableWithName=function(e,t){var n,r={},a=null===t?h(i):Ne(t);if(a){if(null!==a.args){var o,s=b(a.args);try{for(s.s();!(o=s.n()).done;)if((null===(n=o.value.identifier)||void 0===n?void 0:n.name)===e)return r.found=!0,r.isArgument=!0,r.ownerFlow=a,r}catch(e){s.e(e)}finally{s.f()}}if(a!==i.story&&a.variableDeclarations.has(e))return r.found=!0,r.ownerFlow=a,r.isTemporary=!0,r}return i.story.variableDeclarations.has(e)?(r.found=!0,r.ownerFlow=i.story,r.isGlobal=!0,r):(r.found=!1,r)},i.AddNewVariableDeclaration=function(e){var t=e.variableName;if(i.variableDeclarations.has(t)){var n=i.variableDeclarations.get(t),r="";return n.debugMetadata&&(r=" (".concat(n.debugMetadata,")")),void i.Error("found declaration variable '".concat(t,"' that was already declared").concat(r),e,!1)}i.variableDeclarations.set(e.variableName,e)},i.ResolveWeavePointNaming=function(){i._rootWeave&&i._rootWeave.ResolveWeavePointNaming();var e,t=b(i._subFlowsByName);try{for(t.s();!(e=t.n()).done;){var n=m(e.value,2)[1];n.hasOwnProperty("ResolveWeavePointNaming")&&n.ResolveWeavePointNaming()}}catch(e){t.e(e)}finally{t.f()}},i.GenerateRuntimeObject=function(){var e,t=null;i.isFunction?i.CheckForDisallowedFunctionFlowControl():i.flowLevel!==we.Knot&&i.flowLevel!==we.Stitch||null!==(t=i.Find(Ae)())&&i.Error("Return statements can only be used in knots that are declared as functions: == function ".concat(i.identifier," =="),t);var n=new ee;n.name=null===(e=i.identifier)||void 0===e?void 0:e.name,i.story.countAllVisits&&(n.visitsShouldBeCounted=!0),i.GenerateArgumentVariableAssignments(n);for(var a=0;null!==i.content&&a<i.content.length;){var o=i.content[a];if(o instanceof r){var s=o,l=s.runtimeObject;0!==a||s.hasParameters||i.flowLevel!==we.Knot||(i._startingSubFlowDivert=new pe,n.AddContent(i._startingSubFlowDivert),i._startingSubFlowRuntime=l);var u=l,c=n.namedContent.get(u.name)||null;if(c){var h="".concat(i.GetType()," already contains flow named '").concat(u.name,"' (at ").concat(c.debugMetadata,")");i.Error(h,s)}n.AddToNamedContentOnly(u)}else o&&n.AddContent(o.runtimeObject);a+=1}return i.flowLevel===we.Story||i.isFunction||null===i._rootWeave||null!==t||i._rootWeave.ValidateTermination(i.WarningInTermination),n},i.GenerateArgumentVariableAssignments=function(e){var t;if(null!==i.args&&0!==i.args.length)for(var n=i.args.length-1;n>=0;--n){var r=(null===(t=i.args[n].identifier)||void 0===t?void 0:t.name)||null,a=new ve(r,!0);e.AddContent(a)}},i.ContentWithNameAtLevel=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if((n===i.flowLevel||null===n)&&e===(null===(t=i.identifier)||void 0===t?void 0:t.name))return h(i);if(n===we.WeavePoint||null===n){var a=null;if(i._rootWeave&&(a=i._rootWeave.WeavePointNamed(e)))return a;if(n===we.WeavePoint)return r?i.DeepSearchForAnyLevelContent(e):null}if(null!==n&&n<i.flowLevel)return null;var o=i._subFlowsByName.get(e)||null;return!o||null!==n&&n!==o.flowLevel?r?i.DeepSearchForAnyLevelContent(e):null:o},i.DeepSearchForAnyLevelContent=function(e){var t=i.ContentWithNameAtLevel(e,we.WeavePoint,!1);if(t)return t;var n,r=b(i._subFlowsByName);try{for(r.s();!(n=r.n()).done;){var a=m(n.value,2)[1].ContentWithNameAtLevel(e,null,!0);if(a)return a}}catch(e){r.e(e)}finally{r.f()}return null},i.CheckForDisallowedFunctionFlowControl=function(){i.flowLevel!==we.Knot&&i.Error("Functions cannot be stitches - i.e. they should be defined as '== function myFunc ==' rather than internal to another knot.");var e,t=b(i._subFlowsByName);try{for(t.s();!(e=t.n()).done;){var n=m(e.value,2),r=n[0],a=n[1];i.Error("Functions may not contain stitches, but saw '".concat(r,"' within the function '").concat(i.identifier,"'"),a)}}catch(e){t.e(e)}finally{t.f()}if(!i._rootWeave)throw new Error;var o,s=b(i._rootWeave.FindAll($e)());try{for(s.s();!(o=s.n()).done;){var l=o.value;l.isFunctionCall||l.parent instanceof je||i.Error("Functions may not contain diverts, but saw '".concat(l,"'"),l)}}catch(e){s.e(e)}finally{s.f()}var u,c=b(i._rootWeave.FindAll(me)());try{for(c.s();!(u=c.n()).done;){var h=u.value;i.Error("Functions may not contain choices, but saw '".concat(h,"'"),h)}}catch(e){c.e(e)}finally{c.f()}},i.WarningInTermination=function(e){var t="Apparent loose end exists where the flow runs out. Do you need a '-> DONE' statement, choice or divert?";e.parent===i._rootWeave&&i._firstChildFlow&&(t="".concat(t," Note that if you intend to enter '").concat(i._firstChildFlow.identifier,"' next, you need to divert to it explicitly."));var n=E(e,$e);n&&n.isTunnel&&(t+=" When final tunnel to '".concat(n.target," ->' returns it won't have anywhere to go.")),i.Warning(t,e)},i.toString=function(){return"".concat(i.typeName," '").concat(i.identifier,"'")},i.identifier=e,i.args=o,null===a&&(a=[]),i.PreProcessTopLevelObjects(a),a=i.SplitWeaveAndSubFlowContent(a,"Story"==i.GetType()&&!l),i.AddContent(a),i}return i(r,[{key:"hasParameters",get:function(){return null!==this.args&&this.args.length>0}},{key:"subFlowsByName",get:function(){return this._subFlowsByName}},{key:"typeName",get:function(){return this.isFunction?"Function":String(this.flowLevel)}},{key:"name",get:function(){var e;return(null===(e=this.identifier)||void 0===e?void 0:e.name)||null}},{key:"PreProcessTopLevelObjects",value:function(e){}},{key:"ResolveReferences",value:function(e){var t,n;if(this._startingSubFlowDivert){if(!this._startingSubFlowRuntime)throw new Error;this._startingSubFlowDivert.targetPath=this._startingSubFlowRuntime.path}if(v(o(r.prototype),"ResolveReferences",this).call(this,e),null!==this.args){var i,a=b(this.args);try{for(a.s();!(i=a.n()).done;){var s=i.value;e.CheckForNamingCollisions(this,s.identifier,fe.Arg,"argument")}}catch(e){a.e(e)}finally{a.f()}for(var l=0;l<this.args.length;l+=1)for(var u=l+1;u<this.args.length;u+=1)(null===(t=this.args[l].identifier)||void 0===t?void 0:t.name)==(null===(n=this.args[u].identifier)||void 0===n?void 0:n.name)&&this.Error("Multiple arguments with the same name: '".concat(this.args[l].identifier,"'"))}if(this.flowLevel!==we.Story){var c=this.flowLevel===we.Knot?fe.Knot:fe.SubFlowAndWeave;e.CheckForNamingCollisions(this,this.identifier,c)}}}]),r}(F),Ie=function(e){a(r,e);var t=d(r);function r(e){var i;n(this,r),(i=t.call(this)).dontFlatten=!1,i.TrimTrailingWhitespace=function(){for(var e=i.content.length-1;e>=0;--e){var t=E(i.content[e],xe);if(null===t)break;if(t.text=t.text.replace(new RegExp(/[ \t]/g),""),0!==t.text.length)break;i.content.splice(e,1)}},i.GenerateRuntimeObject=function(){var e=new ee;if(null!==i.content){var t,n=b(i.content);try{for(n.s();!(t=n.n()).done;){var r=t.value.runtimeObject;r&&e.AddContent(r)}}catch(e){n.e(e)}finally{n.f()}}return i.dontFlatten&&i.story.DontFlattenContainer(e),e},i.toString=function(){return"ContentList(".concat(i.content.join(", "),")")},e&&i.AddContent(e);for(var a=arguments.length,o=new Array(a>1?a-1:0),s=1;s<a;s++)o[s-1]=arguments[s];return o&&i.AddContent(o),i}return i(r,[{key:"runtimeContainer",get:function(){return this.runtimeObject}},{key:"typeName",get:function(){return"ContentList"}}]),r}(F),Fe=function(e){a(r,e);var t=d(r);function r(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return n(this,r),(e=t.call(this)).pathForCount=null,e.name=i,e}return i(r,[{key:"containerForCount",get:function(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}},{key:"pathStringForCount",get:function(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(e){this.pathForCount=null===e?null:new R(e)}},{key:"toString",value:function(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}}]),r}(j),We=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this)).pathIdentifiers=e,i._runtimeVarRef=null,i.isConstantReference=!1,i.isListItemReference=!1,i.GenerateIntoContainer=function(e){var t=i.story.constants.get(i.name);if(t)return t.GenerateConstantIntoContainer(e),void(i.isConstantReference=!0);if(i._runtimeVarRef=new Fe(i.name),1===i.path.length||2===i.path.length){var n="",r="";1===i.path.length?n=i.path[0]:(r=i.path[0],n=i.path[1]),i.story.ResolveListItem(r,n,h(i))&&(i.isListItemReference=!0)}e.AddContent(i._runtimeVarRef)},i.toString=function(){return"{".concat(i.path.join("."),"}")},i}return i(r,[{key:"name",get:function(){return this.path.join(".")}},{key:"path",get:function(){return this.pathIdentifiers.map((function(e){return e.name})).filter(P)}},{key:"identifier",get:function(){if(!this.pathIdentifiers||0==this.pathIdentifiers.length)return null;var e=this.path.join(".");return new Oe(e)}},{key:"runtimeVarRef",get:function(){return this._runtimeVarRef}},{key:"typeName",get:function(){return"ref"}},{key:"ResolveReferences",value:function(e){if(v(o(r.prototype),"ResolveReferences",this).call(this,e),!this.isConstantReference&&!this.isListItemReference){var t=new Te(this.pathIdentifiers),n=t.ResolveFromContext(this);if(n){if(!n.containerForCounting)throw new Error;if(n.containerForCounting.visitsShouldBeCounted=!0,null===this._runtimeVarRef)return;this._runtimeVarRef.pathForCount=n.runtimePath,this._runtimeVarRef.name=null;var i=E(n,Pe);i&&i.isFunction&&(this.parent instanceof ze||this.parent instanceof Ie||this.parent instanceof Pe)&&this.Warning("'".concat(i.identifier,"' being used as read count rather than being called as function. Perhaps you intended to write ").concat(i.identifier,"()"))}else{if(this.path.length>1){var a="Could not find target for read count: ".concat(t);return this.path.length<=2&&(a+=", or couldn't find list item with the name ".concat(this.path.join(","))),void this.Error(a)}e.ResolveVariableWithName(this.name,this).found||this.Error("Unresolved variable: ".concat(this.name),this)}}}}]),r}(ne),Re=function(e){a(r,e);var t=d(r);function r(e,i){var a;return n(this,r),(a=t.call(this))._divertTargetToCount=null,a._variableReferenceToCount=null,a.shouldPopReturnedValue=!1,a.GenerateIntoContainer=function(e){var t=a.story.ResolveList(a.name),n=!1;if(a.isChoiceCount)a.args.length>0&&a.Error("The CHOICE_COUNT() function shouldn't take any arguments"),e.AddContent(te.ChoiceCount());else if(a.isTurns)a.args.length>0&&a.Error("The TURNS() function shouldn't take any arguments"),e.AddContent(te.Turns());else if(a.isTurnsSince||a.isReadCount){var r=E(a.args[0],je),i=E(a.args[0],We);if(1!==a.args.length||null===r&&null===i)return void a.Error("The ".concat(a.name,"() function should take one argument: a divert target to the target knot, stitch, gather or choice you want to check. e.g. TURNS_SINCE(-> myKnot)"));r?(a._divertTargetToCount=r,a.AddContent(a._divertTargetToCount),a._divertTargetToCount.GenerateIntoContainer(e)):i&&(a._variableReferenceToCount=i,a.AddContent(a._variableReferenceToCount),a._variableReferenceToCount.GenerateIntoContainer(e)),a.isTurnsSince?e.AddContent(te.TurnsSince()):e.AddContent(te.ReadCount())}else if(a.isRandom){2!==a.args.length&&a.Error("RANDOM should take 2 parameters: a minimum and a maximum integer");for(var o=0;o<a.args.length;o+=1){var s=E(a.args[o],ae);if(s&&!s.isInt()){var l=0===o?"minimum":"maximum";a.Error("RANDOM's ".concat(l," parameter should be an integer"))}a.args[o].GenerateIntoContainer(e)}e.AddContent(te.Random())}else if(a.isSeedRandom){1!==a.args.length&&a.Error("SEED_RANDOM should take 1 parameter - an integer seed");var u=E(a.args[0],ae);u&&!u.isInt()&&a.Error("SEED_RANDOM's parameter should be an integer seed"),a.args[0].GenerateIntoContainer(e),e.AddContent(te.SeedRandom())}else if(a.isListRange){3!==a.args.length&&a.Error("LIST_RANGE should take 3 parameters - a list, a min and a max");for(var c=0;c<a.args.length;c+=1)a.args[c].GenerateIntoContainer(e);e.AddContent(te.ListRange())}else if(a.isListRandom)1!==a.args.length&&a.Error("LIST_RANDOM should take 1 parameter - a list"),a.args[0].GenerateIntoContainer(e),e.AddContent(te.ListRandom());else if(ie.CallExistsWithName(a.name)){var h=ie.CallWithName(a.name);if(h.numberOfParameters!==a.args.length){var f="".concat(name," should take ").concat(h.numberOfParameters," parameter");h.numberOfParameters>1&&(f+="s"),a.Error(f)}for(var d=0;d<a.args.length;d+=1)a.args[d].GenerateIntoContainer(e);e.AddContent(ie.CallWithName(a.name))}else if(null!==t)if(a.args.length>1&&a.Error("Can currently only construct a list from one integer (or an empty list from a given list definition)"),1===a.args.length)e.AddContent(new J(a.name)),a.args[0].GenerateIntoContainer(e),e.AddContent(te.ListFromInt());else{var p=new V;p.SetInitialOriginName(a.name),e.AddContent(new Z(p))}else e.AddContent(a._proxyDivert.runtimeObject),n=!0;n||a.content.splice(a.content.indexOf(a._proxyDivert),1),a.shouldPopReturnedValue&&e.AddContent(te.PopEvaluatedValue())},a.toString=function(){var e=a.args.join(", ");return"".concat(a.name,"(").concat(e,")")},a._proxyDivert=new $e(new Te(e),i),a._proxyDivert.isFunctionCall=!0,a.AddContent(a._proxyDivert),a}return i(r,[{key:"proxyDivert",get:function(){return this._proxyDivert}},{key:"name",get:function(){return this._proxyDivert.target.firstComponent||""}},{key:"args",get:function(){return this._proxyDivert.args}},{key:"runtimeDivert",get:function(){return this._proxyDivert.runtimeDivert}},{key:"isChoiceCount",get:function(){return"CHOICE_COUNT"===this.name}},{key:"isTurns",get:function(){return"TURNS"===this.name}},{key:"isTurnsSince",get:function(){return"TURNS_SINCE"===this.name}},{key:"isRandom",get:function(){return"RANDOM"===this.name}},{key:"isSeedRandom",get:function(){return"SEED_RANDOM"===this.name}},{key:"isListRange",get:function(){return"LIST_RANGE"===this.name}},{key:"isListRandom",get:function(){return"LIST_RANDOM"===this.name}},{key:"isReadCount",get:function(){return"READ_COUNT"===this.name}},{key:"typeName",get:function(){return"FunctionCall"}},{key:"ResolveReferences",value:function(e){if(v(o(r.prototype),"ResolveReferences",this).call(this,e),!this.content.includes(this._proxyDivert)&&null!==this.args){var t,n=b(this.args);try{for(n.s();!(t=n.n()).done;)t.value.ResolveReferences(e)}catch(e){n.e(e)}finally{n.f()}}if(this._divertTargetToCount){var i=this._divertTargetToCount.divert,a=null!=i.runtimeDivert.variableDivertName;if(a)return void this.Error("When getting the TURNS_SINCE() of a variable target, remove the '->' - i.e. it should just be TURNS_SINCE(".concat(i.runtimeDivert.variableDivertName,")"));var s=i.targetContent;if(null===s)a||this.Error("Failed to find target for TURNS_SINCE: '".concat(i.target,"'"));else{if(!s.containerForCounting)throw new Error;s.containerForCounting.turnIndexShouldBeCounted=!0}}else if(this._variableReferenceToCount){var l=this._variableReferenceToCount.runtimeVarRef;if(!l)throw new Error;null!==l.pathForCount&&this.Error("Should be '".concat(name,"'(-> '").concat(this._variableReferenceToCount.name,"). Usage without the '->' only makes sense for variable targets."))}}}]),r}(ne);Re.IsBuiltIn=function(e){return!!ie.CallExistsWithName(e)||"CHOICE_COUNT"===e||"TURNS_SINCE"===e||"TURNS"===e||"RANDOM"===e||"SEED_RANDOM"===e||"LIST_VALUE"===e||"LIST_RANDOM"===e||"READ_COUNT"===e};var De,Le=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this)).GenerateIntoContainer=function(e){var t,n=!0,r=b(i.subExpressions);try{for(r.s();!(t=r.n()).done;)t.value.GenerateIntoContainer(e),n||e.AddContent(ie.CallWithName("&&")),n=!1}catch(e){r.e(e)}finally{r.f()}},i.AddContent(e),i}return i(r,[{key:"subExpressions",get:function(){return this.content}},{key:"typeName",get:function(){return"MultipleConditionExpression"}}]),r}(ne),je=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this))._runtimeDivert=null,i._runtimeDivertTargetValue=null,i.GenerateIntoContainer=function(e){i.divert.GenerateRuntimeObject(),i._runtimeDivert=i.divert.runtimeDivert,i._runtimeDivertTargetValue=new Y,e.AddContent(i.runtimeDivertTargetValue)},i.Equals=function(e){var t=E(e,r);return!!(t&&i.divert.target&&t.divert.target)&&i.divert.target.dotSeparatedComponents===t.divert.target.dotSeparatedComponents},i.divert=i.AddContent(e),i}return i(r,[{key:"runtimeDivert",get:function(){if(!this._runtimeDivert)throw new Error;return this._runtimeDivert}},{key:"runtimeDivertTargetValue",get:function(){if(!this._runtimeDivertTargetValue)throw new Error;return this._runtimeDivertTargetValue}},{key:"typeName",get:function(){return"DivertTarget"}},{key:"ResolveReferences",value:function(e){if(v(o(r.prototype),"ResolveReferences",this).call(this,e),this.divert.isDone||this.divert.isEnd)this.Error("Can't use -> DONE or -> END as variable divert targets",this);else{for(var t=this;t&&t instanceof ne;){var n=!1,i=!1,a=t.parent;if(a instanceof se){var s=a;"=="!==s.opName&&"!="!==s.opName?n=!0:(s.leftExpression instanceof r||s.leftExpression instanceof We)&&(s.rightExpression instanceof r||s.rightExpression instanceof We)||(n=!0),i=!0}else if(a instanceof Re){var l=a;l.isTurnsSince||l.isReadCount||(n=!0),i=!0}else(a instanceof ne||a instanceof Le||a instanceof me&&a.condition===t||a instanceof ke||a instanceof Je)&&(n=!0,i=!0);if(n&&this.Error("Can't use a divert target like that. Did you intend to call '".concat(this.divert.target,"' as a function: likeThis(), or check the read count: likeThis, with no arrows?"),this),i)break;t=a}if(this.runtimeDivert.hasVariableTarget){if(!this.divert.target)throw new Error;this.Error("Since '".concat(this.divert.target.dotSeparatedComponents,"' is a variable, it shouldn't be preceded by '->' here."))}this.runtimeDivert.targetPath&&(this.runtimeDivertTargetValue.targetPath=this.runtimeDivert.targetPath);var u=this.divert.targetContent;if(null!==u){var c=u.containerForCounting;if(null!==c){var h=E(this.parent,Re);h&&h.isTurnsSince||(c.visitsShouldBeCounted=!0),c.turnIndexShouldBeCounted=!0}var f=E(u,Pe);if(null!=f&&null!==f.args){var d,p=b(f.args);try{for(p.s();!(d=p.n()).done;){var m=d.value;m.isByReference&&this.Error("Can't store a divert target to a knot or function that has by-reference arguments ('".concat(f.identifier,"' has 'ref ").concat(m.identifier,"')."))}}catch(e){p.e(e)}finally{p.f()}}}}}}]),r}(ne),$e=function(e){a(r,e);var t=d(r);function r(e,i){var a;return n(this,r),(a=t.call(this)).args=[],a.target=null,a.targetContent=null,a._runtimeDivert=null,a.isFunctionCall=!1,a.isEmpty=!1,a.isTunnel=!1,a.isThread=!1,a.GenerateRuntimeObject=function(){if(a.isEnd)return te.End();if(a.isDone)return te.Done();a.runtimeDivert=new pe,a.ResolveTargetContent(),a.CheckArgumentValidity();var e=null!==a.args&&a.args.length>0;if(e||a.isFunctionCall||a.isTunnel||a.isThread){var t=new ee;if(e){a.isFunctionCall||t.AddContent(te.EvalStart());var n=null;a.targetContent&&(n=a.targetContent.args);for(var r=0;r<a.args.length;++r){var i=a.args[r],o=null;if(n&&r<n.length&&(o=n[r]),o&&o.isByReference){var s=E(i,We);if(!s){a.Error("Expected variable name to pass by reference to 'ref ".concat(o.identifier,"' but saw ").concat(i));break}var l=new Te(s.pathIdentifiers);if(l.ResolveFromContext(h(a))){a.Error("can't pass a read count by reference. '".concat(l.dotSeparatedComponents,"' is a knot/stitch/label, but '").concat(a.target.dotSeparatedComponents,"' requires the name of a VAR to be passed."));break}var u=new X(s.name);t.AddContent(u)}else i.GenerateIntoContainer(t)}a.isFunctionCall||t.AddContent(te.EvalEnd())}return a.isThread?t.AddContent(te.StartThread()):(a.isFunctionCall||a.isTunnel)&&(a.runtimeDivert.pushesToStack=!0,a.runtimeDivert.stackPushType=a.isFunctionCall?ce.Function:ce.Tunnel),t.AddContent(a.runtimeDivert),t}return a.runtimeDivert},a.PathAsVariableName=function(){return a.target?a.target.firstComponent:null},a.ResolveTargetContent=function(){if(!a.isEmpty&&!a.isEnd&&null===a.targetContent){var e=a.PathAsVariableName();if(null!==e){var t=E(Ne(h(a)),Pe);if(t){var n=t.ResolveVariableWithName(e,h(a));if(n.found){if(n.isArgument&&n.ownerFlow&&n.ownerFlow.args){var r=n.ownerFlow.args.find((function(t){var n;return(null===(n=t.identifier)||void 0===n?void 0:n.name)==e}));r&&!r.isDivertTarget&&a.Error("Since '".concat(r.identifier,"' is used as a variable divert target (on ").concat(a.debugMetadata,"), it should be marked as: -> ").concat(r.identifier),n.ownerFlow)}return void(a.runtimeDivert.variableDivertName=e)}}}if(!a.target)throw new Error;a.targetContent=a.target.ResolveFromContext(h(a))}},a.CheckArgumentValidity=function(){if(!a.isEmpty){var e=0;if(null!==a.args&&a.args.length>0&&(e=a.args.length),null!==a.targetContent){var t=E(a.targetContent,Pe);if(0!==e||null!==t&&t.hasParameters)if(null===t&&e>0)a.Error("target needs to be a knot or stitch in order to pass arguments");else if(null!==t&&(null===t.args||!t.args&&e>0))a.Error("target (".concat(t.name,") doesn't take parameters"));else if(a.parent instanceof je)e>0&&a.Error("can't store arguments in a divert target variable");else{var n,r=t.args.length;if(r!==e)return n=0===e?"but there weren't any passed to it":e<r?"but only got ".concat(e):"but got ".concat(e),void a.Error("to '".concat(t.identifier,"' requires ").concat(r," arguments, ").concat(n));for(var i=0;i<r;++i){var o=t.args[i],s=a.args[i];if(o.isDivertTarget){var l=E(s,We);if(s instanceof je||null!==l){if(l){var u=new Te(l.pathIdentifiers);u.ResolveFromContext(l)&&a.Error("Passing read count of '".concat(u.dotSeparatedComponents,"' instead of a divert target. You probably meant '").concat(u,"'"))}}else a.Error("Target '".concat(t.identifier,"' expects a divert target for the parameter named -> ").concat(o.identifier," but saw ").concat(s),s)}}null!==t||a.Error("Can't call as a function or with arguments unless it's a knot or stitch")}}}},a.CheckExternalArgumentValidity=function(e){var t=a.target?a.target.firstComponent:null,n=e.externals.get(t);if(!n)throw new Error("external not found");var r=n.argumentNames.length,i=0;a.args&&(i=a.args.length),i!==r&&a.Error("incorrect number of arguments sent to external function '".concat(t,"'. Expected ").concat(r," but got ").concat(i))},a.toString=function(){var e="";return null===a.target?"-> <empty divert>":(e+=a.target.toString(),a.isTunnel&&(e+=" ->"),a.isFunctionCall&&(e+=" ()"),e)},e&&(a.target=e),i&&(a.args=i,a.AddContent(i)),a}return i(r,[{key:"runtimeDivert",get:function(){if(!this._runtimeDivert)throw new Error;return this._runtimeDivert},set:function(e){this._runtimeDivert=e}},{key:"isEnd",get:function(){return Boolean(this.target&&"END"===this.target.dotSeparatedComponents)}},{key:"isDone",get:function(){return Boolean(this.target&&"DONE"===this.target.dotSeparatedComponents)}},{key:"typeName",get:function(){return"Divert"}},{key:"ResolveReferences",value:function(e){if(!(this.isEmpty||this.isEnd||this.isDone)){if(!this.runtimeDivert)throw new Error;this.targetContent&&(this.runtimeDivert.targetPath=this.targetContent.runtimePath),v(o(r.prototype),"ResolveReferences",this).call(this,e);var t=E(this.targetContent,Pe);t&&(!t.isFunction&&this.isFunctionCall?v(o(r.prototype),"Error",this).call(this,"".concat(t.identifier," hasn't been marked as a function, but it's being called as one. Do you need to delcare the knot as '== function ").concat(t.identifier," =='?")):!t.isFunction||this.isFunctionCall||this.parent instanceof je||v(o(r.prototype),"Error",this).call(this,t.identifier+" can't be diverted to. It can only be called as a function since it's been marked as such: '"+t.identifier+"(...)'"));var n=null!==this.targetContent,i=!1,a=!1;if(!this.target)throw new Error;if(1===this.target.numberOfComponents){if(!this.target.firstComponent)throw new Error;if(i=Re.IsBuiltIn(this.target.firstComponent),a=e.IsExternal(this.target.firstComponent),i||a)return this.isFunctionCall||v(o(r.prototype),"Error",this).call(this,"".concat(this.target.firstComponent," must be called as a function: ~ ").concat(this.target.firstComponent,"()")),void(a&&(this.runtimeDivert.isExternal=!0,null!==this.args&&(this.runtimeDivert.externalArgs=this.args.length),this.runtimeDivert.pushesToStack=!1,this.runtimeDivert.targetPath=new R(this.target.firstComponent),this.CheckExternalArgumentValidity(e)))}null==this.runtimeDivert.variableDivertName&&(n||i||a||this.Error("target not found: '".concat(this.target,"'")))}}},{key:"Error",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];t!==this&&t?v(o(r.prototype),"Error",this).call(this,e,t):this.isFunctionCall?v(o(r.prototype),"Error",this).call(this,"Function call ".concat(e),t,n):v(o(r.prototype),"Error",this).call(this,"Divert ".concat(e),t,n)}}]),r}(F),Me=i((function e(t,r){n(this,e),this.divert=t,this.targetRuntimeObj=r})),Ve=i((function e(t,r){n(this,e),this.divert=t,this.targetContent=r}));!function(e){e[e.Stopping=1]="Stopping",e[e.Cycle=2]="Cycle",e[e.Shuffle=4]="Shuffle",e[e.Once=8]="Once"}(De||(De={}));var Be,Ge=function(e){a(r,e);var t=d(r);function r(e,i){var a;n(this,r),(a=t.call(this)).sequenceType=i,a._sequenceDivertsToResolve=[],a.GenerateRuntimeObject=function(){var e=new ee;e.visitsShouldBeCounted=!0,e.countingAtStartOnly=!0,a._sequenceDivertsToResolve=[],e.AddContent(te.EvalStart()),e.AddContent(te.VisitIndex());var t=(a.sequenceType&De.Once)>0,n=(a.sequenceType&De.Cycle)>0,r=(a.sequenceType&De.Stopping)>0,i=(a.sequenceType&De.Shuffle)>0,o=a.sequenceElements.length;if(t&&(o+=1),r||t?(e.AddContent(new K(o-1)),e.AddContent(ie.CallWithName("MIN"))):n&&(e.AddContent(new K(a.sequenceElements.length)),e.AddContent(ie.CallWithName("%"))),i){var s=te.NoOp();if(t||r){var l=r?a.sequenceElements.length-1:a.sequenceElements.length;e.AddContent(te.Duplicate()),e.AddContent(new K(l)),e.AddContent(ie.CallWithName("=="));var u=new pe;u.isConditional=!0,e.AddContent(u),a.AddDivertToResolve(u,s)}var c=a.sequenceElements.length;r&&(c-=1),e.AddContent(new K(c)),e.AddContent(te.SequenceShuffleIndex()),(t||r)&&e.AddContent(s)}e.AddContent(te.EvalEnd());for(var h=te.NoOp(),f=0;f<o;f+=1){e.AddContent(te.EvalStart()),e.AddContent(te.Duplicate()),e.AddContent(new K(f)),e.AddContent(ie.CallWithName("==")),e.AddContent(te.EvalEnd());var d=new pe;d.isConditional=!0,e.AddContent(d);var p=void 0;(p=f<a.sequenceElements.length?a.sequenceElements[f].runtimeObject:new ee).name="s".concat(f),p.InsertContent(te.PopEvaluatedValue(),0);var v=new pe;p.AddContent(v),e.AddToNamedContentOnly(p),a.AddDivertToResolve(d,p),a.AddDivertToResolve(v,h)}return e.AddContent(h),e},a.AddDivertToResolve=function(e,t){a._sequenceDivertsToResolve.push(new Ve(e,t))},a.sequenceType=i,a.sequenceElements=[];var o,s=b(e);try{for(s.s();!(o=s.n()).done;){var l=o.value,u=l.content,c=null;c=null===u||0===u.length?l:new ze(u),a.sequenceElements.push(c),a.AddContent(c)}}catch(e){s.e(e)}finally{s.f()}return a}return i(r,[{key:"typeName",get:function(){return"Sequence"}},{key:"ResolveReferences",value:function(e){v(o(r.prototype),"ResolveReferences",this).call(this,e);var t,n=b(this._sequenceDivertsToResolve);try{for(n.s();!(t=n.n()).done;){var i=t.value;i.divert.targetPath=i.targetContent.path}}catch(e){n.e(e)}finally{n.f()}}}]),r}(F),qe=function(e){a(r,e);var t=d(r);function r(){var e;return n(this,r),(e=t.apply(this,arguments))._overrideDivertTarget=null,e._divertAfter=null,e.GenerateRuntimeObject=function(){var t=new ee;if(t.AddContent(te.EvalStart()),e.divertAfter){var n=e.divertAfter.GenerateRuntimeObject();if(n){var r=e.divertAfter.args;if(null!==r&&r.length>0){for(var i=-1,a=-1,o=0;o<n.content.length;o+=1){var s=n.content[o];s&&(-1==i&&s.commandType===te.CommandType.EvalStart?i=o:s.commandType===te.CommandType.EvalEnd&&(a=o))}for(var l=i+1;l<a;l+=1)n.content[l].parent=null,t.AddContent(n.content[l])}}e._overrideDivertTarget=new Y,t.AddContent(e._overrideDivertTarget)}else t.AddContent(new re);return t.AddContent(te.EvalEnd()),t.AddContent(te.PopTunnel()),t},e.toString=function(){return" -> ".concat(e._divertAfter)},e}return i(r,[{key:"divertAfter",get:function(){return this._divertAfter},set:function(e){this._divertAfter=e,this._divertAfter&&this.AddContent(this._divertAfter)}},{key:"typeName",get:function(){return"TunnelOnwards"}},{key:"ResolveReferences",value:function(e){v(o(r.prototype),"ResolveReferences",this).call(this,e),this.divertAfter&&this.divertAfter.targetContent&&(this._overrideDivertTarget.targetPath=this.divertAfter.targetContent.runtimePath)}}]),r}(F),He=function(){function e(t,r){n(this,e),this._name=t||"",this._items=null,this._itemNameToValues=r||new Map}return i(e,[{key:"name",get:function(){return this._name}},{key:"items",get:function(){if(null==this._items){this._items=new Map;var e,t=b(this._itemNameToValues);try{for(t.s();!(e=t.n()).done;){var n=m(e.value,2),r=n[0],i=n[1],a=new M(this.name,r);this._items.set(a.serialized(),i)}}catch(e){t.e(e)}finally{t.f()}}return this._items}},{key:"ValueForItem",value:function(e){if(!e.itemName)return 0;var t=this._itemNameToValues.get(e.itemName);return void 0!==t?t:0}},{key:"ContainsItem",value:function(e){return!!e.itemName&&e.originName==this.name&&this._itemNameToValues.has(e.itemName)}},{key:"ContainsItemWithName",value:function(e){return this._itemNameToValues.has(e)}},{key:"TryGetItemWithValue",value:function(e,t){var n,r=b(this._itemNameToValues);try{for(r.s();!(n=r.n()).done;){var i=m(n.value,2),a=i[0];if(i[1]==e)return{result:new M(this.name,a),exists:!0}}}catch(e){r.e(e)}finally{r.f()}return{result:M.Null,exists:!1}}},{key:"TryGetValueForItem",value:function(e,t){if(!e.itemName)return{result:0,exists:!1};var n=this._itemNameToValues.get(e.itemName);return n?{result:n,exists:!0}:{result:0,exists:!1}}}]),e}(),Ue=function(e){a(r,e);var t=d(r);function r(e){var i;n(this,r),(i=t.call(this)).itemDefinitions=e,i.identifier=null,i.variableAssignment=null,i._elementsByName=null,i.ItemNamed=function(e){if(null===i._elementsByName){i._elementsByName=new Map;var t,n=b(i.itemDefinitions);try{for(n.s();!(t=n.n()).done;){var r=t.value;i._elementsByName.set(r.name,r)}}catch(e){n.e(e)}finally{n.f()}}return i._elementsByName.get(e)||null},i.GenerateRuntimeObject=function(){var e,t,n,r=new V,a=b(i.itemDefinitions);try{for(a.s();!(n=a.n()).done;){var o=n.value;if(o.inInitialList){var s=new M((null===(e=i.identifier)||void 0===e?void 0:e.name)||null,o.name||null);r.Add(s,o.seriesValue)}}}catch(e){a.e(e)}finally{a.f()}return r.SetInitialOriginName((null===(t=i.identifier)||void 0===t?void 0:t.name)||""),new Z(r)};var a,o=1,s=b(i.itemDefinitions);try{for(s.s();!(a=s.n()).done;){var l=a.value;null!==l.explicitValue&&(o=l.explicitValue),l.seriesValue=o,o+=1}}catch(e){s.e(e)}finally{s.f()}return i.AddContent(e),i}return i(r,[{key:"typeName",get:function(){return"ListDefinition"}},{key:"runtimeListDefinition",get:function(){var e,t,n=new Map,r=b(this.itemDefinitions);try{for(r.s();!(t=r.n()).done;){var i=t.value;n.has(i.name)?this.Error("List '".concat(this.identifier,"' contains duplicate items called '").concat(i.name,"'")):n.set(i.name,i.seriesValue)}}catch(e){r.e(e)}finally{r.f()}return new He((null===(e=this.identifier)||void 0===e?void 0:e.name)||"",n)}},{key:"ResolveReferences",value:function(e){v(o(r.prototype),"ResolveReferences",this).call(this,e),e.CheckForNamingCollisions(this,this.identifier,fe.List)}}]),r}(F),Ke=function(e){a(r,e);var t=d(r);function r(e){var i,a=e.assignedExpression,o=e.isGlobalDeclaration,s=e.isTemporaryNewDeclaration,l=e.listDef,u=e.variableIdentifier;return n(this,r),(i=t.call(this))._runtimeAssignment=null,i.expression=null,i.listDefinition=null,i.GenerateRuntimeObject=function(){var e=null;if(i.isGlobalDeclaration?e=i.story:i.isNewTemporaryDeclaration&&(e=Ne(h(i))),e&&e.AddNewVariableDeclaration(h(i)),i.isGlobalDeclaration)return null;var t=new ee;return i.expression?t.AddContent(i.expression.runtimeObject):i.listDefinition&&t.AddContent(i.listDefinition.runtimeObject),i._runtimeAssignment=new ve(i.variableName,i.isNewTemporaryDeclaration),t.AddContent(i._runtimeAssignment),t},i.toString=function(){return"".concat(i.isGlobalDeclaration?"VAR":i.isNewTemporaryDeclaration?"~ temp":""," ").concat(i.variableName)},i.variableIdentifier=u,i.isGlobalDeclaration=Boolean(o),i.isNewTemporaryDeclaration=Boolean(s),l instanceof Ue?(i.listDefinition=i.AddContent(l),i.listDefinition.variableAssignment=h(i),i.isGlobalDeclaration=!0):a&&(i.expression=i.AddContent(a)),i}return i(r,[{key:"variableName",get:function(){return this.variableIdentifier.name}},{key:"typeName",get:function(){return this.isNewTemporaryDeclaration?"temp":this.isGlobalDeclaration?null!==this.listDefinition?"LIST":"VAR":"variable assignment"}},{key:"isDeclaration",get:function(){return this.isGlobalDeclaration||this.isNewTemporaryDeclaration}},{key:"ResolveReferences",value:function(e){if(v(o(r.prototype),"ResolveReferences",this).call(this,e),this.isDeclaration&&null===this.listDefinition&&e.CheckForNamingCollisions(this,this.variableIdentifier,this.isGlobalDeclaration?fe.Var:fe.Temp),this.isGlobalDeclaration){var t=E(this.expression,We);!t||t.isConstantReference||t.isListItemReference||this.Error("global variable assignments cannot refer to other variables, only literal values, constants and list items")}if(!this.isNewTemporaryDeclaration){var n=e.ResolveVariableWithName(this.variableName,this);n.found||(this.variableName in this.story.constants?this.Error("Can't re-assign to a constant (do you need to use VAR when declaring '".concat(this.variableName,"'?)"),this):this.Error("Variable could not be found to assign to: '".concat(this.variableName,"'"),this)),this._runtimeAssignment&&(this._runtimeAssignment.isGlobal=n.isGlobal)}}}]),r}(F),ze=function(e){a(r,e);var t=d(r);function r(e){var i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;return n(this,r),(i=t.call(this)).previousWeavePoint=null,i.addContentToPreviousWeavePoint=!1,i.hasSeenChoiceInSection=!1,i.currentContainer=null,i._unnamedGatherCount=0,i._choiceCount=0,i._rootContainer=null,i._namedWeavePoints=new Map,i.looseEnds=[],i.gatherPointsToResolve=[],i.ResolveWeavePointNaming=function(){var e,t,n,r=[].concat(y(i.FindAll(_e)((function(e){return!(null===e.name||void 0===e.name)}))),y(i.FindAll(me)((function(e){return!(null===e.name||void 0===e.name)}))));i._namedWeavePoints=new Map;var a,o=b(r);try{for(o.s();!(a=o.n()).done;){var s=a.value,l=i.namedWeavePoints.get((null===(e=s.identifier)||void 0===e?void 0:e.name)||"");if(l){var u=l instanceof _e?"gather":"choice",c=l;i.Error("A ".concat(u," with the same label name '").concat(s.name,"' already exists in this context on line ").concat(c.debugMetadata?c.debugMetadata.startLineNumber:"NO DEBUG METADATA AVAILABLE"),s)}(null===(t=s.identifier)||void 0===t?void 0:t.name)&&i.namedWeavePoints.set(null===(n=s.identifier)||void 0===n?void 0:n.name,s)}}catch(e){o.e(e)}finally{o.f()}},i.ConstructWeaveHierarchyFromIndentation=function(){for(var e=0;e<i.content.length;){var t=i.content[e];if(t instanceof me||t instanceof _e){var n=t.indentationDepth-1;if(n>i.baseIndentIndex){for(var a=e;e<i.content.length;){var o=E(i.content[e],me)||E(i.content[e],_e);if(null!==o&&o.indentationDepth-1<=i.baseIndentIndex)break;e+=1}var s=e-a,l=i.content.slice(a,a+s);i.content.splice(a,s);var u=new r(l,n);i.InsertContent(a,u),e=a}}e+=1}},i.DetermineBaseIndentationFromContent=function(e){var t,n=b(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r instanceof me||r instanceof _e)return r.indentationDepth-1}}catch(e){n.e(e)}finally{n.f()}return 0},i.GenerateRuntimeObject=function(){i._rootContainer=new ee,i.currentContainer=i._rootContainer,i.looseEnds=[],i.gatherPointsToResolve=[];var e,t=b(i.content);try{for(t.s();!(e=t.n()).done;){var n=e.value;if(n instanceof me||n instanceof _e)i.AddRuntimeForWeavePoint(n);else if(n instanceof r){var a,o=n;i.AddRuntimeForNestedWeave(o),(a=i.gatherPointsToResolve).splice.apply(a,[0,0].concat(y(o.gatherPointsToResolve)))}else i.AddGeneralRuntimeContent(n.runtimeObject)}}catch(e){t.e(e)}finally{t.f()}return i.PassLooseEndsToAncestors(),i._rootContainer},i.AddRuntimeForGather=function(e){var t=!i.hasSeenChoiceInSection;i.hasSeenChoiceInSection=!1;var n=e.runtimeContainer;if(e.name||(n.name="g-".concat(i._unnamedGatherCount),i._unnamedGatherCount+=1),t){if(!i.currentContainer)throw new Error;i.currentContainer.AddContent(n)}else i.rootContainer.AddToNamedContentOnly(n);var r,a=b(i.looseEnds);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(!(o instanceof _e&&o.indentationDepth==e.indentationDepth)){var s=null;if(o instanceof $e)s=o.runtimeObject;else{s=new pe;var l=o;if(!l.runtimeContainer)throw new Error;l.runtimeContainer.AddContent(s)}i.gatherPointsToResolve.push(new Me(s,n))}}}catch(e){a.e(e)}finally{a.f()}i.looseEnds=[],i.currentContainer=n},i.AddRuntimeForWeavePoint=function(e){if(e instanceof _e)i.AddRuntimeForGather(e);else if(e instanceof me){if(!i.currentContainer)throw new Error;i.previousWeavePoint instanceof _e&&i.looseEnds.splice(i.looseEnds.indexOf(i.previousWeavePoint),1);var t=e;if(i.currentContainer.AddContent(t.runtimeObject),!t.innerContentContainer)throw new Error;t.innerContentContainer.name="c-".concat(i._choiceCount),i.currentContainer.AddToNamedContentOnly(t.innerContentContainer),i._choiceCount+=1,i.hasSeenChoiceInSection=!0}i.addContentToPreviousWeavePoint=!1,i.WeavePointHasLooseEnd(e)&&(i.looseEnds.push(e),E(e,me)&&(i.addContentToPreviousWeavePoint=!0)),i.previousWeavePoint=e},i.AddRuntimeForNestedWeave=function(e){i.AddGeneralRuntimeContent(e.rootContainer),null!==i.previousWeavePoint&&(i.looseEnds.splice(i.looseEnds.indexOf(i.previousWeavePoint),1),i.addContentToPreviousWeavePoint=!1)},i.AddGeneralRuntimeContent=function(e){if(null!==e)if(i.addContentToPreviousWeavePoint){if(!i.previousWeavePoint||!i.previousWeavePoint.runtimeContainer)throw new Error;i.previousWeavePoint.runtimeContainer.AddContent(e)}else{if(!i.currentContainer)throw new Error;i.currentContainer.AddContent(e)}},i.PassLooseEndsToAncestors=function(){if(0!==i.looseEnds.length){for(var e=null,t=null,n=!1,a=i.parent;null!==a;a=a.parent){var o=E(a,r);o&&(n||null!==e||(e=o),n&&null===t&&(t=o)),(a instanceof Ge||a instanceof ke)&&(n=!0)}if(null!==e||null!==t)for(var s=i.looseEnds.length-1;s>=0;s-=1){var l=i.looseEnds[s],u=!1;if(n){if(l instanceof me&&null!==e)e.ReceiveLooseEnd(l),u=!0;else if(!(l instanceof me)){var c=e||t;null!==c&&(c.ReceiveLooseEnd(l),u=!0)}}else(null==e?void 0:e.hasOwnProperty("ReceiveLooseEnd"))&&e.ReceiveLooseEnd(l),u=!0;u&&i.looseEnds.splice(s,1)}}},i.ReceiveLooseEnd=function(e){i.looseEnds.push(e)},i.WeavePointNamed=function(e){return i.namedWeavePoints&&i.namedWeavePoints.get(e)||null},i.IsGlobalDeclaration=function(e){var t=E(e,Ke);return!!(t&&t.isGlobalDeclaration&&t.isDeclaration)||!!E(e,Ee)},i.ContentThatFollowsWeavePoint=function(e){var t=[],n=e;if(null!==n.content){var a,o=b(n.content);try{for(o.s();!(a=o.n()).done;){var s=a.value;i.IsGlobalDeclaration(s)||t.push(s)}}catch(e){o.e(e)}finally{o.f()}}var l=E(n.parent,r);if(null===l)throw new Error("Expected weave point parent to be weave?");for(var u=l.content.indexOf(n)+1;u<l.content.length;u+=1){var c=l.content[u];if(!i.IsGlobalDeclaration(c)){if(c instanceof me||c instanceof _e)break;if(c instanceof r)break;t.push(c)}}return t},i.ValidateTermination=function(e){if(!(i.lastParsedSignificantObject instanceof W))if(null!==i.looseEnds&&i.looseEnds.length>0){var t,n=b(i.looseEnds);try{for(n.s();!(t=n.n()).done;){var r=t.value,a=i.ContentThatFollowsWeavePoint(r);i.ValidateFlowOfObjectsTerminates(a,r,e)}}catch(e){n.e(e)}finally{n.f()}}else{var o,s=b(i.content);try{for(s.s();!(o=s.n()).done;){var l=o.value;if(l instanceof me||l instanceof $e)return}}catch(e){s.e(e)}finally{s.f()}i.ValidateFlowOfObjectsTerminates(i.content,h(i),e)}},i.BadNestedTerminationHandler=function(e){for(var t=null,n=e.parent;null!==n;n=n.parent)if(n instanceof Ge||n instanceof ke){t=E(n,ke);break}var r="Choices nested in conditionals or sequences need to explicitly divert afterwards.";null!==t&&1===t.FindAll(me)().length&&(r="Choices with conditions should be written: '* {condition} choice'. Otherwise, ".concat(r.toLowerCase())),i.Error(r,e)},i.ValidateFlowOfObjectsTerminates=function(e,t,n){var r,i=!1,a=t,o=b(e);try{for(o.s();!(r=o.n()).done;){var s=r.value;if(null!==s.Find($e)((function(e){return!(e.isThread||e.isTunnel||e.isFunctionCall||e.parent instanceof je)}))&&(i=!0),null!=s.Find(qe)()){i=!0;break}a=s}}catch(e){o.e(e)}finally{o.f()}if(!i){if(a instanceof W)return;n(a)}},i.WeavePointHasLooseEnd=function(e){if(null===e.content)return!0;for(var t=e.content.length-1;t>=0;--t){var n=E(e.content[t],$e);if(n&&!(n.isThread||n.isTunnel||n.isFunctionCall))return!1}return!0},i.CheckForWeavePointNamingCollisions=function(){if(i.namedWeavePoints){var e,t=[],n=b(i.ancestry);try{for(n.s();!(e=n.n()).done;){var r=E(e.value,Pe);if(!r)break;t.push(r)}}catch(e){n.e(e)}finally{n.f()}var a,o=b(i.namedWeavePoints);try{for(o.s();!(a=o.n()).done;){var s,l=m(a.value,2),u=l[0],c=l[1],h=b(t);try{for(h.s();!(s=h.n()).done;){var f=s.value.ContentWithNameAtLevel(u);if(f&&f!==c){var d="".concat(c.GetType()," '").concat(u,"' has the same label name as a ").concat(f.GetType()," (on ").concat(f.debugMetadata,")");i.Error(d,c)}}}catch(e){h.e(e)}finally{h.f()}}}catch(e){o.e(e)}finally{o.f()}}},i.baseIndentIndex=-1==a?i.DetermineBaseIndentationFromContent(e):a,i.AddContent(e),i.ConstructWeaveHierarchyFromIndentation(),i}return i(r,[{key:"rootContainer",get:function(){return this._rootContainer||(this._rootContainer=this.GenerateRuntimeObject()),this._rootContainer}},{key:"namedWeavePoints",get:function(){return this._namedWeavePoints}},{key:"lastParsedSignificantObject",get:function(){if(0===this.content.length)return null;for(var e=null,t=this.content.length-1;t>=0;--t){var n=E(e=this.content[t],xe);if(!(n&&"\n"===n.text||this.IsGlobalDeclaration(e)))break}var i=E(e,r);return i&&(e=i.lastParsedSignificantObject),e}},{key:"typeName",get:function(){return"Weave"}},{key:"ResolveReferences",value:function(e){if(v(o(r.prototype),"ResolveReferences",this).call(this,e),null!==this.looseEnds&&this.looseEnds.length>0){for(var t=!1,n=this.parent;null!==n;n=n.parent)if(n instanceof Ge||n instanceof ke){t=!0;break}t&&this.ValidateTermination(this.BadNestedTerminationHandler)}var i,a=b(this.gatherPointsToResolve);try{for(a.s();!(i=a.n()).done;){var s=i.value;s.divert.targetPath=s.targetRuntimeObj.path}}catch(e){a.e(e)}finally{a.f()}this.CheckForWeavePointNamingCollisions()}}]),r}(F),Je=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this))._contentContainer=null,i._conditionalDivert=null,i._ownExpression=null,i._innerWeave=null,i.isTrueBranch=!1,i.matchingEquality=!1,i.isElse=!1,i.isInline=!1,i.returnDivert=null,i.GenerateRuntimeObject=function(){if(i._innerWeave){var e,t=b(i._innerWeave.content);try{for(t.s();!(e=t.n()).done;){var n=E(e.value,xe);n&&n.text.startsWith("else:")&&i.Warning("Saw the text 'else:' which is being treated as content. Did you mean '- else:'?",n)}}catch(e){t.e(e)}finally{t.f()}}var r=new ee,a=i.matchingEquality&&!i.isElse;if(a&&r.AddContent(te.Duplicate()),i._conditionalDivert=new pe,i._conditionalDivert.isConditional=!i.isElse,!i.isTrueBranch&&!i.isElse){var o=null!==i.ownExpression;o&&r.AddContent(te.EvalStart()),i.ownExpression&&i.ownExpression.GenerateIntoContainer(r),i.matchingEquality&&r.AddContent(ie.CallWithName("==")),o&&r.AddContent(te.EvalEnd())}return r.AddContent(i._conditionalDivert),i._contentContainer=i.GenerateRuntimeForContent(),i._contentContainer.name="b",i.isInline||i._contentContainer.InsertContent(new J("\n"),0),(a||i.isElse&&i.matchingEquality)&&i._contentContainer.InsertContent(te.PopEvaluatedValue(),0),r.AddToNamedContentOnly(i._contentContainer),i.returnDivert=new pe,i._contentContainer.AddContent(i.returnDivert),r},i.GenerateRuntimeForContent=function(){return null===i._innerWeave?new ee:i._innerWeave.rootContainer},e&&(i._innerWeave=new ze(e),i.AddContent(i._innerWeave)),i}return i(r,[{key:"ownExpression",get:function(){return this._ownExpression},set:function(e){this._ownExpression=e,this._ownExpression&&this.AddContent(this._ownExpression)}},{key:"typeName",get:function(){return"ConditionalSingleBranch"}},{key:"ResolveReferences",value:function(e){if(!this._conditionalDivert||!this._contentContainer)throw new Error;this._conditionalDivert.targetPath=this._contentContainer.path,v(o(r.prototype),"ResolveReferences",this).call(this,e)}}]),r}(F);!function(e){e[e.ParsingString=1]="ParsingString"}(Be||(Be={}));var Ye,Xe=function(){function e(){n(this,e),this.startLineNumber=0,this.endLineNumber=0,this.startCharacterNumber=0,this.endCharacterNumber=0,this.fileName=null,this.sourceName=null}return i(e,[{key:"Merge",value:function(t){var n=new e;return n.fileName=this.fileName,n.sourceName=this.sourceName,this.startLineNumber<t.startLineNumber?(n.startLineNumber=this.startLineNumber,n.startCharacterNumber=this.startCharacterNumber):this.startLineNumber>t.startLineNumber?(n.startLineNumber=t.startLineNumber,n.startCharacterNumber=t.startCharacterNumber):(n.startLineNumber=this.startLineNumber,n.startCharacterNumber=Math.min(this.startCharacterNumber,t.startCharacterNumber)),this.endLineNumber>t.endLineNumber?(n.endLineNumber=this.endLineNumber,n.endCharacterNumber=this.endCharacterNumber):this.endLineNumber<t.endLineNumber?(n.endLineNumber=t.endLineNumber,n.endCharacterNumber=t.endCharacterNumber):(n.endLineNumber=this.endLineNumber,n.endCharacterNumber=Math.max(this.endCharacterNumber,t.endCharacterNumber)),n}},{key:"toString",value:function(){return null!==this.fileName?"line ".concat(this.startLineNumber," of ").concat(this.fileName,'"'):"line "+this.startLineNumber}}]),e}(),Ze=function(e){a(r,e);var t=d(r);function r(e,i){var a;return n(this,r),(a=t.call(this)).identifier=e,a.argumentNames=i,a.GenerateRuntimeObject=function(){return a.story.AddExternal(h(a)),null},a}return i(r,[{key:"name",get:function(){var e;return(null===(e=this.identifier)||void 0===e?void 0:e.name)||null}},{key:"typeName",get:function(){return"EXTERNAL"}},{key:"toString",value:function(){var e;return"EXTERNAL ".concat(null===(e=this.identifier)||void 0===e?void 0:e.name)}}]),r}(F),Qe=i((function e(t,r,i){n(this,e),this.name=t,this.args=r,this.isFunction=i})),et=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this))._objToWrap=e,i.GenerateRuntimeObject=function(){return i._objToWrap},i}return i(r)}(F),tt=function(e){a(r,e);var t=d(r);function r(e){return n(this,r),t.call(this,e)}return i(r,[{key:"typeName",get:function(){return"Glue"}}]),r}(et),nt=function(e){a(r,e);var t=d(r);function r(){return n(this,r),t.apply(this,arguments)}return i(r,[{key:"toString",value:function(){return"Glue"}}]),r}(j),rt=function(e){a(r,e);var t=d(r);function r(e,i,a){var o;return n(this,r),(o=t.call(this)).varIdentifier=e,o._runtimeAssignment=null,o.expression=null,o.GenerateIntoContainer=function(e){var t,n;e.AddContent(new Fe((null===(t=o.varIdentifier)||void 0===t?void 0:t.name)||null)),o.expression?o.expression.GenerateIntoContainer(e):e.AddContent(new K(1)),e.AddContent(ie.CallWithName(o.isInc?"+":"-")),o._runtimeAssignment=new ve((null===(n=o.varIdentifier)||void 0===n?void 0:n.name)||null,!1),e.AddContent(o._runtimeAssignment)},o.toString=function(){var e,t;return o.expression?"".concat(null===(e=o.varIdentifier)||void 0===e?void 0:e.name).concat(o.isInc?" += ":" -= ").concat(o.expression):"".concat(null===(t=o.varIdentifier)||void 0===t?void 0:t.name)+(o.isInc?"++":"--")},i instanceof ne?(o.expression=i,o.AddContent(o.expression),o.isInc=Boolean(a)):o.isInc=i,o}return i(r,[{key:"typeName",get:function(){return"IncDecExpression"}},{key:"ResolveReferences",value:function(e){var t;v(o(r.prototype),"ResolveReferences",this).call(this,e);var n=e.ResolveVariableWithName((null===(t=this.varIdentifier)||void 0===t?void 0:t.name)||"",this);if(n.found||this.Error("variable for ".concat(this.incrementDecrementWord," could not be found: '").concat(this.varIdentifier,"' after searching: {this.descriptionOfScope}")),!this._runtimeAssignment)throw new Error;this._runtimeAssignment.isGlobal=n.isGlobal,this.parent instanceof ze||this.parent instanceof Pe||this.parent instanceof Ie||this.Error("Can't use ".concat(this.incrementDecrementWord," as sub-expression"))}},{key:"incrementDecrementWord",get:function(){return this.isInc?"increment":"decrement"}}]),r}(ne),it=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this)).includedStory=e,i.GenerateRuntimeObject=function(){return null},i}return i(r)}(F),at=i((function e(t,r,i){var a=this;n(this,e),this.type=t,this.precedence=r,this.requireWhitespace=i,this.toString=function(){return a.type}})),ot=function(e){a(r,e);var t=d(r);function r(e,i,a,o){return n(this,r),t.call(this,e,i,a,o)}return i(r,[{key:"flowLevel",get:function(){return we.Knot}},{key:"typeName",get:function(){return this.isFunction?"Function":"Knot"}},{key:"ResolveReferences",value:function(e){v(o(r.prototype),"ResolveReferences",this).call(this,e);var t=this.story;for(var n in this.subFlowsByName){var i=t.ContentWithNameAtLevel(n,we.Knot,!1);if(i){var a=this.subFlowsByName.get(n),s="Stitch '".concat(a?a.name:"NO STITCH FOUND","' has the same name as a knot (on ").concat(i.debugMetadata,")");this.Error(s,a)}}}}]),r}(Pe),st=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this)).itemIdentifierList=e,i.GenerateIntoContainer=function(e){var t,n,r=new V;if(null!=i.itemIdentifierList){var a,o=b(i.itemIdentifierList);try{for(o.s();!(a=o.n()).done;){var s=a.value,l=(null===(t=null==s?void 0:s.name)||void 0===t?void 0:t.split("."))||[],u=null,c="";l.length>1?(u=l[0],c=l[1]):c=l[0];var f=i.story.ResolveListItem(u,c,h(i));if(null===f)null===u?i.Error("Could not find list definition that contains item '".concat(s,"'")):i.Error("Could not find list item ".concat(s));else{if(null==f.parent)return void i.Error("Could not find list definition for item ".concat(s));u||(u=(null===(n=f.parent.identifier)||void 0===n?void 0:n.name)||null);var d=new M(u,f.name||null);r.has(d.serialized())?i.Warning("Duplicate of item '".concat(s,"' in list.")):r.Add(d,f.seriesValue)}}}catch(e){o.e(e)}finally{o.f()}}e.AddContent(new Z(r))},i}return i(r,[{key:"typeName",get:function(){return"List"}}]),r}(ne),lt=function(e){a(r,e);var t=d(r);function r(e,i){var a,s,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return n(this,r),(s=t.call(this)).indentifier=e,s.inInitialList=i,s.explicitValue=l,s.seriesValue=0,s.parent=null,s.GenerateRuntimeObject=function(){throw new Error("Not implemented.")},s.toString=function(){return s.fullName},s.parent=v((a=h(s),o(r.prototype)),"parent",a),s}return i(r,[{key:"fullName",get:function(){var e,t=this.parent;if(null===t)throw new Error("Can't get full name without a parent list.");return"".concat(null===(e=t.identifier)||void 0===e?void 0:e.name,".").concat(this.name)}},{key:"typeName",get:function(){return"ListElement"}},{key:"name",get:function(){var e;return(null===(e=this.indentifier)||void 0===e?void 0:e.name)||null}},{key:"ResolveReferences",value:function(e){v(o(r.prototype),"ResolveReferences",this).call(this,e),e.CheckForNamingCollisions(this,this.indentifier,fe.ListItem)}}]),r}(F);!function(e){e[e.InnerBlock=0]="InnerBlock",e[e.Stitch=1]="Stitch",e[e.Knot=2]="Knot",e[e.Top=3]="Top"}(Ye||(Ye={}));var ut=function(e){a(r,e);var t=d(r);function r(e,i,a,s){var l,u;return n(this,r),(u=t.call(this,e,i,a,s)).toString=function(){return"".concat(null!==u.parent?u.parent+" > ":"").concat(v((l=h(u),o(r.prototype)),"toString",l).call(l))},u}return i(r,[{key:"flowLevel",get:function(){return we.Stitch}},{key:"typeName",get:function(){return"Stitch"}}]),r}(Pe),ct=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this)).text=e.toString()||"",i}return i(r,[{key:"toString",value:function(){return"# "+this.text}}]),r}(j),ht=function(e){a(r,e);var t=d(r);function r(){var e;return n(this,r),(e=t.apply(this,arguments)).text="",e.index=0,e.threadAtGeneration=null,e.sourcePath="",e.targetPath=null,e.isInvisibleDefault=!1,e.originalThreadIndex=0,e}return i(r,[{key:"pathStringOnChoice",get:function(){return null===this.targetPath?L("Choice.targetPath"):this.targetPath.toString()},set:function(e){this.targetPath=new R(e)}}]),r}(j),ft=function(){function e(t){n(this,e),this._lists=new Map,this._allUnambiguousListValueCache=new Map;var r,i=b(t);try{for(i.s();!(r=i.n()).done;){var a=r.value;this._lists.set(a.name,a);var o,s=b(a.items);try{for(s.s();!(o=s.n()).done;){var l=m(o.value,2),u=l[0],c=l[1],h=M.fromSerializedKey(u),f=new Z(h,c);if(!h.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(h.itemName,f),this._allUnambiguousListValueCache.set(h.fullName,f)}}catch(e){s.e(e)}finally{s.f()}}}catch(e){i.e(e)}finally{i.f()}}return i(e,[{key:"lists",get:function(){var e,t=[],n=b(this._lists);try{for(n.s();!(e=n.n()).done;){var r=m(e.value,2)[1];t.push(r)}}catch(e){n.e(e)}finally{n.f()}return t}},{key:"TryListGetDefinition",value:function(e,t){if(null===e)return{result:t,exists:!1};var n=this._lists.get(e);return n?{result:n,exists:!0}:{result:t,exists:!1}}},{key:"FindSingleItemListWithName",value:function(e){if(null===e)return L("name");var t=this._allUnambiguousListValueCache.get(e);return void 0!==t?t:null}}]),e}(),dt=function(){function e(){n(this,e)}return i(e,null,[{key:"JArrayToRuntimeObjList",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e.length;t&&n--;for(var r=[],i=0;i<n;i++){var a=e[i],o=this.JTokenToRuntimeObject(a);if(null===o)return L("runtimeObj");r.push(o)}return r}},{key:"WriteDictionaryRuntimeObjs",value:function(e,t){e.WriteObjectStart();var n,r=b(t);try{for(r.s();!(n=r.n()).done;){var i=m(n.value,2),a=i[0],o=i[1];e.WritePropertyStart(a),this.WriteRuntimeObject(e,o),e.WritePropertyEnd()}}catch(e){r.e(e)}finally{r.f()}e.WriteObjectEnd()}},{key:"WriteListRuntimeObjs",value:function(e,t){e.WriteArrayStart();var n,r=b(t);try{for(r.s();!(n=r.n()).done;){var i=n.value;this.WriteRuntimeObject(e,i)}}catch(e){r.e(e)}finally{r.f()}e.WriteArrayEnd()}},{key:"WriteIntDictionary",value:function(e,t){e.WriteObjectStart();var n,r=b(t);try{for(r.s();!(n=r.n()).done;){var i=m(n.value,2),a=i[0],o=i[1];e.WriteIntProperty(a,o)}}catch(e){r.e(e)}finally{r.f()}e.WriteObjectEnd()}},{key:"WriteRuntimeObject",value:function(t,n){var r=E(n,ee);if(r)this.WriteRuntimeContainer(t,r);else{var i=E(n,pe);if(i){var a,o="->";return i.isExternal?o="x()":i.pushesToStack&&(i.stackPushType==ce.Function?o="f()":i.stackPushType==ce.Tunnel&&(o="->t->")),a=i.hasVariableTarget?i.variableDivertName:i.targetPathString,t.WriteObjectStart(),t.WriteProperty(o,a),i.hasVariableTarget&&t.WriteProperty("var",!0),i.isConditional&&t.WriteProperty("c",!0),i.externalArgs>0&&t.WriteIntProperty("exArgs",i.externalArgs),void t.WriteObjectEnd()}var s=E(n,he);if(s)return t.WriteObjectStart(),t.WriteProperty("*",s.pathStringOnChoice),t.WriteIntProperty("flg",s.flags),void t.WriteObjectEnd();var l=E(n,U);if(l)t.WriteBool(l.value);else{var u=E(n,K);if(u)t.WriteInt(u.value);else{var c=E(n,z);if(c)t.WriteFloat(c.value);else{var h=E(n,J);if(h)h.isNewline?t.Write("\n",!1):(t.WriteStringStart(),t.WriteStringInner("^"),t.WriteStringInner(h.value),t.WriteStringEnd());else{var f=E(n,Z);if(f)this.WriteInkList(t,f);else{var d=E(n,Y);if(d)return t.WriteObjectStart(),null===d.value?L("divTargetVal.value"):(t.WriteProperty("^->",d.value.componentsString),void t.WriteObjectEnd());var p=E(n,X);if(p)return t.WriteObjectStart(),t.WriteProperty("^var",p.value),t.WriteIntProperty("ci",p.contextIndex),void t.WriteObjectEnd();if(E(n,nt))t.Write("<>");else{var v=E(n,te);if(v)t.Write(e._controlCommandNames[v.commandType]);else{var m=E(n,ie);if(m){var y=m.name;return"^"==y&&(y="L^"),void t.Write(y)}var g=E(n,Fe);if(g){t.WriteObjectStart();var C=g.pathStringForCount;return null!=C?t.WriteProperty("CNT?",C):t.WriteProperty("VAR?",g.name),void t.WriteObjectEnd()}var b=E(n,ve);if(b){t.WriteObjectStart();var w=b.isGlobal?"VAR=":"temp=";return t.WriteProperty(w,b.variableName),b.isNewDeclaration||t.WriteProperty("re",!0),void t.WriteObjectEnd()}if(E(n,re))t.Write("void");else{var S=E(n,ct);if(S)return t.WriteObjectStart(),t.WriteProperty("#",S.text),void t.WriteObjectEnd();var k=E(n,ht);if(!k)throw new Error("Failed to convert runtime object to Json token: "+n);this.WriteChoice(t,k)}}}}}}}}}}},{key:"JObjectToDictionaryRuntimeObjs",value:function(e){var t=new Map;for(var n in e)if(e.hasOwnProperty(n)){var r=this.JTokenToRuntimeObject(e[n]);if(null===r)return L("inkObject");t.set(n,r)}return t}},{key:"JObjectToIntDictionary",value:function(e){var t=new Map;for(var n in e)e.hasOwnProperty(n)&&t.set(n,parseInt(e[n]));return t}},{key:"JTokenToRuntimeObject",value:function(n){if("number"==typeof n&&!isNaN(n)||"boolean"==typeof n)return H.Create(n);if("string"==typeof n){var r=n.toString(),i=r[0];if("^"==i)return new J(r.substring(1));if("\n"==i&&1==r.length)return new J("\n");if("<>"==r)return new nt;for(var a=0;a<e._controlCommandNames.length;++a)if(r==e._controlCommandNames[a])return new te(a);if("L^"==r&&(r="^"),ie.CallExistsWithName(r))return ie.CallWithName(r);if("->->"==r)return te.PopTunnel();if("~ret"==r)return te.PopFunction();if("void"==r)return new re}if("object"===t(n)&&!Array.isArray(n)){var o,s=n;if(s["^->"])return o=s["^->"],new Y(new R(o.toString()));if(s["^var"]){o=s["^var"];var l=new X(o.toString());return"ci"in s&&(o=s.ci,l.contextIndex=parseInt(o)),l}var u=!1,c=!1,h=ce.Function,f=!1;if((o=s["->"])?u=!0:(o=s["f()"])?(u=!0,c=!0,h=ce.Function):(o=s["->t->"])?(u=!0,c=!0,h=ce.Tunnel):(o=s["x()"])&&(u=!0,f=!0,c=!1,h=ce.Function),u){var d=new pe;d.pushesToStack=c,d.stackPushType=h,d.isExternal=f;var p=o.toString();return(o=s.var)?d.variableDivertName=p:d.targetPathString=p,d.isConditional=!!s.c,f&&(o=s.exArgs)&&(d.externalArgs=parseInt(o)),d}if(o=s["*"]){var v=new he;return v.pathStringOnChoice=o.toString(),(o=s.flg)&&(v.flags=parseInt(o)),v}if(o=s["VAR?"])return new Fe(o.toString());if(o=s["CNT?"]){var m=new Fe;return m.pathStringForCount=o.toString(),m}var y=!1,g=!1;if((o=s["VAR="])?(y=!0,g=!0):(o=s["temp="])&&(y=!0,g=!1),y){var C=o.toString(),b=!s.re,w=new ve(C,b);return w.isGlobal=g,w}if(void 0!==s["#"])return o=s["#"],new ct(o.toString());if(o=s.list){var S=o,k=new V;if(o=s.origins){var x=o;k.SetInitialOriginNames(x)}for(var E in S)if(S.hasOwnProperty(E)){var _=S[E],T=new M(E),A=parseInt(_);k.Add(T,A)}return new Z(k)}if(null!=s.originalChoicePath)return this.JObjectToChoice(s)}if(Array.isArray(n))return this.JArrayToContainer(n);if(null==n)return null;throw new Error("Failed to convert token to runtime object: "+this.toJson(n,["parent"]))}},{key:"toJson",value:function(e,t,n){return JSON.stringify(e,(function(e,n){return(null==t?void 0:t.some((function(t){return t===e})))?void 0:n}),n)}},{key:"WriteRuntimeContainer",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(e.WriteArrayStart(),null===t)return L("container");var r,i=b(t.content);try{for(i.s();!(r=i.n()).done;){var a=r.value;this.WriteRuntimeObject(e,a)}}catch(e){i.e(e)}finally{i.f()}var o=t.namedOnlyContent,s=t.countFlags,l=null!=t.name&&!n,u=null!=o||s>0||l;if(u&&e.WriteObjectStart(),null!=o){var c,h=b(o);try{for(h.s();!(c=h.n()).done;){var f=m(c.value,2),d=f[0],p=f[1],v=d,y=E(p,ee);e.WritePropertyStart(v),this.WriteRuntimeContainer(e,y,!0),e.WritePropertyEnd()}}catch(e){h.e(e)}finally{h.f()}}s>0&&e.WriteIntProperty("#f",s),l&&e.WriteProperty("#n",t.name),u?e.WriteObjectEnd():e.WriteNull(),e.WriteArrayEnd()}},{key:"JArrayToContainer",value:function(e){var t=new ee;t.content=this.JArrayToRuntimeObjList(e,!0);var n=e[e.length-1];if(null!=n){var r=new Map;for(var i in n)if("#f"==i)t.countFlags=parseInt(n[i]);else if("#n"==i)t.name=n[i].toString();else{var a=this.JTokenToRuntimeObject(n[i]),o=E(a,ee);o&&(o.name=i),r.set(i,a)}t.namedOnlyContent=r}return t}},{key:"JObjectToChoice",value:function(e){var t=new ht;return t.text=e.text.toString(),t.index=parseInt(e.index),t.sourcePath=e.originalChoicePath.toString(),t.originalThreadIndex=parseInt(e.originalThreadIndex),t.pathStringOnChoice=e.targetPath.toString(),t}},{key:"WriteChoice",value:function(e,t){e.WriteObjectStart(),e.WriteProperty("text",t.text),e.WriteIntProperty("index",t.index),e.WriteProperty("originalChoicePath",t.sourcePath),e.WriteIntProperty("originalThreadIndex",t.originalThreadIndex),e.WriteProperty("targetPath",t.pathStringOnChoice),e.WriteObjectEnd()}},{key:"WriteInkList",value:function(e,t){var n=t.value;if(null===n)return L("rawList");e.WriteObjectStart(),e.WritePropertyStart("list"),e.WriteObjectStart();var r,i=b(n);try{for(i.s();!(r=i.n()).done;){var a=m(r.value,2),o=a[0],s=a[1],l=M.fromSerializedKey(o),u=s;if(null===l.itemName)return L("item.itemName");e.WritePropertyNameStart(),e.WritePropertyNameInner(l.originName?l.originName:"?"),e.WritePropertyNameInner("."),e.WritePropertyNameInner(l.itemName),e.WritePropertyNameEnd(),e.Write(u),e.WritePropertyEnd()}}catch(e){i.e(e)}finally{i.f()}if(e.WriteObjectEnd(),e.WritePropertyEnd(),0==n.Count&&null!=n.originNames&&n.originNames.length>0){e.WritePropertyStart("origins"),e.WriteArrayStart();var c,h=b(n.originNames);try{for(h.s();!(c=h.n()).done;){var f=c.value;e.Write(f)}}catch(e){h.e(e)}finally{h.f()}e.WriteArrayEnd(),e.WritePropertyEnd()}e.WriteObjectEnd()}},{key:"ListDefinitionsToJToken",value:function(e){var t,n={},r=b(e.lists);try{for(r.s();!(t=r.n()).done;){var i,a=t.value,o={},s=b(a.items);try{for(s.s();!(i=s.n()).done;){var l=m(i.value,2),u=l[0],c=l[1],h=M.fromSerializedKey(u);if(null===h.itemName)return L("item.itemName");o[h.itemName]=c}}catch(e){s.e(e)}finally{s.f()}n[a.name]=o}}catch(e){r.e(e)}finally{r.f()}return n}},{key:"JTokenToListDefinitions",value:function(e){var t=e,n=[];for(var r in t)if(t.hasOwnProperty(r)){var i=r.toString(),a=t[r],o=new Map;for(var s in a)if(t.hasOwnProperty(r)){var l=a[s];o.set(s,parseInt(l))}var u=new He(i,o);n.push(u)}return new ft(n)}}]),e}();dt._controlCommandNames=function(){var e=[];e[te.CommandType.EvalStart]="ev",e[te.CommandType.EvalOutput]="out",e[te.CommandType.EvalEnd]="/ev",e[te.CommandType.Duplicate]="du",e[te.CommandType.PopEvaluatedValue]="pop",e[te.CommandType.PopFunction]="~ret",e[te.CommandType.PopTunnel]="->->",e[te.CommandType.BeginString]="str",e[te.CommandType.EndString]="/str",e[te.CommandType.NoOp]="nop",e[te.CommandType.ChoiceCount]="choiceCnt",e[te.CommandType.Turns]="turn",e[te.CommandType.TurnsSince]="turns",e[te.CommandType.ReadCount]="readc",e[te.CommandType.Random]="rnd",e[te.CommandType.SeedRandom]="srnd",e[te.CommandType.VisitIndex]="visit",e[te.CommandType.SequenceShuffleIndex]="seq",e[te.CommandType.StartThread]="thread",e[te.CommandType.Done]="done",e[te.CommandType.End]="end",e[te.CommandType.ListFromInt]="listInt",e[te.CommandType.ListRange]="range",e[te.CommandType.ListRandom]="lrnd";for(var t=0;t<te.CommandType.TOTAL_VALUES;++t)if(null==e[t])throw new Error("Control command not accounted for in serialisation");return e}();var pt=function(){function t(){if(n(this,t),this._threadCounter=0,this._startOfRoot=de.Null,arguments[0]instanceof e.Story){var r=arguments[0];this._startOfRoot=de.StartOf(r.rootContentContainer),this.Reset()}else{var i=arguments[0];this._threads=[];var a,o=b(i._threads);try{for(o.s();!(a=o.n()).done;){var s=a.value;this._threads.push(s.Copy())}}catch(e){o.e(e)}finally{o.f()}this._threadCounter=i._threadCounter,this._startOfRoot=i._startOfRoot.copy()}}return i(t,[{key:"elements",get:function(){return this.callStack}},{key:"depth",get:function(){return this.elements.length}},{key:"currentElement",get:function(){var e=this._threads[this._threads.length-1].callstack;return e[e.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(e){I.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(e)}},{key:"canPop",get:function(){return this.callStack.length>1}},{key:"Reset",value:function(){this._threads=[],this._threads.push(new t.Thread),this._threads[0].callstack.push(new t.Element(ce.Tunnel,this._startOfRoot))}},{key:"SetJsonToken",value:function(e,n){this._threads.length=0;var r,i=b(e.threads);try{for(i.s();!(r=i.n()).done;){var a=r.value,o=new t.Thread(a,n);this._threads.push(o)}}catch(e){i.e(e)}finally{i.f()}this._threadCounter=parseInt(e.threadCounter),this._startOfRoot=de.StartOf(n.rootContentContainer)}},{key:"WriteJson",value:function(e){var t=this;e.WriteObject((function(e){e.WritePropertyStart("threads"),e.WriteArrayStart();var n,r=b(t._threads);try{for(r.s();!(n=r.n()).done;)n.value.WriteJson(e)}catch(e){r.e(e)}finally{r.f()}e.WriteArrayEnd(),e.WritePropertyEnd(),e.WritePropertyStart("threadCounter"),e.WriteInt(t._threadCounter),e.WritePropertyEnd()}))}},{key:"PushThread",value:function(){var e=this.currentThread.Copy();this._threadCounter++,e.threadIndex=this._threadCounter,this._threads.push(e)}},{key:"ForkThread",value:function(){var e=this.currentThread.Copy();return this._threadCounter++,e.threadIndex=this._threadCounter,e}},{key:"PopThread",value:function(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}},{key:"canPopThread",get:function(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}},{key:"elementIsEvaluateFromGame",get:function(){return this.currentElement.type==ce.FunctionEvaluationFromGame}},{key:"Push",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=new t.Element(e,this.currentElement.currentPointer,!1);i.evaluationStackHeightWhenPushed=n,i.functionStartInOutputStream=r,this.callStack.push(i)}},{key:"CanPop",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return!!this.canPop&&(null==e||this.currentElement.type==e)}},{key:"Pop",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this.CanPop(e))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}},{key:"GetTemporaryVariableWithName",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;-1==t&&(t=this.currentElementIndex+1);var n=G(this.callStack[t-1].temporaryVariables,e,null);return n.exists?n.result:null}},{key:"SetTemporaryVariable",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;-1==r&&(r=this.currentElementIndex+1);var i=this.callStack[r-1];if(!n&&!i.temporaryVariables.get(e))throw new Error("Could not find temporary variable to set: "+e);var a=G(i.temporaryVariables,e,null);a.exists&&Z.RetainListOriginsForAssignment(a.result,t),i.temporaryVariables.set(e,t)}},{key:"ContextForVariableNamed",value:function(e){return this.currentElement.temporaryVariables.get(e)?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(e){var t=this._threads.filter((function(t){if(t.threadIndex==e)return t}));return t.length>0?t[0]:null}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"callStackTrace",get:function(){for(var e=new $,t=0;t<this._threads.length;t++){var n=this._threads[t],r=t==this._threads.length-1;e.AppendFormat("=== THREAD {0}/{1} {2}===\n",t+1,this._threads.length,r?"(current) ":"");for(var i=0;i<n.callstack.length;i++){n.callstack[i].type==ce.Function?e.Append("  [FUNCTION] "):e.Append("  [TUNNEL] ");var a=n.callstack[i].currentPointer;if(!a.isNull){if(e.Append("<SOMEWHERE IN "),null===a.container)return L("pointer.container");e.Append(a.container.path.toString()),e.AppendLine(">")}}}return e.toString()}}]),t}();!function(e){var t=function(){function e(t,r){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];n(this,e),this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=r.copy(),this.inExpressionEvaluation=i,this.temporaryVariables=new Map,this.type=t}return i(e,[{key:"Copy",value:function(){var t=new e(this.type,this.currentPointer,this.inExpressionEvaluation);return t.temporaryVariables=new Map(this.temporaryVariables),t.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,t.functionStartInOutputStream=this.functionStartInOutputStream,t}}]),e}();e.Element=t;var r=function(){function e(){if(n(this,e),this.threadIndex=0,this.previousPointer=de.Null,this.callstack=[],arguments[0]&&arguments[1]){var r=arguments[0],i=arguments[1];this.threadIndex=parseInt(r.threadIndex);var a,o=b(r.callstack);try{for(o.s();!(a=o.n()).done;){var s=a.value,l=parseInt(s.type),u=de.Null,c=void 0,h=s.cPath;if(void 0!==h){c=h.toString();var f=i.ContentAtPath(new R(c));if(u.container=f.container,u.index=parseInt(s.idx),null==f.obj)throw new Error("When loading state, internal story location couldn't be found: "+c+". Has the story changed since this save data was created?");if(f.approximate){if(null===u.container)return L("pointer.container");i.Warning("When loading state, exact internal story location couldn't be found: '"+c+"', so it was approximated to '"+u.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}var d=!!s.exp,p=new t(l,u,d),v=s.temp;void 0!==v?p.temporaryVariables=dt.JObjectToDictionaryRuntimeObjs(v):p.temporaryVariables.clear(),this.callstack.push(p)}}catch(e){o.e(e)}finally{o.f()}var m=r.previousContentObject;if(void 0!==m){var y=new R(m.toString());this.previousPointer=i.PointerAtPath(y)}}}return i(e,[{key:"Copy",value:function(){var t=new e;t.threadIndex=this.threadIndex;var n,r=b(this.callstack);try{for(r.s();!(n=r.n()).done;){var i=n.value;t.callstack.push(i.Copy())}}catch(e){r.e(e)}finally{r.f()}return t.previousPointer=this.previousPointer.copy(),t}},{key:"WriteJson",value:function(e){e.WriteObjectStart(),e.WritePropertyStart("callstack"),e.WriteArrayStart();var t,n=b(this.callstack);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(e.WriteObjectStart(),!r.currentPointer.isNull){if(null===r.currentPointer.container)return L("el.currentPointer.container");e.WriteProperty("cPath",r.currentPointer.container.path.componentsString),e.WriteIntProperty("idx",r.currentPointer.index)}e.WriteProperty("exp",r.inExpressionEvaluation),e.WriteIntProperty("type",r.type),r.temporaryVariables.size>0&&(e.WritePropertyStart("temp"),dt.WriteDictionaryRuntimeObjs(e,r.temporaryVariables),e.WritePropertyEnd()),e.WriteObjectEnd()}}catch(e){n.e(e)}finally{n.f()}if(e.WriteArrayEnd(),e.WritePropertyEnd(),e.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){var i=this.previousPointer.Resolve();if(null===i)return L("this.previousPointer.Resolve()");e.WriteProperty("previousContentObject",i.path.toString())}e.WriteObjectEnd()}}]),e}();e.Thread=r}(pt||(pt={}));var vt=function(){function e(t,r){n(this,e),this.variableChangedEventCallbacks=[],this.patch=null,this._batchObservingVariableChanges=!1,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._globalVariables=new Map,this._callStack=t,this._listDefsOrigin=r;try{return new Proxy(this,{get:function(e,t){return t in e?e[t]:e.$(t)},set:function(e,t,n){return t in e?e[t]=n:e.$(t,n),!0}})}catch(e){}}return i(e,[{key:"variableChangedEvent",value:function(e,t){var n,r=b(this.variableChangedEventCallbacks);try{for(r.s();!(n=r.n()).done;)(0,n.value)(e,t)}catch(e){r.e(e)}finally{r.f()}}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(e){if(this._batchObservingVariableChanges=e,e)this._changedVariablesForBatchObs=new Set;else if(null!=this._changedVariablesForBatchObs){var t,n=b(this._changedVariablesForBatchObs);try{for(n.s();!(t=n.n()).done;){var r=t.value,i=this._globalVariables.get(r);i?this.variableChangedEvent(r,i):L("currentValue")}}catch(e){n.e(e)}finally{n.f()}this._changedVariablesForBatchObs=null}}},{key:"callStack",get:function(){return this._callStack},set:function(e){this._callStack=e}},{key:"$",value:function(e,t){if(void 0===t){var n=null;return null!==this.patch&&(n=this.patch.TryGetGlobal(e,null)).exists?n.result.valueObject:(void 0===(n=this._globalVariables.get(e))&&(n=this._defaultGlobalVariables.get(e)),void 0!==n?n.valueObject:null)}if(void 0===this._defaultGlobalVariables.get(e))throw new B("Cannot assign to a variable ("+e+") that hasn't been declared in the story");var r=H.Create(t);if(null==r)throw null==t?new Error("Cannot pass null to VariableState"):new Error("Invalid value passed to VariableState: "+t.toString());this.SetGlobal(e,r)}},{key:"ApplyPatch",value:function(){if(null===this.patch)return L("this.patch");var e,t=b(this.patch.globals);try{for(t.s();!(e=t.n()).done;){var n=m(e.value,2),r=n[0],i=n[1];this._globalVariables.set(r,i)}}catch(e){t.e(e)}finally{t.f()}if(null!==this._changedVariablesForBatchObs){var a,o=b(this.patch.changedVariables);try{for(o.s();!(a=o.n()).done;){var s=a.value;this._changedVariablesForBatchObs.add(s)}}catch(e){o.e(e)}finally{o.f()}}this.patch=null}},{key:"SetJsonToken",value:function(e){this._globalVariables.clear();var t,n=b(this._defaultGlobalVariables);try{for(n.s();!(t=n.n()).done;){var r=m(t.value,2),i=r[0],a=r[1],o=e[i];if(void 0!==o){var s=dt.JTokenToRuntimeObject(o);if(null===s)return L("tokenInkObject");this._globalVariables.set(i,s)}else this._globalVariables.set(i,a)}}catch(e){n.e(e)}finally{n.f()}}},{key:"WriteJson",value:function(t){t.WriteObjectStart();var n,r=b(this._globalVariables);try{for(r.s();!(n=r.n()).done;){var i=m(n.value,2),a=i[0],o=i[1],s=a,l=o;if(e.dontSaveDefaultValues&&this._defaultGlobalVariables.has(s)){var u=this._defaultGlobalVariables.get(s);if(this.RuntimeObjectsEqual(l,u))continue}t.WritePropertyStart(s),dt.WriteRuntimeObject(t,l),t.WritePropertyEnd()}}catch(e){r.e(e)}finally{r.f()}t.WriteObjectEnd()}},{key:"RuntimeObjectsEqual",value:function(e,t){if(null===e)return L("obj1");if(null===t)return L("obj2");if(e.constructor!==t.constructor)return!1;var n=E(e,U);if(null!==n)return n.value===_(t,U).value;var r=E(e,K);if(null!==r)return r.value===_(t,K).value;var i=E(e,z);if(null!==i)return i.value===_(t,z).value;var a=E(e,H),o=E(t,H);if(null!==a&&null!==o)return N(a.valueObject)&&N(o.valueObject)?a.valueObject.Equals(o.valueObject):a.valueObject===o.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+e.constructor.name)}},{key:"GetVariableWithName",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,n=this.GetRawVariableWithName(e,t),r=E(n,X);return null!==r&&(n=this.ValueAtVariablePointer(r)),n}},{key:"TryGetDefaultVariableValue",value:function(e){var t=G(this._defaultGlobalVariables,e,null);return t.exists?t.result:null}},{key:"GlobalVariableExistsWithName",value:function(e){return this._globalVariables.has(e)||null!==this._defaultGlobalVariables&&this._defaultGlobalVariables.has(e)}},{key:"GetRawVariableWithName",value:function(e,t){if(0==t||-1==t){var n=null;if(null!==this.patch&&(n=this.patch.TryGetGlobal(e,null)).exists)return n.result;if((n=G(this._globalVariables,e,null)).exists)return n.result;if(null!==this._defaultGlobalVariables&&(n=G(this._defaultGlobalVariables,e,null)).exists)return n.result;if(null===this._listDefsOrigin)return L("VariablesState._listDefsOrigin");var r=this._listDefsOrigin.FindSingleItemListWithName(e);if(r)return r}return this._callStack.GetTemporaryVariableWithName(e,t)}},{key:"ValueAtVariablePointer",value:function(e){return this.GetVariableWithName(e.variableName,e.contextIndex)}},{key:"Assign",value:function(e,t){var n=e.variableName;if(null===n)return L("name");var r=-1,i=!1;if(i=e.isNewDeclaration?e.isGlobal:this.GlobalVariableExistsWithName(n),e.isNewDeclaration){var a=E(t,X);null!==a&&(t=this.ResolveVariablePointer(a))}else{var o=null;do{null!=(o=E(this.GetRawVariableWithName(n,r),X))&&(n=o.variableName,i=0==(r=o.contextIndex))}while(null!=o)}i?this.SetGlobal(n,t):this._callStack.SetTemporaryVariable(n,t,e.isNewDeclaration,r)}},{key:"SnapshotDefaultGlobals",value:function(){this._defaultGlobalVariables=new Map(this._globalVariables)}},{key:"RetainListOriginsForAssignment",value:function(e,t){var n=_(e,Z),r=_(t,Z);n.value&&r.value&&0==r.value.Count&&r.value.SetInitialOriginNames(n.value.originNames)}},{key:"SetGlobal",value:function(e,t){var n=null;if(null===this.patch&&(n=G(this._globalVariables,e,null)),null!==this.patch&&((n=this.patch.TryGetGlobal(e,null)).exists||(n=G(this._globalVariables,e,null))),Z.RetainListOriginsForAssignment(n.result,t),null===e)return L("variableName");if(null!==this.patch?this.patch.SetGlobal(e,t):this._globalVariables.set(e,t),null!==this.variableChangedEvent&&null!==n&&t!==n.result)if(this.batchObservingVariableChanges){if(null===this._changedVariablesForBatchObs)return L("this._changedVariablesForBatchObs");null!==this.patch?this.patch.AddChangedVariable(e):null!==this._changedVariablesForBatchObs&&this._changedVariablesForBatchObs.add(e)}else this.variableChangedEvent(e,t)}},{key:"ResolveVariablePointer",value:function(e){var t=e.contextIndex;-1==t&&(t=this.GetContextIndexOfVariableNamed(e.variableName));var n=E(this.GetRawVariableWithName(e.variableName,t),X);return null!=n?n:new X(e.variableName,t)}},{key:"GetContextIndexOfVariableNamed",value:function(e){return this.GlobalVariableExistsWithName(e)?0:this._callStack.currentElementIndex}},{key:"ObserveVariableChange",value:function(e){this.variableChangedEventCallbacks.push(e)}}]),e}();vt.dontSaveDefaultValues=!0;var mt=function(){function e(t){n(this,e),this.seed=t%2147483647,this.seed<=0&&(this.seed+=2147483646)}return i(e,[{key:"next",value:function(){return this.seed=48271*this.seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),e}(),yt=function(){function e(){if(n(this,e),this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,1===arguments.length&&null!==arguments[0]){var t=arguments[0];this._globals=new Map(t._globals),this._changedVariables=new Set(t._changedVariables),this._visitCounts=new Map(t._visitCounts),this._turnIndices=new Map(t._turnIndices)}else this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map}return i(e,[{key:"globals",get:function(){return this._globals}},{key:"changedVariables",get:function(){return this._changedVariables}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"TryGetGlobal",value:function(e,t){return null!==e&&this._globals.has(e)?{result:this._globals.get(e),exists:!0}:{result:t,exists:!1}}},{key:"SetGlobal",value:function(e,t){this._globals.set(e,t)}},{key:"AddChangedVariable",value:function(e){return this._changedVariables.add(e)}},{key:"TryGetVisitCount",value:function(e,t){return this._visitCounts.has(e)?{result:this._visitCounts.get(e),exists:!0}:{result:t,exists:!1}}},{key:"SetVisitCount",value:function(e,t){this._visitCounts.set(e,t)}},{key:"SetTurnIndex",value:function(e,t){this._turnIndices.set(e,t)}},{key:"TryGetTurnIndex",value:function(e,t){return this._turnIndices.has(e)?{result:this._turnIndices.get(e),exists:!0}:{result:t,exists:!1}}}]),e}(),gt=function(){function e(){n(this,e)}return i(e,null,[{key:"TextToDictionary",value:function(t){return new e.Reader(t).ToDictionary()}},{key:"TextToArray",value:function(t){return new e.Reader(t).ToArray()}}]),e}();!function(e){var t=function(){function e(t){n(this,e),this._rootObject=JSON.parse(t)}return i(e,[{key:"ToDictionary",value:function(){return this._rootObject}},{key:"ToArray",value:function(){return this._rootObject}}]),e}();e.Reader=t;var r=function(){function t(){n(this,t),this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}return i(t,[{key:"WriteObject",value:function(e){this.WriteObjectStart(),e(this),this.WriteObjectEnd()}},{key:"WriteObjectStart",value:function(){this.StartNewObject(!0);var t={};if(this.state===e.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);var n=this._propertyNameStack.pop();this.currentCollection[n]=t,this._collectionStack.push(t)}else this.state===e.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(t),this._collectionStack.push(t)):(this.Assert(this.state===e.Writer.State.None),this._jsonObject=t,this._collectionStack.push(t));this._stateStack.push(new e.Writer.StateElement(e.Writer.State.Object))}},{key:"WriteObjectEnd",value:function(){this.Assert(this.state===e.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}},{key:"WriteProperty",value:function(e,t){if(this.WritePropertyStart(e),arguments[1]instanceof Function)(0,arguments[1])(this);else{var n=arguments[1];this.Write(n)}this.WritePropertyEnd()}},{key:"WriteIntProperty",value:function(e,t){this.WritePropertyStart(e),this.WriteInt(t),this.WritePropertyEnd()}},{key:"WriteFloatProperty",value:function(e,t){this.WritePropertyStart(e),this.WriteFloat(t),this.WritePropertyEnd()}},{key:"WritePropertyStart",value:function(t){this.Assert(this.state===e.Writer.State.Object),this._propertyNameStack.push(t),this.IncrementChildCount(),this._stateStack.push(new e.Writer.StateElement(e.Writer.State.Property))}},{key:"WritePropertyEnd",value:function(){this.Assert(this.state===e.Writer.State.Property),this.Assert(1===this.childCount),this._stateStack.pop()}},{key:"WritePropertyNameStart",value:function(){this.Assert(this.state===e.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new e.Writer.StateElement(e.Writer.State.Property)),this._stateStack.push(new e.Writer.StateElement(e.Writer.State.PropertyName))}},{key:"WritePropertyNameEnd",value:function(){this.Assert(this.state===e.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}},{key:"WritePropertyNameInner",value:function(t){this.Assert(this.state===e.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._currentPropertyName+=t}},{key:"WriteArrayStart",value:function(){this.StartNewObject(!0);var t=[];if(this.state===e.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);var n=this._propertyNameStack.pop();this.currentCollection[n]=t,this._collectionStack.push(t)}else this.state===e.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(t),this._collectionStack.push(t)):(this.Assert(this.state===e.Writer.State.None),this._jsonObject=t,this._collectionStack.push(t));this._stateStack.push(new e.Writer.StateElement(e.Writer.State.Array))}},{key:"WriteArrayEnd",value:function(){this.Assert(this.state===e.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}},{key:"Write",value:function(e){null!==e?(this.StartNewObject(!1),this._addToCurrentObject(e)):console.error("Warning: trying to write a null value")}},{key:"WriteBool",value:function(e){null!==e&&(this.StartNewObject(!1),this._addToCurrentObject(e))}},{key:"WriteInt",value:function(e){null!==e&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(e)))}},{key:"WriteFloat",value:function(e){null!==e&&(this.StartNewObject(!1),e==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):e==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):isNaN(e)?this._addToCurrentObject(0):this._addToCurrentObject(e))}},{key:"WriteNull",value:function(){this.StartNewObject(!1),this._addToCurrentObject(null)}},{key:"WriteStringStart",value:function(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new e.Writer.StateElement(e.Writer.State.String))}},{key:"WriteStringEnd",value:function(){this.Assert(this.state==e.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}},{key:"WriteStringInner",value:function(t){this.Assert(this.state===e.Writer.State.String),null!==t?this._currentString+=t:console.error("Warning: trying to write a null string")}},{key:"toString",value:function(){return null===this._jsonObject?"":JSON.stringify(this._jsonObject)}},{key:"StartNewObject",value:function(t){t?this.Assert(this.state===e.Writer.State.None||this.state===e.Writer.State.Property||this.state===e.Writer.State.Array):this.Assert(this.state===e.Writer.State.Property||this.state===e.Writer.State.Array),this.state===e.Writer.State.Property&&this.Assert(0===this.childCount),this.state!==e.Writer.State.Array&&this.state!==e.Writer.State.Property||this.IncrementChildCount()}},{key:"state",get:function(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].type:e.Writer.State.None}},{key:"childCount",get:function(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].childCount:0}},{key:"currentCollection",get:function(){return this._collectionStack.length>0?this._collectionStack[this._collectionStack.length-1]:null}},{key:"currentPropertyName",get:function(){return this._propertyNameStack.length>0?this._propertyNameStack[this._propertyNameStack.length-1]:null}},{key:"IncrementChildCount",value:function(){this.Assert(this._stateStack.length>0);var e=this._stateStack.pop();e.childCount++,this._stateStack.push(e)}},{key:"Assert",value:function(e){if(!e)throw Error("Assert failed while writing JSON")}},{key:"_addToCurrentObject",value:function(t){this.Assert(null!==this.currentCollection),this.state===e.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(t)):this.state===e.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(null!==this.currentPropertyName),this.currentCollection[this.currentPropertyName]=t,this._propertyNameStack.pop())}}]),t}();e.Writer=r,function(t){var r;(r=t.State||(t.State={}))[r.None=0]="None",r[r.Object=1]="Object",r[r.Array=2]="Array",r[r.Property=3]="Property",r[r.PropertyName=4]="PropertyName",r[r.String=5]="String";var a=i((function t(r){n(this,t),this.type=e.Writer.State.None,this.childCount=0,this.type=r}));t.StateElement=a}(r=e.Writer||(e.Writer={}))}(gt||(gt={}));var Ct,bt=function(){function e(){n(this,e);var t=arguments[0],r=arguments[1];if(this.name=t,this.callStack=new pt(r),arguments[2]){var i=arguments[2];this.callStack.SetJsonToken(i.callstack,r),this.outputStream=dt.JArrayToRuntimeObjList(i.outputStream),this.currentChoices=dt.JArrayToRuntimeObjList(i.currentChoices);var a=i.choiceThreads;void 0!==a&&this.LoadFlowChoiceThreads(a,r)}else this.outputStream=[],this.currentChoices=[]}return i(e,[{key:"WriteJson",value:function(e){var t=this;e.WriteObjectStart(),e.WriteProperty("callstack",(function(e){return t.callStack.WriteJson(e)})),e.WriteProperty("outputStream",(function(e){return dt.WriteListRuntimeObjs(e,t.outputStream)}));var n,r=!1,i=b(this.currentChoices);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(null===a.threadAtGeneration)return L("c.threadAtGeneration");a.originalThreadIndex=a.threadAtGeneration.threadIndex,null===this.callStack.ThreadWithIndex(a.originalThreadIndex)&&(r||(r=!0,e.WritePropertyStart("choiceThreads"),e.WriteObjectStart()),e.WritePropertyStart(a.originalThreadIndex),a.threadAtGeneration.WriteJson(e),e.WritePropertyEnd())}}catch(e){i.e(e)}finally{i.f()}r&&(e.WriteObjectEnd(),e.WritePropertyEnd()),e.WriteProperty("currentChoices",(function(e){e.WriteArrayStart();var n,r=b(t.currentChoices);try{for(r.s();!(n=r.n()).done;){var i=n.value;dt.WriteChoice(e,i)}}catch(e){r.e(e)}finally{r.f()}e.WriteArrayEnd()})),e.WriteObjectEnd()}},{key:"LoadFlowChoiceThreads",value:function(e,t){var n,r=b(this.currentChoices);try{for(r.s();!(n=r.n()).done;){var i=n.value,a=this.callStack.ThreadWithIndex(i.originalThreadIndex);if(null!==a)i.threadAtGeneration=a.Copy();else{var o=e["".concat(i.originalThreadIndex)];i.threadAtGeneration=new pt.Thread(o,t)}}}catch(e){r.e(e)}finally{r.f()}}}]),e}(),wt=function(){function t(e){n(this,t),this.kInkSaveStateVersion=9,this.kMinCompatibleLoadVersion=8,this.onDidLoadState=null,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=de.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this._namedFlows=null,this.kDefaultFlowName="DEFAULT_FLOW",this.story=e,this._currentFlow=new bt(this.kDefaultFlowName,e),this.OutputStreamDirty(),this._evaluationStack=[],this._variablesState=new vt(this.callStack,e.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;var r=(new Date).getTime();this.storySeed=new mt(r).next()%100,this.previousRandom=0,this.GoToStart()}return i(t,[{key:"ToJson",value:function(){var e=new gt.Writer;return this.WriteJson(e),e.toString()}},{key:"toJson",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.ToJson(e)}},{key:"LoadJson",value:function(e){var t=gt.TextToDictionary(e);this.LoadJsonObj(t),null!==this.onDidLoadState&&this.onDidLoadState()}},{key:"VisitCountAtPathString",value:function(e){var t;if(null!==this._patch){var n=this.story.ContentAtPath(new R(e)).container;if(null===n)throw new Error("Content at path not found: "+e);if((t=this._patch.TryGetVisitCount(n,0)).exists)return t.result}return(t=G(this._visitCounts,e,null)).exists?t.result:0}},{key:"VisitCountForContainer",value:function(e){if(null===e)return L("container");if(!e.visitsShouldBeCounted)return this.story.Error("Read count for target ("+e.name+" - on "+e.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(null!==this._patch){var t=this._patch.TryGetVisitCount(e,0);if(t.exists)return t.result}var n=e.path.toString(),r=G(this._visitCounts,n,null);return r.exists?r.result:0}},{key:"IncrementVisitCountForContainer",value:function(e){if(null!==this._patch){var t=this.VisitCountForContainer(e);return t++,void this._patch.SetVisitCount(e,t)}var n=e.path.toString(),r=G(this._visitCounts,n,null);r.exists?this._visitCounts.set(n,r.result+1):this._visitCounts.set(n,1)}},{key:"RecordTurnIndexVisitToContainer",value:function(e){if(null===this._patch){var t=e.path.toString();this._turnIndices.set(t,this.currentTurnIndex)}else this._patch.SetTurnIndex(e,this.currentTurnIndex)}},{key:"TurnsSinceForContainer",value:function(e){if(e.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+e.name+" - on "+e.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),null!==this._patch){var t=this._patch.TryGetTurnIndex(e,0);if(t.exists)return this.currentTurnIndex-t.result}var n=e.path.toString(),r=G(this._turnIndices,n,0);return r.exists?this.currentTurnIndex-r.result:-1}},{key:"callstackDepth",get:function(){return this.callStack.depth}},{key:"outputStream",get:function(){return this._currentFlow.outputStream}},{key:"currentChoices",get:function(){return this.canContinue?[]:this._currentFlow.currentChoices}},{key:"generatedChoices",get:function(){return this._currentFlow.currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"currentWarnings",get:function(){return this._currentWarnings}},{key:"variablesState",get:function(){return this._variablesState},set:function(e){this._variablesState=e}},{key:"callStack",get:function(){return this._currentFlow.callStack}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex},set:function(e){this._currentTurnIndex=e}},{key:"currentPathString",get:function(){var e=this.currentPointer;return e.isNull?null:null===e.path?L("pointer.path"):e.path.toString()}},{key:"currentPointer",get:function(){return this.callStack.currentElement.currentPointer.copy()},set:function(e){this.callStack.currentElement.currentPointer=e.copy()}},{key:"previousPointer",get:function(){return this.callStack.currentThread.previousPointer.copy()},set:function(e){this.callStack.currentThread.previousPointer=e.copy()}},{key:"canContinue",get:function(){return!this.currentPointer.isNull&&!this.hasError}},{key:"hasError",get:function(){return null!=this.currentErrors&&this.currentErrors.length>0}},{key:"hasWarning",get:function(){return null!=this.currentWarnings&&this.currentWarnings.length>0}},{key:"currentText",get:function(){if(this._outputStreamTextDirty){var e,t=new $,n=b(this.outputStream);try{for(n.s();!(e=n.n()).done;){var r=E(e.value,J);null!==r&&t.Append(r.value)}}catch(e){n.e(e)}finally{n.f()}this._currentText=this.CleanOutputWhitespace(t.toString()),this._outputStreamTextDirty=!1}return this._currentText}},{key:"CleanOutputWhitespace",value:function(e){for(var t=new $,n=-1,r=0,i=0;i<e.length;i++){var a=e.charAt(i),o=" "==a||"\t"==a;o&&-1==n&&(n=i),o||("\n"!=a&&n>0&&n!=r&&t.Append(" "),n=-1),"\n"==a&&(r=i+1),o||t.Append(a)}return t.toString()}},{key:"currentTags",get:function(){if(this._outputStreamTagsDirty){this._currentTags=[];var e,t=b(this.outputStream);try{for(t.s();!(e=t.n()).done;){var n=E(e.value,ct);null!==n&&this._currentTags.push(n.text)}}catch(e){t.e(e)}finally{t.f()}this._outputStreamTagsDirty=!1}return this._currentTags}},{key:"currentFlowName",get:function(){return this._currentFlow.name}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(e){this.callStack.currentElement.inExpressionEvaluation=e}},{key:"GoToStart",value:function(){this.callStack.currentElement.currentPointer=de.StartOf(this.story.mainContentContainer)}},{key:"SwitchFlow_Internal",value:function(e){if(null===e)throw new Error("Must pass a non-null string to Story.SwitchFlow");if(null===this._namedFlows&&(this._namedFlows=new Map,this._namedFlows.set(this.kDefaultFlowName,this._currentFlow)),e!==this._currentFlow.name){var t,n=G(this._namedFlows,e,null);n.exists?t=n.result:(t=new bt(e,this.story),this._namedFlows.set(e,t)),this._currentFlow=t,this.variablesState.callStack=this._currentFlow.callStack,this.OutputStreamDirty()}}},{key:"SwitchToDefaultFlow_Internal",value:function(){null!==this._namedFlows&&this.SwitchFlow_Internal(this.kDefaultFlowName)}},{key:"RemoveFlow_Internal",value:function(e){if(null===e)throw new Error("Must pass a non-null string to Story.DestroyFlow");if(e===this.kDefaultFlowName)throw new Error("Cannot destroy default flow");if(this._currentFlow.name===e&&this.SwitchToDefaultFlow_Internal(),null===this._namedFlows)return L("this._namedFlows");this._namedFlows.delete(e)}},{key:"CopyAndStartPatching",value:function(){var e,n,r,i,a,o=new t(this.story);if(o._patch=new yt(this._patch),o._currentFlow.name=this._currentFlow.name,o._currentFlow.callStack=new pt(this._currentFlow.callStack),(e=o._currentFlow.currentChoices).push.apply(e,y(this._currentFlow.currentChoices)),(n=o._currentFlow.outputStream).push.apply(n,y(this._currentFlow.outputStream)),o.OutputStreamDirty(),null!==this._namedFlows){o._namedFlows=new Map;var s,l=b(this._namedFlows);try{for(l.s();!(s=l.n()).done;){var u=m(s.value,2),c=u[0],h=u[1];o._namedFlows.set(c,h)}}catch(e){l.e(e)}finally{l.f()}o._namedFlows.set(this._currentFlow.name,o._currentFlow)}return this.hasError&&(o._currentErrors=[],(i=o._currentErrors).push.apply(i,y(this.currentErrors||[]))),this.hasWarning&&(o._currentWarnings=[],(a=o._currentWarnings).push.apply(a,y(this.currentWarnings||[]))),o.variablesState=this.variablesState,o.variablesState.callStack=o.callStack,o.variablesState.patch=o._patch,(r=o.evaluationStack).push.apply(r,y(this.evaluationStack)),this.divertedPointer.isNull||(o.divertedPointer=this.divertedPointer.copy()),o.previousPointer=this.previousPointer.copy(),o._visitCounts=this._visitCounts,o._turnIndices=this._turnIndices,o.currentTurnIndex=this.currentTurnIndex,o.storySeed=this.storySeed,o.previousRandom=this.previousRandom,o.didSafeExit=this.didSafeExit,o}},{key:"RestoreAfterPatch",value:function(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}},{key:"ApplyAnyPatch",value:function(){if(null!==this._patch){this.variablesState.ApplyPatch();var e,t=b(this._patch.visitCounts);try{for(t.s();!(e=t.n()).done;){var n=m(e.value,2),r=n[0],i=n[1];this.ApplyCountChanges(r,i,!0)}}catch(e){t.e(e)}finally{t.f()}var a,o=b(this._patch.turnIndices);try{for(o.s();!(a=o.n()).done;){var s=m(a.value,2),l=s[0],u=s[1];this.ApplyCountChanges(l,u,!1)}}catch(e){o.e(e)}finally{o.f()}this._patch=null}}},{key:"ApplyCountChanges",value:function(e,t,n){(n?this._visitCounts:this._turnIndices).set(e.path.toString(),t)}},{key:"WriteJson",value:function(t){var n=this;if(t.WriteObjectStart(),t.WritePropertyStart("flows"),t.WriteObjectStart(),null!==this._namedFlows){var r,i=b(this._namedFlows);try{var a=function(){var e=m(r.value,2),n=e[0],i=e[1];t.WriteProperty(n,(function(e){return i.WriteJson(e)}))};for(i.s();!(r=i.n()).done;)a()}catch(e){i.e(e)}finally{i.f()}}else t.WriteProperty(this._currentFlow.name,(function(e){return n._currentFlow.WriteJson(e)}));if(t.WriteObjectEnd(),t.WritePropertyEnd(),t.WriteProperty("currentFlowName",this._currentFlow.name),t.WriteProperty("variablesState",(function(e){return n.variablesState.WriteJson(e)})),t.WriteProperty("evalStack",(function(e){return dt.WriteListRuntimeObjs(e,n.evaluationStack)})),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return L("divertedPointer");t.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}t.WriteProperty("visitCounts",(function(e){return dt.WriteIntDictionary(e,n._visitCounts)})),t.WriteProperty("turnIndices",(function(e){return dt.WriteIntDictionary(e,n._turnIndices)})),t.WriteIntProperty("turnIdx",this.currentTurnIndex),t.WriteIntProperty("storySeed",this.storySeed),t.WriteIntProperty("previousRandom",this.previousRandom),t.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),t.WriteIntProperty("inkFormatVersion",e.Story.inkVersionCurrent),t.WriteObjectEnd()}},{key:"LoadJsonObj",value:function(e){var t=e,n=t.inkSaveVersion;if(null==n)throw new Error("ink save format incorrect, can't load.");if(parseInt(n)<this.kMinCompatibleLoadVersion)throw new Error("Ink save format isn't compatible with the current version (saw '"+n+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");var r=t.flows;if(null!=r){var i=r;1===Object.keys(i).length?this._namedFlows=null:null===this._namedFlows?this._namedFlows=new Map:this._namedFlows.clear();for(var a=0,o=Object.entries(i);a<o.length;a++){var s=m(o[a],2),l=s[0],u=s[1],c=new bt(l,this.story,u);if(1===Object.keys(i).length)this._currentFlow=new bt(l,this.story,u);else{if(null===this._namedFlows)return L("this._namedFlows");this._namedFlows.set(l,c)}}if(null!=this._namedFlows&&this._namedFlows.size>1){var h=t.currentFlowName;this._currentFlow=this._namedFlows.get(h)}}else{this._namedFlows=null,this._currentFlow.name=this.kDefaultFlowName,this._currentFlow.callStack.SetJsonToken(t.callstackThreads,this.story),this._currentFlow.outputStream=dt.JArrayToRuntimeObjList(t.outputStream),this._currentFlow.currentChoices=dt.JArrayToRuntimeObjList(t.currentChoices);var f=t.choiceThreads;this._currentFlow.LoadFlowChoiceThreads(f,this.story)}this.OutputStreamDirty(),this.variablesState.SetJsonToken(t.variablesState),this.variablesState.callStack=this._currentFlow.callStack,this._evaluationStack=dt.JArrayToRuntimeObjList(t.evalStack);var d=t.currentDivertTarget;if(null!=d){var p=new R(d.toString());this.divertedPointer=this.story.PointerAtPath(p)}this._visitCounts=dt.JObjectToIntDictionary(t.visitCounts),this._turnIndices=dt.JObjectToIntDictionary(t.turnIndices),this.currentTurnIndex=parseInt(t.turnIdx),this.storySeed=parseInt(t.storySeed),this.previousRandom=parseInt(t.previousRandom)}},{key:"ResetErrors",value:function(){this._currentErrors=null,this._currentWarnings=null}},{key:"ResetOutput",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.outputStream.length=0,null!==t&&(e=this.outputStream).push.apply(e,y(t)),this.OutputStreamDirty()}},{key:"PushToOutputStream",value:function(e){var t=E(e,J);if(null!==t){var n=this.TrySplittingHeadTailWhitespace(t);if(null!==n){var r,i=b(n);try{for(i.s();!(r=i.n()).done;){var a=r.value;this.PushToOutputStreamIndividual(a)}}catch(e){i.e(e)}finally{i.f()}return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(e),this.OutputStreamDirty()}},{key:"PopFromOutputStream",value:function(e){this.outputStream.splice(this.outputStream.length-e,e),this.OutputStreamDirty()}},{key:"TrySplittingHeadTailWhitespace",value:function(e){var t=e.value;if(null===t)return L("single.value");for(var n=-1,r=-1,i=0;i<t.length;i++){var a=t[i];if("\n"!=a){if(" "==a||"\t"==a)continue;break}-1==n&&(n=i),r=i}for(var o=-1,s=-1,l=t.length-1;l>=0;l--){var u=t[l];if("\n"!=u){if(" "==u||"\t"==u)continue;break}-1==o&&(o=l),s=l}if(-1==n&&-1==o)return null;var c=[],h=0,f=t.length;if(-1!=n){if(n>0){var d=new J(t.substring(0,n));c.push(d)}c.push(new J("\n")),h=r+1}if(-1!=o&&(f=s),f>h){var p=t.substring(h,f-h);c.push(new J(p))}if(-1!=o&&s>r&&(c.push(new J("\n")),o<t.length-1)){var v=t.length-o-1,m=new J(t.substring(o+1,v));c.push(m)}return c}},{key:"PushToOutputStreamIndividual",value:function(e){var t=E(e,nt),n=E(e,J),r=!0;if(t)this.TrimNewlinesFromOutputStream(),r=!0;else if(n){var i=-1,a=this.callStack.currentElement;a.type==ce.Function&&(i=a.functionStartInOutputStream);for(var o=-1,s=this.outputStream.length-1;s>=0;s--){var l=this.outputStream[s],u=l instanceof te?l:null;if(null!=(l instanceof nt?l:null)){o=s;break}if(null!=u&&u.commandType==te.CommandType.BeginString){s>=i&&(i=-1);break}}if(-1!=(-1!=o&&-1!=i?Math.min(i,o):-1!=o?o:i)){if(n.isNewline)r=!1;else if(n.isNonWhitespace&&(o>-1&&this.RemoveExistingGlue(),i>-1))for(var c=this.callStack.elements,h=c.length-1;h>=0;h--){var f=c[h];if(f.type!=ce.Function)break;f.functionStartInOutputStream=-1}}else n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(r=!1))}if(r){if(null===e)return L("obj");this.outputStream.push(e),this.OutputStreamDirty()}}},{key:"TrimNewlinesFromOutputStream",value:function(){for(var e=-1,t=this.outputStream.length-1;t>=0;){var n=this.outputStream[t],r=E(n,te),i=E(n,J);if(null!=r||null!=i&&i.isNonWhitespace)break;null!=i&&i.isNewline&&(e=t),t--}if(e>=0)for(t=e;t<this.outputStream.length;)E(this.outputStream[t],J)?this.outputStream.splice(t,1):t++;this.OutputStreamDirty()}},{key:"RemoveExistingGlue",value:function(){for(var e=this.outputStream.length-1;e>=0;e--){var t=this.outputStream[e];if(t instanceof nt)this.outputStream.splice(e,1);else if(t instanceof te)break}this.OutputStreamDirty()}},{key:"outputStreamEndsInNewline",get:function(){if(this.outputStream.length>0)for(var e=this.outputStream.length-1;e>=0&&!(this.outputStream[e]instanceof te);e--){var t=this.outputStream[e];if(t instanceof J){if(t.isNewline)return!0;if(t.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){var e,t=b(this.outputStream);try{for(t.s();!(e=t.n()).done;)if(e.value instanceof J)return!0}catch(e){t.e(e)}finally{t.f()}return!1}},{key:"inStringEvaluation",get:function(){for(var e=this.outputStream.length-1;e>=0;e--){var t=E(this.outputStream[e],te);if(t instanceof te&&t.commandType==te.CommandType.BeginString)return!0}return!1}},{key:"PushEvaluationStack",value:function(e){var t=E(e,Z);if(t){var n=t.value;if(null===n)return L("rawList");if(null!=n.originNames){n.origins||(n.origins=[]),n.origins.length=0;var r,i=b(n.originNames);try{for(i.s();!(r=i.n()).done;){var a=r.value;if(null===this.story.listDefinitions)return L("StoryState.story.listDefinitions");var o=this.story.listDefinitions.TryListGetDefinition(a,null);if(null===o.result)return L("StoryState def.result");n.origins.indexOf(o.result)<0&&n.origins.push(o.result)}}catch(e){i.e(e)}finally{i.f()}}}if(null===e)return L("obj");this.evaluationStack.push(e)}},{key:"PopEvaluationStack",value:function(e){if(void 0===e)return A(this.evaluationStack.pop());if(e>this.evaluationStack.length)throw new Error("trying to pop too many objects");return A(this.evaluationStack.splice(this.evaluationStack.length-e,e))}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"ForceEnd",value:function(){this.callStack.Reset(),this._currentFlow.currentChoices.length=0,this.currentPointer=de.Null,this.previousPointer=de.Null,this.didSafeExit=!0}},{key:"TrimWhitespaceFromFunctionEnd",value:function(){I.Assert(this.callStack.currentElement.type==ce.Function);var e=this.callStack.currentElement.functionStartInOutputStream;-1==e&&(e=0);for(var t=this.outputStream.length-1;t>=e;t--){var n=this.outputStream[t],r=E(n,J),i=E(n,te);if(null!=r){if(i)break;if(!r.isNewline&&!r.isInlineWhitespace)break;this.outputStream.splice(t,1),this.OutputStreamDirty()}}}},{key:"PopCallStack",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.callStack.currentElement.type==ce.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(e)}},{key:"SetChosenPath",value:function(e,t){this._currentFlow.currentChoices.length=0;var n=this.story.PointerAtPath(e);n.isNull||-1!=n.index||(n.index=0),this.currentPointer=n,t&&this.currentTurnIndex++}},{key:"StartFunctionEvaluationFromGame",value:function(e,t){this.callStack.Push(ce.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=de.StartOf(e),this.PassArgumentsToEvaluationStack(t)}},{key:"PassArgumentsToEvaluationStack",value:function(e){if(null!==e)for(var t=0;t<e.length;t++){if("number"!=typeof e[t]&&"string"!=typeof e[t]||e[t]instanceof V)throw new Error("null");this.PushEvaluationStack(H.Create(e[t]))}}},{key:"TryExitFunctionEvaluationFromGame",value:function(){return this.callStack.currentElement.type==ce.FunctionEvaluationFromGame&&(this.currentPointer=de.Null,this.didSafeExit=!0,!0)}},{key:"CompleteFunctionEvaluationFromGame",value:function(){if(this.callStack.currentElement.type!=ce.FunctionEvaluationFromGame)throw new Error("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);for(var e=this.callStack.currentElement.evaluationStackHeightWhenPushed,t=null;this.evaluationStack.length>e;){var n=this.PopEvaluationStack();null===t&&(t=n)}if(this.PopCallStack(ce.FunctionEvaluationFromGame),t){if(t instanceof re)return null;var r=_(t,H);return r.valueType==q.DivertTarget?r.valueObject.toString():r.valueObject}return null}},{key:"AddError",value:function(e,t){t?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(e)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(e))}},{key:"OutputStreamDirty",value:function(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}]),t}(),St=function(){function e(){n(this,e),this.startTime=void 0}return i(e,[{key:"ElapsedMilliseconds",get:function(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}},{key:"Start",value:function(){this.startTime=(new Date).getTime()}},{key:"Stop",value:function(){this.startTime=void 0}}]),e}();!function(e){e[e.Author=0]="Author",e[e.Warning=1]="Warning",e[e.Error=2]="Error"}(Ct||(Ct={})),Number.isInteger||(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&e>-9007199254740992&&e<9007199254740992&&Math.floor(e)===e}),e.Story=function(e){a(o,e);var r=d(o);function o(){var e,t;n(this,o),(e=r.call(this)).inkVersionMinimumCompatible=18,e.onError=null,e.onDidContinue=null,e.onMakeChoice=null,e.onEvaluateFunction=null,e.onCompleteEvaluateFunction=null,e.onChoosePathString=null,e._prevContainers=[],e.allowExternalFunctionFallbacks=!1,e._listDefinitions=null,e._variableObservers=null,e._hasValidatedExternals=!1,e._temporaryEvaluationContainer=null,e._asyncContinueActive=!1,e._stateSnapshotAtLastNewline=null,e._sawLookaheadUnsafeFunctionAfterNewline=!1,e._recursiveContinueCount=0,e._asyncSaving=!1,e._profiler=null;var i=null,a=null;if(arguments[0]instanceof ee)t=arguments[0],void 0!==arguments[1]&&(i=arguments[1]),e._mainContentContainer=t;else if("string"==typeof arguments[0]){var s=arguments[0];a=gt.TextToDictionary(s)}else a=arguments[0];if(null!=i&&(e._listDefinitions=new ft(i)),e._externals=new Map,null!==a){var l=a,u=l.inkVersion;if(null==u)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");var c=parseInt(u);if(c>o.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(c<e.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");c!=o.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var h,f=l.root;if(null==f)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(h=l.listDefs)&&(e._listDefinitions=dt.JTokenToListDefinitions(h)),e._mainContentContainer=_(dt.JTokenToRuntimeObject(f),ee),e.ResetState()}return e}return i(o,[{key:"currentChoices",get:function(){var e=[];if(null===this._state)return L("this._state");var t,n=b(this._state.currentChoices);try{for(n.s();!(t=n.n()).done;){var r=t.value;r.isInvisibleDefault||(r.index=e.length,e.push(r))}}catch(e){n.e(e)}finally{n.f()}return e}},{key:"currentText",get:function(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}},{key:"currentTags",get:function(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"currentWarnings",get:function(){return this.state.currentWarnings}},{key:"currentFlowName",get:function(){return this.state.currentFlowName}},{key:"hasError",get:function(){return this.state.hasError}},{key:"hasWarning",get:function(){return this.state.hasWarning}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"listDefinitions",get:function(){return this._listDefinitions}},{key:"state",get:function(){return this._state}},{key:"StartProfiling",value:function(){}},{key:"EndProfiling",value:function(){}},{key:"ToJson",value:function(e){var t=this,n=!1;if(e||(n=!0,e=new gt.Writer),e.WriteObjectStart(),e.WriteIntProperty("inkVersion",o.inkVersionCurrent),e.WriteProperty("root",(function(e){return dt.WriteRuntimeContainer(e,t._mainContentContainer)})),null!=this._listDefinitions){e.WritePropertyStart("listDefs"),e.WriteObjectStart();var r,i=b(this._listDefinitions.lists);try{for(i.s();!(r=i.n()).done;){var a=r.value;e.WritePropertyStart(a.name),e.WriteObjectStart();var s,l=b(a.items);try{for(l.s();!(s=l.n()).done;){var u=m(s.value,2),c=u[0],h=u[1],f=M.fromSerializedKey(c),d=h;e.WriteIntProperty(f.itemName,d)}}catch(e){l.e(e)}finally{l.f()}e.WriteObjectEnd(),e.WritePropertyEnd()}}catch(e){i.e(e)}finally{i.f()}e.WriteObjectEnd(),e.WritePropertyEnd()}if(e.WriteObjectEnd(),n)return e.toString()}},{key:"ResetState",value:function(){this.IfAsyncWeCant("ResetState"),this._state=new wt(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){if(null===this._state)return L("this._state");this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return L("this._state");this._state.ForceEnd()}},{key:"ResetGlobals",value:function(){if(this._mainContentContainer.namedContent.get("global decl")){var e=this.state.currentPointer.copy();this.ChoosePath(new R("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=e}this.state.variablesState.SnapshotDefaultGlobals()}},{key:"SwitchFlow",value:function(e){if(this.IfAsyncWeCant("switch flow"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't switch flow to "+e);this.state.SwitchFlow_Internal(e)}},{key:"RemoveFlow",value:function(e){this.state.RemoveFlow_Internal(e)}},{key:"SwitchToDefaultFlow",value:function(){this.state.SwitchToDefaultFlow_Internal()}},{key:"Continue",value:function(){return this.ContinueAsync(0),this.currentText}},{key:"canContinue",get:function(){return this.state.canContinue}},{key:"asyncContinueComplete",get:function(){return!this._asyncContinueActive}},{key:"ContinueAsync",value:function(e){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(e)}},{key:"ContinueInternal",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;null!=this._profiler&&this._profiler.PreContinue();var t=e>0;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=t,!this.canContinue)throw new Error("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}var n=new St;n.Start();var r=!1;this._sawLookaheadUnsafeFunctionAfterNewline=!1;do{try{r=this.ContinueSingleStep()}catch(e){if(!(e instanceof B))throw e;this.AddError(e.message,void 0,e.useEndLineNumber);break}if(r)break;if(this._asyncContinueActive&&n.ElapsedMilliseconds>e)break}while(this.canContinue);if(n.Stop(),!r&&this.canContinue||(null!==this._stateSnapshotAtLastNewline&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(ce.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(ce.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,this._sawLookaheadUnsafeFunctionAfterNewline=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1,null!==this.onDidContinue&&this.onDidContinue()),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue(),this.state.hasError||this.state.hasWarning){if(null===this.onError){var i=new $;throw i.Append("Ink had "),this.state.hasError&&(i.Append("".concat(this.state.currentErrors.length)),i.Append(1==this.state.currentErrors.length?" error":"errors"),this.state.hasWarning&&i.Append(" and ")),this.state.hasWarning&&(i.Append("".concat(this.state.currentWarnings.length)),i.Append(1==this.state.currentWarnings.length?" warning":"warnings"),this.state.hasWarning&&i.Append(" and ")),i.Append(". It is strongly suggested that you assign an error handler to story.onError. The first issue was: "),i.Append(this.state.hasError?this.state.currentErrors[0]:this.state.currentWarnings[0]),new B(i.toString())}if(this.state.hasError){var a,o=b(this.state.currentErrors);try{for(o.s();!(a=o.n()).done;){var s=a.value;this.onError(s,Ct.Error)}}catch(s){o.e(s)}finally{o.f()}}if(this.state.hasWarning){var l,u=b(this.state.currentWarnings);try{for(u.s();!(l=u.n()).done;){var c=l.value;this.onError(c,Ct.Warning)}}catch(s){u.e(s)}finally{u.f()}}this.ResetErrors()}}},{key:"ContinueSingleStep",value:function(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!==this._stateSnapshotAtLastNewline){if(null===this._stateSnapshotAtLastNewline.currentTags)return L("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return L("this.state.currentTags");var e=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(e==o.OutputStateChange.ExtendedBeyondNewline||this._sawLookaheadUnsafeFunctionAfterNewline)return this.RestoreStateSnapshot(),!0;e==o.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateSnapshotAtLastNewline&&this.StateSnapshot():this.DiscardSnapshot())}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}},{key:"CalculateNewlineOutputStateChange",value:function(e,t,n,r){if(null===e)return L("prevText");if(null===t)return L("currText");var i=t.length>=e.length&&"\n"==t.charAt(e.length-1);if(n==r&&e.length==t.length&&i)return o.OutputStateChange.NoChange;if(!i)return o.OutputStateChange.NewlineRemoved;if(r>n)return o.OutputStateChange.ExtendedBeyondNewline;for(var a=e.length;a<t.length;a++){var s=t.charAt(a);if(" "!=s&&"\t"!=s)return o.OutputStateChange.ExtendedBeyondNewline}return o.OutputStateChange.NoChange}},{key:"ContinueMaximally",value:function(){this.IfAsyncWeCant("ContinueMaximally");for(var e=new $;this.canContinue;)e.Append(this.Continue());return e.toString()}},{key:"ContentAtPath",value:function(e){return this.mainContentContainer.ContentAtPath(e)}},{key:"KnotContainerWithName",value:function(e){var t=this.mainContentContainer.namedContent.get(e);return t instanceof ee?t:null}},{key:"PointerAtPath",value:function(e){if(0==e.length)return de.Null;var t=new de,n=e.length,r=null;return null===e.lastComponent?L("path.lastComponent"):(e.lastComponent.isIndex?(n=e.length-1,r=this.mainContentContainer.ContentAtPath(e,void 0,n),t.container=r.container,t.index=e.lastComponent.index):(r=this.mainContentContainer.ContentAtPath(e),t.container=r.container,t.index=-1),null==r.obj||r.obj==this.mainContentContainer&&n>0?this.Error("Failed to find content at path '"+e+"', and no approximation of it was possible."):r.approximate&&this.Warning("Failed to find content at path '"+e+"', so it was approximated to: '"+r.obj.path+"'."),t)}},{key:"StateSnapshot",value:function(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching()}},{key:"RestoreStateSnapshot",value:function(){null===this._stateSnapshotAtLastNewline&&L("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}},{key:"DiscardSnapshot",value:function(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}},{key:"CopyStateForBackgroundThreadSave",value:function(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");var e=this._state;return this._state=this._state.CopyAndStartPatching(),this._asyncSaving=!0,e}},{key:"BackgroundSaveComplete",value:function(){null===this._stateSnapshotAtLastNewline&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}},{key:"Step",value:function(){var e=!0,t=this.state.currentPointer.copy();if(!t.isNull){for(var n=E(t.Resolve(),ee);n&&(this.VisitContainer(n,!0),0!=n.content.length);)n=E((t=de.StartOf(n)).Resolve(),ee);this.state.currentPointer=t.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);var r=t.Resolve(),i=this.PerformLogicAndFlowControl(r);if(!this.state.currentPointer.isNull){i&&(e=!1);var a=E(r,he);if(a){var o=this.ProcessChoice(a);o&&this.state.generatedChoices.push(o),r=null,e=!1}if(r instanceof ee&&(e=!1),e){var s=E(r,X);if(s&&-1==s.contextIndex){var l=this.state.callStack.ContextForVariableNamed(s.variableName);r=new X(s.variableName,l)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(r):this.state.PushToOutputStream(r)}this.NextContent();var u=E(r,te);u&&u.commandType==te.CommandType.StartThread&&this.state.callStack.PushThread()}}}},{key:"VisitContainer",value:function(e,t){e.countingAtStartOnly&&!t||(e.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(e),e.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(e))}},{key:"VisitChangedContainersDueToDivert",value:function(){var e=this.state.previousPointer.copy(),t=this.state.currentPointer.copy();if(!t.isNull&&-1!=t.index){if(this._prevContainers.length=0,!e.isNull)for(var n=E(e.Resolve(),ee)||E(e.container,ee);n;)this._prevContainers.push(n),n=E(n.parent,ee);var r=t.Resolve();if(null!=r)for(var i=E(r.parent,ee),a=!0;i&&(this._prevContainers.indexOf(i)<0||i.countingAtStartOnly);){var o=i.content.length>0&&r==i.content[0]&&a;o||(a=!1),this.VisitContainer(i,o),r=i,i=E(i.parent,ee)}}}},{key:"ProcessChoice",value:function(e){var t=!0;if(e.hasCondition){var n=this.state.PopEvaluationStack();this.IsTruthy(n)||(t=!1)}var r="",i="";if(e.hasChoiceOnlyContent&&(i=_(this.state.PopEvaluationStack(),J).value||""),e.hasStartContent&&(r=_(this.state.PopEvaluationStack(),J).value||""),e.onceOnly&&this.state.VisitCountForContainer(e.choiceTarget)>0&&(t=!1),!t)return null;var a=new ht;return a.targetPath=e.pathOnChoice,a.sourcePath=e.path.toString(),a.isInvisibleDefault=e.isInvisibleDefault,a.threadAtGeneration=this.state.callStack.ForkThread(),a.text=(r+i).replace(/^[ \t]+|[ \t]+$/g,""),a}},{key:"IsTruthy",value:function(e){if(e instanceof H){var t=e;if(t instanceof Y){var n=t;return this.Error("Shouldn't use a divert target (to "+n.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return t.isTruthy}return!1}},{key:"PerformLogicAndFlowControl",value:function(e){if(null==e)return!1;if(e instanceof pe){var t=e;if(t.isConditional){var n=this.state.PopEvaluationStack();if(!this.IsTruthy(n))return!0}if(t.hasVariableTarget){var r=t.variableDivertName,i=this.state.variablesState.GetVariableWithName(r);if(null==i)this.Error("Tried to divert using a target from a variable that could not be found ("+r+")");else if(!(i instanceof Y)){var a=E(i,K),o="Tried to divert to a target from a variable, but the variable ("+r+") didn't contain a divert target, it ";a instanceof K&&0==a.value?o+="was empty/null (the value 0).":o+="contained '"+i+"'.",this.Error(o)}var s=_(i,Y);this.state.divertedPointer=this.PointerAtPath(s.targetPath)}else{if(t.isExternal)return this.CallExternalFunction(t.targetPathString,t.externalArgs),!0;this.state.divertedPointer=t.targetPointer.copy()}return t.pushesToStack&&this.state.callStack.Push(t.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!t.isExternal&&(t&&t.debugMetadata&&null!=t.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+t.debugMetadata.sourceName):this.Error("Divert resolution failed: "+t)),!0}if(e instanceof te){var l=e;switch(l.commandType){case te.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case te.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case te.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){var u=this.state.PopEvaluationStack();if(!(u instanceof re)){var c=new J(u.toString());this.state.PushToOutputStream(c)}}break;case te.CommandType.NoOp:break;case te.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case te.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case te.CommandType.PopFunction:case te.CommandType.PopTunnel:var h=l.commandType==te.CommandType.PopFunction?ce.Function:ce.Tunnel,f=null;if(h==ce.Tunnel){var d=this.state.PopEvaluationStack();null===(f=E(d,Y))&&this.Assert(d instanceof re,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==h&&this.state.callStack.canPop)this.state.PopCallStack(),f&&(this.state.divertedPointer=this.PointerAtPath(f.targetPath));else{var p=new Map;p.set(ce.Function,"function return statement (~ return)"),p.set(ce.Tunnel,"tunnel onwards statement (->->)");var v=p.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(v="end of flow (-> END or choice)");var m="Found "+p.get(h)+", when expected "+v;this.Error(m)}break;case te.CommandType.BeginString:this.state.PushToOutputStream(l),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case te.CommandType.EndString:for(var y=[],g=0,C=this.state.outputStream.length-1;C>=0;--C){var w=this.state.outputStream[C];g++;var S=E(w,te);if(S&&S.commandType==te.CommandType.BeginString)break;w instanceof J&&y.push(w)}this.state.PopFromOutputStream(g),y=y.reverse();var k,x=new $,T=b(y);try{for(T.s();!(k=T.n()).done;){var A=k.value;x.Append(A.toString())}}catch(e){T.e(e)}finally{T.f()}this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new J(x.toString()));break;case te.CommandType.ChoiceCount:var N=this.state.generatedChoices.length;this.state.PushEvaluationStack(new K(N));break;case te.CommandType.Turns:this.state.PushEvaluationStack(new K(this.state.currentTurnIndex+1));break;case te.CommandType.TurnsSince:case te.CommandType.ReadCount:var O=this.state.PopEvaluationStack();if(!(O instanceof Y)){var P="";O instanceof K&&(P=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+O+P);break}var I,F=_(O,Y),W=E(this.ContentAtPath(F.targetPath).correctObj,ee);null!=W?I=l.commandType==te.CommandType.TurnsSince?this.state.TurnsSinceForContainer(W):this.state.VisitCountForContainer(W):(I=l.commandType==te.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+l.toString()+" lookup at "+F.targetPath.toString())),this.state.PushEvaluationStack(new K(I));break;case te.CommandType.Random:var R=E(this.state.PopEvaluationStack(),K),D=E(this.state.PopEvaluationStack(),K);if(null==D||D instanceof K==0)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==R||D instanceof K==0)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===R.value)return L("maxInt.value");if(null===D.value)return L("minInt.value");var j=R.value-D.value+1;(!isFinite(j)||j>Number.MAX_SAFE_INTEGER)&&(j=Number.MAX_SAFE_INTEGER,this.Error("RANDOM was called with a range that exceeds the size that ink numbers can use.")),j<=0&&this.Error("RANDOM was called with minimum as "+D.value+" and maximum as "+R.value+". The maximum must be larger");var G=this.state.storySeed+this.state.previousRandom,q=new mt(G).next(),U=q%j+D.value;this.state.PushEvaluationStack(new K(U)),this.state.previousRandom=q;break;case te.CommandType.SeedRandom:var z=E(this.state.PopEvaluationStack(),K);if(null==z||z instanceof K==0)return this.Error("Invalid value passed to SEED_RANDOM");if(null===z.value)return L("minInt.value");this.state.storySeed=z.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new re);break;case te.CommandType.VisitIndex:var X=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new K(X));break;case te.CommandType.SequenceShuffleIndex:var Q=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new K(Q));break;case te.CommandType.StartThread:break;case te.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=de.Null);break;case te.CommandType.End:this.state.ForceEnd();break;case te.CommandType.ListFromInt:var ne=E(this.state.PopEvaluationStack(),K),ae=_(this.state.PopEvaluationStack(),J);if(null===ne)throw new B("Passed non-integer when creating a list element from a numerical value.");var oe=null;if(null===this.listDefinitions)return L("this.listDefinitions");var se=this.listDefinitions.TryListGetDefinition(ae.value,null);if(!se.exists)throw new B("Failed to find LIST called "+ae.value);if(null===ne.value)return L("minInt.value");var le=se.result.TryGetItemWithValue(ne.value,M.Null);le.exists&&(oe=new Z(le.result,ne.value)),null==oe&&(oe=new Z),this.state.PushEvaluationStack(oe);break;case te.CommandType.ListRange:var ue=E(this.state.PopEvaluationStack(),H),he=E(this.state.PopEvaluationStack(),H),fe=E(this.state.PopEvaluationStack(),Z);if(null===fe||null===he||null===ue)throw new B("Expected list, minimum and maximum for LIST_RANGE");if(null===fe.value)return L("targetList.value");var me=fe.value.ListWithSubRange(he.valueObject,ue.valueObject);this.state.PushEvaluationStack(new Z(me));break;case te.CommandType.ListRandom:var ye=this.state.PopEvaluationStack();if(null===ye)throw new B("Expected list for LIST_RANDOM");var ge=ye.value,Ce=null;if(null===ge)throw L("list");if(0==ge.Count)Ce=new V;else{for(var be=this.state.storySeed+this.state.previousRandom,we=new mt(be).next(),Se=we%ge.Count,ke=ge.entries(),xe=0;xe<=Se-1;xe++)ke.next();var Ee=ke.next().value,_e={Key:M.fromSerializedKey(Ee[0]),Value:Ee[1]};if(null===_e.Key.originName)return L("randomItem.Key.originName");(Ce=new V(_e.Key.originName,this)).Add(_e.Key,_e.Value),this.state.previousRandom=we}this.state.PushEvaluationStack(new Z(Ce));break;default:this.Error("unhandled ControlCommand: "+l)}return!0}if(e instanceof ve){var Te=e,Ae=this.state.PopEvaluationStack();return this.state.variablesState.Assign(Te,Ae),!0}if(e instanceof Fe){var Ne=e,Oe=null;if(null!=Ne.pathForCount){var Pe=Ne.containerForCount,Ie=this.state.VisitCountForContainer(Pe);Oe=new K(Ie)}else null==(Oe=this.state.variablesState.GetVariableWithName(Ne.name))&&(this.Warning("Variable not found: '"+Ne.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),Oe=new K(0));return this.state.PushEvaluationStack(Oe),!0}if(e instanceof ie){var We=e,Re=this.state.PopEvaluationStack(We.numberOfParameters),De=We.Call(Re);return this.state.PushEvaluationStack(De),!0}return!1}},{key:"ChoosePathString",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),null!==this.onChoosePathString&&this.onChoosePathString(e,n),t)this.ResetCallstack();else if(this.state.callStack.currentElement.type==ce.Function){var r="",i=this.state.callStack.currentElement.currentPointer.container;throw null!=i&&(r="("+i.path.toString()+") "),new Error("Story was running a function "+r+"when you called ChoosePathString("+e+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(n),this.ChoosePath(new R(e))}},{key:"IfAsyncWeCant",value:function(e){if(this._asyncContinueActive)throw new Error("Can't "+e+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}},{key:"ChoosePath",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.state.SetChosenPath(e,t),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(e){var t=this.currentChoices;this.Assert(e>=0&&e<t.length,"choice out of range");var n=t[e];return null!==this.onMakeChoice&&this.onMakeChoice(n),null===n.threadAtGeneration?L("choiceToChoose.threadAtGeneration"):null===n.targetPath?L("choiceToChoose.targetPath"):(this.state.callStack.currentThread=n.threadAtGeneration,void this.ChoosePath(n.targetPath))}},{key:"HasFunction",value:function(e){try{return null!=this.KnotContainerWithName(e)}catch(e){return!1}}},{key:"EvaluateFunction",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null!==this.onEvaluateFunction&&this.onEvaluateFunction(e,t),this.IfAsyncWeCant("evaluate a function"),null==e)throw new Error("Function is null");if(""==e||""==e.trim())throw new Error("Function is empty or white space.");var r=this.KnotContainerWithName(e);if(null==r)throw new Error("Function doesn't exist: '"+e+"'");var i=[];i.push.apply(i,y(this.state.outputStream)),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(r,t);for(var a=new $;this.canContinue;)a.Append(this.Continue());var o=a.toString();this._state.ResetOutput(i);var s=this.state.CompleteFunctionEvaluationFromGame();return null!=this.onCompleteEvaluateFunction&&this.onCompleteEvaluateFunction(e,t,o,s),n?{returned:s,output:o}:s}},{key:"EvaluateExpression",value:function(e){var t=this.state.callStack.elements.length;this.state.callStack.Push(ce.Tunnel),this._temporaryEvaluationContainer=e,this.state.GoToStart();var n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>t&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(e,n){if(null===e)return L("funcName");var r=this._externals.get(e),i=null,a=void 0!==r;if(!a||r.lookAheadSafe||null===this._stateSnapshotAtLastNewline){if(!a){if(this.allowExternalFunctionFallbacks)return i=this.KnotContainerWithName(e),this.Assert(null!==i,"Trying to call EXTERNAL function '"+e+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(ce.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=de.StartOf(i));this.Assert(!1,"Trying to call EXTERNAL function '"+e+"' which has not been bound (and ink fallbacks disabled).")}for(var o=[],s=0;s<n;++s){var l=_(this.state.PopEvaluationStack(),H).valueObject;o.push(l)}o.reverse();var u=r.function(o),c=null;null!=u?(c=H.Create(u),this.Assert(null!==c,"Could not create ink value from returned object of type "+t(u))):c=new re,this.state.PushEvaluationStack(c)}else this._sawLookaheadUnsafeFunctionAfterNewline=!0}},{key:"BindExternalFunctionGeneral",value:function(e,t,n){this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(e),"Function '"+e+"' has already been bound."),this._externals.set(e,{function:t,lookAheadSafe:n})}},{key:"TryCoerce",value:function(e){return e}},{key:"BindExternalFunction",value:function(e,t,n){var r=this;this.Assert(null!=t,"Can't bind a null function"),this.BindExternalFunctionGeneral(e,(function(e){r.Assert(e.length>=t.length,"External function expected "+t.length+" arguments");for(var n=[],i=0,a=e.length;i<a;i++)n[i]=r.TryCoerce(e[i]);return t.apply(null,n)}),n)}},{key:"UnbindExternalFunction",value:function(e){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(e),"Function '"+e+"' has not been bound."),this._externals.delete(e)}},{key:"ValidateExternalBindings",value:function(){var e=null,t=null,n=arguments[1]||new Set;if(arguments[0]instanceof ee&&(e=arguments[0]),arguments[0]instanceof j&&(t=arguments[0]),null===e&&null===t)if(this.ValidateExternalBindings(this._mainContentContainer,n),this._hasValidatedExternals=!0,0==n.size)this._hasValidatedExternals=!0;else{var r="Error: Missing function binding for external";r+=n.size>1?"s":"",r+=": '",r+=Array.from(n).join("', '"),r+="' ",r+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(r)}else if(null!=e){var i,a=b(e.content);try{for(a.s();!(i=a.n()).done;){var o=i.value;null!=o&&o.hasValidName||this.ValidateExternalBindings(o,n)}}catch(e){a.e(e)}finally{a.f()}var s,l=b(e.namedContent);try{for(l.s();!(s=l.n()).done;){var u=m(s.value,2)[1];this.ValidateExternalBindings(E(u,j),n)}}catch(e){l.e(e)}finally{l.f()}}else if(null!=t){var c=E(t,pe);if(c&&c.isExternal){var h=c.targetPathString;if(null===h)return L("name");this._externals.has(h)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(h)||n.add(h)}}}},{key:"ObserveVariable",value:function(e,t){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(e))throw new Error("Cannot observe variable '"+e+"' because it wasn't declared in the ink story.");this._variableObservers.has(e)?this._variableObservers.get(e).push(t):this._variableObservers.set(e,[t])}},{key:"ObserveVariables",value:function(e,t){for(var n=0,r=e.length;n<r;n++)this.ObserveVariable(e[n],t[n])}},{key:"RemoveVariableObserver",value:function(e,t){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(null!=t){if(this._variableObservers.has(t))if(null!=e){var n=this._variableObservers.get(t);null!=n&&(n.splice(n.indexOf(e),1),0===n.length&&this._variableObservers.delete(t))}else this._variableObservers.delete(t)}else if(null!=e){var r,i=b(this._variableObservers.keys());try{for(i.s();!(r=i.n()).done;){var a=r.value,o=this._variableObservers.get(a);null!=o&&(o.splice(o.indexOf(e),1),0===o.length&&this._variableObservers.delete(a))}}catch(e){i.e(e)}finally{i.f()}}}},{key:"VariableStateDidChangeEvent",value:function(e,t){if(null!==this._variableObservers){var n=this._variableObservers.get(e);if(void 0!==n){if(!(t instanceof H))throw new Error("Tried to get the value of a variable that isn't a standard type");var r,i=_(t,H),a=b(n);try{for(a.s();!(r=a.n()).done;)(0,r.value)(e,i.valueObject)}catch(e){a.e(e)}finally{a.f()}}}}},{key:"globalTags",get:function(){return this.TagsAtStartOfFlowContainerWithPathString("")}},{key:"TagsForContentAtPath",value:function(e){return this.TagsAtStartOfFlowContainerWithPathString(e)}},{key:"TagsAtStartOfFlowContainerWithPathString",value:function(e){var t=new R(e),n=this.ContentAtPath(t).container;if(null===n)return L("flowContainer");for(;;){var r=n.content[0];if(!(r instanceof ee))break;n=r}var i,a=null,o=b(n.content);try{for(o.s();!(i=o.n()).done;){var s=E(i.value,ct);if(!s)break;null==a&&(a=[]),a.push(s.text)}}catch(e){o.e(e)}finally{o.f()}return a}},{key:"BuildStringOfHierarchy",value:function(){var e=new $;return this.mainContentContainer.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}},{key:"BuildStringOfContainer",value:function(e){var t=new $;return e.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}},{key:"NextContent",value:function(){if(this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=de.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){var e=!1;this.state.callStack.CanPop(ce.Function)?(this.state.PopCallStack(ce.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new re),e=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),e=!0):this.state.TryExitFunctionEvaluationFromGame(),e&&!this.state.currentPointer.isNull&&this.NextContent()}}},{key:"IncrementContentPointer",value:function(){var e=!0,t=this.state.callStack.currentElement.currentPointer.copy();if(t.index++,null===t.container)return L("pointer.container");for(;t.index>=t.container.content.length;){e=!1;var n=E(t.container.parent,ee);if(n instanceof ee==0)break;var r=n.content.indexOf(t.container);if(-1==r)break;if((t=new de(n,r)).index++,e=!0,null===t.container)return L("pointer.container")}return e||(t=de.Null),this.state.callStack.currentElement.currentPointer=t.copy(),e}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var e=this._state.currentChoices,t=e.filter((function(e){return e.isInvisibleDefault}));if(0==t.length||e.length>t.length)return!1;var n=t[0];return null===n.targetPath?L("choice.targetPath"):null===n.threadAtGeneration?L("choice.threadAtGeneration"):(this.state.callStack.currentThread=n.threadAtGeneration,null!==this._stateSnapshotAtLastNewline&&(this.state.callStack.currentThread=this.state.callStack.ForkThread()),this.ChoosePath(n.targetPath,!1),!0)}},{key:"NextSequenceShuffleIndex",value:function(){var e=E(this.state.PopEvaluationStack(),K);if(!(e instanceof K))return this.Error("expected number of elements in sequence for shuffle index"),0;var t=this.state.currentPointer.container;if(null===t)return L("seqContainer");if(null===e.value)return L("numElementsIntVal.value");var n=e.value,r=_(this.state.PopEvaluationStack(),K).value;if(null===r)return L("seqCount");for(var i=r/n,a=r%n,o=t.path.toString(),s=0,l=0,u=o.length;l<u;l++)s+=o.charCodeAt(l)||0;for(var c=s+i+this.state.storySeed,h=new mt(Math.floor(c)),f=[],d=0;d<n;++d)f.push(d);for(var p=0;p<=a;++p){var v=h.next()%f.length,m=f[v];if(f.splice(v,1),p==a)return m}throw new Error("Should never reach here")}},{key:"Error",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=new B(e);throw n.useEndLineNumber=t,n}},{key:"Warning",value:function(e){this.AddError(e,!0)}},{key:"AddError",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.currentDebugMetadata,i=t?"WARNING":"ERROR";if(null!=r){var a=n?r.endLineNumber:r.startLineNumber;e="RUNTIME "+i+": '"+r.fileName+"' line "+a+": "+e}else e=this.state.currentPointer.isNull?"RUNTIME "+i+": "+e:"RUNTIME "+i+": ("+this.state.currentPointer+"): "+e;this.state.AddError(e,t),t||this.state.ForceEnd()}},{key:"Assert",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(0==e)throw null==t&&(t="Story assert"),new Error(t+" "+this.currentDebugMetadata)}},{key:"currentDebugMetadata",get:function(){var e,t=this.state.currentPointer;if(!t.isNull&&null!==t.Resolve()&&null!==(e=t.Resolve().debugMetadata))return e;for(var n=this.state.callStack.elements.length-1;n>=0;--n)if(!(t=this.state.callStack.elements[n].currentPointer).isNull&&null!==t.Resolve()&&null!==(e=t.Resolve().debugMetadata))return e;for(var r=this.state.outputStream.length-1;r>=0;--r)if(null!==(e=this.state.outputStream[r].debugMetadata))return e;return null}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}]),o}(j),e.Story.inkVersionCurrent=20,function(e){var t;(t=e.OutputStateChange||(e.OutputStateChange={}))[t.NoChange=0]="NoChange",t[t.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",t[t.NewlineRemoved=2]="NewlineRemoved"}(e.Story||(e.Story={}));var kt=function(t){a(s,t);var r=d(s);function s(t){var i,a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return n(this,s),(i=r.call(this,null,t,null,!1,a))._errorHandler=null,i._hadError=!1,i._hadWarning=!1,i._dontFlattenContainers=new Set,i._listDefs=new Map,i.constants=new Map,i.externals=new Map,i.countAllVisits=!1,i.ExportRuntime=function(){var t,n,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;i._errorHandler=r,i.constants=new Map;var a,o=b(i.FindAll(Ee)());try{for(o.s();!(a=o.n()).done;){var s=a.value,l=i.constants.get(s.constantName);if(l&&!l.Equals(s.expression)){var u="CONST '".concat(s.constantName,"' has been redefined with a different value. Multiple definitions of the same CONST are valid so long as they contain the same value. Initial definition was on ").concat(l.debugMetadata,".");i.Error(u,s,!1)}i.constants.set(s.constantName,s.expression)}}catch(e){o.e(e)}finally{o.f()}i._listDefs=new Map;var c,f=b(i.FindAll(Ue)());try{for(f.s();!(c=f.n()).done;){var d=c.value;(null===(t=d.identifier)||void 0===t?void 0:t.name)&&i._listDefs.set(null===(n=d.identifier)||void 0===n?void 0:n.name,d)}}catch(e){f.e(e)}finally{f.f()}i.externals=new Map,i.ResolveWeavePointNaming();var p=i.runtimeObject,v=new ee;v.AddContent(te.EvalStart());var y,g=[],C=b(i.variableDeclarations);try{for(C.s();!(y=C.n()).done;){var w=m(y.value,2),S=w[0],k=w[1];if(k.isGlobalDeclaration){if(k.listDefinition)i._listDefs.set(S,k.listDefinition),v.AddContent(k.listDefinition.runtimeObject),g.push(k.listDefinition.runtimeListDefinition);else{if(!k.expression)throw new Error;k.expression.GenerateIntoContainer(v)}var x=new ve(S,!0);x.isGlobal=!0,v.AddContent(x)}}}catch(e){C.e(e)}finally{C.f()}v.AddContent(te.EvalEnd()),v.AddContent(te.End()),i.variableDeclarations.size>0&&(v.name="global decl",p.AddToNamedContentOnly(v)),p.AddContent(te.Done());var E=new e.Story(p,g);return i.runtimeObject=E,i.hadError?null:(i.FlattenContainersIn(p),i.ResolveReferences(h(i)),i.hadError?null:(E.ResetState(),E))},i.ResolveList=function(e){return i._listDefs.get(e)||null},i.ResolveListItem=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=null;if(e)return(r=i._listDefs.get(e))?r.ItemNamed(t):null;var a,o=null,s=null,l=b(i._listDefs.entries());try{for(l.s();!(a=l.n()).done;){var u=m(a.value,2)[1],c=u.ItemNamed(t);c&&(o?i.Error("Ambiguous item name '".concat(t,"' found in multiple sets, including ").concat(s.identifier," and ").concat(u.identifier),n,!1):(o=c,s=u))}}catch(e){l.e(e)}finally{l.f()}return o},i.FlattenContainersIn=function(e){var t=new Set;if(e.content){var n,r=b(e.content);try{for(r.s();!(n=r.n()).done;){var a=E(n.value,ee);a&&t.add(a)}}catch(e){r.e(e)}finally{r.f()}}if(e.namedContent){var o,s=b(e.namedContent);try{for(s.s();!(o=s.n()).done;){var l=E(m(o.value,2)[1],ee);l&&t.add(l)}}catch(e){s.e(e)}finally{s.f()}}var u,c=b(t);try{for(c.s();!(u=c.n()).done;){var h=u.value;i.TryFlattenContainer(h),i.FlattenContainersIn(h)}}catch(e){c.e(e)}finally{c.f()}},i.TryFlattenContainer=function(e){if(!(e.namedContent&&e.namedContent.size>0||e.hasValidName||i._dontFlattenContainers.has(e))){var t=E(e.parent,ee);if(t){var n=t.content.indexOf(e);t.content.splice(n,1);var r=e.ownDebugMetadata;if(e.content){var a,o=b(e.content);try{for(o.s();!(a=o.n()).done;){var s=a.value;s.parent=null,null!==r&&null===s.ownDebugMetadata&&(s.debugMetadata=r),t.InsertContent(s,n),n+=1}}catch(e){o.e(e)}finally{o.f()}}}}},i.Error=function(e,t,n){var r=n?w.Warning:w.Error,a="";if(t instanceof W?(a+="TODO: ",r=w.Author):a+=n?"WARNING: ":"ERROR: ",t&&null!==t.debugMetadata&&t.debugMetadata.startLineNumber>=1&&(null!=t.debugMetadata.fileName&&(a+="'".concat(t.debugMetadata.fileName,"' ")),a+="line ".concat(t.debugMetadata.startLineNumber,": ")),e=a+=e,null===i._errorHandler)throw new Error(e);i._errorHandler(e,r),i._hadError=r===w.Error,i._hadWarning=r===w.Warning},i.ResetError=function(){i._hadError=!1,i._hadWarning=!1},i.IsExternal=function(e){return i.externals.has(e)},i.AddExternal=function(e){i.externals.has(e.name)?i.Error("Duplicate EXTERNAL definition of '".concat(e.name,"'"),e,!1):e.name&&i.externals.set(e.name,e)},i.DontFlattenContainer=function(e){i._dontFlattenContainers.add(e)},i.NameConflictError=function(e,t,n,r){e.Error("".concat(r," '").concat(t,"': name has already been used for a ").concat(n.typeName.toLowerCase()," on ").concat(n.debugMetadata))},i.CheckForNamingCollisions=function(e,t,n){var r,a=(arguments.length>3&&void 0!==arguments[3]?arguments[3]:"")||e.typeName;if(s.IsReservedKeyword(null==t?void 0:t.name))e.Error("'".concat(t,"' cannot be used for the name of a ").concat(a.toLowerCase()," because it's a reserved keyword"));else if(Re.IsBuiltIn((null==t?void 0:t.name)||""))e.Error("'".concat(t,"' cannot be used for the name of a ").concat(a.toLowerCase()," because it's a built in function"));else{var o=E(i.ContentWithNameAtLevel((null==t?void 0:t.name)||"",we.Knot),Pe);if(!o||o===e&&n!==fe.Arg){if(!(n<fe.List)){var l,u=b(i._listDefs);try{for(u.s();!(l=u.n()).done;){var c=m(l.value,2),h=c[0],f=c[1];if((null==t?void 0:t.name)===h&&e!==f&&f.variableAssignment!==e&&i.NameConflictError(e,null==t?void 0:t.name,f,a),!(e instanceof lt)){var d,p=b(f.itemDefinitions);try{for(p.s();!(d=p.n()).done;){var v=d.value;(null==t?void 0:t.name)===v.name&&i.NameConflictError(e,(null==t?void 0:t.name)||"",v,a)}}catch(e){p.e(e)}finally{p.f()}}}}catch(e){u.e(e)}finally{u.f()}if(!(n<=fe.Var)){var y=(null==t?void 0:t.name)&&i.variableDeclarations.get(null==t?void 0:t.name)||null;if(y&&y!==e&&y.isGlobalDeclaration&&null==y.listDefinition&&i.NameConflictError(e,(null==t?void 0:t.name)||"",y,a),!(n<fe.SubFlowAndWeave)){var g=new Te(t).ResolveFromContext(e);if(g&&g!==e)i.NameConflictError(e,(null==t?void 0:t.name)||"",g,a);else if(!(n<fe.Arg)&&n!==fe.Arg){var C=E(e,Pe);if(C||(C=Ne(e)),C&&C.hasParameters&&C.args){var w,S=b(C.args);try{for(S.s();!(w=S.n()).done;)if((null===(r=w.value.identifier)||void 0===r?void 0:r.name)===(null==t?void 0:t.name))return void e.Error("".concat(a," '").concat(t,"': name has already been used for a argument to ").concat(C.identifier," on ").concat(C.debugMetadata))}catch(e){S.e(e)}finally{S.f()}}}}}}}else i.NameConflictError(e,(null==t?void 0:t.name)||"",o,a)}},i}return i(s,[{key:"flowLevel",get:function(){return we.Story}},{key:"hadError",get:function(){return this._hadError}},{key:"hadWarning",get:function(){return this._hadWarning}},{key:"typeName",get:function(){return"Story"}},{key:"PreProcessTopLevelObjects",value:function(e){v(o(s.prototype),"PreProcessTopLevelObjects",this).call(this,e);var t,n=[],r=b(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(i instanceof it){var a=i,l=e.indexOf(i);if(e.splice(l,1),a.includedStory){var u=[],c=a.includedStory;if(null!=c.content){var h,f=b(c.content);try{for(f.s();!(h=f.n()).done;){var d=h.value;d instanceof Pe?n.push(d):u.push(d)}}catch(e){f.e(e)}finally{f.f()}u.push(new xe("\n")),e.splice.apply(e,[l,0].concat(u))}}}}}catch(e){r.e(e)}finally{r.f()}e.splice.apply(e,[0,0].concat(n))}}]),s}(Pe);kt.IsReservedKeyword=function(e){switch(e){case"true":case"false":case"not":case"return":case"else":case"VAR":case"CONST":case"temp":case"LIST":case"function":return!0}return!1};var xt=function(e){a(r,e);var t=d(r);function r(e){var i;return n(this,r),(i=t.call(this)).GenerateIntoContainer=function(e){e.AddContent(te.BeginString());var t,n=b(i.content);try{for(n.s();!(t=n.n()).done;){var r=t.value;e.AddContent(r.runtimeObject)}}catch(e){n.e(e)}finally{n.f()}e.AddContent(te.EndString())},i.toString=function(){var e,t="",n=b(i.content);try{for(n.s();!(e=n.n()).done;)t+=e.value}catch(e){n.e(e)}finally{n.f()}return t},i.AddContent(e),i}return i(r,[{key:"isSingleString",get:function(){return 1===this.content.length&&this.content[0]instanceof xe}},{key:"typeName",get:function(){return"String"}},{key:"Equals",value:function(e){var t=E(e,r);return null!==t&&!(!this.isSingleString||!t.isSingleString)&&this.toString()===t.toString()}}]),r}(ne),Et=function(e){a(r,e);var t=d(r);function r(e){return n(this,r),t.call(this,e)}return i(r,[{key:"typeName",get:function(){return"Tag"}}]),r}(et),_t=i((function e(t){n(this,e),this.rootPath=t,this.ResolveInkFilename=function(){throw Error("Can't resolve filename because no FileHandler was provided when instantiating the parser / compiler.")},this.LoadInkFileContents=function(){throw Error("Can't load ink content because no FileHandler was provided when instantiating the parser / compiler.")}})),Tt=function(e){a(o,e);var r=d(o);function o(e){var i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(n(this,o),(i=r.call(this,e)).ParseStory=function(){var e=i.StatementsAtLevel(Ye.Top);return new kt(e,i._rootParser!==h(i))},i.SeparatedList=function(e,t){var n=i.Parse(e);if(null===n)return null;var r=[];for(r.push(n);;){var a=i.BeginRule();if(null===t()){i.FailRule(a);break}var o=i.Parse(e);if(null===o){i.FailRule(a);break}i.SucceedRule(a),r.push(o)}return r},i.CreateDebugMetadata=function(e,t){var n=new Xe;return n.startLineNumber=((null==e?void 0:e.lineIndex)||0)+1,n.endLineNumber=t.lineIndex+1,n.startCharacterNumber=((null==e?void 0:e.characterInLineIndex)||0)+1,n.endCharacterNumber=t.characterInLineIndex+1,n.fileName=i._filename,n},i.RuleDidSucceed=function(e,t,n){var r=E(e,F);r&&(r.debugMetadata=i.CreateDebugMetadata(t,n));var a=Array.isArray(e)?e:null;if(null!==a){var o,s=b(a);try{for(s.s();!(o=s.n()).done;){var l=o.value;E(l,F)&&(l.hasOwnDebugMetadata||(l.debugMetadata=i.CreateDebugMetadata(t,n)))}}catch(e){s.e(e)}finally{s.f()}}var u=E(e,Oe);null!=u&&(u.debugMetadata=i.CreateDebugMetadata(t,n))},i.OnStringParserError=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=r?"WARNING:":"ERROR:";if(null!==i._filename&&(a+=" '".concat(i._filename,"'")),a+=" line ".concat(n+1,": ").concat(e),null===i._externalErrorHandler)throw new Error(a);i._externalErrorHandler(a,r?w.Warning:w.Error)},i.AuthorWarning=function(){i.Whitespace();var e=i.Parse(i.IdentifierWithMetadata);if(null===e||"TODO"!==e.name)return null;i.Whitespace(),i.ParseString(":"),i.Whitespace();var t=i.ParseUntilCharactersFromString("\n\r");return t?new W(t):null},i.ExtendIdentifierCharacterRanges=function(e){var t,n=b(o.ListAllCharacterRanges());try{for(n.s();!(t=n.n()).done;){var r=t.value;e.AddCharacters(r.ToCharacterSet())}}catch(e){n.e(e)}finally{n.f()}},i._parsingChoice=!1,i.Choice=function(){var e=!0,t=i.Interleave(i.OptionalExclude(i.Whitespace),i.String("*"));if(!t){if(null===(t=i.Interleave(i.OptionalExclude(i.Whitespace),i.String("+"))))return null;e=!1}var n=i.Parse(i.BracketedName);i.Whitespace();var r=i.Parse(i.ChoiceCondition);if(i.Whitespace(),i._parsingChoice)throw new Error("Already parsing a choice - shouldn't have nested choices");i._parsingChoice=!0;var a=null,o=i.Parse(i.MixedTextAndLogic);o&&(a=new Ie(o));var s=null,l=null,u=null!==i.ParseString("[");if(u){var c=i.Parse(i.MixedTextAndLogic);null!==c&&(s=new Ie(c)),i.Expect(i.String("]"),"closing ']' for weave-style option");var h=i.Parse(i.MixedTextAndLogic);null!==h&&(l=new Ie(h))}i.Whitespace();var f=i.Parse(i.MultiDivert);i._parsingChoice=!1,i.Whitespace();var d=!a&&!l&&!s;d&&null===f&&i.Warning("Choice is completely empty. Interpretting as a default fallback choice. Add a divert arrow to remove this warning: * ->"),a||!u||s||i.Warning("Blank choice - if you intended a default fallback choice, use the `* ->` syntax"),l||(l=new Ie);var p=i.Parse(i.Tags);if(null!==p&&l.AddContent(p),null!==f){var v,m=b(f);try{for(m.s();!(v=m.n()).done;){var y=v.value,g=E(y,$e);g&&g.isEmpty||l.AddContent(y)}}catch(e){m.e(e)}finally{m.f()}}l.AddContent(new xe("\n"));var C=new me(a,s,l);return n&&(C.identifier=n),C.indentationDepth=t.length,C.hasWeaveStyleInlineBrackets=u,C.condition=r,C.onceOnly=e,C.isInvisibleDefault=d,C},i.ChoiceCondition=function(){var e=i.Interleave(i.ChoiceSingleCondition,i.ChoiceConditionsSpace);return null===e?null:1===e.length?e[0]:new Le(e)},i.ChoiceConditionsSpace=function(){return i.Newline(),i.Whitespace(),Ce},i.ChoiceSingleCondition=function(){if(null===i.ParseString("{"))return null;var e=i.Expect(i.Expression,"choice condition inside { }");return i.DisallowIncrement(e),i.Expect(i.String("}"),"closing '}' for choice condition"),e},i.Gather=function(){var e=i.Parse(i.GatherDashes);if(null===e)return null;var t=Number(e),n=i.Parse(i.BracketedName),r=new _e(n,t);return i.Newline(),r},i.GatherDashes=function(){i.Whitespace();for(var e=0;null!==i.ParseDashNotArrow();)e+=1,i.Whitespace();return 0===e?null:e},i.ParseDashNotArrow=function(){var e=i.BeginRule();return null===i.ParseString("->")&&"-"===i.ParseSingleCharacter()?i.SucceedRule(e):i.FailRule(e)},i.BracketedName=function(){if(null===i.ParseString("("))return null;i.Whitespace();var e=i.Parse(i.IdentifierWithMetadata);return null===e?null:(i.Whitespace(),i.Expect(i.String(")"),"closing ')' for bracketed name"),e)},i.InnerConditionalContent=function(e){if(void 0===e){var t=i.Parse(i.ConditionExpression),n=i.Parse((function(){return i.InnerConditionalContent(t)}));return null===n?null:n}var r,a=null!==e,o=null===i.Parse(i.Newline);if(o&&!a)return null;if(o)r=i.InlineConditionalBranches();else{if(null===(r=i.MultilineConditionalBranches())){if(e){var s=i.StatementsAtLevel(Ye.InnerBlock);if(null!==s){r=[new Je(s)];var l=i.Parse(i.SingleMultilineCondition);l&&(l.isElse||(i.ErrorWithParsedObject("Expected an '- else:' clause here rather than an extra condition",l),l.isElse=!0),r.push(l))}}if(null===r)return null}else if(1===r.length&&r[0].isElse&&e){var u=new Je(null);u.isTrueBranch=!0,r.unshift(u)}if(e)for(var c=!1,h=0;h<r.length;++h){var f=r[h],d=h===r.length-1;f.ownExpression?(f.matchingEquality=!0,c=!0):c&&d?(f.matchingEquality=!0,f.isElse=!0):!d&&r.length>2?i.ErrorWithParsedObject("Only final branch can be an 'else'. Did you miss a ':'?",f):0===h?f.isTrueBranch=!0:f.isElse=!0}else{for(var p=0;p<r.length;++p){var v=r[p],m=p===r.length-1;if(null===v.ownExpression)if(m)v.isElse=!0;else if(v.isElse){var y=r[r.length-1];y.isElse?i.ErrorWithParsedObject("Multiple 'else' cases. Can have a maximum of one, at the end.",y):i.ErrorWithParsedObject("'else' case in conditional should always be the final one",v)}else i.ErrorWithParsedObject("Branch doesn't have condition. Are you missing a ':'? ",v)}1===r.length&&null===r[0].ownExpression&&i.ErrorWithParsedObject("Condition block with no conditions",r[0])}}if(null===r)return null;var g,C=b(r);try{for(C.s();!(g=C.n()).done;)g.value.isInline=o}catch(e){C.e(e)}finally{C.f()}return new ke(e,r)},i.InlineConditionalBranches=function(){var e=i.Interleave(i.MixedTextAndLogic,i.Exclude(i.String("|")),null,!1);if(null===e||0===e.length)return null;var t=[];if(e.length>2)i.Error("Expected one or two alternatives separated by '|' in inline conditional");else{var n=new Je(e[0]);if(n.isTrueBranch=!0,t.push(n),e.length>1){var r=new Je(e[1]);r.isElse=!0,t.push(r)}}return t},i.MultilineConditionalBranches=function(){i.MultilineWhitespace();var e=i.OneOrMore(i.SingleMultilineCondition);return null===e?null:(i.MultilineWhitespace(),e)},i.SingleMultilineCondition=function(){if(i.Whitespace(),null!==i.ParseString("->")||null===i.ParseString("-"))return null;i.Whitespace();var e=null,t=null!==i.Parse(i.ElseExpression);t||(e=i.Parse(i.ConditionExpression));var n=i.StatementsAtLevel(Ye.InnerBlock);null===e&&null===n&&(i.Error("expected content for the conditional branch following '-'"),n=[new xe("")]),i.MultilineWhitespace();var r=new Je(n);return r.ownExpression=e,r.isElse=t,r},i.ConditionExpression=function(){var e=i.Parse(i.Expression);return null===e?null:(i.DisallowIncrement(e),i.Whitespace(),null===i.ParseString(":")?null:e)},i.ElseExpression=function(){return null===i.ParseString("else")?null:(i.Whitespace(),null===i.ParseString(":")?null:Ce)},i._nonTextPauseCharacters=null,i._nonTextEndCharacters=null,i._notTextEndCharactersChoice=null,i._notTextEndCharactersString=null,i.TrimEndWhitespace=function(e,t){if(e.length>0){var n=e.length-1,r=e[n];if(r instanceof xe){var a=r;a.text=a.text.replace(new RegExp(/[ \t]+$/g),""),t?a.text+=" ":0===a.text.length&&(e.splice(n,1),i.TrimEndWhitespace(e,!1))}}},i.LineOfMixedTextAndLogic=function(){i.Parse(i.Whitespace);var e=i.Parse(i.MixedTextAndLogic),t=!1,n=i.Parse(i.Tags);if(n)if(e){var r,a=b(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;e.push(o)}}catch(e){a.e(e)}finally{a.f()}}else e=n,t=!0;if(!e||!e.length)return null;var s=e[0];return s&&s.text&&s.text.startsWith("return")&&i.Warning("Do you need a '~' before 'return'? If not, perhaps use a glue: <> (since it's lowercase) or rewrite somehow?"),0===e.length?null:(e[e.length-1]instanceof $e||i.TrimEndWhitespace(e,!1),t||e.push(new xe("\n")),i.Expect(i.EndOfLine,"end of line",i.SkipToNextLine),e)},i.MixedTextAndLogic=function(){null!==i.ParseObject(i.Spaced(i.String("~")))&&i.Error("You shouldn't use a '~' here - tildas are for logic that's on its own line. To do inline logic, use { curly braces } instead");var e=i.Interleave(i.Optional(i.ContentText),i.Optional(i.InlineLogicOrGlue));if(!i._parsingChoice){var t,n=i.Parse(i.MultiDivert);null!==n&&(null===e&&(e=[]),i.TrimEndWhitespace(e,!0),(t=e).push.apply(t,y(n)))}return e||null},i.ContentText=function(){return i.ContentTextAllowingEscapeChar()},i.ContentTextAllowingEscapeChar=function(){for(var e=null;;){var t=i.Parse(i.ContentTextNoEscape),n=null!==i.ParseString("\\");if(!n&&null===t)break;null===e&&(e=""),null!==t&&(e+=String(t)),n&&(e+=i.ParseSingleCharacter())}return null!==e?new xe(e):null},i.ContentTextNoEscape=function(){null===i._nonTextPauseCharacters&&(i._nonTextPauseCharacters=new le("-<")),null===i._nonTextEndCharacters&&(i._nonTextEndCharacters=new le("{}|\n\r\\#"),i._notTextEndCharactersChoice=new le(i._nonTextEndCharacters),i._notTextEndCharactersChoice.AddCharacters("[]"),i._notTextEndCharactersString=new le(i._nonTextEndCharacters),i._notTextEndCharactersString.AddCharacters('"'));var e=null;e=i.parsingStringExpression?i._notTextEndCharactersString:i._parsingChoice?i._notTextEndCharactersChoice:i._nonTextEndCharacters;var t=i.ParseUntil((function(){return i.OneOf([i.ParseDivertArrow,i.ParseThreadArrow,i.EndOfLine,i.Glue])}),i._nonTextPauseCharacters,e);return null!==t?t:null},i.MultiDivert=function(){i.Whitespace();var e=[],t=i.Parse(i.StartThread);if(t)return[t];var n=i.Interleave(i.ParseDivertArrowOrTunnelOnwards,i.DivertIdentifierWithArguments);if(!n)return null;e=[];for(var r=0;r<n.length;++r)if(r%2==0){if("->->"===n[r]){0===r||r===n.length-1||r===n.length-2||i.Error("Tunnel onwards '->->' must only come at the begining or the start of a divert");var a=new qe;if(r<n.length-1){var o=E(n[r+1],$e);a.divertAfter=o}e.push(a);break}}else{var s=n[r];r<n.length-1&&(s.isTunnel=!0),e.push(s)}if(0===e.length&&1===n.length){var l=new $e(null);l.isEmpty=!0,e.push(l),i._parsingChoice||i.Error("Empty diverts (->) are only valid on choices")}return e},i.StartThread=function(){if(i.Whitespace(),null===i.ParseThreadArrow())return null;i.Whitespace();var e=i.Expect(i.DivertIdentifierWithArguments,"target for new thread",(function(){return new $e(null)}));return e.isThread=!0,e},i.DivertIdentifierWithArguments=function(){i.Whitespace();var e=i.Parse(i.DotSeparatedDivertPathComponents);if(!e)return null;i.Whitespace();var t=i.Parse(i.ExpressionFunctionCallArguments);i.Whitespace();var n=new Te(e);return new $e(n,t)},i.SingleDivert=function(){var e=i.Parse(i.MultiDivert);if(!e)return null;if(1!==e.length)return null;if(e[0]instanceof qe)return null;var t=e[0];return t.isTunnel?null:t},i.DotSeparatedDivertPathComponents=function(){return i.Interleave(i.Spaced(i.IdentifierWithMetadata),i.Exclude(i.String(".")))},i.ParseDivertArrowOrTunnelOnwards=function(){for(var e=0;null!==i.ParseString("->");)e+=1;return 0===e?null:1===e?"->":(2===e||i.Error("Unexpected number of arrows in divert. Should only have '->' or '->->'"),"->->")},i.ParseDivertArrow=function(){return i.ParseString("->")},i.ParseThreadArrow=function(){return i.ParseString("<-")},i._binaryOperators=[],i._maxBinaryOpLength=0,i.TempDeclarationOrAssignment=function(){i.Whitespace();var e=i.ParseTempKeyword();i.Whitespace();var t=null;if(null===(t=e?i.Expect(i.IdentifierWithMetadata,"variable name"):i.Parse(i.IdentifierWithMetadata)))return null;i.Whitespace();var n=null!==i.ParseString("+"),r=null!==i.ParseString("-");if(n&&r&&i.Error("Unexpected sequence '+-'"),null===i.ParseString("="))return e&&i.Error("Expected '='"),null;var a=i.Expect(i.Expression,"value expression to be assigned");return n||r?new rt(t,a,n):new Ke({variableIdentifier:t,assignedExpression:a,isTemporaryNewDeclaration:e})},i.DisallowIncrement=function(e){e instanceof rt&&i.Error("Can't use increment/decrement here. It can only be used on a ~ line")},i.ParseTempKeyword=function(){var e=i.BeginRule();return"temp"===i.Parse(i.Identifier)?(i.SucceedRule(e),!0):(i.FailRule(e),!1)},i.ReturnStatement=function(){if(i.Whitespace(),"return"!==i.Parse(i.Identifier))return null;i.Whitespace();var e=i.Parse(i.Expression);return new Ae(e)},i.Expression=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;i.Whitespace();var n=i.ExpressionUnary();if(null===n)return null;i.Whitespace();for(var r=function(){var t=i.BeginRule(),r=i.ParseInfixOperator();if(null!==r&&r.precedence>e){var a="right side of '".concat(r.type,"' expression"),o=i.Expect((function(){return i.ExpressionInfixRight(n,r)}),a);return null===o?(i.FailRule(t),{v:null}):(n=i.SucceedRule(t,o),"continue")}return i.FailRule(t),"break"};;){var a=r();if("continue"!==a){if("break"===a)break;if("object"===t(a))return a.v}}return i.Whitespace(),n},i.ExpressionUnary=function(){var e=i.Parse(i.ExpressionDivertTarget);if(null!==e)return e;var t=i.OneOf([i.String("-"),i.String("!")]);null===t&&(t=i.Parse(i.ExpressionNot)),i.Whitespace();var n=i.OneOf([i.ExpressionList,i.ExpressionParen,i.ExpressionFunctionCall,i.ExpressionVariableName,i.ExpressionLiteral]);if(null===n&&null!==t&&(n=i.ExpressionUnary()),null===n)return null;null!==t&&(n=oe.WithInner(n,t)),i.Whitespace();var r=i.OneOf([i.String("++"),i.String("--")]);if(null!==r){var a="++"===r;n instanceof We?n=new rt(n.identifier,a):i.Error("can only increment and decrement variables, but saw '".concat(n,"'."))}return n},i.ExpressionNot=function(){var e=i.Identifier();return"not"===e?e:null},i.ExpressionLiteral=function(){return i.OneOf([i.ExpressionFloat,i.ExpressionInt,i.ExpressionBool,i.ExpressionString])},i.ExpressionDivertTarget=function(){i.Whitespace();var e=i.Parse(i.SingleDivert);return!e||e&&e.isThread?null:(i.Whitespace(),new je(e))},i.ExpressionInt=function(){var e=i.ParseInt();return null===e?null:new ae(e,"int")},i.ExpressionFloat=function(){var e=i.ParseFloat();return null===e?null:new ae(e,"float")},i.ExpressionString=function(){if(null===i.ParseString('"'))return null;i.parsingStringExpression=!0;var e=i.Parse(i.MixedTextAndLogic);return i.Expect(i.String('"'),"close quote for string expression"),i.parsingStringExpression=!1,null===e?e=[new xe("")]:e.find((function(e){return e instanceof $e}))&&i.Error("String expressions cannot contain diverts (->)"),new xt(e)},i.ExpressionBool=function(){var e=i.Parse(i.Identifier);return"true"===e?new ae(!0,"bool"):"false"===e?new ae(!1,"bool"):null},i.ExpressionFunctionCall=function(){var e=i.Parse(i.IdentifierWithMetadata);if(null===e)return null;i.Whitespace();var t=i.Parse(i.ExpressionFunctionCallArguments);return null===t?null:new Re(e,t)},i.ExpressionFunctionCallArguments=function(){if(null===i.ParseString("("))return null;var e=i.Exclude(i.String(",")),t=i.Interleave(i.Expression,e);return null===t&&(t=[]),i.Whitespace(),i.Expect(i.String(")"),"closing ')' for function call"),t},i.ExpressionVariableName=function(){var e=i.Interleave(i.IdentifierWithMetadata,i.Exclude(i.Spaced(i.String("."))));return null===e||kt.IsReservedKeyword(e[0].name)?null:new We(e)},i.ExpressionParen=function(){if(null===i.ParseString("("))return null;var e=i.Parse(i.Expression);return null===e?null:(i.Whitespace(),i.Expect(i.String(")"),"closing parenthesis ')' for expression"),e)},i.ExpressionInfixRight=function(e,t){if(!e)return null;i.Whitespace();var n=i.Parse((function(){return i.Expression(t.precedence)}));return n?new se(e,n,t.type):null},i.ParseInfixOperator=function(){var e,t=b(i._binaryOperators);try{for(t.s();!(e=t.n()).done;){var n=e.value,r=i.BeginRule();if(null!==i.ParseString(n.type)){if(n.requireWhitespace&&null===i.Whitespace()){i.FailRule(r);continue}return i.SucceedRule(r,n)}i.FailRule(r)}}catch(e){t.e(e)}finally{t.f()}return null},i.ExpressionList=function(){if(i.Whitespace(),null===i.ParseString("("))return null;i.Whitespace();var e=i.SeparatedList(i.ListMember,i.Spaced(i.String(",")));return i.Whitespace(),null===i.ParseString(")")?null:new st(e)},i.ListMember=function(){i.Whitespace();var e=i.Parse(i.IdentifierWithMetadata);if(null===e)return null;if(null!==i.ParseString(".")){var t=i.Expect(i.IdentifierWithMetadata,"element name within the set ".concat(e));e.name+=".".concat(null==t?void 0:t.name)}return i.Whitespace(),e},i.RegisterExpressionOperators=function(){i.RegisterBinaryOperator("&&",1),i.RegisterBinaryOperator("||",1),i.RegisterBinaryOperator("and",1,!0),i.RegisterBinaryOperator("or",1,!0),i.RegisterBinaryOperator("==",2),i.RegisterBinaryOperator(">=",2),i.RegisterBinaryOperator("<=",2),i.RegisterBinaryOperator("<",2),i.RegisterBinaryOperator(">",2),i.RegisterBinaryOperator("!=",2),i.RegisterBinaryOperator("?",3),i.RegisterBinaryOperator("has",3,!0),i.RegisterBinaryOperator("!?",3),i.RegisterBinaryOperator("hasnt",3,!0),i.RegisterBinaryOperator("^",3),i.RegisterBinaryOperator("+",4),i.RegisterBinaryOperator("-",5),i.RegisterBinaryOperator("*",6),i.RegisterBinaryOperator("/",7),i.RegisterBinaryOperator("%",8),i.RegisterBinaryOperator("mod",8,!0)},i.RegisterBinaryOperator=function(e,t){var n=new at(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2]);i._binaryOperators.push(n),i._maxBinaryOpLength=Math.max(i._maxBinaryOpLength,e.length)},i._openFilenames=[],i.IncludeStatement=function(){if(i.Whitespace(),null===i.ParseString("INCLUDE"))return null;i.Whitespace();var e=i.Expect((function(){return i.ParseUntilCharactersFromString("\n\r")}),"filename for include statement");e=e.replace(new RegExp(/[ \t]+$/g),"");var t=i.fileHandler.ResolveInkFilename(e);if(i.FilenameIsAlreadyOpen(t))return i.Error("Recursive INCLUDE detected: '".concat(t,"' is already open.")),i.ParseUntilCharactersFromString("\r\n"),new it(null);i.AddOpenFilename(t);var n=null,r="";try{r=i._rootParser.fileHandler.LoadInkFileContents(t)}catch(t){i.Error("Failed to load: '".concat(e,"'.\nError:").concat(t))}return r&&(n=new o(r,e,i._externalErrorHandler,i._rootParser,i.fileHandler).ParseStory()),i.RemoveOpenFilename(t),new it(n)},i.FilenameIsAlreadyOpen=function(e){return i._rootParser._openFilenames.includes(e)},i.AddOpenFilename=function(e){i._rootParser._openFilenames.push(e)},i.RemoveOpenFilename=function(e){i._rootParser._openFilenames.splice(i._rootParser._openFilenames.indexOf(e),1)},i.KnotDefinition=function(){var e=i.Parse(i.KnotDeclaration);if(null===e)return null;i.Expect(i.EndOfLine,"end of line after knot name definition",i.SkipToNextLine);var t=i.Expect((function(){return i.StatementsAtLevel(Ye.Knot)}),"at least one line within the knot",i.KnotStitchNoContentRecoveryRule);return new ot(e.name,t,e.args,e.isFunction)},i.KnotDeclaration=function(){if(i.Whitespace(),null===i.KnotTitleEquals())return null;i.Whitespace();var e,t=i.Parse(i.IdentifierWithMetadata),n="function"===(null==t?void 0:t.name);n?(i.Expect(i.Whitespace,"whitespace after the 'function' keyword"),e=i.Parse(i.IdentifierWithMetadata)):e=t,null===e&&(i.Error("Expected the name of the ".concat(n?"function":"knot")),e=new Oe("")),i.Whitespace();var r=i.Parse(i.BracketedKnotDeclArguments);return i.Whitespace(),i.Parse(i.KnotTitleEquals),new Qe(e,r,n)},i.KnotTitleEquals=function(){var e=i.ParseCharactersFromString("=");return null===e||e.length<=1?null:e},i.StitchDefinition=function(){var e=i.Parse(i.StitchDeclaration);if(null===e)return null;i.Expect(i.EndOfLine,"end of line after stitch name",i.SkipToNextLine);var t=i.Expect((function(){return i.StatementsAtLevel(Ye.Stitch)}),"at least one line within the stitch",i.KnotStitchNoContentRecoveryRule);return new ut(e.name,t,e.args,e.isFunction)},i.StitchDeclaration=function(){if(i.Whitespace(),null===i.ParseString("="))return null;if(null!==i.ParseString("="))return null;i.Whitespace();var e=null!==i.ParseString("function");e&&i.Whitespace();var t=i.Parse(i.IdentifierWithMetadata);if(null===t)return null;i.Whitespace();var n=i.Parse(i.BracketedKnotDeclArguments);return i.Whitespace(),new Qe(t,n,e)},i.KnotStitchNoContentRecoveryRule=function(){return i.ParseUntil(i.KnotDeclaration,new le("="),null),[new xe("<ERROR IN FLOW>")]},i.BracketedKnotDeclArguments=function(){if(null===i.ParseString("("))return null;var e=i.Interleave(i.Spaced(i.FlowDeclArgument),i.Exclude(i.String(",")));return i.Expect(i.String(")"),"closing ')' for parameter list"),null===e&&(e=[]),e},i.FlowDeclArgument=function(){var e=i.Parse(i.IdentifierWithMetadata);i.Whitespace();var t=i.ParseDivertArrow();i.Whitespace();var n=i.Parse(i.IdentifierWithMetadata);if(null==e&&null===n)return null;var r=new x;return null!==t&&(r.isDivertTarget=!0),null!==e&&"ref"===e.name?(null===n&&i.Error("Expected an parameter name after 'ref'"),r.identifier=n,r.isByReference=!0):(r.isDivertTarget?r.identifier=n:r.identifier=e,null===r.identifier&&i.Error("Expected an parameter name"),r.isByReference=!1),r},i.ExternalDeclaration=function(){i.Whitespace();var e=i.Parse(i.IdentifierWithMetadata);if(null===e||"EXTERNAL"!=e.name)return null;i.Whitespace();var t=i.Expect(i.IdentifierWithMetadata,"name of external function")||new Oe("");i.Whitespace();var n=i.Expect(i.BracketedKnotDeclArguments,"declaration of arguments for EXTERNAL, even if empty, i.e. 'EXTERNAL ".concat(t,"()'"));null===n&&(n=[]);var r=n.map((function(e){var t;return null===(t=e.identifier)||void 0===t?void 0:t.name})).filter(P);return new Ze(t,r)},i._identifierCharSet=null,i.LogicLine=function(){if(i.Whitespace(),null===i.ParseString("~"))return null;i.Whitespace();var e=i.Expect((function(){return i.OneOf([i.ReturnStatement,i.TempDeclarationOrAssignment,i.Expression])}),"expression after '~'",i.SkipToNextLine);if(null===e)return new Ie;e instanceof ne&&!(e instanceof Re||e instanceof rt)&&i.Error("Logic following a '~' can't be that type of expression. It can only be something like:\n\t~ return\n\t~ var x = blah\n\t~ x++\n\t~ myFunction()");var t=E(e,Re);return t&&(t.shouldPopReturnedValue=!0),null!==e.Find(Re)()&&(e=new Ie(e,new xe("\n"))),i.Expect(i.EndOfLine,"end of line",i.SkipToNextLine),e},i.VariableDeclaration=function(){if(i.Whitespace(),"VAR"!==i.Parse(i.Identifier))return null;i.Whitespace();var e=i.Expect(i.IdentifierWithMetadata,"variable name");i.Whitespace(),i.Expect(i.String("="),"the '=' for an assignment of a value, e.g. '= 5' (initial values are mandatory)"),i.Whitespace();var t=i.Expect(i.Expression,"initial value for ");return t?(t instanceof ae||t instanceof xt||t instanceof je||t instanceof We||t instanceof st||i.Error("initial value for a variable must be a number, constant, list or divert target"),null!==i.Parse(i.ListElementDefinitionSeparator)?i.Error("Unexpected ','. If you're trying to declare a new list, use the LIST keyword, not VAR"):t instanceof xt&&(t.isSingleString||i.Error("Constant strings cannot contain any logic.")),new Ke({assignedExpression:t,isGlobalDeclaration:!0,variableIdentifier:e})):null},i.ListDeclaration=function(){if(i.Whitespace(),"LIST"!=i.Parse(i.Identifier))return null;i.Whitespace();var e=i.Expect(i.IdentifierWithMetadata,"list name");i.Whitespace(),i.Expect(i.String("="),"the '=' for an assignment of the list definition"),i.Whitespace();var t=i.Expect(i.ListDefinition,"list item names");return t?(t.identifier=new Oe(e.name),new Ke({variableIdentifier:e,listDef:t})):null},i.ListDefinition=function(){i.AnyWhitespace();var e=i.SeparatedList(i.ListElementDefinition,i.ListElementDefinitionSeparator);return null===e?null:new Ue(e)},i.ListElementDefinitionSeparator=function(){return i.AnyWhitespace(),null===i.ParseString(",")?null:(i.AnyWhitespace(),",")},i.ListElementDefinition=function(){var e=null!==i.ParseString("("),t=e;i.Whitespace();var n=i.Parse(i.IdentifierWithMetadata);if(null===n)return null;i.Whitespace(),e&&null!=i.ParseString(")")&&(t=!1,i.Whitespace());var r=null;if(null!==i.ParseString("=")){i.Whitespace();var a=i.Expect(i.ExpressionInt,"value to be assigned to list item");null!==a&&(r=a.value),t&&(i.Whitespace(),null!==i.ParseString(")")&&(t=!1))}return t&&i.Error("Expected closing ')'"),new lt(n,e,r)},i.ConstDeclaration=function(){if(i.Whitespace(),"CONST"!==i.Parse(i.Identifier))return null;i.Whitespace();var e=i.Expect(i.IdentifierWithMetadata,"constant name");i.Whitespace(),i.Expect(i.String("="),"the '=' for an assignment of a value, e.g. '= 5' (initial values are mandatory)"),i.Whitespace();var t=i.Expect(i.Expression,"initial value for ");return t instanceof ae||t instanceof je||t instanceof xt?t instanceof xt&&(t.isSingleString||i.Error("Constant strings cannot contain any logic.")):i.Error("initial value for a constant must be a number or divert target"),new Ee(e,t)},i.InlineLogicOrGlue=function(){return i.OneOf([i.InlineLogic,i.Glue])},i.Glue=function(){return null!==i.ParseString("<>")?new tt(new nt):null},i.InlineLogic=function(){if(null===i.ParseString("{"))return null;i.Whitespace();var e=i.Expect(i.InnerLogic,"some kind of logic, conditional or sequence within braces: { ... }");if(null===e)return null;i.DisallowIncrement(e);var t=E(e,Ie);return t||(t=new Ie(e)),i.Whitespace(),i.Expect(i.String("}"),"closing brace '}' for inline logic"),t},i.InnerLogic=function(){i.Whitespace();var e=i.ParseObject(i.SequenceTypeAnnotation);if(null!==e){var t=i.Expect(i.InnerSequenceObjects,"sequence elements (for cycle/stoping etc)");return null===t?null:new Ge(t,e)}var n=i.Parse(i.ConditionExpression);if(n)return i.Expect((function(){return i.InnerConditionalContent(n)}),"conditional content following query");for(var r=0,a=[i.InnerConditionalContent,i.InnerSequence,i.InnerExpression];r<a.length;r++){var o=a[r],s=i.BeginRule(),l=i.ParseObject(o);if(l){if(null!==i.Peek(i.Spaced(i.String("}"))))return i.SucceedRule(s,l);i.FailRule(s)}else i.FailRule(s)}return null},i.InnerExpression=function(){var e=i.Parse(i.Expression);return e&&(e.outputWhenComplete=!0),e},i.IdentifierWithMetadata=function(){var e=i.Identifier();return null===e?null:new Oe(e)},i.Identifier=function(){var e=i.ParseCharactersFromCharSet(i.identifierCharSet);if(null===e)return null;var t,n=!0,r=b(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(!(a>="0"&&a<="9")){n=!1;break}}}catch(e){r.e(e)}finally{r.f()}return n?null:e},i._sequenceTypeSymbols=new le("!&~$"),i.InnerSequence=function(){i.Whitespace();var e=De.Stopping,t=i.Parse(i.SequenceTypeAnnotation);null!==t&&(e=t);var n=i.Parse(i.InnerSequenceObjects);return null===n||n.length<=1?null:new Ge(n,e)},i.SequenceTypeAnnotation=function(){var e=i.Parse(i.SequenceTypeSymbolAnnotation);if(null===e&&(e=i.Parse(i.SequenceTypeWordAnnotation)),null===e)return null;switch(e){case De.Once:case De.Cycle:case De.Stopping:case De.Shuffle:case De.Shuffle|De.Stopping:case De.Shuffle|De.Once:break;default:return i.Error("Sequence type combination not supported: ".concat(e)),De.Stopping}return e},i.SequenceTypeSymbolAnnotation=function(){null===i._sequenceTypeSymbols&&(i._sequenceTypeSymbols=new le("!&~$ "));var e=0,t=i.ParseCharactersFromCharSet(i._sequenceTypeSymbols);if(null===t)return null;var n,r=b(t);try{for(r.s();!(n=r.n()).done;)switch(n.value){case"!":e|=De.Once;break;case"&":e|=De.Cycle;break;case"~":e|=De.Shuffle;break;case"$":e|=De.Stopping}}catch(e){r.e(e)}finally{r.f()}return 0===e?null:e},i.SequenceTypeWordAnnotation=function(){var e=i.Interleave(i.SequenceTypeSingleWord,i.Exclude(i.Whitespace));if(null===e||0===e.length)return null;if(null===i.ParseString(":"))return null;var t,n=0,r=b(e);try{for(r.s();!(t=r.n()).done;)n|=t.value}catch(e){r.e(e)}finally{r.f()}return n},i.SequenceTypeSingleWord=function(){var e=null,t=i.Parse(i.IdentifierWithMetadata);if(null!==t)switch(t.name){case"once":e=De.Once;break;case"cycle":e=De.Cycle;break;case"shuffle":e=De.Shuffle;break;case"stopping":e=De.Stopping}return null===e?null:e},i.InnerSequenceObjects=function(){return null!==i.Parse(i.Newline)?i.Parse(i.InnerMultilineSequenceObjects):i.Parse(i.InnerInlineSequenceObjects)},i.InnerInlineSequenceObjects=function(){var e=i.Interleave(i.Optional(i.MixedTextAndLogic),i.String("|"),null,!1);if(null===e)return null;var t,n=[],r=!1,a=b(e);try{for(a.s();!(t=a.n()).done;){var o=t.value;if("|"===o)r||n.push(new Ie),r=!1;else{var s=o;null===s?i.Error("Expected content, but got ".concat(o," (this is an ink compiler bug!)")):n.push(new Ie(s)),r=!0}}}catch(e){a.e(e)}finally{a.f()}return r||n.push(new Ie),n},i.InnerMultilineSequenceObjects=function(){i.MultilineWhitespace();var e=i.OneOrMore(i.SingleMultilineSequenceElement);return null===e?null:e},i.SingleMultilineSequenceElement=function(){if(i.Whitespace(),null!==i.ParseString("->"))return null;if(null===i.ParseString("-"))return null;i.Whitespace();var e=i.StatementsAtLevel(Ye.InnerBlock);return null===e?i.MultilineWhitespace():e.unshift(new xe("\n")),new Ie(e)},i._statementRulesAtLevel=[],i._statementBreakRulesAtLevel=[],i.StatementsAtLevel=function(e){return e===Ye.InnerBlock&&null!==i.Parse(i.GatherDashes)&&i.Error("You can't use a gather (the dashes) within the { curly braces } context. For multi-line sequences and conditions, you should only use one dash."),i.Interleave(i.Optional(i.MultilineWhitespace),(function(){return i.StatementAtLevel(e)}),(function(){return i.StatementsBreakForLevel(e)}))},i.StatementAtLevel=function(e){var t=i._statementRulesAtLevel[e],n=i.OneOf(t);return e===Ye.Top&&n instanceof Ae&&i.Error("should not have return statement outside of a knot"),n},i.StatementsBreakForLevel=function(e){i.Whitespace();var t=i._statementBreakRulesAtLevel[e],n=i.OneOf(t);return null===n?null:n},i.GenerateStatementLevelRules=function(){var e=Object.values(Ye);i._statementRulesAtLevel="f".repeat(e.length).split("f").map((function(){return[]})),i._statementBreakRulesAtLevel="f".repeat(e.length).split("f").map((function(){return[]}));for(var t=0,n=e;t<n.length;t++){var r=n[t],a=[],o=[];a.push(i.Line(i.MultiDivert)),r>=Ye.Top&&a.push(i.KnotDefinition),a.push(i.Line(i.Choice)),a.push(i.Line(i.AuthorWarning)),r>Ye.InnerBlock&&a.push(i.Gather),r>=Ye.Knot&&a.push(i.StitchDefinition),a.push(i.Line(i.ListDeclaration)),a.push(i.Line(i.VariableDeclaration)),a.push(i.Line(i.ConstDeclaration)),a.push(i.Line(i.ExternalDeclaration)),a.push(i.Line(i.IncludeStatement)),a.push(i.LogicLine),a.push(i.LineOfMixedTextAndLogic),r<=Ye.Knot&&o.push(i.KnotDeclaration),r<=Ye.Stitch&&o.push(i.StitchDeclaration),r<=Ye.InnerBlock&&(o.push(i.ParseDashNotArrow),o.push(i.String("}"))),i._statementRulesAtLevel[r]=a,i._statementBreakRulesAtLevel[r]=o}},i.SkipToNextLine=function(){return i.ParseUntilCharactersFromString("\n\r"),i.ParseNewline(),Ce},i.Line=function(e){return function(){var t=i.ParseObject(e);return null===t?null:(i.Expect(i.EndOfLine,"end of line",i.SkipToNextLine),t)}},i._endOfTagCharSet=new le("#\n\r\\"),i.Tag=function(){if(i.Whitespace(),null===i.ParseString("#"))return null;i.Whitespace();for(var e="";e+=i.ParseUntilCharactersFromCharSet(i._endOfTagCharSet)||"",null!==i.ParseString("\\");){var t=i.ParseSingleCharacter();"\0"!==t&&(e+=t)}var n=e.trim();return new Et(new ct(n))},i.Tags=function(){var e=i.OneOrMore(i.Tag);return null===e?null:e},i._inlineWhitespaceChars=new le(" \t"),i.EndOfLine=function(){return i.OneOf([i.Newline,i.EndOfFile])},i.Newline=function(){return i.Whitespace(),null!==i.ParseNewline()?Ce:null},i.EndOfFile=function(){return i.Whitespace(),i.endOfInput?Ce:null},i.MultilineWhitespace=function(){var e=i.OneOrMore(i.Newline);return null===e?null:e.length>=1?Ce:null},i.Whitespace=function(){return null!==i.ParseCharactersFromCharSet(i._inlineWhitespaceChars)?Ce:null},i.Spaced=function(e){return function(){i.Whitespace();var t=i.ParseObject(e);return null===t?null:(i.Whitespace(),t)}},i.AnyWhitespace=function(){for(var e=!1;null!==i.OneOf([i.Whitespace,i.MultilineWhitespace]);)e=!0;return e?Ce:null},i.MultiSpaced=function(e){return function(){i.AnyWhitespace();var t=i.ParseObject(e);return null===t?null:(i.AnyWhitespace(),t)}},i._filename=null,i._externalErrorHandler=null,i._fileHandler=null,i._filename=a,i.RegisterExpressionOperators(),i.GenerateStatementLevelRules(),i.errorHandler=i.OnStringParserError,i._externalErrorHandler=s,i._fileHandler=null===u?new _t:u,null===l){if(i._rootParser=h(i),i._openFilenames=[],null!==i._filename){var c=i.fileHandler.ResolveInkFilename(i._filename);i._openFilenames.push(c)}}else i._rootParser=l;return i}return i(o,[{key:"fileHandler",get:function(){if(!this._fileHandler)throw new Error("No FileHandler defined");return this._fileHandler},set:function(e){this._fileHandler=e}},{key:"PreProcessInputString",value:function(e){return new Se(e).Process()}},{key:"parsingStringExpression",get:function(){return this.GetFlag(Number(Be.ParsingString))},set:function(e){this.SetFlag(Number(Be.ParsingString),e)}},{key:"identifierCharSet",get:function(){return null===this._identifierCharSet&&((this._identifierCharSet=new le).AddRange("A","Z").AddRange("a","z").AddRange("0","9").Add("_"),this.ExtendIdentifierCharacterRanges(this._identifierCharSet)),this._identifierCharSet}}]),o}(be);Tt.LatinBasic=ue.Define("A","z",(new le).AddRange("[","`")),Tt.LatinExtendedA=ue.Define("Ā","ſ"),Tt.LatinExtendedB=ue.Define("ƀ","ɏ"),Tt.Greek=ue.Define("Ͱ","Ͽ",(new le).AddRange("͸","΅").AddCharacters("ʹ͵͸·΋΍΢")),Tt.Cyrillic=ue.Define("Ѐ","ӿ",(new le).AddRange("҂","҉")),Tt.Armenian=ue.Define("԰","֏",(new le).AddCharacters("԰").AddRange("՗","ՠ").AddRange("ֈ","֎")),Tt.Hebrew=ue.Define("֐","׿",new le),Tt.Arabic=ue.Define("؀","ۿ",new le),Tt.Korean=ue.Define("가","힯",new le),Tt.ListAllCharacterRanges=function(){return[Tt.LatinBasic,Tt.LatinExtendedA,Tt.LatinExtendedB,Tt.Arabic,Tt.Armenian,Tt.Cyrillic,Tt.Greek,Tt.Hebrew,Tt.Korean]};var At=function(){function e(t){var r=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;n(this,e),this._errors=[],this._warnings=[],this._authorMessages=[],this._parsedStory=null,this._runtimeStory=null,this._parser=null,this._debugSourceRanges=[],this.Compile=function(){return r._parser=new Tt(r.inputString,r.options.sourceFilename||null,r.OnError,null,r.options.fileHandler),r._parsedStory=r.parser.ParseStory(),0===r.errors.length?(r.parsedStory.countAllVisits=r.options.countAllVisits,r._runtimeStory=r.parsedStory.ExportRuntime(r.OnError)):r._runtimeStory=null,r.runtimeStory},this.RetrieveDebugSourceForLatestContent=function(){var e,t,n=b(r.runtimeStory.state.outputStream);try{for(n.s();!(t=n.n()).done;){var i=E(t.value,J);if(null!==i){var a=new k((null===(e=i.value)||void 0===e?void 0:e.length)||0,i.debugMetadata,i.value||"unknown");r.debugSourceRanges.push(a)}}}catch(e){n.e(e)}finally{n.f()}},this.DebugMetadataForContentAtOffset=function(e){var t,n=0,i=null,a=b(r.debugSourceRanges);try{for(a.s();!(t=a.n()).done;){var o=t.value;if(null!==o.debugMetadata&&(i=o.debugMetadata),e>=n&&e<n+o.length)return i;n+=o.length}}catch(e){a.e(e)}finally{a.f()}return null},this.OnError=function(e,t){switch(t){case w.Author:r._authorMessages.push(e);break;case w.Warning:r._warnings.push(e);break;case w.Error:r._errors.push(e)}null!==r.options.errorHandler&&r.options.errorHandler(e,t)},this._inputString=t,this._options=i||new S}return i(e,[{key:"errors",get:function(){return this._errors}},{key:"warnings",get:function(){return this._warnings}},{key:"authorMessages",get:function(){return this._authorMessages}},{key:"inputString",get:function(){return this._inputString}},{key:"options",get:function(){return this._options}},{key:"parsedStory",get:function(){if(!this._parsedStory)throw new Error;return this._parsedStory}},{key:"runtimeStory",get:function(){if(!this._runtimeStory)throw new Error("Compilation failed.");return this._runtimeStory}},{key:"parser",get:function(){if(!this._parser)throw new Error;return this._parser}},{key:"debugSourceRanges",get:function(){return this._debugSourceRanges}}]),e}();e.Compiler=At,e.CompilerOptions=S,e.InkList=V,Object.defineProperty(e,"__esModule",{value:!0})}(t)})),jt=Rt(Lt),$t={inkVersion:20,root:[["^The year is 2050. You look outside your window and see...","\n",["ev",{"^->":"0.2.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":"0.c-0",flg:18},{s:["^People wearing gasmasks, standing in line to get more food rations.",{"->":"$r",var:!0},null]}],["ev",{"^->":"0.3.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":"0.c-1",flg:18},{s:["^Factories keeping the world together to sustain the consumerist lifestyles.",{"->":"$r",var:!0},null]}],["ev",{"^->":"0.4.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":"0.c-2",flg:18},{s:["^A green oasis with children joyfully playing outside.",{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"0.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":"0.2.s"},[{"#n":"$r2"}],"\n","^You live in a world completely destroyed by a local factory. Your last food source has been destroyed by the pollution of this building. You have no other options for food anymore to survive.","\n",{"#":"choice_id=1"},"^You have the option to destroy the factory to possibly save your the food source of your community. But this mean that the big part of the community will lose their job and bring possibly even more people hunger. If you can't create a new food source.","\n",[["ev",{"^->":"0.c-0.12.0.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:["^Don't destroy it.",{"->":"$r",var:!0},null]}],["ev",{"^->":"0.c-0.12.1.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-1",flg:18},{s:["^Destroy it.",{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"0.c-0.12.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.0.s"},[{"#n":"$r2"}],"\n",{"#":"choice_id=2"},"^You didn't destroy the factory. Your neighbours and family ask, \"WHY DIDN'T YOU DESTROY THE FACTORY? NOW WE ARE SURLY DOOMED\".","\n",[["ev",{"^->":"0.c-0.12.c-0.10.0.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:["^It would have been a selfish act harming more people",{"->":"$r",var:!0},null]}],["ev",{"^->":"0.c-0.12.c-0.10.1.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-1",flg:18},{s:["^I didn't know any better",{"->":"$r",var:!0},null]}],["ev",{"^->":"0.c-0.12.c-0.10.2.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-2",flg:18},{s:["^Other",{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"0.c-0.12.c-0.10.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.0.s"},[{"#n":"$r2"}],"\n",{"->":"factoryNotDestroyed"},{"->":"0.g-0"},{"#f":5}],"c-1":["ev",{"^->":"0.c-0.12.c-0.10.c-1.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.1.s"},[{"#n":"$r2"}],"\n",{"->":"factoryNotDestroyed"},{"->":"0.g-0"},{"#f":5}],"c-2":["ev",{"^->":"0.c-0.12.c-0.10.c-2.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.2.s"},[{"#n":"$r2"}],"\n",{"->":"factoryNotDestroyed"},{"->":"0.g-0"},{"#f":5}]}],{"#f":5}],"c-1":["ev",{"^->":"0.c-0.12.c-1.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.1.s"},[{"#n":"$r2"}],"\n",{"->":"destroyFactory"},{"->":"0.g-0"},{"#f":5}]}],{"#f":5}],"c-1":["ev",{"^->":"0.c-1.$r2"},"/ev",{"temp=":"$r"},{"->":"0.3.s"},[{"#n":"$r2"}],"\n","^You live in a world depended on local factories. You happen to work at one of these factories, which provides you with just enough income to live. However, your factory is a major pollutant for its environment and people living nearby are not able to grow any crops which is causing them to starve.","\n",{"#":"choice_id=3"},"^You have the option to close the factory out of empathy for the neighboring community that are affected by the pollution. Or you can keep the factory open to keep supporting you own small community of factory workers.","\n",[["ev",{"^->":"0.c-1.12.0.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:["^Close it.",{"->":"$r",var:!0},null]}],["ev",{"^->":"0.c-1.12.1.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-1",flg:18},{s:["^Keep it open.",{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"0.c-1.12.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.0.s"},[{"#n":"$r2"}],"\n",{"->":"destroyFactory"},{"->":"0.g-0"},{"#f":5}],"c-1":["ev",{"^->":"0.c-1.12.c-1.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.1.s"},[{"#n":"$r2"}],"\n",{"->":"keepFactoryOpen"},{"->":"0.g-0"},{"#f":5}]}],{"#f":5}],"c-2":["ev",{"^->":"0.c-2.$r2"},"/ev",{"temp=":"$r"},{"->":"0.4.s"},[{"#n":"$r2"}],"\n","^You live in a world defined by luxury and pleasure, and you haven't experienced much difficulty in your life. You live in a paradise surrounded by walls, seperating you from other classes. Your pleasure comes at the cost of others and you have a lot of influence in deciding the future.","\n",{"#":"choice_id=4"},"^You hear news of an investment opportunity that is coming up. You can invest in a factory of a lower class community, which could allow for their community to become more self-sustaining. Your other option is to invest more in upcoming fusion reactor developments, which could boost your own community's energy production exponentially.","\n",[["ev",{"^->":"0.c-2.12.0.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","str","^in neighboring community","/str","/ev",{"*":".^.^.c-0",flg:22},{s:["^Invest ",{"->":"$r",var:!0},null]}],["ev",{"^->":"0.c-2.12.1.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","str","^in our community","/str","/ev",{"*":".^.^.c-1",flg:22},{s:["^Invest ",{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"0.c-2.12.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.0.s"},[{"#n":"$r2"}],"^ in the neighboring lower class community.","\n",{"->":"investInFactory"},{"->":"0.g-0"},{"#f":5}],"c-1":["ev",{"^->":"0.c-2.12.c-1.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.1.s"},[{"#n":"$r2"}],"^ in the upcoming fusion reactor developments. ","\n",{"->":"investInCommunity"},{"->":"0.g-0"},{"#f":5}]}],{"#f":5}],"g-0":["done",{"#f":5}]}],"done",{factoryNotDestroyed:["^Over the upcoming days you try to come up with different food sources. But nothing works. You desperately you move to the bigger city to try and ask them for help.","\n",{"->":"flee"},{"#f":1}],destroyFactory:[[{"#":"choice_id=5"},"^The factory is now gone. Now the world has less pollution and you might by able to create a new form of food and income for your community. However you now must provide for a lot more people who were depended on the factory. They are angry at you and demand an explanation and reasoning as to why you destroyed their lives.","\n",["ev",{"^->":"destroyFactory.0.3.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:['^"Sometimes you got to make sacrificies to make our world a better place."',{"->":"$r",var:!0},null]}],["ev",{"^->":"destroyFactory.0.4.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-1",flg:18},{s:['^"I had no choice! Otherwise, I had no food for myself and my community."',{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"destroyFactory.0.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.3.s"},[{"#n":"$r2"}],"\n",{"->":"newLife"},{"#f":5}],"c-1":["ev",{"^->":"destroyFactory.0.c-1.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.4.s"},[{"#n":"$r2"}],"\n",{"->":"newLife"},{"#f":5}]}],{"#f":1}],keepFactoryOpen:[[{"#":"choice_id=6"},"^You keep the factory open. You are still able to barely support your own community. But the land of your neighbors next to you is completely destroyed and they have nothing left. You know some of the people there and you get messages with the question of why you didn't close the factory","\n",["ev",{"^->":"keepFactoryOpen.0.3.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:['^"I have to support my own community first. I can\'t risk getting more people in trouble."',{"->":"$r",var:!0},null]}],["ev",{"^->":"keepFactoryOpen.0.4.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-1",flg:18},{s:['^"Otherwise these people will never learn how to be autonomous like us."',{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"keepFactoryOpen.0.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.3.s"},[{"#n":"$r2"}],"\n",{"->":"promotion"},{"#f":5}],"c-1":["ev",{"^->":"keepFactoryOpen.0.c-1.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.4.s"},[{"#n":"$r2"}],"\n",{"->":"promotion"},{"#f":5}]}],{"#f":1}],promotion:[[{"#":"choice_id=7"},"^Things are going well in the factory and you have been promoted to the executive board. There is a new budget and you get to decide how it should be spend. You have the option of helping out your neighbours by investing in soil fertility repairment, or you can upgrade the factory which would increase the production that could sustain the food needs of the whole community.","\n",["ev",{"^->":"promotion.0.3.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:["^Invest in the soil fertility program.",{"->":"$r",var:!0},null]}],["ev",{"^->":"promotion.0.4.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-1",flg:18},{s:["^Upgrade the production.",{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"promotion.0.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.3.s"},[{"#n":"$r2"}],"\n",{"->":"rebuild"},{"#f":5}],"c-1":["ev",{"^->":"promotion.0.c-1.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.4.s"},[{"#n":"$r2"}],"\n",{"->":"upgrade"},{"#f":5}]}],{"#f":1}],newLife:[{"#":"choice_id=8"},"^Over the upcoming days you try to come up with new food sources. You can stay with your community to try and improve your life there by slowly trying to rebuild food and production, with a possible chance of failure. Or you can move to the big city and try to rebuild your life there with your community. This requires everyone to abandon there lives.","\n",[["ev",{"^->":"newLife.3.0.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:["^Rebuild from the ground up.",{"->":"$r",var:!0},null]}],["ev",{"^->":"newLife.3.1.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-1",flg:18},{s:["^Seek a new life in the big city.",{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"newLife.3.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.0.s"},[{"#n":"$r2"}],"\n",{"->":"rebuild"},{"#f":5}],"c-1":["ev",{"^->":"newLife.3.c-1.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.1.s"},[{"#n":"$r2"}],"\n",{"->":"flee"},{"#f":5}]}],{"#f":1}],investInCommunity:[[{"#":"choice_id=9"},"^Your investment turned out to be a great succes, and the energy production of your community has sky rocketed. Some people are complaining though about the stench that is coming over the wall of your community. Some argue that an investment in the factory would have been a better option. Yet you argue that...","\n",["ev",{"^->":"investInCommunity.0.3.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:['^"Its better to fix your own problems first before you try to fix that of others."',{"->":"$r",var:!0},null]}],["ev",{"^->":"investInCommunity.0.4.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-1",flg:18},{s:['^"The other community needs to learn how to be autonomous, which they have to achieve without external aid."',{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"investInCommunity.0.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.3.s"},[{"#n":"$r2"}],"\n",{"->":"utopia"},{"#f":5}],"c-1":["ev",{"^->":"investInCommunity.0.c-1.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.4.s"},[{"#n":"$r2"}],"\n",{"->":"utopia"},{"#f":5}]}],{"#f":1}],utopia:["^You are able to maintain an utopian community. Chaos does seem to be present over the walls of your paradise, yet it doesn't really affect your quality of life. You and your peers have come to a consensus that these  external problems will have to be fixed by themselves, which is just a matter of time.","\n",{"->":"focusOnYourself"},"end",{"#f":1}],investInFactory:[[{"#":"choice_id=10"},"^You invest in the factory of the neighboring community. They are grateful for your help, Your own community is dissatisfied with your choice. You are wealthy but still have lots of other problems that require investing. They demand to know why you refuse to fix your own communities problems first.","\n",["ev",{"^->":"investInFactory.0.3.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:['^"We are wealthy enough the try and help others to achieve the same level of wealth. Maybe we can use them in the future to trade with."',{"->":"$r",var:!0},null]}],["ev",{"^->":"investInFactory.0.4.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-1",flg:18},{s:['^"We have to show good will to other from time to time. In the future we will focus more on our selves again."',{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"investInFactory.0.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.3.s"},[{"#n":"$r2"}],"\n",{"->":"afterInvestingInFactory"},{"#f":5}],"c-1":["ev",{"^->":"investInFactory.0.c-1.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.4.s"},[{"#n":"$r2"}],"\n",{"->":"afterInvestingInFactory"},{"#f":5}]}],{"#f":1}],afterInvestingInFactory:[[{"#":"choice_id=11"},"^After you invested you hear that the other community wants even more money and resources from you. They can't keep up them selves and need you to keep supporting them more and more. You realize they have become dependent on you. You can chose to keep investing in them or pull all the funds from them.","\n",["ev",{"^->":"afterInvestingInFactory.0.3.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:["^Keep investing",{"->":"$r",var:!0},null]}],["ev",{"^->":"afterInvestingInFactory.0.4.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-1",flg:18},{s:["^Pull all funds",{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"afterInvestingInFactory.0.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.3.s"},[{"#n":"$r2"}],"\n",{"->":"upgrade"},{"#f":5}],"c-1":["ev",{"^->":"afterInvestingInFactory.0.c-1.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.4.s"},[{"#n":"$r2"}],"\n",{"->":"focusOnYourself"},{"#f":5}]}],{"#f":1}],flee:["^When you arrive at the gates of the big cities, you must plead your case before the others will let you in. You have tried everything but it seems that the city has no place for you.","\n","end",{"#f":1}],rebuild:["^You work hard to get your community to a better place. Your situation somewhat stabilizes more and your can support your own community a little bit better with improved living conditions and overall wealth. You are still not risk free. but you have learned that it is possible to improve a situation with a little investment. With this new perspective you decide to meet with the other leaders, to try and convince them that you could build a better world for all to live in.","\n","end",{"#f":1}],upgrade:["^You invest again in the community. You see the effect your actions have on a lower community. It did however cost some of your own progress. But the world is a bit easier to live in for them. You decide to meet with the other community leaders to discuss your actions.","\n","end",{"#f":1}],focusOnYourself:["^The other communities outside your city walls are destroyed. They were not able to sustain or rebuild themselves. They come knocking at your city walls asking for help. You don't know what decisions they have made that lead them to that situation. Maybe they destroyed themselves or maybe you caused their misfortune. But now a stream of refugees is headed towards your city.","\n","end","end",{"#f":1}],"#f":1}],listDefs:{}};let Mt;const Vt=new Uint8Array(16);function Bt(){if(!Mt&&(Mt="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Mt))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Mt(Vt)}const Gt=[];for(let e=0;e<256;++e)Gt.push((e+256).toString(16).slice(1));var qt={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Ht(e,t,n){if(qt.randomUUID&&!t&&!e)return qt.randomUUID();const r=(e=e||{}).random||(e.rng||Bt)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return function(e,t=0){return(Gt[e[t+0]]+Gt[e[t+1]]+Gt[e[t+2]]+Gt[e[t+3]]+"-"+Gt[e[t+4]]+Gt[e[t+5]]+"-"+Gt[e[t+6]]+Gt[e[t+7]]+"-"+Gt[e[t+8]]+Gt[e[t+9]]+"-"+Gt[e[t+10]]+Gt[e[t+11]]+Gt[e[t+12]]+Gt[e[t+13]]+Gt[e[t+14]]+Gt[e[t+15]]).toLowerCase()}(r)}
/*!
     * jQuery JavaScript Library v3.6.1
     * https://jquery.com/
     *
     * Includes Sizzle.js
     * https://sizzlejs.com/
     *
     * Copyright OpenJS Foundation and other contributors
     * Released under the MIT license
     * https://jquery.org/license
     *
     * Date: 2022-08-26T17:52Z
     */var Ut=Dt((function(e){!function(t,n){e.exports=t.document?n(t,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return n(e)}}("undefined"!=typeof window?window:Wt,(function(e,t){var n=[],r=Object.getPrototypeOf,i=n.slice,a=n.flat?function(e){return n.flat.call(e)}:function(e){return n.concat.apply([],e)},o=n.push,s=n.indexOf,l={},u=l.toString,c=l.hasOwnProperty,h=c.toString,f=h.call(Object),d={},p=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType&&"function"!=typeof e.item},v=function(e){return null!=e&&e===e.window},m=e.document,y={type:!0,src:!0,nonce:!0,noModule:!0};function g(e,t,n){var r,i,a=(n=n||m).createElement("script");if(a.text=e,t)for(r in y)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&a.setAttribute(r,i);n.head.appendChild(a).parentNode.removeChild(a)}function C(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?l[u.call(e)]||"object":typeof e}var b="3.6.1",w=function(e,t){return new w.fn.init(e,t)};function S(e){var t=!!e&&"length"in e&&e.length,n=C(e);return!p(e)&&!v(e)&&("array"===n||0===t||"number"==typeof t&&t>0&&t-1 in e)}w.fn=w.prototype={jquery:b,constructor:w,length:0,toArray:function(){return i.call(this)},get:function(e){return null==e?i.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=w.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return w.each(this,e)},map:function(e){return this.pushStack(w.map(this,(function(t,n){return e.call(t,n,t)})))},slice:function(){return this.pushStack(i.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(w.grep(this,(function(e,t){return(t+1)%2})))},odd:function(){return this.pushStack(w.grep(this,(function(e,t){return t%2})))},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(n>=0&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:o,sort:n.sort,splice:n.splice},w.extend=w.fn.extend=function(){var e,t,n,r,i,a,o=arguments[0]||{},s=1,l=arguments.length,u=!1;for("boolean"==typeof o&&(u=o,o=arguments[s]||{},s++),"object"==typeof o||p(o)||(o={}),s===l&&(o=this,s--);s<l;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&o!==r&&(u&&r&&(w.isPlainObject(r)||(i=Array.isArray(r)))?(n=o[t],a=i&&!Array.isArray(n)?[]:i||w.isPlainObject(n)?n:{},i=!1,o[t]=w.extend(u,a,r)):void 0!==r&&(o[t]=r));return o},w.extend({expando:"jQuery"+(b+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==u.call(e))&&(!(t=r(e))||"function"==typeof(n=c.call(t,"constructor")&&t.constructor)&&h.call(n)===f)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t,n){g(e,{nonce:t&&t.nonce},n)},each:function(e,t){var n,r=0;if(S(e))for(n=e.length;r<n&&!1!==t.call(e[r],r,e[r]);r++);else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},makeArray:function(e,t){var n=t||[];return null!=e&&(S(Object(e))?w.merge(n,"string"==typeof e?[e]:e):o.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:s.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,a=e.length,o=!n;i<a;i++)!t(e[i],i)!==o&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,s=[];if(S(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&s.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&s.push(i);return a(s)},guid:1,support:d}),"function"==typeof Symbol&&(w.fn[Symbol.iterator]=n[Symbol.iterator]),w.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),(function(e,t){l["[object "+t+"]"]=t.toLowerCase()}));var k=
/*!
     * Sizzle CSS Selector Engine v2.3.6
     * https://sizzlejs.com/
     *
     * Copyright JS Foundation and other contributors
     * Released under the MIT license
     * https://js.foundation/
     *
     * Date: 2021-02-16
     */
function(e){var t,n,r,i,a,o,s,l,u,c,h,f,d,p,v,m,y,g,C,b="sizzle"+1*new Date,w=e.document,S=0,k=0,x=le(),E=le(),_=le(),T=le(),A=function(e,t){return e===t&&(h=!0),0},N={}.hasOwnProperty,O=[],P=O.pop,I=O.push,F=O.push,W=O.slice,R=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},D="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",L="[\\x20\\t\\r\\n\\f]",j="(?:\\\\[\\da-fA-F]{1,6}[\\x20\\t\\r\\n\\f]?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",$="\\[[\\x20\\t\\r\\n\\f]*("+j+")(?:"+L+"*([*^$|!~]?=)"+L+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+j+"))|)"+L+"*\\]",M=":("+j+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+$+")*)|.*)\\)|)",V=new RegExp(L+"+","g"),B=new RegExp("^[\\x20\\t\\r\\n\\f]+|((?:^|[^\\\\])(?:\\\\.)*)[\\x20\\t\\r\\n\\f]+$","g"),G=new RegExp("^[\\x20\\t\\r\\n\\f]*,[\\x20\\t\\r\\n\\f]*"),q=new RegExp("^[\\x20\\t\\r\\n\\f]*([>+~]|[\\x20\\t\\r\\n\\f])[\\x20\\t\\r\\n\\f]*"),H=new RegExp(L+"|>"),U=new RegExp(M),K=new RegExp("^"+j+"$"),z={ID:new RegExp("^#("+j+")"),CLASS:new RegExp("^\\.("+j+")"),TAG:new RegExp("^("+j+"|[*])"),ATTR:new RegExp("^"+$),PSEUDO:new RegExp("^"+M),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\([\\x20\\t\\r\\n\\f]*(even|odd|(([+-]|)(\\d*)n|)[\\x20\\t\\r\\n\\f]*(?:([+-]|)[\\x20\\t\\r\\n\\f]*(\\d+)|))[\\x20\\t\\r\\n\\f]*\\)|)","i"),bool:new RegExp("^(?:"+D+")$","i"),needsContext:new RegExp("^[\\x20\\t\\r\\n\\f]*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\([\\x20\\t\\r\\n\\f]*((?:-\\d)?\\d*)[\\x20\\t\\r\\n\\f]*\\)|)(?=[^-]|$)","i")},J=/HTML$/i,Y=/^(?:input|select|textarea|button)$/i,X=/^h\d$/i,Z=/^[^{]+\{\s*\[native \w/,Q=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ee=/[+~]/,te=new RegExp("\\\\[\\da-fA-F]{1,6}[\\x20\\t\\r\\n\\f]?|\\\\([^\\r\\n\\f])","g"),ne=function(e,t){var n="0x"+e.slice(1)-65536;return t||(n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320))},re=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,ie=function(e,t){return t?"\0"===e?"�":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},ae=function(){f()},oe=be((function(e){return!0===e.disabled&&"fieldset"===e.nodeName.toLowerCase()}),{dir:"parentNode",next:"legend"});try{F.apply(O=W.call(w.childNodes),w.childNodes),O[w.childNodes.length].nodeType}catch(e){F={apply:O.length?function(e,t){I.apply(e,W.call(t))}:function(e,t){for(var n=e.length,r=0;e[n++]=t[r++];);e.length=n-1}}}function se(e,t,r,i){var a,s,u,c,h,p,y,g=t&&t.ownerDocument,w=t?t.nodeType:9;if(r=r||[],"string"!=typeof e||!e||1!==w&&9!==w&&11!==w)return r;if(!i&&(f(t),t=t||d,v)){if(11!==w&&(h=Q.exec(e)))if(a=h[1]){if(9===w){if(!(u=t.getElementById(a)))return r;if(u.id===a)return r.push(u),r}else if(g&&(u=g.getElementById(a))&&C(t,u)&&u.id===a)return r.push(u),r}else{if(h[2])return F.apply(r,t.getElementsByTagName(e)),r;if((a=h[3])&&n.getElementsByClassName&&t.getElementsByClassName)return F.apply(r,t.getElementsByClassName(a)),r}if(n.qsa&&!T[e+" "]&&(!m||!m.test(e))&&(1!==w||"object"!==t.nodeName.toLowerCase())){if(y=e,g=t,1===w&&(H.test(e)||q.test(e))){for((g=ee.test(e)&&ye(t.parentNode)||t)===t&&n.scope||((c=t.getAttribute("id"))?c=c.replace(re,ie):t.setAttribute("id",c=b)),s=(p=o(e)).length;s--;)p[s]=(c?"#"+c:":scope")+" "+Ce(p[s]);y=p.join(",")}try{return F.apply(r,g.querySelectorAll(y)),r}catch(t){T(e,!0)}finally{c===b&&t.removeAttribute("id")}}}return l(e.replace(B,"$1"),t,r,i)}function le(){var e=[];return function t(n,i){return e.push(n+" ")>r.cacheLength&&delete t[e.shift()],t[n+" "]=i}}function ue(e){return e[b]=!0,e}function ce(e){var t=d.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function he(e,t){for(var n=e.split("|"),i=n.length;i--;)r.attrHandle[n[i]]=t}function fe(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(r)return r;if(n)for(;n=n.nextSibling;)if(n===t)return-1;return e?1:-1}function de(e){return function(t){return"input"===t.nodeName.toLowerCase()&&t.type===e}}function pe(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}function ve(e){return function(t){return"form"in t?t.parentNode&&!1===t.disabled?"label"in t?"label"in t.parentNode?t.parentNode.disabled===e:t.disabled===e:t.isDisabled===e||t.isDisabled!==!e&&oe(t)===e:t.disabled===e:"label"in t&&t.disabled===e}}function me(e){return ue((function(t){return t=+t,ue((function(n,r){for(var i,a=e([],n.length,t),o=a.length;o--;)n[i=a[o]]&&(n[i]=!(r[i]=n[i]))}))}))}function ye(e){return e&&void 0!==e.getElementsByTagName&&e}for(t in n=se.support={},a=se.isXML=function(e){var t=e&&e.namespaceURI,n=e&&(e.ownerDocument||e).documentElement;return!J.test(t||n&&n.nodeName||"HTML")},f=se.setDocument=function(e){var t,i,o=e?e.ownerDocument||e:w;return o!=d&&9===o.nodeType&&o.documentElement?(p=(d=o).documentElement,v=!a(d),w!=d&&(i=d.defaultView)&&i.top!==i&&(i.addEventListener?i.addEventListener("unload",ae,!1):i.attachEvent&&i.attachEvent("onunload",ae)),n.scope=ce((function(e){return p.appendChild(e).appendChild(d.createElement("div")),void 0!==e.querySelectorAll&&!e.querySelectorAll(":scope fieldset div").length})),n.attributes=ce((function(e){return e.className="i",!e.getAttribute("className")})),n.getElementsByTagName=ce((function(e){return e.appendChild(d.createComment("")),!e.getElementsByTagName("*").length})),n.getElementsByClassName=Z.test(d.getElementsByClassName),n.getById=ce((function(e){return p.appendChild(e).id=b,!d.getElementsByName||!d.getElementsByName(b).length})),n.getById?(r.filter.ID=function(e){var t=e.replace(te,ne);return function(e){return e.getAttribute("id")===t}},r.find.ID=function(e,t){if(void 0!==t.getElementById&&v){var n=t.getElementById(e);return n?[n]:[]}}):(r.filter.ID=function(e){var t=e.replace(te,ne);return function(e){var n=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return n&&n.value===t}},r.find.ID=function(e,t){if(void 0!==t.getElementById&&v){var n,r,i,a=t.getElementById(e);if(a){if((n=a.getAttributeNode("id"))&&n.value===e)return[a];for(i=t.getElementsByName(e),r=0;a=i[r++];)if((n=a.getAttributeNode("id"))&&n.value===e)return[a]}return[]}}),r.find.TAG=n.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):n.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],i=0,a=t.getElementsByTagName(e);if("*"===e){for(;n=a[i++];)1===n.nodeType&&r.push(n);return r}return a},r.find.CLASS=n.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&v)return t.getElementsByClassName(e)},y=[],m=[],(n.qsa=Z.test(d.querySelectorAll))&&(ce((function(e){var t;p.appendChild(e).innerHTML="<a id='"+b+"'></a><select id='"+b+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&m.push("[*^$]=[\\x20\\t\\r\\n\\f]*(?:''|\"\")"),e.querySelectorAll("[selected]").length||m.push("\\[[\\x20\\t\\r\\n\\f]*(?:value|"+D+")"),e.querySelectorAll("[id~="+b+"-]").length||m.push("~="),(t=d.createElement("input")).setAttribute("name",""),e.appendChild(t),e.querySelectorAll("[name='']").length||m.push("\\[[\\x20\\t\\r\\n\\f]*name[\\x20\\t\\r\\n\\f]*=[\\x20\\t\\r\\n\\f]*(?:''|\"\")"),e.querySelectorAll(":checked").length||m.push(":checked"),e.querySelectorAll("a#"+b+"+*").length||m.push(".#.+[+~]"),e.querySelectorAll("\\\f"),m.push("[\\r\\n\\f]")})),ce((function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=d.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&m.push("name[\\x20\\t\\r\\n\\f]*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&m.push(":enabled",":disabled"),p.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&m.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),m.push(",.*:")}))),(n.matchesSelector=Z.test(g=p.matches||p.webkitMatchesSelector||p.mozMatchesSelector||p.oMatchesSelector||p.msMatchesSelector))&&ce((function(e){n.disconnectedMatch=g.call(e,"*"),g.call(e,"[s!='']:x"),y.push("!=",M)})),m=m.length&&new RegExp(m.join("|")),y=y.length&&new RegExp(y.join("|")),t=Z.test(p.compareDocumentPosition),C=t||Z.test(p.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},A=t?function(e,t){if(e===t)return h=!0,0;var r=!e.compareDocumentPosition-!t.compareDocumentPosition;return r||(1&(r=(e.ownerDocument||e)==(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!n.sortDetached&&t.compareDocumentPosition(e)===r?e==d||e.ownerDocument==w&&C(w,e)?-1:t==d||t.ownerDocument==w&&C(w,t)?1:c?R(c,e)-R(c,t):0:4&r?-1:1)}:function(e,t){if(e===t)return h=!0,0;var n,r=0,i=e.parentNode,a=t.parentNode,o=[e],s=[t];if(!i||!a)return e==d?-1:t==d?1:i?-1:a?1:c?R(c,e)-R(c,t):0;if(i===a)return fe(e,t);for(n=e;n=n.parentNode;)o.unshift(n);for(n=t;n=n.parentNode;)s.unshift(n);for(;o[r]===s[r];)r++;return r?fe(o[r],s[r]):o[r]==w?-1:s[r]==w?1:0},d):d},se.matches=function(e,t){return se(e,null,null,t)},se.matchesSelector=function(e,t){if(f(e),n.matchesSelector&&v&&!T[t+" "]&&(!y||!y.test(t))&&(!m||!m.test(t)))try{var r=g.call(e,t);if(r||n.disconnectedMatch||e.document&&11!==e.document.nodeType)return r}catch(e){T(t,!0)}return se(t,d,null,[e]).length>0},se.contains=function(e,t){return(e.ownerDocument||e)!=d&&f(e),C(e,t)},se.attr=function(e,t){(e.ownerDocument||e)!=d&&f(e);var i=r.attrHandle[t.toLowerCase()],a=i&&N.call(r.attrHandle,t.toLowerCase())?i(e,t,!v):void 0;return void 0!==a?a:n.attributes||!v?e.getAttribute(t):(a=e.getAttributeNode(t))&&a.specified?a.value:null},se.escape=function(e){return(e+"").replace(re,ie)},se.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},se.uniqueSort=function(e){var t,r=[],i=0,a=0;if(h=!n.detectDuplicates,c=!n.sortStable&&e.slice(0),e.sort(A),h){for(;t=e[a++];)t===e[a]&&(i=r.push(a));for(;i--;)e.splice(r[i],1)}return c=null,e},i=se.getText=function(e){var t,n="",r=0,a=e.nodeType;if(a){if(1===a||9===a||11===a){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=i(e)}else if(3===a||4===a)return e.nodeValue}else for(;t=e[r++];)n+=i(t);return n},r=se.selectors={cacheLength:50,createPseudo:ue,match:z,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(te,ne),e[3]=(e[3]||e[4]||e[5]||"").replace(te,ne),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||se.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&se.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return z.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&U.test(n)&&(t=o(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(te,ne).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=x[e+" "];return t||(t=new RegExp("(^|[\\x20\\t\\r\\n\\f])"+e+"("+L+"|$)"))&&x(e,(function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")}))},ATTR:function(e,t,n){return function(r){var i=se.attr(r,e);return null==i?"!="===t:!t||(i+="","="===t?i===n:"!="===t?i!==n:"^="===t?n&&0===i.indexOf(n):"*="===t?n&&i.indexOf(n)>-1:"$="===t?n&&i.slice(-n.length)===n:"~="===t?(" "+i.replace(V," ")+" ").indexOf(n)>-1:"|="===t&&(i===n||i.slice(0,n.length+1)===n+"-"))}},CHILD:function(e,t,n,r,i){var a="nth"!==e.slice(0,3),o="last"!==e.slice(-4),s="of-type"===t;return 1===r&&0===i?function(e){return!!e.parentNode}:function(t,n,l){var u,c,h,f,d,p,v=a!==o?"nextSibling":"previousSibling",m=t.parentNode,y=s&&t.nodeName.toLowerCase(),g=!l&&!s,C=!1;if(m){if(a){for(;v;){for(f=t;f=f[v];)if(s?f.nodeName.toLowerCase()===y:1===f.nodeType)return!1;p=v="only"===e&&!p&&"nextSibling"}return!0}if(p=[o?m.firstChild:m.lastChild],o&&g){for(C=(d=(u=(c=(h=(f=m)[b]||(f[b]={}))[f.uniqueID]||(h[f.uniqueID]={}))[e]||[])[0]===S&&u[1])&&u[2],f=d&&m.childNodes[d];f=++d&&f&&f[v]||(C=d=0)||p.pop();)if(1===f.nodeType&&++C&&f===t){c[e]=[S,d,C];break}}else if(g&&(C=d=(u=(c=(h=(f=t)[b]||(f[b]={}))[f.uniqueID]||(h[f.uniqueID]={}))[e]||[])[0]===S&&u[1]),!1===C)for(;(f=++d&&f&&f[v]||(C=d=0)||p.pop())&&((s?f.nodeName.toLowerCase()!==y:1!==f.nodeType)||!++C||(g&&((c=(h=f[b]||(f[b]={}))[f.uniqueID]||(h[f.uniqueID]={}))[e]=[S,C]),f!==t)););return(C-=i)===r||C%r==0&&C/r>=0}}},PSEUDO:function(e,t){var n,i=r.pseudos[e]||r.setFilters[e.toLowerCase()]||se.error("unsupported pseudo: "+e);return i[b]?i(t):i.length>1?(n=[e,e,"",t],r.setFilters.hasOwnProperty(e.toLowerCase())?ue((function(e,n){for(var r,a=i(e,t),o=a.length;o--;)e[r=R(e,a[o])]=!(n[r]=a[o])})):function(e){return i(e,0,n)}):i}},pseudos:{not:ue((function(e){var t=[],n=[],r=s(e.replace(B,"$1"));return r[b]?ue((function(e,t,n,i){for(var a,o=r(e,null,i,[]),s=e.length;s--;)(a=o[s])&&(e[s]=!(t[s]=a))})):function(e,i,a){return t[0]=e,r(t,null,a,n),t[0]=null,!n.pop()}})),has:ue((function(e){return function(t){return se(e,t).length>0}})),contains:ue((function(e){return e=e.replace(te,ne),function(t){return(t.textContent||i(t)).indexOf(e)>-1}})),lang:ue((function(e){return K.test(e||"")||se.error("unsupported lang: "+e),e=e.replace(te,ne).toLowerCase(),function(t){var n;do{if(n=v?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return(n=n.toLowerCase())===e||0===n.indexOf(e+"-")}while((t=t.parentNode)&&1===t.nodeType);return!1}})),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===p},focus:function(e){return e===d.activeElement&&(!d.hasFocus||d.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:ve(!1),disabled:ve(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!r.pseudos.empty(e)},header:function(e){return X.test(e.nodeName)},input:function(e){return Y.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:me((function(){return[0]})),last:me((function(e,t){return[t-1]})),eq:me((function(e,t,n){return[n<0?n+t:n]})),even:me((function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e})),odd:me((function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e})),lt:me((function(e,t,n){for(var r=n<0?n+t:n>t?t:n;--r>=0;)e.push(r);return e})),gt:me((function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e}))}},r.pseudos.nth=r.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})r.pseudos[t]=de(t);for(t in{submit:!0,reset:!0})r.pseudos[t]=pe(t);function ge(){}function Ce(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function be(e,t,n){var r=t.dir,i=t.next,a=i||r,o=n&&"parentNode"===a,s=k++;return t.first?function(t,n,i){for(;t=t[r];)if(1===t.nodeType||o)return e(t,n,i);return!1}:function(t,n,l){var u,c,h,f=[S,s];if(l){for(;t=t[r];)if((1===t.nodeType||o)&&e(t,n,l))return!0}else for(;t=t[r];)if(1===t.nodeType||o)if(c=(h=t[b]||(t[b]={}))[t.uniqueID]||(h[t.uniqueID]={}),i&&i===t.nodeName.toLowerCase())t=t[r]||t;else{if((u=c[a])&&u[0]===S&&u[1]===s)return f[2]=u[2];if(c[a]=f,f[2]=e(t,n,l))return!0}return!1}}function we(e){return e.length>1?function(t,n,r){for(var i=e.length;i--;)if(!e[i](t,n,r))return!1;return!0}:e[0]}function Se(e,t,n,r,i){for(var a,o=[],s=0,l=e.length,u=null!=t;s<l;s++)(a=e[s])&&(n&&!n(a,r,i)||(o.push(a),u&&t.push(s)));return o}function ke(e,t,n,r,i,a){return r&&!r[b]&&(r=ke(r)),i&&!i[b]&&(i=ke(i,a)),ue((function(a,o,s,l){var u,c,h,f=[],d=[],p=o.length,v=a||function(e,t,n){for(var r=0,i=t.length;r<i;r++)se(e,t[r],n);return n}(t||"*",s.nodeType?[s]:s,[]),m=!e||!a&&t?v:Se(v,f,e,s,l),y=n?i||(a?e:p||r)?[]:o:m;if(n&&n(m,y,s,l),r)for(u=Se(y,d),r(u,[],s,l),c=u.length;c--;)(h=u[c])&&(y[d[c]]=!(m[d[c]]=h));if(a){if(i||e){if(i){for(u=[],c=y.length;c--;)(h=y[c])&&u.push(m[c]=h);i(null,y=[],u,l)}for(c=y.length;c--;)(h=y[c])&&(u=i?R(a,h):f[c])>-1&&(a[u]=!(o[u]=h))}}else y=Se(y===o?y.splice(p,y.length):y),i?i(null,o,y,l):F.apply(o,y)}))}function xe(e){for(var t,n,i,a=e.length,o=r.relative[e[0].type],s=o||r.relative[" "],l=o?1:0,c=be((function(e){return e===t}),s,!0),h=be((function(e){return R(t,e)>-1}),s,!0),f=[function(e,n,r){var i=!o&&(r||n!==u)||((t=n).nodeType?c(e,n,r):h(e,n,r));return t=null,i}];l<a;l++)if(n=r.relative[e[l].type])f=[be(we(f),n)];else{if((n=r.filter[e[l].type].apply(null,e[l].matches))[b]){for(i=++l;i<a&&!r.relative[e[i].type];i++);return ke(l>1&&we(f),l>1&&Ce(e.slice(0,l-1).concat({value:" "===e[l-2].type?"*":""})).replace(B,"$1"),n,l<i&&xe(e.slice(l,i)),i<a&&xe(e=e.slice(i)),i<a&&Ce(e))}f.push(n)}return we(f)}return ge.prototype=r.filters=r.pseudos,r.setFilters=new ge,o=se.tokenize=function(e,t){var n,i,a,o,s,l,u,c=E[e+" "];if(c)return t?0:c.slice(0);for(s=e,l=[],u=r.preFilter;s;){for(o in n&&!(i=G.exec(s))||(i&&(s=s.slice(i[0].length)||s),l.push(a=[])),n=!1,(i=q.exec(s))&&(n=i.shift(),a.push({value:n,type:i[0].replace(B," ")}),s=s.slice(n.length)),r.filter)!(i=z[o].exec(s))||u[o]&&!(i=u[o](i))||(n=i.shift(),a.push({value:n,type:o,matches:i}),s=s.slice(n.length));if(!n)break}return t?s.length:s?se.error(e):E(e,l).slice(0)},s=se.compile=function(e,t){var n,i=[],a=[],s=_[e+" "];if(!s){for(t||(t=o(e)),n=t.length;n--;)(s=xe(t[n]))[b]?i.push(s):a.push(s);s=_(e,function(e,t){var n=t.length>0,i=e.length>0,a=function(a,o,s,l,c){var h,p,m,y=0,g="0",C=a&&[],b=[],w=u,k=a||i&&r.find.TAG("*",c),x=S+=null==w?1:Math.random()||.1,E=k.length;for(c&&(u=o==d||o||c);g!==E&&null!=(h=k[g]);g++){if(i&&h){for(p=0,o||h.ownerDocument==d||(f(h),s=!v);m=e[p++];)if(m(h,o||d,s)){l.push(h);break}c&&(S=x)}n&&((h=!m&&h)&&y--,a&&C.push(h))}if(y+=g,n&&g!==y){for(p=0;m=t[p++];)m(C,b,o,s);if(a){if(y>0)for(;g--;)C[g]||b[g]||(b[g]=P.call(l));b=Se(b)}F.apply(l,b),c&&!a&&b.length>0&&y+t.length>1&&se.uniqueSort(l)}return c&&(S=x,u=w),C};return n?ue(a):a}(a,i)),s.selector=e}return s},l=se.select=function(e,t,n,i){var a,l,u,c,h,f="function"==typeof e&&e,d=!i&&o(e=f.selector||e);if(n=n||[],1===d.length){if((l=d[0]=d[0].slice(0)).length>2&&"ID"===(u=l[0]).type&&9===t.nodeType&&v&&r.relative[l[1].type]){if(!(t=(r.find.ID(u.matches[0].replace(te,ne),t)||[])[0]))return n;f&&(t=t.parentNode),e=e.slice(l.shift().value.length)}for(a=z.needsContext.test(e)?0:l.length;a--&&(u=l[a],!r.relative[c=u.type]);)if((h=r.find[c])&&(i=h(u.matches[0].replace(te,ne),ee.test(l[0].type)&&ye(t.parentNode)||t))){if(l.splice(a,1),!(e=i.length&&Ce(l)))return F.apply(n,i),n;break}}return(f||s(e,d))(i,t,!v,n,!t||ee.test(e)&&ye(t.parentNode)||t),n},n.sortStable=b.split("").sort(A).join("")===b,n.detectDuplicates=!!h,f(),n.sortDetached=ce((function(e){return 1&e.compareDocumentPosition(d.createElement("fieldset"))})),ce((function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")}))||he("type|href|height|width",(function(e,t,n){if(!n)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)})),n.attributes&&ce((function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")}))||he("value",(function(e,t,n){if(!n&&"input"===e.nodeName.toLowerCase())return e.defaultValue})),ce((function(e){return null==e.getAttribute("disabled")}))||he(D,(function(e,t,n){var r;if(!n)return!0===e[t]?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null})),se}(e);w.find=k,w.expr=k.selectors,w.expr[":"]=w.expr.pseudos,w.uniqueSort=w.unique=k.uniqueSort,w.text=k.getText,w.isXMLDoc=k.isXML,w.contains=k.contains,w.escapeSelector=k.escape;var x=function(e,t,n){for(var r=[],i=void 0!==n;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(i&&w(e).is(n))break;r.push(e)}return r},E=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},_=w.expr.match.needsContext;function T(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}var A=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function N(e,t,n){return p(t)?w.grep(e,(function(e,r){return!!t.call(e,r,e)!==n})):t.nodeType?w.grep(e,(function(e){return e===t!==n})):"string"!=typeof t?w.grep(e,(function(e){return s.call(t,e)>-1!==n})):w.filter(t,e,n)}w.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?w.find.matchesSelector(r,e)?[r]:[]:w.find.matches(e,w.grep(t,(function(e){return 1===e.nodeType})))},w.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(w(e).filter((function(){for(t=0;t<r;t++)if(w.contains(i[t],this))return!0})));for(n=this.pushStack([]),t=0;t<r;t++)w.find(e,i[t],n);return r>1?w.uniqueSort(n):n},filter:function(e){return this.pushStack(N(this,e||[],!1))},not:function(e){return this.pushStack(N(this,e||[],!0))},is:function(e){return!!N(this,"string"==typeof e&&_.test(e)?w(e):e||[],!1).length}});var O,P=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/,I=w.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||O,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&e.length>=3?[null,e,null]:P.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof w?t[0]:t,w.merge(this,w.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:m,!0)),A.test(r[1])&&w.isPlainObject(t))for(r in t)p(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=m.getElementById(r[2]))&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):p(e)?void 0!==n.ready?n.ready(e):e(w):w.makeArray(e,this)};I.prototype=w.fn,O=w(m);var F=/^(?:parents|prev(?:Until|All))/,W={children:!0,contents:!0,next:!0,prev:!0};function R(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}w.fn.extend({has:function(e){var t=w(e,this),n=t.length;return this.filter((function(){for(var e=0;e<n;e++)if(w.contains(this,t[e]))return!0}))},closest:function(e,t){var n,r=0,i=this.length,a=[],o="string"!=typeof e&&w(e);if(!_.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(o?o.index(n)>-1:1===n.nodeType&&w.find.matchesSelector(n,e))){a.push(n);break}return this.pushStack(a.length>1?w.uniqueSort(a):a)},index:function(e){return e?"string"==typeof e?s.call(w(e),this[0]):s.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(w.uniqueSort(w.merge(this.get(),w(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),w.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return x(e,"parentNode")},parentsUntil:function(e,t,n){return x(e,"parentNode",n)},next:function(e){return R(e,"nextSibling")},prev:function(e){return R(e,"previousSibling")},nextAll:function(e){return x(e,"nextSibling")},prevAll:function(e){return x(e,"previousSibling")},nextUntil:function(e,t,n){return x(e,"nextSibling",n)},prevUntil:function(e,t,n){return x(e,"previousSibling",n)},siblings:function(e){return E((e.parentNode||{}).firstChild,e)},children:function(e){return E(e.firstChild)},contents:function(e){return null!=e.contentDocument&&r(e.contentDocument)?e.contentDocument:(T(e,"template")&&(e=e.content||e),w.merge([],e.childNodes))}},(function(e,t){w.fn[e]=function(n,r){var i=w.map(this,t,n);return"Until"!==e.slice(-5)&&(r=n),r&&"string"==typeof r&&(i=w.filter(r,i)),this.length>1&&(W[e]||w.uniqueSort(i),F.test(e)&&i.reverse()),this.pushStack(i)}}));var D=/[^\x20\t\r\n\f]+/g;function L(e){return e}function j(e){throw e}function $(e,t,n,r){var i;try{e&&p(i=e.promise)?i.call(e).done(t).fail(n):e&&p(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}w.Callbacks=function(e){e="string"==typeof e?function(e){var t={};return w.each(e.match(D)||[],(function(e,n){t[n]=!0})),t}(e):w.extend({},e);var t,n,r,i,a=[],o=[],s=-1,l=function(){for(i=i||e.once,r=t=!0;o.length;s=-1)for(n=o.shift();++s<a.length;)!1===a[s].apply(n[0],n[1])&&e.stopOnFalse&&(s=a.length,n=!1);e.memory||(n=!1),t=!1,i&&(a=n?[]:"")},u={add:function(){return a&&(n&&!t&&(s=a.length-1,o.push(n)),function t(n){w.each(n,(function(n,r){p(r)?e.unique&&u.has(r)||a.push(r):r&&r.length&&"string"!==C(r)&&t(r)}))}(arguments),n&&!t&&l()),this},remove:function(){return w.each(arguments,(function(e,t){for(var n;(n=w.inArray(t,a,n))>-1;)a.splice(n,1),n<=s&&s--})),this},has:function(e){return e?w.inArray(e,a)>-1:a.length>0},empty:function(){return a&&(a=[]),this},disable:function(){return i=o=[],a=n="",this},disabled:function(){return!a},lock:function(){return i=o=[],n||t||(a=n=""),this},locked:function(){return!!i},fireWith:function(e,n){return i||(n=[e,(n=n||[]).slice?n.slice():n],o.push(n),t||l()),this},fire:function(){return u.fireWith(this,arguments),this},fired:function(){return!!r}};return u},w.extend({Deferred:function(t){var n=[["notify","progress",w.Callbacks("memory"),w.Callbacks("memory"),2],["resolve","done",w.Callbacks("once memory"),w.Callbacks("once memory"),0,"resolved"],["reject","fail",w.Callbacks("once memory"),w.Callbacks("once memory"),1,"rejected"]],r="pending",i={state:function(){return r},always:function(){return a.done(arguments).fail(arguments),this},catch:function(e){return i.then(null,e)},pipe:function(){var e=arguments;return w.Deferred((function(t){w.each(n,(function(n,r){var i=p(e[r[4]])&&e[r[4]];a[r[1]]((function(){var e=i&&i.apply(this,arguments);e&&p(e.promise)?e.promise().progress(t.notify).done(t.resolve).fail(t.reject):t[r[0]+"With"](this,i?[e]:arguments)}))})),e=null})).promise()},then:function(t,r,i){var a=0;function o(t,n,r,i){return function(){var s=this,l=arguments,u=function(){var e,u;if(!(t<a)){if((e=r.apply(s,l))===n.promise())throw new TypeError("Thenable self-resolution");u=e&&("object"==typeof e||"function"==typeof e)&&e.then,p(u)?i?u.call(e,o(a,n,L,i),o(a,n,j,i)):(a++,u.call(e,o(a,n,L,i),o(a,n,j,i),o(a,n,L,n.notifyWith))):(r!==L&&(s=void 0,l=[e]),(i||n.resolveWith)(s,l))}},c=i?u:function(){try{u()}catch(e){w.Deferred.exceptionHook&&w.Deferred.exceptionHook(e,c.stackTrace),t+1>=a&&(r!==j&&(s=void 0,l=[e]),n.rejectWith(s,l))}};t?c():(w.Deferred.getStackHook&&(c.stackTrace=w.Deferred.getStackHook()),e.setTimeout(c))}}return w.Deferred((function(e){n[0][3].add(o(0,e,p(i)?i:L,e.notifyWith)),n[1][3].add(o(0,e,p(t)?t:L)),n[2][3].add(o(0,e,p(r)?r:j))})).promise()},promise:function(e){return null!=e?w.extend(e,i):i}},a={};return w.each(n,(function(e,t){var o=t[2],s=t[5];i[t[1]]=o.add,s&&o.add((function(){r=s}),n[3-e][2].disable,n[3-e][3].disable,n[0][2].lock,n[0][3].lock),o.add(t[3].fire),a[t[0]]=function(){return a[t[0]+"With"](this===a?void 0:this,arguments),this},a[t[0]+"With"]=o.fireWith})),i.promise(a),t&&t.call(a,a),a},when:function(e){var t=arguments.length,n=t,r=Array(n),a=i.call(arguments),o=w.Deferred(),s=function(e){return function(n){r[e]=this,a[e]=arguments.length>1?i.call(arguments):n,--t||o.resolveWith(r,a)}};if(t<=1&&($(e,o.done(s(n)).resolve,o.reject,!t),"pending"===o.state()||p(a[n]&&a[n].then)))return o.then();for(;n--;)$(a[n],s(n),o.reject);return o.promise()}});var M=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;w.Deferred.exceptionHook=function(t,n){e.console&&e.console.warn&&t&&M.test(t.name)&&e.console.warn("jQuery.Deferred exception: "+t.message,t.stack,n)},w.readyException=function(t){e.setTimeout((function(){throw t}))};var V=w.Deferred();function B(){m.removeEventListener("DOMContentLoaded",B),e.removeEventListener("load",B),w.ready()}w.fn.ready=function(e){return V.then(e).catch((function(e){w.readyException(e)})),this},w.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--w.readyWait:w.isReady)||(w.isReady=!0,!0!==e&&--w.readyWait>0||V.resolveWith(m,[w]))}}),w.ready.then=V.then,"complete"===m.readyState||"loading"!==m.readyState&&!m.documentElement.doScroll?e.setTimeout(w.ready):(m.addEventListener("DOMContentLoaded",B),e.addEventListener("load",B));var G=function(e,t,n,r,i,a,o){var s=0,l=e.length,u=null==n;if("object"===C(n))for(s in i=!0,n)G(e,t,s,n[s],!0,a,o);else if(void 0!==r&&(i=!0,p(r)||(o=!0),u&&(o?(t.call(e,r),t=null):(u=t,t=function(e,t,n){return u.call(w(e),n)})),t))for(;s<l;s++)t(e[s],n,o?r:r.call(e[s],s,t(e[s],n)));return i?e:u?t.call(e):l?t(e[0],n):a},q=/^-ms-/,H=/-([a-z])/g;function U(e,t){return t.toUpperCase()}function K(e){return e.replace(q,"ms-").replace(H,U)}var z=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function J(){this.expando=w.expando+J.uid++}J.uid=1,J.prototype={cache:function(e){var t=e[this.expando];return t||(t={},z(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[K(t)]=n;else for(r in t)i[K(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][K(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(K):(t=K(t))in r?[t]:t.match(D)||[]).length;for(;n--;)delete r[t[n]]}(void 0===t||w.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!w.isEmptyObject(t)}};var Y=new J,X=new J,Z=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,Q=/[A-Z]/g;function ee(e,t,n){var r;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(Q,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n=function(e){return"true"===e||"false"!==e&&("null"===e?null:e===+e+""?+e:Z.test(e)?JSON.parse(e):e)}(n)}catch(e){}X.set(e,t,n)}else n=void 0;return n}w.extend({hasData:function(e){return X.hasData(e)||Y.hasData(e)},data:function(e,t,n){return X.access(e,t,n)},removeData:function(e,t){X.remove(e,t)},_data:function(e,t,n){return Y.access(e,t,n)},_removeData:function(e,t){Y.remove(e,t)}}),w.fn.extend({data:function(e,t){var n,r,i,a=this[0],o=a&&a.attributes;if(void 0===e){if(this.length&&(i=X.get(a),1===a.nodeType&&!Y.get(a,"hasDataAttrs"))){for(n=o.length;n--;)o[n]&&0===(r=o[n].name).indexOf("data-")&&(r=K(r.slice(5)),ee(a,r,i[r]));Y.set(a,"hasDataAttrs",!0)}return i}return"object"==typeof e?this.each((function(){X.set(this,e)})):G(this,(function(t){var n;if(a&&void 0===t)return void 0!==(n=X.get(a,e))||void 0!==(n=ee(a,e))?n:void 0;this.each((function(){X.set(this,e,t)}))}),null,t,arguments.length>1,null,!0)},removeData:function(e){return this.each((function(){X.remove(this,e)}))}}),w.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=Y.get(e,t),n&&(!r||Array.isArray(n)?r=Y.access(e,t,w.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=w.queue(e,t),r=n.length,i=n.shift(),a=w._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete a.stop,i.call(e,(function(){w.dequeue(e,t)}),a)),!r&&a&&a.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return Y.get(e,n)||Y.access(e,n,{empty:w.Callbacks("once memory").add((function(){Y.remove(e,[t+"queue",n])}))})}}),w.fn.extend({queue:function(e,t){var n=2;return"string"!=typeof e&&(t=e,e="fx",n--),arguments.length<n?w.queue(this[0],e):void 0===t?this:this.each((function(){var n=w.queue(this,e,t);w._queueHooks(this,e),"fx"===e&&"inprogress"!==n[0]&&w.dequeue(this,e)}))},dequeue:function(e){return this.each((function(){w.dequeue(this,e)}))},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=w.Deferred(),a=this,o=this.length,s=function(){--r||i.resolveWith(a,[a])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";o--;)(n=Y.get(a[o],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var te=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,ne=new RegExp("^(?:([+-])=|)("+te+")([a-z%]*)$","i"),re=["Top","Right","Bottom","Left"],ie=m.documentElement,ae=function(e){return w.contains(e.ownerDocument,e)},oe={composed:!0};ie.getRootNode&&(ae=function(e){return w.contains(e.ownerDocument,e)||e.getRootNode(oe)===e.ownerDocument});var se=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&ae(e)&&"none"===w.css(e,"display")};function le(e,t,n,r){var i,a,o=20,s=r?function(){return r.cur()}:function(){return w.css(e,t,"")},l=s(),u=n&&n[3]||(w.cssNumber[t]?"":"px"),c=e.nodeType&&(w.cssNumber[t]||"px"!==u&&+l)&&ne.exec(w.css(e,t));if(c&&c[3]!==u){for(l/=2,u=u||c[3],c=+l||1;o--;)w.style(e,t,c+u),(1-a)*(1-(a=s()/l||.5))<=0&&(o=0),c/=a;c*=2,w.style(e,t,c+u),n=n||[]}return n&&(c=+c||+l||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=u,r.start=c,r.end=i)),i}var ue={};function ce(e){var t,n=e.ownerDocument,r=e.nodeName,i=ue[r];return i||(t=n.body.appendChild(n.createElement(r)),i=w.css(t,"display"),t.parentNode.removeChild(t),"none"===i&&(i="block"),ue[r]=i,i)}function he(e,t){for(var n,r,i=[],a=0,o=e.length;a<o;a++)(r=e[a]).style&&(n=r.style.display,t?("none"===n&&(i[a]=Y.get(r,"display")||null,i[a]||(r.style.display="")),""===r.style.display&&se(r)&&(i[a]=ce(r))):"none"!==n&&(i[a]="none",Y.set(r,"display",n)));for(a=0;a<o;a++)null!=i[a]&&(e[a].style.display=i[a]);return e}w.fn.extend({show:function(){return he(this,!0)},hide:function(){return he(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each((function(){se(this)?w(this).show():w(this).hide()}))}});var fe,de,pe=/^(?:checkbox|radio)$/i,ve=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,me=/^$|^module$|\/(?:java|ecma)script/i;fe=m.createDocumentFragment().appendChild(m.createElement("div")),(de=m.createElement("input")).setAttribute("type","radio"),de.setAttribute("checked","checked"),de.setAttribute("name","t"),fe.appendChild(de),d.checkClone=fe.cloneNode(!0).cloneNode(!0).lastChild.checked,fe.innerHTML="<textarea>x</textarea>",d.noCloneChecked=!!fe.cloneNode(!0).lastChild.defaultValue,fe.innerHTML="<option></option>",d.option=!!fe.lastChild;var ye={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function ge(e,t){var n;return n=void 0!==e.getElementsByTagName?e.getElementsByTagName(t||"*"):void 0!==e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&T(e,t)?w.merge([e],n):n}function Ce(e,t){for(var n=0,r=e.length;n<r;n++)Y.set(e[n],"globalEval",!t||Y.get(t[n],"globalEval"))}ye.tbody=ye.tfoot=ye.colgroup=ye.caption=ye.thead,ye.th=ye.td,d.option||(ye.optgroup=ye.option=[1,"<select multiple='multiple'>","</select>"]);var be=/<|&#?\w+;/;function we(e,t,n,r,i){for(var a,o,s,l,u,c,h=t.createDocumentFragment(),f=[],d=0,p=e.length;d<p;d++)if((a=e[d])||0===a)if("object"===C(a))w.merge(f,a.nodeType?[a]:a);else if(be.test(a)){for(o=o||h.appendChild(t.createElement("div")),s=(ve.exec(a)||["",""])[1].toLowerCase(),l=ye[s]||ye._default,o.innerHTML=l[1]+w.htmlPrefilter(a)+l[2],c=l[0];c--;)o=o.lastChild;w.merge(f,o.childNodes),(o=h.firstChild).textContent=""}else f.push(t.createTextNode(a));for(h.textContent="",d=0;a=f[d++];)if(r&&w.inArray(a,r)>-1)i&&i.push(a);else if(u=ae(a),o=ge(h.appendChild(a),"script"),u&&Ce(o),n)for(c=0;a=o[c++];)me.test(a.type||"")&&n.push(a);return h}var Se=/^([^.]*)(?:\.(.+)|)/;function ke(){return!0}function xe(){return!1}function Ee(e,t){return e===function(){try{return m.activeElement}catch(e){}}()==("focus"===t)}function _e(e,t,n,r,i,a){var o,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)_e(e,s,n,r,t[s],a);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=xe;else if(!i)return e;return 1===a&&(o=i,i=function(e){return w().off(e),o.apply(this,arguments)},i.guid=o.guid||(o.guid=w.guid++)),e.each((function(){w.event.add(this,t,i,r,n)}))}function Te(e,t,n){n?(Y.set(e,t,!1),w.event.add(e,t,{namespace:!1,handler:function(e){var r,a,o=Y.get(this,t);if(1&e.isTrigger&&this[t]){if(o.length)(w.event.special[t]||{}).delegateType&&e.stopPropagation();else if(o=i.call(arguments),Y.set(this,t,o),r=n(this,t),this[t](),o!==(a=Y.get(this,t))||r?Y.set(this,t,!1):a={},o!==a)return e.stopImmediatePropagation(),e.preventDefault(),a&&a.value}else o.length&&(Y.set(this,t,{value:w.event.trigger(w.extend(o[0],w.Event.prototype),o.slice(1),this)}),e.stopImmediatePropagation())}})):void 0===Y.get(e,t)&&w.event.add(e,t,ke)}w.event={global:{},add:function(e,t,n,r,i){var a,o,s,l,u,c,h,f,d,p,v,m=Y.get(e);if(z(e))for(n.handler&&(n=(a=n).handler,i=a.selector),i&&w.find.matchesSelector(ie,i),n.guid||(n.guid=w.guid++),(l=m.events)||(l=m.events=Object.create(null)),(o=m.handle)||(o=m.handle=function(t){return void 0!==w&&w.event.triggered!==t.type?w.event.dispatch.apply(e,arguments):void 0}),u=(t=(t||"").match(D)||[""]).length;u--;)d=v=(s=Se.exec(t[u])||[])[1],p=(s[2]||"").split(".").sort(),d&&(h=w.event.special[d]||{},d=(i?h.delegateType:h.bindType)||d,h=w.event.special[d]||{},c=w.extend({type:d,origType:v,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&w.expr.match.needsContext.test(i),namespace:p.join(".")},a),(f=l[d])||((f=l[d]=[]).delegateCount=0,h.setup&&!1!==h.setup.call(e,r,p,o)||e.addEventListener&&e.addEventListener(d,o)),h.add&&(h.add.call(e,c),c.handler.guid||(c.handler.guid=n.guid)),i?f.splice(f.delegateCount++,0,c):f.push(c),w.event.global[d]=!0)},remove:function(e,t,n,r,i){var a,o,s,l,u,c,h,f,d,p,v,m=Y.hasData(e)&&Y.get(e);if(m&&(l=m.events)){for(u=(t=(t||"").match(D)||[""]).length;u--;)if(d=v=(s=Se.exec(t[u])||[])[1],p=(s[2]||"").split(".").sort(),d){for(h=w.event.special[d]||{},f=l[d=(r?h.delegateType:h.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),o=a=f.length;a--;)c=f[a],!i&&v!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(f.splice(a,1),c.selector&&f.delegateCount--,h.remove&&h.remove.call(e,c));o&&!f.length&&(h.teardown&&!1!==h.teardown.call(e,p,m.handle)||w.removeEvent(e,d,m.handle),delete l[d])}else for(d in l)w.event.remove(e,d+t[u],n,r,!0);w.isEmptyObject(l)&&Y.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,a,o,s=new Array(arguments.length),l=w.event.fix(e),u=(Y.get(this,"events")||Object.create(null))[l.type]||[],c=w.event.special[l.type]||{};for(s[0]=l,t=1;t<arguments.length;t++)s[t]=arguments[t];if(l.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,l)){for(o=w.event.handlers.call(this,l,u),t=0;(i=o[t++])&&!l.isPropagationStopped();)for(l.currentTarget=i.elem,n=0;(a=i.handlers[n++])&&!l.isImmediatePropagationStopped();)l.rnamespace&&!1!==a.namespace&&!l.rnamespace.test(a.namespace)||(l.handleObj=a,l.data=a.data,void 0!==(r=((w.event.special[a.origType]||{}).handle||a.handler).apply(i.elem,s))&&!1===(l.result=r)&&(l.preventDefault(),l.stopPropagation()));return c.postDispatch&&c.postDispatch.call(this,l),l.result}},handlers:function(e,t){var n,r,i,a,o,s=[],l=t.delegateCount,u=e.target;if(l&&u.nodeType&&!("click"===e.type&&e.button>=1))for(;u!==this;u=u.parentNode||this)if(1===u.nodeType&&("click"!==e.type||!0!==u.disabled)){for(a=[],o={},n=0;n<l;n++)void 0===o[i=(r=t[n]).selector+" "]&&(o[i]=r.needsContext?w(i,this).index(u)>-1:w.find(i,this,null,[u]).length),o[i]&&a.push(r);a.length&&s.push({elem:u,handlers:a})}return u=this,l<t.length&&s.push({elem:u,handlers:t.slice(l)}),s},addProp:function(e,t){Object.defineProperty(w.Event.prototype,e,{enumerable:!0,configurable:!0,get:p(t)?function(){if(this.originalEvent)return t(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[e]},set:function(t){Object.defineProperty(this,e,{enumerable:!0,configurable:!0,writable:!0,value:t})}})},fix:function(e){return e[w.expando]?e:new w.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return pe.test(t.type)&&t.click&&T(t,"input")&&Te(t,"click",ke),!1},trigger:function(e){var t=this||e;return pe.test(t.type)&&t.click&&T(t,"input")&&Te(t,"click"),!0},_default:function(e){var t=e.target;return pe.test(t.type)&&t.click&&T(t,"input")&&Y.get(t,"click")||T(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},w.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},w.Event=function(e,t){if(!(this instanceof w.Event))return new w.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?ke:xe,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&w.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[w.expando]=!0},w.Event.prototype={constructor:w.Event,isDefaultPrevented:xe,isPropagationStopped:xe,isImmediatePropagationStopped:xe,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=ke,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=ke,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=ke,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},w.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,char:!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:!0},w.event.addProp),w.each({focus:"focusin",blur:"focusout"},(function(e,t){w.event.special[e]={setup:function(){return Te(this,e,Ee),!1},trigger:function(){return Te(this,e),!0},_default:function(t){return Y.get(t.target,e)},delegateType:t}})),w.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},(function(e,t){w.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=this,i=e.relatedTarget,a=e.handleObj;return i&&(i===r||w.contains(r,i))||(e.type=a.origType,n=a.handler.apply(this,arguments),e.type=t),n}}})),w.fn.extend({on:function(e,t,n,r){return _e(this,e,t,n,r)},one:function(e,t,n,r){return _e(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,w(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=xe),this.each((function(){w.event.remove(this,e,n,t)}))}});var Ae=/<script|<style|<link/i,Ne=/checked\s*(?:[^=]|=\s*.checked.)/i,Oe=/^\s*<!\[CDATA\[|\]\]>\s*$/g;function Pe(e,t){return T(e,"table")&&T(11!==t.nodeType?t:t.firstChild,"tr")&&w(e).children("tbody")[0]||e}function Ie(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function Fe(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function We(e,t){var n,r,i,a,o,s;if(1===t.nodeType){if(Y.hasData(e)&&(s=Y.get(e).events))for(i in Y.remove(t,"handle events"),s)for(n=0,r=s[i].length;n<r;n++)w.event.add(t,i,s[i][n]);X.hasData(e)&&(a=X.access(e),o=w.extend({},a),X.set(t,o))}}function Re(e,t){var n=t.nodeName.toLowerCase();"input"===n&&pe.test(e.type)?t.checked=e.checked:"input"!==n&&"textarea"!==n||(t.defaultValue=e.defaultValue)}function De(e,t,n,r){t=a(t);var i,o,s,l,u,c,h=0,f=e.length,v=f-1,m=t[0],y=p(m);if(y||f>1&&"string"==typeof m&&!d.checkClone&&Ne.test(m))return e.each((function(i){var a=e.eq(i);y&&(t[0]=m.call(this,i,a.html())),De(a,t,n,r)}));if(f&&(o=(i=we(t,e[0].ownerDocument,!1,e,r)).firstChild,1===i.childNodes.length&&(i=o),o||r)){for(l=(s=w.map(ge(i,"script"),Ie)).length;h<f;h++)u=i,h!==v&&(u=w.clone(u,!0,!0),l&&w.merge(s,ge(u,"script"))),n.call(e[h],u,h);if(l)for(c=s[s.length-1].ownerDocument,w.map(s,Fe),h=0;h<l;h++)u=s[h],me.test(u.type||"")&&!Y.access(u,"globalEval")&&w.contains(c,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?w._evalUrl&&!u.noModule&&w._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")},c):g(u.textContent.replace(Oe,""),u,c))}return e}function Le(e,t,n){for(var r,i=t?w.filter(t,e):e,a=0;null!=(r=i[a]);a++)n||1!==r.nodeType||w.cleanData(ge(r)),r.parentNode&&(n&&ae(r)&&Ce(ge(r,"script")),r.parentNode.removeChild(r));return e}w.extend({htmlPrefilter:function(e){return e},clone:function(e,t,n){var r,i,a,o,s=e.cloneNode(!0),l=ae(e);if(!(d.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||w.isXMLDoc(e)))for(o=ge(s),r=0,i=(a=ge(e)).length;r<i;r++)Re(a[r],o[r]);if(t)if(n)for(a=a||ge(e),o=o||ge(s),r=0,i=a.length;r<i;r++)We(a[r],o[r]);else We(e,s);return(o=ge(s,"script")).length>0&&Ce(o,!l&&ge(e,"script")),s},cleanData:function(e){for(var t,n,r,i=w.event.special,a=0;void 0!==(n=e[a]);a++)if(z(n)){if(t=n[Y.expando]){if(t.events)for(r in t.events)i[r]?w.event.remove(n,r):w.removeEvent(n,r,t.handle);n[Y.expando]=void 0}n[X.expando]&&(n[X.expando]=void 0)}}}),w.fn.extend({detach:function(e){return Le(this,e,!0)},remove:function(e){return Le(this,e)},text:function(e){return G(this,(function(e){return void 0===e?w.text(this):this.empty().each((function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)}))}),null,e,arguments.length)},append:function(){return De(this,arguments,(function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Pe(this,e).appendChild(e)}))},prepend:function(){return De(this,arguments,(function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Pe(this,e);t.insertBefore(e,t.firstChild)}}))},before:function(){return De(this,arguments,(function(e){this.parentNode&&this.parentNode.insertBefore(e,this)}))},after:function(){return De(this,arguments,(function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)}))},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(w.cleanData(ge(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map((function(){return w.clone(this,e,t)}))},html:function(e){return G(this,(function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!Ae.test(e)&&!ye[(ve.exec(e)||["",""])[1].toLowerCase()]){e=w.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(w.cleanData(ge(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)}),null,e,arguments.length)},replaceWith:function(){var e=[];return De(this,arguments,(function(t){var n=this.parentNode;w.inArray(this,e)<0&&(w.cleanData(ge(this)),n&&n.replaceChild(t,this))}),e)}}),w.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},(function(e,t){w.fn[e]=function(e){for(var n,r=[],i=w(e),a=i.length-1,s=0;s<=a;s++)n=s===a?this:this.clone(!0),w(i[s])[t](n),o.apply(r,n.get());return this.pushStack(r)}}));var je=new RegExp("^("+te+")(?!px)[a-z%]+$","i"),$e=/^--/,Me=function(t){var n=t.ownerDocument.defaultView;return n&&n.opener||(n=e),n.getComputedStyle(t)},Ve=function(e,t,n){var r,i,a={};for(i in t)a[i]=e.style[i],e.style[i]=t[i];for(i in r=n.call(e),t)e.style[i]=a[i];return r},Be=new RegExp(re.join("|"),"i"),Ge=new RegExp("^[\\x20\\t\\r\\n\\f]+|((?:^|[^\\\\])(?:\\\\.)*)[\\x20\\t\\r\\n\\f]+$","g");function qe(e,t,n){var r,i,a,o,s=$e.test(t),l=e.style;return(n=n||Me(e))&&(o=n.getPropertyValue(t)||n[t],s&&(o=o.replace(Ge,"$1")),""!==o||ae(e)||(o=w.style(e,t)),!d.pixelBoxStyles()&&je.test(o)&&Be.test(t)&&(r=l.width,i=l.minWidth,a=l.maxWidth,l.minWidth=l.maxWidth=l.width=o,o=n.width,l.width=r,l.minWidth=i,l.maxWidth=a)),void 0!==o?o+"":o}function He(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function t(){if(c){u.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",c.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",ie.appendChild(u).appendChild(c);var t=e.getComputedStyle(c);r="1%"!==t.top,l=12===n(t.marginLeft),c.style.right="60%",o=36===n(t.right),i=36===n(t.width),c.style.position="absolute",a=12===n(c.offsetWidth/3),ie.removeChild(u),c=null}}function n(e){return Math.round(parseFloat(e))}var r,i,a,o,s,l,u=m.createElement("div"),c=m.createElement("div");c.style&&(c.style.backgroundClip="content-box",c.cloneNode(!0).style.backgroundClip="",d.clearCloneStyle="content-box"===c.style.backgroundClip,w.extend(d,{boxSizingReliable:function(){return t(),i},pixelBoxStyles:function(){return t(),o},pixelPosition:function(){return t(),r},reliableMarginLeft:function(){return t(),l},scrollboxSize:function(){return t(),a},reliableTrDimensions:function(){var t,n,r,i;return null==s&&(t=m.createElement("table"),n=m.createElement("tr"),r=m.createElement("div"),t.style.cssText="position:absolute;left:-11111px;border-collapse:separate",n.style.cssText="border:1px solid",n.style.height="1px",r.style.height="9px",r.style.display="block",ie.appendChild(t).appendChild(n).appendChild(r),i=e.getComputedStyle(n),s=parseInt(i.height,10)+parseInt(i.borderTopWidth,10)+parseInt(i.borderBottomWidth,10)===n.offsetHeight,ie.removeChild(t)),s}}))}();var Ue=["Webkit","Moz","ms"],Ke=m.createElement("div").style,ze={};function Je(e){var t=w.cssProps[e]||ze[e];return t||(e in Ke?e:ze[e]=function(e){for(var t=e[0].toUpperCase()+e.slice(1),n=Ue.length;n--;)if((e=Ue[n]+t)in Ke)return e}(e)||e)}var Ye=/^(none|table(?!-c[ea]).+)/,Xe={position:"absolute",visibility:"hidden",display:"block"},Ze={letterSpacing:"0",fontWeight:"400"};function Qe(e,t,n){var r=ne.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function et(e,t,n,r,i,a){var o="width"===t?1:0,s=0,l=0;if(n===(r?"border":"content"))return 0;for(;o<4;o+=2)"margin"===n&&(l+=w.css(e,n+re[o],!0,i)),r?("content"===n&&(l-=w.css(e,"padding"+re[o],!0,i)),"margin"!==n&&(l-=w.css(e,"border"+re[o]+"Width",!0,i))):(l+=w.css(e,"padding"+re[o],!0,i),"padding"!==n?l+=w.css(e,"border"+re[o]+"Width",!0,i):s+=w.css(e,"border"+re[o]+"Width",!0,i));return!r&&a>=0&&(l+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-a-l-s-.5))||0),l}function tt(e,t,n){var r=Me(e),i=(!d.boxSizingReliable()||n)&&"border-box"===w.css(e,"boxSizing",!1,r),a=i,o=qe(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if(je.test(o)){if(!n)return o;o="auto"}return(!d.boxSizingReliable()&&i||!d.reliableTrDimensions()&&T(e,"tr")||"auto"===o||!parseFloat(o)&&"inline"===w.css(e,"display",!1,r))&&e.getClientRects().length&&(i="border-box"===w.css(e,"boxSizing",!1,r),(a=s in e)&&(o=e[s])),(o=parseFloat(o)||0)+et(e,t,n||(i?"border":"content"),a,r,o)+"px"}function nt(e,t,n,r,i){return new nt.prototype.init(e,t,n,r,i)}w.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=qe(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,a,o,s=K(t),l=$e.test(t),u=e.style;if(l||(t=Je(s)),o=w.cssHooks[t]||w.cssHooks[s],void 0===n)return o&&"get"in o&&void 0!==(i=o.get(e,!1,r))?i:u[t];"string"===(a=typeof n)&&(i=ne.exec(n))&&i[1]&&(n=le(e,t,i),a="number"),null!=n&&n==n&&("number"!==a||l||(n+=i&&i[3]||(w.cssNumber[s]?"":"px")),d.clearCloneStyle||""!==n||0!==t.indexOf("background")||(u[t]="inherit"),o&&"set"in o&&void 0===(n=o.set(e,n,r))||(l?u.setProperty(t,n):u[t]=n))}},css:function(e,t,n,r){var i,a,o,s=K(t);return $e.test(t)||(t=Je(s)),(o=w.cssHooks[t]||w.cssHooks[s])&&"get"in o&&(i=o.get(e,!0,n)),void 0===i&&(i=qe(e,t,r)),"normal"===i&&t in Ze&&(i=Ze[t]),""===n||n?(a=parseFloat(i),!0===n||isFinite(a)?a||0:i):i}}),w.each(["height","width"],(function(e,t){w.cssHooks[t]={get:function(e,n,r){if(n)return!Ye.test(w.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?tt(e,t,r):Ve(e,Xe,(function(){return tt(e,t,r)}))},set:function(e,n,r){var i,a=Me(e),o=!d.scrollboxSize()&&"absolute"===a.position,s=(o||r)&&"border-box"===w.css(e,"boxSizing",!1,a),l=r?et(e,t,r,s,a):0;return s&&o&&(l-=Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-parseFloat(a[t])-et(e,t,"border",!1,a)-.5)),l&&(i=ne.exec(n))&&"px"!==(i[3]||"px")&&(e.style[t]=n,n=w.css(e,t)),Qe(0,n,l)}}})),w.cssHooks.marginLeft=He(d.reliableMarginLeft,(function(e,t){if(t)return(parseFloat(qe(e,"marginLeft"))||e.getBoundingClientRect().left-Ve(e,{marginLeft:0},(function(){return e.getBoundingClientRect().left})))+"px"})),w.each({margin:"",padding:"",border:"Width"},(function(e,t){w.cssHooks[e+t]={expand:function(n){for(var r=0,i={},a="string"==typeof n?n.split(" "):[n];r<4;r++)i[e+re[r]+t]=a[r]||a[r-2]||a[0];return i}},"margin"!==e&&(w.cssHooks[e+t].set=Qe)})),w.fn.extend({css:function(e,t){return G(this,(function(e,t,n){var r,i,a={},o=0;if(Array.isArray(t)){for(r=Me(e),i=t.length;o<i;o++)a[t[o]]=w.css(e,t[o],!1,r);return a}return void 0!==n?w.style(e,t,n):w.css(e,t)}),e,t,arguments.length>1)}}),w.Tween=nt,nt.prototype={constructor:nt,init:function(e,t,n,r,i,a){this.elem=e,this.prop=n,this.easing=i||w.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=a||(w.cssNumber[n]?"":"px")},cur:function(){var e=nt.propHooks[this.prop];return e&&e.get?e.get(this):nt.propHooks._default.get(this)},run:function(e){var t,n=nt.propHooks[this.prop];return this.options.duration?this.pos=t=w.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):nt.propHooks._default.set(this),this}},nt.prototype.init.prototype=nt.prototype,nt.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=w.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){w.fx.step[e.prop]?w.fx.step[e.prop](e):1!==e.elem.nodeType||!w.cssHooks[e.prop]&&null==e.elem.style[Je(e.prop)]?e.elem[e.prop]=e.now:w.style(e.elem,e.prop,e.now+e.unit)}}},nt.propHooks.scrollTop=nt.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},w.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},w.fx=nt.prototype.init,w.fx.step={};var rt,it,at=/^(?:toggle|show|hide)$/,ot=/queueHooks$/;function st(){it&&(!1===m.hidden&&e.requestAnimationFrame?e.requestAnimationFrame(st):e.setTimeout(st,w.fx.interval),w.fx.tick())}function lt(){return e.setTimeout((function(){rt=void 0})),rt=Date.now()}function ut(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=re[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function ct(e,t,n){for(var r,i=(ht.tweeners[t]||[]).concat(ht.tweeners["*"]),a=0,o=i.length;a<o;a++)if(r=i[a].call(n,t,e))return r}function ht(e,t,n){var r,i,a=0,o=ht.prefilters.length,s=w.Deferred().always((function(){delete l.elem})),l=function(){if(i)return!1;for(var t=rt||lt(),n=Math.max(0,u.startTime+u.duration-t),r=1-(n/u.duration||0),a=0,o=u.tweens.length;a<o;a++)u.tweens[a].run(r);return s.notifyWith(e,[u,r,n]),r<1&&o?n:(o||s.notifyWith(e,[u,1,0]),s.resolveWith(e,[u]),!1)},u=s.promise({elem:e,props:w.extend({},t),opts:w.extend(!0,{specialEasing:{},easing:w.easing._default},n),originalProperties:t,originalOptions:n,startTime:rt||lt(),duration:n.duration,tweens:[],createTween:function(t,n){var r=w.Tween(e,u.opts,t,n,u.opts.specialEasing[t]||u.opts.easing);return u.tweens.push(r),r},stop:function(t){var n=0,r=t?u.tweens.length:0;if(i)return this;for(i=!0;n<r;n++)u.tweens[n].run(1);return t?(s.notifyWith(e,[u,1,0]),s.resolveWith(e,[u,t])):s.rejectWith(e,[u,t]),this}}),c=u.props;for(!function(e,t){var n,r,i,a,o;for(n in e)if(i=t[r=K(n)],a=e[n],Array.isArray(a)&&(i=a[1],a=e[n]=a[0]),n!==r&&(e[r]=a,delete e[n]),(o=w.cssHooks[r])&&"expand"in o)for(n in a=o.expand(a),delete e[r],a)n in e||(e[n]=a[n],t[n]=i);else t[r]=i}(c,u.opts.specialEasing);a<o;a++)if(r=ht.prefilters[a].call(u,e,c,u.opts))return p(r.stop)&&(w._queueHooks(u.elem,u.opts.queue).stop=r.stop.bind(r)),r;return w.map(c,ct,u),p(u.opts.start)&&u.opts.start.call(e,u),u.progress(u.opts.progress).done(u.opts.done,u.opts.complete).fail(u.opts.fail).always(u.opts.always),w.fx.timer(w.extend(l,{elem:e,anim:u,queue:u.opts.queue})),u}w.Animation=w.extend(ht,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return le(n.elem,e,ne.exec(t),n),n}]},tweener:function(e,t){p(e)?(t=e,e=["*"]):e=e.match(D);for(var n,r=0,i=e.length;r<i;r++)n=e[r],ht.tweeners[n]=ht.tweeners[n]||[],ht.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,i,a,o,s,l,u,c,h="width"in t||"height"in t,f=this,d={},p=e.style,v=e.nodeType&&se(e),m=Y.get(e,"fxshow");for(r in n.queue||(null==(o=w._queueHooks(e,"fx")).unqueued&&(o.unqueued=0,s=o.empty.fire,o.empty.fire=function(){o.unqueued||s()}),o.unqueued++,f.always((function(){f.always((function(){o.unqueued--,w.queue(e,"fx").length||o.empty.fire()}))}))),t)if(i=t[r],at.test(i)){if(delete t[r],a=a||"toggle"===i,i===(v?"hide":"show")){if("show"!==i||!m||void 0===m[r])continue;v=!0}d[r]=m&&m[r]||w.style(e,r)}if((l=!w.isEmptyObject(t))||!w.isEmptyObject(d))for(r in h&&1===e.nodeType&&(n.overflow=[p.overflow,p.overflowX,p.overflowY],null==(u=m&&m.display)&&(u=Y.get(e,"display")),"none"===(c=w.css(e,"display"))&&(u?c=u:(he([e],!0),u=e.style.display||u,c=w.css(e,"display"),he([e]))),("inline"===c||"inline-block"===c&&null!=u)&&"none"===w.css(e,"float")&&(l||(f.done((function(){p.display=u})),null==u&&(c=p.display,u="none"===c?"":c)),p.display="inline-block")),n.overflow&&(p.overflow="hidden",f.always((function(){p.overflow=n.overflow[0],p.overflowX=n.overflow[1],p.overflowY=n.overflow[2]}))),l=!1,d)l||(m?"hidden"in m&&(v=m.hidden):m=Y.access(e,"fxshow",{display:u}),a&&(m.hidden=!v),v&&he([e],!0),f.done((function(){for(r in v||he([e]),Y.remove(e,"fxshow"),d)w.style(e,r,d[r])}))),l=ct(v?m[r]:0,r,f),r in m||(m[r]=l.start,v&&(l.end=l.start,l.start=0))}],prefilter:function(e,t){t?ht.prefilters.unshift(e):ht.prefilters.push(e)}}),w.speed=function(e,t,n){var r=e&&"object"==typeof e?w.extend({},e):{complete:n||!n&&t||p(e)&&e,duration:e,easing:n&&t||t&&!p(t)&&t};return w.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in w.fx.speeds?r.duration=w.fx.speeds[r.duration]:r.duration=w.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){p(r.old)&&r.old.call(this),r.queue&&w.dequeue(this,r.queue)},r},w.fn.extend({fadeTo:function(e,t,n,r){return this.filter(se).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var i=w.isEmptyObject(e),a=w.speed(t,n,r),o=function(){var t=ht(this,w.extend({},e),a);(i||Y.get(this,"finish"))&&t.stop(!0)};return o.finish=o,i||!1===a.queue?this.each(o):this.queue(a.queue,o)},stop:function(e,t,n){var r=function(e){var t=e.stop;delete e.stop,t(n)};return"string"!=typeof e&&(n=t,t=e,e=void 0),t&&this.queue(e||"fx",[]),this.each((function(){var t=!0,i=null!=e&&e+"queueHooks",a=w.timers,o=Y.get(this);if(i)o[i]&&o[i].stop&&r(o[i]);else for(i in o)o[i]&&o[i].stop&&ot.test(i)&&r(o[i]);for(i=a.length;i--;)a[i].elem!==this||null!=e&&a[i].queue!==e||(a[i].anim.stop(n),t=!1,a.splice(i,1));!t&&n||w.dequeue(this,e)}))},finish:function(e){return!1!==e&&(e=e||"fx"),this.each((function(){var t,n=Y.get(this),r=n[e+"queue"],i=n[e+"queueHooks"],a=w.timers,o=r?r.length:0;for(n.finish=!0,w.queue(this,e,[]),i&&i.stop&&i.stop.call(this,!0),t=a.length;t--;)a[t].elem===this&&a[t].queue===e&&(a[t].anim.stop(!0),a.splice(t,1));for(t=0;t<o;t++)r[t]&&r[t].finish&&r[t].finish.call(this);delete n.finish}))}}),w.each(["toggle","show","hide"],(function(e,t){var n=w.fn[t];w.fn[t]=function(e,r,i){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(ut(t,!0),e,r,i)}})),w.each({slideDown:ut("show"),slideUp:ut("hide"),slideToggle:ut("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},(function(e,t){w.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}})),w.timers=[],w.fx.tick=function(){var e,t=0,n=w.timers;for(rt=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||w.fx.stop(),rt=void 0},w.fx.timer=function(e){w.timers.push(e),w.fx.start()},w.fx.interval=13,w.fx.start=function(){it||(it=!0,st())},w.fx.stop=function(){it=null},w.fx.speeds={slow:600,fast:200,_default:400},w.fn.delay=function(t,n){return t=w.fx&&w.fx.speeds[t]||t,n=n||"fx",this.queue(n,(function(n,r){var i=e.setTimeout(n,t);r.stop=function(){e.clearTimeout(i)}}))},function(){var e=m.createElement("input"),t=m.createElement("select").appendChild(m.createElement("option"));e.type="checkbox",d.checkOn=""!==e.value,d.optSelected=t.selected,(e=m.createElement("input")).value="t",e.type="radio",d.radioValue="t"===e.value}();var ft,dt=w.expr.attrHandle;w.fn.extend({attr:function(e,t){return G(this,w.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each((function(){w.removeAttr(this,e)}))}}),w.extend({attr:function(e,t,n){var r,i,a=e.nodeType;if(3!==a&&8!==a&&2!==a)return void 0===e.getAttribute?w.prop(e,t,n):(1===a&&w.isXMLDoc(e)||(i=w.attrHooks[t.toLowerCase()]||(w.expr.match.bool.test(t)?ft:void 0)),void 0!==n?null===n?void w.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=w.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!d.radioValue&&"radio"===t&&T(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(D);if(i&&1===e.nodeType)for(;n=i[r++];)e.removeAttribute(n)}}),ft={set:function(e,t,n){return!1===t?w.removeAttr(e,n):e.setAttribute(n,n),n}},w.each(w.expr.match.bool.source.match(/\w+/g),(function(e,t){var n=dt[t]||w.find.attr;dt[t]=function(e,t,r){var i,a,o=t.toLowerCase();return r||(a=dt[o],dt[o]=i,i=null!=n(e,t,r)?o:null,dt[o]=a),i}}));var pt=/^(?:input|select|textarea|button)$/i,vt=/^(?:a|area)$/i;function mt(e){return(e.match(D)||[]).join(" ")}function yt(e){return e.getAttribute&&e.getAttribute("class")||""}function gt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(D)||[]}w.fn.extend({prop:function(e,t){return G(this,w.prop,e,t,arguments.length>1)},removeProp:function(e){return this.each((function(){delete this[w.propFix[e]||e]}))}}),w.extend({prop:function(e,t,n){var r,i,a=e.nodeType;if(3!==a&&8!==a&&2!==a)return 1===a&&w.isXMLDoc(e)||(t=w.propFix[t]||t,i=w.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=w.find.attr(e,"tabindex");return t?parseInt(t,10):pt.test(e.nodeName)||vt.test(e.nodeName)&&e.href?0:-1}}},propFix:{for:"htmlFor",class:"className"}}),d.optSelected||(w.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),w.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],(function(){w.propFix[this.toLowerCase()]=this})),w.fn.extend({addClass:function(e){var t,n,r,i,a,o;return p(e)?this.each((function(t){w(this).addClass(e.call(this,t,yt(this)))})):(t=gt(e)).length?this.each((function(){if(r=yt(this),n=1===this.nodeType&&" "+mt(r)+" "){for(a=0;a<t.length;a++)i=t[a],n.indexOf(" "+i+" ")<0&&(n+=i+" ");o=mt(n),r!==o&&this.setAttribute("class",o)}})):this},removeClass:function(e){var t,n,r,i,a,o;return p(e)?this.each((function(t){w(this).removeClass(e.call(this,t,yt(this)))})):arguments.length?(t=gt(e)).length?this.each((function(){if(r=yt(this),n=1===this.nodeType&&" "+mt(r)+" "){for(a=0;a<t.length;a++)for(i=t[a];n.indexOf(" "+i+" ")>-1;)n=n.replace(" "+i+" "," ");o=mt(n),r!==o&&this.setAttribute("class",o)}})):this:this.attr("class","")},toggleClass:function(e,t){var n,r,i,a,o=typeof e,s="string"===o||Array.isArray(e);return p(e)?this.each((function(n){w(this).toggleClass(e.call(this,n,yt(this),t),t)})):"boolean"==typeof t&&s?t?this.addClass(e):this.removeClass(e):(n=gt(e),this.each((function(){if(s)for(a=w(this),i=0;i<n.length;i++)r=n[i],a.hasClass(r)?a.removeClass(r):a.addClass(r);else void 0!==e&&"boolean"!==o||((r=yt(this))&&Y.set(this,"__className__",r),this.setAttribute&&this.setAttribute("class",r||!1===e?"":Y.get(this,"__className__")||""))})))},hasClass:function(e){var t,n,r=0;for(t=" "+e+" ";n=this[r++];)if(1===n.nodeType&&(" "+mt(yt(n))+" ").indexOf(t)>-1)return!0;return!1}});var Ct=/\r/g;w.fn.extend({val:function(e){var t,n,r,i=this[0];return arguments.length?(r=p(e),this.each((function(n){var i;1===this.nodeType&&(null==(i=r?e.call(this,n,w(this).val()):e)?i="":"number"==typeof i?i+="":Array.isArray(i)&&(i=w.map(i,(function(e){return null==e?"":e+""}))),(t=w.valHooks[this.type]||w.valHooks[this.nodeName.toLowerCase()])&&"set"in t&&void 0!==t.set(this,i,"value")||(this.value=i))}))):i?(t=w.valHooks[i.type]||w.valHooks[i.nodeName.toLowerCase()])&&"get"in t&&void 0!==(n=t.get(i,"value"))?n:"string"==typeof(n=i.value)?n.replace(Ct,""):null==n?"":n:void 0}}),w.extend({valHooks:{option:{get:function(e){var t=w.find.attr(e,"value");return null!=t?t:mt(w.text(e))}},select:{get:function(e){var t,n,r,i=e.options,a=e.selectedIndex,o="select-one"===e.type,s=o?null:[],l=o?a+1:i.length;for(r=a<0?l:o?a:0;r<l;r++)if(((n=i[r]).selected||r===a)&&!n.disabled&&(!n.parentNode.disabled||!T(n.parentNode,"optgroup"))){if(t=w(n).val(),o)return t;s.push(t)}return s},set:function(e,t){for(var n,r,i=e.options,a=w.makeArray(t),o=i.length;o--;)((r=i[o]).selected=w.inArray(w.valHooks.option.get(r),a)>-1)&&(n=!0);return n||(e.selectedIndex=-1),a}}}}),w.each(["radio","checkbox"],(function(){w.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=w.inArray(w(e).val(),t)>-1}},d.checkOn||(w.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})})),d.focusin="onfocusin"in e;var bt=/^(?:focusinfocus|focusoutblur)$/,wt=function(e){e.stopPropagation()};w.extend(w.event,{trigger:function(t,n,r,i){var a,o,s,l,u,h,f,d,y=[r||m],g=c.call(t,"type")?t.type:t,C=c.call(t,"namespace")?t.namespace.split("."):[];if(o=d=s=r=r||m,3!==r.nodeType&&8!==r.nodeType&&!bt.test(g+w.event.triggered)&&(g.indexOf(".")>-1&&(C=g.split("."),g=C.shift(),C.sort()),u=g.indexOf(":")<0&&"on"+g,(t=t[w.expando]?t:new w.Event(g,"object"==typeof t&&t)).isTrigger=i?2:3,t.namespace=C.join("."),t.rnamespace=t.namespace?new RegExp("(^|\\.)"+C.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,t.result=void 0,t.target||(t.target=r),n=null==n?[t]:w.makeArray(n,[t]),f=w.event.special[g]||{},i||!f.trigger||!1!==f.trigger.apply(r,n))){if(!i&&!f.noBubble&&!v(r)){for(l=f.delegateType||g,bt.test(l+g)||(o=o.parentNode);o;o=o.parentNode)y.push(o),s=o;s===(r.ownerDocument||m)&&y.push(s.defaultView||s.parentWindow||e)}for(a=0;(o=y[a++])&&!t.isPropagationStopped();)d=o,t.type=a>1?l:f.bindType||g,(h=(Y.get(o,"events")||Object.create(null))[t.type]&&Y.get(o,"handle"))&&h.apply(o,n),(h=u&&o[u])&&h.apply&&z(o)&&(t.result=h.apply(o,n),!1===t.result&&t.preventDefault());return t.type=g,i||t.isDefaultPrevented()||f._default&&!1!==f._default.apply(y.pop(),n)||!z(r)||u&&p(r[g])&&!v(r)&&((s=r[u])&&(r[u]=null),w.event.triggered=g,t.isPropagationStopped()&&d.addEventListener(g,wt),r[g](),t.isPropagationStopped()&&d.removeEventListener(g,wt),w.event.triggered=void 0,s&&(r[u]=s)),t.result}},simulate:function(e,t,n){var r=w.extend(new w.Event,n,{type:e,isSimulated:!0});w.event.trigger(r,null,t)}}),w.fn.extend({trigger:function(e,t){return this.each((function(){w.event.trigger(e,t,this)}))},triggerHandler:function(e,t){var n=this[0];if(n)return w.event.trigger(e,t,n,!0)}}),d.focusin||w.each({focus:"focusin",blur:"focusout"},(function(e,t){var n=function(e){w.event.simulate(t,e.target,w.event.fix(e))};w.event.special[t]={setup:function(){var r=this.ownerDocument||this.document||this,i=Y.access(r,t);i||r.addEventListener(e,n,!0),Y.access(r,t,(i||0)+1)},teardown:function(){var r=this.ownerDocument||this.document||this,i=Y.access(r,t)-1;i?Y.access(r,t,i):(r.removeEventListener(e,n,!0),Y.remove(r,t))}}}));var St=e.location,kt={guid:Date.now()},xt=/\?/;w.parseXML=function(t){var n,r;if(!t||"string"!=typeof t)return null;try{n=(new e.DOMParser).parseFromString(t,"text/xml")}catch(e){}return r=n&&n.getElementsByTagName("parsererror")[0],n&&!r||w.error("Invalid XML: "+(r?w.map(r.childNodes,(function(e){return e.textContent})).join("\n"):t)),n};var Et=/\[\]$/,_t=/\r?\n/g,Tt=/^(?:submit|button|image|reset|file)$/i,At=/^(?:input|select|textarea|keygen)/i;function Nt(e,t,n,r){var i;if(Array.isArray(t))w.each(t,(function(t,i){n||Et.test(e)?r(e,i):Nt(e+"["+("object"==typeof i&&null!=i?t:"")+"]",i,n,r)}));else if(n||"object"!==C(t))r(e,t);else for(i in t)Nt(e+"["+i+"]",t[i],n,r)}w.param=function(e,t){var n,r=[],i=function(e,t){var n=p(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!w.isPlainObject(e))w.each(e,(function(){i(this.name,this.value)}));else for(n in e)Nt(n,e[n],t,i);return r.join("&")},w.fn.extend({serialize:function(){return w.param(this.serializeArray())},serializeArray:function(){return this.map((function(){var e=w.prop(this,"elements");return e?w.makeArray(e):this})).filter((function(){var e=this.type;return this.name&&!w(this).is(":disabled")&&At.test(this.nodeName)&&!Tt.test(e)&&(this.checked||!pe.test(e))})).map((function(e,t){var n=w(this).val();return null==n?null:Array.isArray(n)?w.map(n,(function(e){return{name:t.name,value:e.replace(_t,"\r\n")}})):{name:t.name,value:n.replace(_t,"\r\n")}})).get()}});var Ot=/%20/g,Pt=/#.*$/,It=/([?&])_=[^&]*/,Ft=/^(.*?):[ \t]*([^\r\n]*)$/gm,Wt=/^(?:GET|HEAD)$/,Rt=/^\/\//,Dt={},Lt={},jt="*/".concat("*"),$t=m.createElement("a");function Mt(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var r,i=0,a=t.toLowerCase().match(D)||[];if(p(n))for(;r=a[i++];)"+"===r[0]?(r=r.slice(1)||"*",(e[r]=e[r]||[]).unshift(n)):(e[r]=e[r]||[]).push(n)}}function Vt(e,t,n,r){var i={},a=e===Lt;function o(s){var l;return i[s]=!0,w.each(e[s]||[],(function(e,s){var u=s(t,n,r);return"string"!=typeof u||a||i[u]?a?!(l=u):void 0:(t.dataTypes.unshift(u),o(u),!1)})),l}return o(t.dataTypes[0])||!i["*"]&&o("*")}function Bt(e,t){var n,r,i=w.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&w.extend(!0,e,r),e}$t.href=St.href,w.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:St.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(St.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":jt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":w.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Bt(Bt(e,w.ajaxSettings),t):Bt(w.ajaxSettings,e)},ajaxPrefilter:Mt(Dt),ajaxTransport:Mt(Lt),ajax:function(t,n){"object"==typeof t&&(n=t,t=void 0),n=n||{};var r,i,a,o,s,l,u,c,h,f,d=w.ajaxSetup({},n),p=d.context||d,v=d.context&&(p.nodeType||p.jquery)?w(p):w.event,y=w.Deferred(),g=w.Callbacks("once memory"),C=d.statusCode||{},b={},S={},k="canceled",x={readyState:0,getResponseHeader:function(e){var t;if(u){if(!o)for(o={};t=Ft.exec(a);)o[t[1].toLowerCase()+" "]=(o[t[1].toLowerCase()+" "]||[]).concat(t[2]);t=o[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return u?a:null},setRequestHeader:function(e,t){return null==u&&(e=S[e.toLowerCase()]=S[e.toLowerCase()]||e,b[e]=t),this},overrideMimeType:function(e){return null==u&&(d.mimeType=e),this},statusCode:function(e){var t;if(e)if(u)x.always(e[x.status]);else for(t in e)C[t]=[C[t],e[t]];return this},abort:function(e){var t=e||k;return r&&r.abort(t),E(0,t),this}};if(y.promise(x),d.url=((t||d.url||St.href)+"").replace(Rt,St.protocol+"//"),d.type=n.method||n.type||d.method||d.type,d.dataTypes=(d.dataType||"*").toLowerCase().match(D)||[""],null==d.crossDomain){l=m.createElement("a");try{l.href=d.url,l.href=l.href,d.crossDomain=$t.protocol+"//"+$t.host!=l.protocol+"//"+l.host}catch(e){d.crossDomain=!0}}if(d.data&&d.processData&&"string"!=typeof d.data&&(d.data=w.param(d.data,d.traditional)),Vt(Dt,d,n,x),u)return x;for(h in(c=w.event&&d.global)&&0==w.active++&&w.event.trigger("ajaxStart"),d.type=d.type.toUpperCase(),d.hasContent=!Wt.test(d.type),i=d.url.replace(Pt,""),d.hasContent?d.data&&d.processData&&0===(d.contentType||"").indexOf("application/x-www-form-urlencoded")&&(d.data=d.data.replace(Ot,"+")):(f=d.url.slice(i.length),d.data&&(d.processData||"string"==typeof d.data)&&(i+=(xt.test(i)?"&":"?")+d.data,delete d.data),!1===d.cache&&(i=i.replace(It,"$1"),f=(xt.test(i)?"&":"?")+"_="+kt.guid+++f),d.url=i+f),d.ifModified&&(w.lastModified[i]&&x.setRequestHeader("If-Modified-Since",w.lastModified[i]),w.etag[i]&&x.setRequestHeader("If-None-Match",w.etag[i])),(d.data&&d.hasContent&&!1!==d.contentType||n.contentType)&&x.setRequestHeader("Content-Type",d.contentType),x.setRequestHeader("Accept",d.dataTypes[0]&&d.accepts[d.dataTypes[0]]?d.accepts[d.dataTypes[0]]+("*"!==d.dataTypes[0]?", "+jt+"; q=0.01":""):d.accepts["*"]),d.headers)x.setRequestHeader(h,d.headers[h]);if(d.beforeSend&&(!1===d.beforeSend.call(p,x,d)||u))return x.abort();if(k="abort",g.add(d.complete),x.done(d.success),x.fail(d.error),r=Vt(Lt,d,n,x)){if(x.readyState=1,c&&v.trigger("ajaxSend",[x,d]),u)return x;d.async&&d.timeout>0&&(s=e.setTimeout((function(){x.abort("timeout")}),d.timeout));try{u=!1,r.send(b,E)}catch(e){if(u)throw e;E(-1,e)}}else E(-1,"No Transport");function E(t,n,o,l){var h,f,m,b,S,k=n;u||(u=!0,s&&e.clearTimeout(s),r=void 0,a=l||"",x.readyState=t>0?4:0,h=t>=200&&t<300||304===t,o&&(b=function(e,t,n){for(var r,i,a,o,s=e.contents,l=e.dataTypes;"*"===l[0];)l.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){l.unshift(i);break}if(l[0]in n)a=l[0];else{for(i in n){if(!l[0]||e.converters[i+" "+l[0]]){a=i;break}o||(o=i)}a=a||o}if(a)return a!==l[0]&&l.unshift(a),n[a]}(d,x,o)),!h&&w.inArray("script",d.dataTypes)>-1&&w.inArray("json",d.dataTypes)<0&&(d.converters["text script"]=function(){}),b=function(e,t,n,r){var i,a,o,s,l,u={},c=e.dataTypes.slice();if(c[1])for(o in e.converters)u[o.toLowerCase()]=e.converters[o];for(a=c.shift();a;)if(e.responseFields[a]&&(n[e.responseFields[a]]=t),!l&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),l=a,a=c.shift())if("*"===a)a=l;else if("*"!==l&&l!==a){if(!(o=u[l+" "+a]||u["* "+a]))for(i in u)if((s=i.split(" "))[1]===a&&(o=u[l+" "+s[0]]||u["* "+s[0]])){!0===o?o=u[i]:!0!==u[i]&&(a=s[0],c.unshift(s[1]));break}if(!0!==o)if(o&&e.throws)t=o(t);else try{t=o(t)}catch(e){return{state:"parsererror",error:o?e:"No conversion from "+l+" to "+a}}}return{state:"success",data:t}}(d,b,x,h),h?(d.ifModified&&((S=x.getResponseHeader("Last-Modified"))&&(w.lastModified[i]=S),(S=x.getResponseHeader("etag"))&&(w.etag[i]=S)),204===t||"HEAD"===d.type?k="nocontent":304===t?k="notmodified":(k=b.state,f=b.data,h=!(m=b.error))):(m=k,!t&&k||(k="error",t<0&&(t=0))),x.status=t,x.statusText=(n||k)+"",h?y.resolveWith(p,[f,k,x]):y.rejectWith(p,[x,k,m]),x.statusCode(C),C=void 0,c&&v.trigger(h?"ajaxSuccess":"ajaxError",[x,d,h?f:m]),g.fireWith(p,[x,k]),c&&(v.trigger("ajaxComplete",[x,d]),--w.active||w.event.trigger("ajaxStop")))}return x},getJSON:function(e,t,n){return w.get(e,t,n,"json")},getScript:function(e,t){return w.get(e,void 0,t,"script")}}),w.each(["get","post"],(function(e,t){w[t]=function(e,n,r,i){return p(n)&&(i=i||r,r=n,n=void 0),w.ajax(w.extend({url:e,type:t,dataType:i,data:n,success:r},w.isPlainObject(e)&&e))}})),w.ajaxPrefilter((function(e){var t;for(t in e.headers)"content-type"===t.toLowerCase()&&(e.contentType=e.headers[t]||"")})),w._evalUrl=function(e,t,n){return w.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){w.globalEval(e,t,n)}})},w.fn.extend({wrapAll:function(e){var t;return this[0]&&(p(e)&&(e=e.call(this[0])),t=w(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map((function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e})).append(this)),this},wrapInner:function(e){return p(e)?this.each((function(t){w(this).wrapInner(e.call(this,t))})):this.each((function(){var t=w(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)}))},wrap:function(e){var t=p(e);return this.each((function(n){w(this).wrapAll(t?e.call(this,n):e)}))},unwrap:function(e){return this.parent(e).not("body").each((function(){w(this).replaceWith(this.childNodes)})),this}}),w.expr.pseudos.hidden=function(e){return!w.expr.pseudos.visible(e)},w.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},w.ajaxSettings.xhr=function(){try{return new e.XMLHttpRequest}catch(e){}};var Gt={0:200,1223:204},qt=w.ajaxSettings.xhr();d.cors=!!qt&&"withCredentials"in qt,d.ajax=qt=!!qt,w.ajaxTransport((function(t){var n,r;if(d.cors||qt&&!t.crossDomain)return{send:function(i,a){var o,s=t.xhr();if(s.open(t.type,t.url,t.async,t.username,t.password),t.xhrFields)for(o in t.xhrFields)s[o]=t.xhrFields[o];for(o in t.mimeType&&s.overrideMimeType&&s.overrideMimeType(t.mimeType),t.crossDomain||i["X-Requested-With"]||(i["X-Requested-With"]="XMLHttpRequest"),i)s.setRequestHeader(o,i[o]);n=function(e){return function(){n&&(n=r=s.onload=s.onerror=s.onabort=s.ontimeout=s.onreadystatechange=null,"abort"===e?s.abort():"error"===e?"number"!=typeof s.status?a(0,"error"):a(s.status,s.statusText):a(Gt[s.status]||s.status,s.statusText,"text"!==(s.responseType||"text")||"string"!=typeof s.responseText?{binary:s.response}:{text:s.responseText},s.getAllResponseHeaders()))}},s.onload=n(),r=s.onerror=s.ontimeout=n("error"),void 0!==s.onabort?s.onabort=r:s.onreadystatechange=function(){4===s.readyState&&e.setTimeout((function(){n&&r()}))},n=n("abort");try{s.send(t.hasContent&&t.data||null)}catch(e){if(n)throw e}},abort:function(){n&&n()}}})),w.ajaxPrefilter((function(e){e.crossDomain&&(e.contents.script=!1)})),w.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return w.globalEval(e),e}}}),w.ajaxPrefilter("script",(function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")})),w.ajaxTransport("script",(function(e){var t,n;if(e.crossDomain||e.scriptAttrs)return{send:function(r,i){t=w("<script>").attr(e.scriptAttrs||{}).prop({charset:e.scriptCharset,src:e.url}).on("load error",n=function(e){t.remove(),n=null,e&&i("error"===e.type?404:200,e.type)}),m.head.appendChild(t[0])},abort:function(){n&&n()}}}));var Ht,Ut=[],Kt=/(=)\?(?=&|$)|\?\?/;w.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Ut.pop()||w.expando+"_"+kt.guid++;return this[e]=!0,e}}),w.ajaxPrefilter("json jsonp",(function(t,n,r){var i,a,o,s=!1!==t.jsonp&&(Kt.test(t.url)?"url":"string"==typeof t.data&&0===(t.contentType||"").indexOf("application/x-www-form-urlencoded")&&Kt.test(t.data)&&"data");if(s||"jsonp"===t.dataTypes[0])return i=t.jsonpCallback=p(t.jsonpCallback)?t.jsonpCallback():t.jsonpCallback,s?t[s]=t[s].replace(Kt,"$1"+i):!1!==t.jsonp&&(t.url+=(xt.test(t.url)?"&":"?")+t.jsonp+"="+i),t.converters["script json"]=function(){return o||w.error(i+" was not called"),o[0]},t.dataTypes[0]="json",a=e[i],e[i]=function(){o=arguments},r.always((function(){void 0===a?w(e).removeProp(i):e[i]=a,t[i]&&(t.jsonpCallback=n.jsonpCallback,Ut.push(i)),o&&p(a)&&a(o[0]),o=a=void 0})),"script"})),d.createHTMLDocument=((Ht=m.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Ht.childNodes.length),w.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(d.createHTMLDocument?((r=(t=m.implementation.createHTMLDocument("")).createElement("base")).href=m.location.href,t.head.appendChild(r)):t=m),a=!n&&[],(i=A.exec(e))?[t.createElement(i[1])]:(i=we([e],t,a),a&&a.length&&w(a).remove(),w.merge([],i.childNodes)));var r,i,a},w.fn.load=function(e,t,n){var r,i,a,o=this,s=e.indexOf(" ");return s>-1&&(r=mt(e.slice(s)),e=e.slice(0,s)),p(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),o.length>0&&w.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done((function(e){a=arguments,o.html(r?w("<div>").append(w.parseHTML(e)).find(r):e)})).always(n&&function(e,t){o.each((function(){n.apply(this,a||[e.responseText,t,e])}))}),this},w.expr.pseudos.animated=function(e){return w.grep(w.timers,(function(t){return e===t.elem})).length},w.offset={setOffset:function(e,t,n){var r,i,a,o,s,l,u=w.css(e,"position"),c=w(e),h={};"static"===u&&(e.style.position="relative"),s=c.offset(),a=w.css(e,"top"),l=w.css(e,"left"),("absolute"===u||"fixed"===u)&&(a+l).indexOf("auto")>-1?(o=(r=c.position()).top,i=r.left):(o=parseFloat(a)||0,i=parseFloat(l)||0),p(t)&&(t=t.call(e,n,w.extend({},s))),null!=t.top&&(h.top=t.top-s.top+o),null!=t.left&&(h.left=t.left-s.left+i),"using"in t?t.using.call(e,h):c.css(h)}},w.fn.extend({offset:function(e){if(arguments.length)return void 0===e?this:this.each((function(t){w.offset.setOffset(this,e,t)}));var t,n,r=this[0];return r?r.getClientRects().length?(t=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:t.top+n.pageYOffset,left:t.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===w.css(r,"position"))t=r.getBoundingClientRect();else{for(t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;e&&(e===n.body||e===n.documentElement)&&"static"===w.css(e,"position");)e=e.parentNode;e&&e!==r&&1===e.nodeType&&((i=w(e).offset()).top+=w.css(e,"borderTopWidth",!0),i.left+=w.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-w.css(r,"marginTop",!0),left:t.left-i.left-w.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map((function(){for(var e=this.offsetParent;e&&"static"===w.css(e,"position");)e=e.offsetParent;return e||ie}))}}),w.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},(function(e,t){var n="pageYOffset"===t;w.fn[e]=function(r){return G(this,(function(e,r,i){var a;if(v(e)?a=e:9===e.nodeType&&(a=e.defaultView),void 0===i)return a?a[t]:e[r];a?a.scrollTo(n?a.pageXOffset:i,n?i:a.pageYOffset):e[r]=i}),e,r,arguments.length)}})),w.each(["top","left"],(function(e,t){w.cssHooks[t]=He(d.pixelPosition,(function(e,n){if(n)return n=qe(e,t),je.test(n)?w(e).position()[t]+"px":n}))})),w.each({Height:"height",Width:"width"},(function(e,t){w.each({padding:"inner"+e,content:t,"":"outer"+e},(function(n,r){w.fn[r]=function(i,a){var o=arguments.length&&(n||"boolean"!=typeof i),s=n||(!0===i||!0===a?"margin":"border");return G(this,(function(t,n,i){var a;return v(t)?0===r.indexOf("outer")?t["inner"+e]:t.document.documentElement["client"+e]:9===t.nodeType?(a=t.documentElement,Math.max(t.body["scroll"+e],a["scroll"+e],t.body["offset"+e],a["offset"+e],a["client"+e])):void 0===i?w.css(t,n,s):w.style(t,n,i,s)}),t,o?i:void 0,o)}}))})),w.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],(function(e,t){w.fn[t]=function(e){return this.on(t,e)}})),w.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),w.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),(function(e,t){w.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}));var zt=/^[\s\uFEFF\xA0]+|([^\s\uFEFF\xA0])[\s\uFEFF\xA0]+$/g;w.proxy=function(e,t){var n,r,a;if("string"==typeof t&&(n=e[t],t=e,e=n),p(e))return r=i.call(arguments,2),a=function(){return e.apply(t||this,r.concat(i.call(arguments)))},a.guid=e.guid=e.guid||w.guid++,a},w.holdReady=function(e){e?w.readyWait++:w.ready(!0)},w.isArray=Array.isArray,w.parseJSON=JSON.parse,w.nodeName=T,w.isFunction=p,w.isWindow=v,w.camelCase=K,w.type=C,w.now=Date.now,w.isNumeric=function(e){var t=w.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},w.trim=function(e){return null==e?"":(e+"").replace(zt,"$1")};var Jt=e.jQuery,Yt=e.$;return w.noConflict=function(t){return e.$===w&&(e.$=Yt),t&&e.jQuery===w&&(e.jQuery=Jt),w},void 0===t&&(e.jQuery=e.$=w),w}))}));function Kt(t){let n,r;return n=new qe({props:{text:"The end."}}),{c(){ye(n.$$.fragment)},m(e,t){ge(n,e,t),r=!0},p:e,i(e){r||(ce(n.$$.fragment,e),r=!0)},o(e){he(n.$$.fragment,e),r=!1},d(e){Ce(n,e)}}}function zt(e){let t,n,r,i;const a=[Yt,Jt],o=[];function s(e,t){return e[0].askOpinion?0:1}return t=s(e),n=o[t]=a[t](e),{c(){n.c(),r=N()},m(e,n){o[t].m(e,n),k(e,r,n),i=!0},p(e,i){let l=t;t=s(e),t===l?o[t].p(e,i):(le(),he(o[l],1,1,(()=>{o[l]=null})),ue(),n=o[t],n?n.p(e,i):(n=o[t]=a[t](e),n.c()),ce(n,1),n.m(r.parentNode,r))},i(e){i||(ce(n),i=!0)},o(e){he(n),i=!1},d(e){o[t].d(e),e&&x(r)}}}function Jt(e){let t,n;return t=new Nt({props:{state:e[0]}}),t.$on("choice:confirmed",e[8]),t.$on("story:continue",e[4]),{c(){ye(t.$$.fragment)},m(e,r){ge(t,e,r),n=!0},p(e,n){const r={};1&n&&(r.state=e[0]),t.$set(r)},i(e){n||(ce(t.$$.fragment,e),n=!0)},o(e){he(t.$$.fragment,e),n=!1},d(e){Ce(t,e)}}}function Yt(e){let t,n;return t=new Ft({props:{choiceText:e[0].lastMadeChoice.text,choiceIndex:e[0].lastMadeChoiceIndex,opinions:e[0].opinions.filter(e[5])}}),t.$on("opinion:submitted",e[6]),t.$on("opinion:agreed",e[7]),{c(){ye(t.$$.fragment)},m(e,r){ge(t,e,r),n=!0},p(e,n){const r={};1&n&&(r.choiceText=e[0].lastMadeChoice.text),1&n&&(r.choiceIndex=e[0].lastMadeChoiceIndex),1&n&&(r.opinions=e[0].opinions.filter(e[5])),t.$set(r)},i(e){n||(ce(t.$$.fragment,e),n=!0)},o(e){he(t.$$.fragment,e),n=!1},d(e){Ce(t,e)}}}function Xt(e){let t,n,r,i;const a=[zt,Kt],o=[];function s(e,t){return null!==e[0]?0:1}return n=s(e),r=o[n]=a[n](e),{c(){t=_("main"),r.c(),P(t,"class","svelte-mefzm7")},m(e,r){k(e,t,r),o[n].m(t,null),i=!0},p(e,[i]){let l=n;n=s(e),n===l?o[n].p(e,i):(le(),he(o[l],1,1,(()=>{o[l]=null})),ue(),r=o[n],r?r.p(e,i):(r=o[n]=a[n](e),r.c()),ce(r,1),r.m(t,null))},i(e){i||(ce(r),i=!0)},o(e){he(r),i=!1},d(e){e&&x(t),o[n].d()}}}function Zt(e,t,n){let r=new jt.Story($t);const i=async()=>{let e=await fetch("https://data.id.tue.nl/datasets/downloadPublic/json/U1Q4cEwrWlViem0rWVFndSs4cnM2UT09",{method:"GET",mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer"});return await e.json()},a=(e,t)=>{Ut.ajax({url:"https://data.id.tue.nl/datasets/entity/2793/item/",headers:{api_token:"Q292bk9FMStweWlzMTM0ZXZILzBqcHpMV2ZzSlJNKzdleW52NThKbTJtTT0=",resource_id:e,token:"Q292bk9FMStweWlzMTM0ZXZILzBqcHpMV2ZzSlJNKzdleW52NThKbTJtTT0="},type:"POST",contentType:"application/json",data:JSON.stringify(t),success:e=>(console.log("CHOICE DATA UPDATED",e),e),error(e){console.error(e)}})},o=async e=>(await i()).filter((t=>t.opinionId===e)),s=async e=>{r.ChooseChoiceIndex(e.detail.index),console.log("Make choice",c,e.detail);let t="choice_data_"+(10*c.opinionId+e.detail.index),o=(await i()).find((e=>e.resource_id===t));console.log("CD",o),void 0!==o?(o.chosen++,a(t,o)):a(t,{chosen:1}),n(0,c.lastMadeChoice=e.detail.choice,c),n(0,c.lastMadeChoiceIndex=e.detail.index,c),0==c.opinionId?h():n(0,c.askOpinion=!0,c)},l=async e=>{let t=await i();t=t.find((t=>t.resource_id===e.detail.opinion.resource_id)),console.log("OPS",t),t.agreedTimes++,Ut.ajax({url:"https://data.id.tue.nl/datasets/entity/2793/item/",headers:{api_token:"Q292bk9FMStweWlzMTM0ZXZILzBqcHpMV2ZzSlJNKzdleW52NThKbTJtTT0=",resource_id:t.resource_id,token:"Q292bk9FMStweWlzMTM0ZXZILzBqcHpMV2ZzSlJNKzdleW52NThKbTJtTT0="},type:"PUT",contentType:"application/json",data:JSON.stringify(t),success(e){console.log("UPDATED",e)},error(e){console.log(e)}}),h()},u=e=>{if(""==e.detail.opinion)return;let t={opinion:e.detail.opinion,opinionId:c.opinionId,choice:c.prompt,choiceId:c.lastMadeChoiceIndex,agreedTimes:0};Ut.ajax({url:"https://data.id.tue.nl/datasets/entity/2793/item/",headers:{api_token:"Q292bk9FMStweWlzMTM0ZXZILzBqcHpMV2ZzSlJNKzdleW52NThKbTJtTT0=",resource_id:Ht(),token:"Q292bk9FMStweWlzMTM0ZXZILzBqcHpMV2ZzSlJNKzdleW52NThKbTJtTT0="},type:"POST",contentType:"application/json",data:JSON.stringify(t),success(e){console.log(e)},error(e){console.error(e)}}),h()};let c=null;const h=async()=>{n(0,c=await(async()=>{if(r.canContinue){let e=r.Continue();console.log(r);let t=0,n=r.currentTags.find((e=>e.includes("choice_id")));void 0!==n&&(t=parseInt(n.split("=")[1]));let a=[],s=await i();for(let e=0;e<r.currentChoices.length;e++)a.push("choice_data_"+(10*t+e));s=s.filter((e=>a.includes(e.resource_id))),s.sort((function(e,t){let n=parseInt(e.resource_id.split("_")[2]),r=parseInt(t.resource_id.split("_")[2]);return n<r?-1:n>r?1:0})),s.forEach((e=>{let t=parseInt(e.resource_id.split("_")[2]);e.opinionId=Math.floor(t/10),e.index=t%10}));let l=0;s.forEach((e=>{l+=e.chosen}));let u={prompt:e,choices:r.currentChoices,choiceData:s,totalChosen:l,opinions:await o(t),opinionId:t};return console.log(u),u}return null})())};h();return[c,s,l,u,h,e=>e.choiceId===c.lastMadeChoiceIndex,e=>u(e),e=>l(e),e=>s(e)]}const Qt=new class extends Se{constructor(e){super(),we(this,e,Zt,Xt,s,{})}}({target:document.body}),en=(e,t)=>t.text.length-e.text.length,tn=e=>new Promise((t=>setTimeout(t,e))),nn=(e,t)=>Math.floor(Math.random()*(t-e)+e),rn=async e=>tn(Array.isArray(e)?e[nn(0,e.length)]:e),an=async(e,t,n)=>{if(!t)return void console.error("The specified parent element does not exists!");let r=e;do{if(r===t)return;n(r),r=r.parentElement||r.parentNode}while(null!==r&&1===r.nodeType)},on=async({currentNode:e,text:t},n)=>{an(e,n.parentElement,(t=>{const n=e===t?"typing":"finished-typing";t.classList.add(n)}));for(let r=0;r<=t.length;r++){"<"===t[r]&&(r=t.indexOf(">",r)),e.innerHTML=t.slice(0,r),await rn(n.interval)}},sn=e=>1===e.childNodes.length&&3===e.childNodes[0].nodeType,ln=e=>void 0===e.dataset.static,un=(e,{parentElement:t})=>{if(sn(t)){const e=t.textContent,n=((e,t)=>{const n=document.createElement(t);return n.textContent=e,n})(t.textContent,"p");return t.textContent="",t.appendChild(n),[{currentNode:n,text:e}]}if(sn(e)){const t=e.innerHTML.replaceAll("&amp;","&");return[{currentNode:e,text:t}]}return[...e.children].filter(ln).flatMap((e=>un(e,{parentElement:t})))},cn=e=>{const t=[...e.querySelectorAll("[data-static]")];for(const n of t)an(n,e,(e=>{e!==n&&e.classList.add("finished-typing")}))},hn=(e,t)=>{const n={parentElement:e,dispatch:q(),...t},r=un(e,n);return cn(e),{options:n,elements:r}};var fn=Object.freeze({__proto__:null,default:(e,t)=>{const{options:n,elements:r}=hn(e,t),i=(e=>e.sort(en)[0].currentNode)(r);((e,t)=>{new MutationObserver((e=>{e.forEach((e=>{const n="attributes"===e.type,r=e.target.classList.contains("finished-typing");n&&r&&t()}))})).observe(e,{attributes:!0,childList:!0,subtree:!0})})(i,(()=>n.dispatch("done")));for(const e of r)on(e,n).then((()=>{if(n.keepCursorOnFinish){e.currentNode!==i&&e.currentNode.classList.replace("typing","finished-typing")}else e.currentNode.classList.replace("typing","finished-typing")}))}});var dn=Object.freeze({__proto__:null,default:async(e,t)=>{const{options:n,elements:r}=hn(e,t);(e=>{e.forEach((e=>e.currentNode.textContent=""))})(r);for(const e of r)if(await on(e,n),n.keepCursorOnFinish){!(r.indexOf(e)===r.length-1)&&e.currentNode.classList.replace("typing","finished-typing")}else e.currentNode.classList.replace("typing","finished-typing");n.dispatch("done")}});const pn=async(e,t)=>{const n=e.innerHTML.replaceAll("&amp;","&");for(let r=n.length-1;r>=0;r--){">"===n[r]&&(r=n.lastIndexOf("<",r)),e.innerHTML=n.slice(0,r),await rn(t.unwriteInterval?t.unwriteInterval:t.interval)}},vn=async({currentNode:e,text:t},n)=>{await on({currentNode:e,text:t},n);const r=t.replaceAll("&","&amp;");e.innerHTML===r&&(n.dispatch("done"),await rn(n.wordInterval),await pn(e,n)),an(e,n.parentElement,(t=>{e===t?t.classList.remove("typing"):t.classList.remove("finished-typing")}))};var mn=Object.freeze({__proto__:null,default:async(e,t)=>{const{options:n,elements:r}=hn(e,t);for(;;){cn(e);for(const e of r)await vn(e,n)}}});var yn=Object.freeze({__proto__:null,default:async(e,t)=>{const{options:n,elements:r}=hn(e,t);for(const e of r){const{currentNode:t,text:i}=e;await on(e,n);const a=i.replaceAll("&","&amp;");if(t.innerHTML===a){n.dispatch("done"),await rn(n.wordInterval);r.indexOf(e)===r.length-1?n.keepCursorOnFinish||an(t,n.parentElement,(e=>{t===e&&e.classList.replace("typing","finished-typing")})):(await pn(t,n),an(t,n.parentElement,(e=>{t===e?e.classList.remove("typing"):e.classList.remove("finished-typing")})))}}}});let gn=[];const Cn=e=>{for(;;){const t=nn(0,e.length),n="number"==typeof gn&&t!==gn,r=Array.isArray(gn)&&!gn.includes(t);if(1===e.length||r||n){n&&(gn=[]),gn.push(t);return e[t]}gn.length===e.length&&(gn=gn.pop())}};var bn=Object.freeze({__proto__:null,default:async(e,t)=>{const{options:n,elements:r}=hn(e,t);for(;;){cn(e);const t=Cn(r);await vn(t,n)}}});const wn=()=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split(""),t=e.length;return e[nn(0,t)]};var Sn=Object.freeze({__proto__:null,default:async(e,t)=>{const{options:n,elements:r}=hn(e,t),i=n.scrambleDuration;await new Promise((e=>{r.forEach((async({currentNode:t,text:r})=>{let a=r.split("");const o=((e,t)=>{const n=t/3;return e.map((()=>nn(n,t-100)))})(a,i),s=Date.now();for(an(t,n.parentElement,(e=>{e.classList.add("finished-typing")}));Date.now()-s<i;){const i=nn(0,a.length),l=o[i],u=" "===a[i],c=()=>Date.now()-s;if((()=>c()>=l)()||u){if(a[i]===r[i])continue;a[i]=r[i]}else a[i]=wn();const h=a.join("");t.innerHTML=h;const f=h===r,d=n.scrambleSlowdown?Math.round(c()/100):1;if(await tn(d),f){e();break}}t.innerHTML=r}))})),n.dispatch("done")}});return Qt}();
//# sourceMappingURL=bundle.js.map
